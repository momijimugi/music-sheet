import{r as e}from"./firebase-DUzmoriO.js";import{_ as t,c as n,f as r,h as i,o as a,p as o,r as s,u as c}from"./index.esm-BYm7NlOb.js";import{a as l,t as u}from"./nav-B79d_qBo.js";/* empty css              */var d=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean),f={loginRequired:`ログインしてください。`,notAdmin:`管理権限がありません。`,loading:`読み込み中...`,loadFail:`ユーザーの読み込みに失敗しました: `,updated:`更新しました`,banned:`利用停止`,active:`有効`},p=e=>document.getElementById(e),m={msg:p(`adminMsg`),userFilter:p(`userFilter`),userList:p(`userList`),activeStats:p(`activeStats`),activeList:p(`activeList`),btnReloadUsers:p(`btnReloadUsers`)},h=[`free`,`pro`,`studio`],g=[`inactive`,`active`,`past_due`,`canceled`],_=null,v=[],y=e=>{m.msg&&(m.msg.textContent=e||``)},b=e=>!!e?.email&&d.includes(e.email),x=e=>String(e??``).replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#39;`),S=e=>{let t=e?.toDate?e.toDate():e instanceof Date?e:null;if(!t)return``;let n=e=>String(e).padStart(2,`0`);return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}`},C=e=>String(e||``).trim().toLowerCase();function w(e,t,n){let r=String(t||``);return`<select data-act="${n}" class="select small">${e.map(e=>{let t=e===r?` selected`:``;return`<option value="${x(e)}"${t}>${x(e)}</option>`}).join(``)}</select>`}function T(e){let t=e===`banned`?f.banned:f.active;return`<span class="${e===`banned`?`svcTag danger`:`svcTag ok`}">${x(t)}</span>`}function E(e){if(m.userList){if(!e.length){m.userList.innerHTML=`<div class="muted">No users</div>`;return}m.userList.innerHTML=e.map(e=>{let t=e.uid||``,n=e.email||e.emailNorm||``,r=[e.displayName||e.name||``,n].filter(Boolean).join(` / `)||t,i=e.status||`active`,a=e.plan||`free`,o=e.subscriptionStatus||`inactive`,s=S(e.lastSeenAt),c=i===`banned`?`Unban`:`Ban`;return`
        <div class="svcAdminRow" data-uid="${x(t)}">
          <div class="svcAdminRowHeader">
            <div>
              <div class="svcAdminName">${x(r)}</div>
              <div class="svcAdminMeta">uid: ${x(t)}${s?` / lastSeen: ${x(s)}`:``}</div>
            </div>
            <div class="svcAdminTags">
              ${T(i)}
              <span class="svcTag">${x(a)}</span>
              <span class="svcTag">${x(o)}</span>
            </div>
          </div>
          <div class="svcAdminControls">
            <label class="svcLabel">Plan ${w(h,a,`plan`)}</label>
            <label class="svcLabel">Subscription ${w(g,o,`sub`)}</label>
            <button class="ghost" type="button" data-act="toggle-ban">${c}</button>
          </div>
        </div>
      `}).join(``)}}function D(e){if(!m.activeStats||!m.activeList)return;let t=e.filter(e=>(e.status||`active`)!==`banned`),n=e.filter(e=>(e.status||`active`)===`banned`);if(m.activeStats.textContent=`total: ${e.length} / active: ${t.length} / banned: ${n.length}`,!t.length){m.activeList.innerHTML=`<div class="muted">No active users</div>`;return}m.activeList.innerHTML=t.map(e=>{let t=e.email||e.emailNorm||``,n=[e.displayName||e.name||``,t].filter(Boolean).join(` / `),r=S(e.lastSeenAt);return`<div class="svcAdminActiveItem">${x(n||e.uid)}${r?` <span class="muted">(${x(r)})</span>`:``}</div>`}).join(``)}function O(){let e=C(m.userFilter?.value||``);if(!e){E(v),D(v);return}let t=v.filter(t=>[t.email,t.emailNorm,t.displayName,t.name,t.uid,t.plan,t.subscriptionStatus,t.status].map(e=>C(e)).join(` `).includes(e));E(t),D(t)}async function k(){if(_){y(f.loading);try{v=(await n(o(s(e,`users`),r(`lastSeenAt`,`desc`),c(300)))).docs.map(e=>({uid:e.id,...e.data()})),y(``),O()}catch(e){console.error(e),y(f.loadFail+(e?.code||e?.message||`unknown`))}}}async function A(n,r){n&&await t(a(e,`users`,n),{...r,updatedAt:i(),updatedBy:_?.uid||``})}m.userList&&(m.userList.addEventListener(`change`,async e=>{let t=e.target,n=(t?.closest?.(`.svcAdminRow`))?.dataset?.uid||``;if(n){if(t.matches(`select[data-act='plan']`)){await A(n,{plan:t.value});let e=v.findIndex(e=>e.uid===n);e>=0&&(v[e]={...v[e],plan:t.value}),O()}if(t.matches(`select[data-act='sub']`)){await A(n,{subscriptionStatus:t.value});let e=v.findIndex(e=>e.uid===n);e>=0&&(v[e]={...v[e],subscriptionStatus:t.value}),O()}}}),m.userList.addEventListener(`click`,async e=>{let t=e.target?.closest?.(`button[data-act='toggle-ban']`);if(!t)return;let n=t.closest(`.svcAdminRow`)?.dataset?.uid||``;if(!n)return;let r=v.findIndex(e=>e.uid===n),a=((r>=0?v[r]:{}).status||`active`)===`banned`?`active`:`banned`;t.disabled=!0;try{await A(n,{status:a,bannedAt:a===`banned`?i():null,bannedBy:a===`banned`?_?.uid||``:null}),r>=0&&(v[r]={...v[r],status:a}),O(),y(f.updated),setTimeout(()=>y(``),1200)}catch(e){console.error(e),y(f.loadFail+(e?.code||e?.message||`unknown`))}finally{t.disabled=!1}})),m.userFilter&&m.userFilter.addEventListener(`input`,O),m.btnReloadUsers?.addEventListener(`click`,()=>k()),(async function(){if(_=await l(),u({current:`admin`,hideAdmin:!b(_)}),!_){y(f.loginRequired);return}if(!b(_)){y(f.notAdmin);return}await k()})();