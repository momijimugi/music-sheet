import{C as e,D as t,E as n,S as r,T as i,_ as a,b as o,d as s,f as c,g as l,h as u,l as d,n as f,o as p,p as ee,r as m,s as h,t as g,w as te,x as ne,y as _}from"./index.esm-BYm7NlOb.js";/* empty css              */import{t as re}from"./tabulator_esm-7yQEXY9l.js";var ie=n().length?i():t({apiKey:`AIzaSyCCp7D78NDqKR2c8cbb29BUUE_5qBOaI_U`,authDomain:`msheet-b7efc.firebaseapp.com`,projectId:`msheet-b7efc`,storageBucket:`sheet-b7efc.firebasestorage.app`,messagingSenderId:`398789467878`,appId:`1:398789467878:web:67a33361881568c6b96527`}),ae=ne(ie),v=d(ie),oe=new o,se=`/music-sheet/index.html`,y=e=>document.getElementById(e),b=e=>y(`msg`).textContent=e||``,ce=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);function x(e){return!!e?.email&&ce.includes(e.email)}var S=localStorage.getItem(`debugGuestMode`)===`1`;function C(){return!!j&&x(j)&&!S}function le(){return!!j&&!C()}function w(e){return j?C()?!0:e===`reference`:!1}function T(){return!!j&&(C()||le())}function E(){return C()}function D(){return j?.displayName||j?.email||j?.uid||``}var ue=y(`lastUpdated`),de=null,fe=``,pe=null,me=``;function O(e){return e?e?.seconds==null?e instanceof Date?e.getTime():0:e.seconds*1e3+(e.nanoseconds||0)/1e6:0}function he(e,t){if(!ue)return;if(!e){ue.textContent=`更新: --`;return}let n=ge(t),r=e?.toDate?e.toDate():e instanceof Date?e:null;ue.textContent=`更新: ${[r?r.toLocaleString():``,n].filter(Boolean).join(` `)||`--`}`}function ge(e){let t=String(e||``).trim();return t?t.includes(`@`)?t.split(`@`)[0]:t:``}function _e(){O(de)>=O(pe)?he(de,fe):he(pe,me)}function k(e,t=40){let n=String(e||``).replace(/\s+/g,` `).trim();return n?n.length>t?`${n.slice(0,t)}…`:n:``}function ve(e){let t=(Array.isArray(e)?e:[]).filter(e=>!(e?.archived||e?.archivedAt));return t.length&&t.reduce((e,t)=>(e?.at?.seconds||0)>=(t?.at?.seconds||0)?e:t)?.text||``}function ye(e,t,n){return k(ve(e)||t||``,n)}var be=[{value:`wip`,label:`wip`,color:`#f59e0b`},{value:`rev`,label:`rev`,color:`#60a5fa`},{value:`fix`,label:`fix`,color:`#2dd4bf`}],A=[...be],xe=new Map,Se=null;function Ce(){xe=new Map(A.map(e=>[e.value,e]))}function we(e){let t=xe.get(e);return e?t?`<span class="tagPill" style="background:${t.color+`22`};border-color:${t.color+`55`};color:var(--tag-text)">${t.label}</span>`:`<span class="tagPill">${e}</span>`:`<span class="tagPill">—</span>`}function Te(e){let t=String(e||``).split(`-`).map(e=>parseInt(e,10));if(t.length<3||t.some(e=>Number.isNaN(e)))return null;let[n,r,i]=t;return new Date(n,r-1,i)}function Ee(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?``:`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)}`}function De(e){if(!e||!e.status)return`<span class="muted">—</span>`;let t=e.color||`#6fd6ff`;return`<span class="tagPill" style="background:${t+`22`};border-color:${t+`55`};color:var(--tag-text)">${X(`${e.dateLabel||e.date||``} ${e.status}`.trim())}</span>`}async function Oe(e,t){if(!e||!t)return!1;if(x(t))return!0;let n=t?.uid;if(n)try{if((await h(p(v,`projects`,e,`members`,n))).exists())return!0}catch(e){e?.code!==`permission-denied`&&console.warn(`member access check failed`,e)}try{let r=await h(p(v,`projects`,e));if(!r.exists())return!1;let i=r.data()||{};if(i.deleted)return!1;if(n&&Array.isArray(i.members)&&i.members.includes(n)||n&&i?.roleByUid&&i.roleByUid[n])return!0;let a=String(t?.email||``).trim().toLowerCase();return!!(a&&String(i.ownerEmail||``).trim().toLowerCase()===a)}catch(e){return e?.code!==`permission-denied`&&console.warn(`project access check failed`,e),!1}}function ke(e){return`
    <div class="ddCell">
      <div class="ddValue">${e||`<span class="muted">&mdash;</span>`}</div>
      <button class="ddBtn" type="button" tabindex="-1">&#9662;</button>
    </div>
  `}function Ae(e,t,n,r,i){let a=typeof i==`function`?i(e):i||{},o=a.values??a,s=document.createElement(`select`);s.className=`sheetSelect`,s.style.width=`100%`,s.style.height=`28px`,s.style.borderRadius=`8px`,s.style.border=`1px solid var(--line)`,s.style.background=`var(--panel)`,s.style.color=`var(--text)`;let c=(e,t)=>{let n=document.createElement(`option`);n.value=e??``,n.textContent=t??``,s.appendChild(n)};return c(``,``),Array.isArray(o)?o.forEach(e=>{e&&typeof e==`object`?c(e.value??e.label??``,e.label??e.value??``):c(e,e)}):o&&typeof o==`object`&&Object.entries(o).forEach(([e,t])=>c(e,t)),s.value=e.getValue()??``,t(()=>{s.focus()}),s.addEventListener(`change`,()=>n(s.value)),s.addEventListener(`blur`,()=>r()),s.addEventListener(`keydown`,e=>{e.key===`Enter`&&(e.preventDefault(),n(s.value)),e.key===`Escape`&&(e.preventDefault(),r())}),s}var je=[{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}],Me=new Map(je.map(e=>[e.value,e]));function Ne(e){if(!e)return`<span class="tagPill">&mdash;</span>`;let t=Me.get(e);return t?`<span class="tagPill" style="background:${t.color}22;border-color:${t.color}55;color:var(--tag-text)">${t.label}</span>`:`<span class="tagPill">${e}</span>`}function Pe(){let e=y(`f_len`);e&&(e.innerHTML=`<option value=""></option>`+je.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``))}function Fe(){Ce();let e=y(`f_status`);e&&(e.innerHTML=`<option value=""></option>`+A.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``));let t=y(`statusFilter`);if(t){let e=t.value;t.innerHTML=`<option value="">進捗：すべて</option>`+A.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``),t.value=e}if(We(),Xe)try{L.updateColumnDefinition(`status`,{title:`進捗`,field:`status`,width:130,formatter:e=>ke(we(e.getValue())),editor:Ae,editable:()=>w(`status`),editorParams:()=>{let e={};return A.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),w(`status`)&&t.edit(!0)}})}catch{}}function Ie(){y(`overlay`).classList.remove(`hidden`),y(`statusModal`).classList.remove(`hidden`),Re(),$e(),V(),H()}function Le(){y(`overlay`).classList.add(`hidden`),y(`statusModal`).classList.add(`hidden`)}function Re(){let e=y(`statusList`);e.innerHTML=``;let t=C();if(A.forEach((n,r)=>{let i=document.createElement(`div`);i.className=`statusRow`,i.innerHTML=`
      <input type="text" value="${n.label||n.value||``}" data-k="label" data-i="${r}" placeholder="表示名" ${t?``:`disabled`} />
      <input type="color" value="${n.color}" data-k="color" data-i="${r}" ${t?``:`disabled`} />
      <button class="smallBtn" data-act="del" data-i="${r}" ${t?``:`disabled`}>削除</button>
    `,e.appendChild(i)}),!t){e.oninput=null,e.onclick=null;return}e.oninput=e=>{let t=e.target,n=Number(t?.dataset?.i),r=t?.dataset?.k;if(!(Number.isNaN(n)||!r)){if(r===`label`){let e=t.value;A[n]={...A[n],label:e,value:e};return}A[n]={...A[n],[r]:t.value}}},e.onclick=e=>{let t=e.target?.closest(`button`);if(t&&t.dataset.act===`del`){let e=Number(t.dataset.i);A.splice(e,1),Re()}}}async function ze(){if(!C()){b(`管理者のみ変更できます`);return}A=A.map(e=>{let t=(e.label||e.value||``).trim(),n=t;return{...e,label:t,value:n}}).filter(e=>e.value&&e.label);let e=new Set;A=A.filter(t=>e.has(t.value)?!1:(e.add(t.value),!0)),await l(p(v,`projects`,M,`settings`,`ui`),{statuses:A,fpsDefault:y(`fpsDefault`)?.value||`24`,updatedAt:u(),updatedBy:D()},{merge:!0}),Fe(),Le(),b(`進捗設定を保存しました`)}function Be(e){Se&&Se();let t=p(v,`projects`,e,`settings`,`ui`);Se=s(t,async e=>{if(e.exists()){let t=e.data();t?.updatedAt&&(pe=t.updatedAt,me=t.updatedBy||``,_e()),A=Array.isArray(t.statuses)&&t.statuses.length?t.statuses:[...be];let n=String(t.fpsDefault??`24`);y(`fpsDefault`)&&(y(`fpsDefault`).value=n),window.__FPS_DEFAULT__=n}else A=[...be],y(`fpsDefault`)&&(y(`fpsDefault`).value=`24`),window.__FPS_DEFAULT__=`24`,C()&&await l(t,{statuses:A,fpsDefault:`24`,createdAt:u()},{merge:!0});Fe()},e=>{console.error(e),b(`設定同期エラー: ${e.code||e.message}`)})}function Ve(e){I=new Map,(e?.statuses||[]).forEach(e=>{!e||!e.name||I.set(e.name,e.color||`#6fd6ff`)});let t=e?.schedule||{},n=new Date;n.setHours(0,0,0,0);let r=new Map;Object.keys(t).forEach(e=>{let i=t[e];if(!i||typeof i!=`object`)return;let a=null;if(Object.keys(i).forEach(e=>{let t=i[e];if(!t||t===`none`)return;let r=Te(e);r&&(r<n||(!a||r<a.dt)&&(a={dt:r,dateStr:e,status:t}))}),!a)return;let o=I.get(a.status)||`#6fd6ff`;r.set(e,{status:a.status,date:a.dateStr,dateLabel:Ee(a.dt),color:o})}),F=r}function He(){if(!L||!L.getData)return;let e=L.getData();if(!e.length)return;let t=e.map(e=>({id:e.id,nextSchedule:F.get(e.id)||null}));L.updateData(t)}function Ue(e){if(Ye&&Ye(),F=new Map,I=new Map,!e){He();return}Ye=s(p(v,`projects`,e,`scheduleBoard`,`state`),e=>{if(!e.exists()){F=new Map,I=new Map,He();return}let t=e.data()||{};Ve(t.state||t),He()},e=>{console.error(e)})}function We(){let e=y(`f_status`)?.value||``;y(`statusTagPreview`).outerHTML=`<span id="statusTagPreview" class="tagPill">${xe.get(e)?.label||e||`—`}</span>`}var j=null,Ge=new URLSearchParams(location.search),Ke=(Ge.get(`project`)||``).trim(),qe=(Ge.get(`cue`)||``).trim();Ke&&(y(`projectId`).value=Ke,y(`projectId`).disabled=!0,localStorage.setItem(`lastProject`,Ke));var M=y(`projectId`).value.trim(),N=null,P=null;qe&&(P=qe);var Je=!1,Ye=null,F=new Map,I=new Map,Xe=!1,L=new re(`#grid`,{height:`100%`,layout:`fitColumns`,rowHeight:40,selectable:!0,selectableRangeMode:`click`,movableRows:!0,index:`id`,columns:[{formatter:`handle`,field:`__handle`,width:34,hozAlign:`center`,headerSort:!1,rowHandle:!0,frozen:!0},{title:`#M`,field:`m`,width:70,headerSort:!0,frozen:!0},{title:`V`,field:`v`,width:55,editor:`input`,editable:()=>w(`v`),frozen:!0},{title:`demo`,field:`demo`,width:80,editor:`input`,editable:()=>w(`demo`),frozen:!0},{title:`scene`,field:`scene`,minWidth:180,editor:`input`,editable:()=>w(`scene`)},{title:`長さ`,field:`len`,width:120,formatter:e=>ke(Ne(e.getValue())),editor:Ae,editable:()=>w(`len`),editorParams:()=>{let e={};return je.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),w(`len`)&&t.edit(!0)}},{title:`進捗`,field:`status`,width:130,formatter:e=>ke(we(e.getValue())),editor:Ae,editable:()=>w(`status`),editorParams:()=>{let e={};return A.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),w(`status`)&&t.edit(!0)}},{title:`直近予定`,field:`nextSchedule`,width:180,headerSort:!1,formatter:e=>De(e.getValue())},{title:`監督FB(省略)`,field:`director`,minWidth:220,headerSort:!1,formatter:e=>{let t=e.getData();return ye(t.directorLog,t.director,40)}},{title:`コメント(省略)`,field:`commentLog`,minWidth:220,headerSort:!1,formatter:e=>{let t=e.getData();return ye(t.commentLog,t.comment,40)}},{title:`参考曲`,field:`reference`,minWidth:200,headerSort:!1,editor:`input`,editable:()=>w(`reference`),formatter:vt},{title:`更新`,field:`updatedAt`,width:190,headerSort:!1,formatter:e=>{let t=e.getData(),n=t.updatedAt?.toDate?t.updatedAt.toDate():null;return`<div style="font-size:12px;line-height:1.15">
          <div>${n?n.toLocaleString():``}</div><div style="opacity:.75">${t.updatedBy||``}</div>
        </div>`}},{title:`IN TC`,field:`in`,width:110,editor:`input`,editable:()=>w(`in`)},{title:`OUT TC`,field:`out`,width:110,editor:`input`,editable:()=>w(`out`)},{title:`INT TC`,field:`interval`,width:110,headerSort:!1}]});L.on(`tableBuilt`,()=>{Xe=!0,Fe(),H()}),Pe();var R=!1,z=!1,B=[],Ze=50,Qe=new Set([`status`,`len`,`scene`,`demo`,`in`,`out`]);function $e(){let e=y(`toggleBulk`);e&&(e.checked=R);let t=y(`bulkState`);t&&(t.textContent=R?`ON`:`OFF`)}function et(e){R=!!e,$e()}y(`toggleBulk`)?.addEventListener(`change`,()=>{if(!C()){et(!1);return}et(y(`toggleBulk`).checked)});function V(){let e=y(`toggleGuest`);if(!e)return;e.checked=S,e.disabled=!x(j);let t=y(`guestState`);t&&(t.textContent=S?`ON`:`OFF`)}function tt(e){S=!!e,localStorage.setItem(`debugGuestMode`,S?`1`:`0`),V(),H()}y(`toggleGuest`)?.addEventListener(`change`,()=>{if(!x(j)){V();return}tt(y(`toggleGuest`).checked)});function H(){let e=x(j),t=C(),n=!!j&&!t,r=y(`btnSettings`);r&&(r.style.display=e?``:`none`);let i=y(`btnAddRow`);i&&(i.style.display=t?``:`none`);let a=y(`btnDeleteRow`);a&&(a.style.display=t?``:`none`);let o=y(`btnUndo`);o&&(o.style.display=t?``:`none`),t||et(!1);let s=y(`toggleBulk`);s&&(s.disabled=!t),$e();let c=y(`fpsDefault`);c&&(c.disabled=!t);let l=y(`f_director_new`);l&&(l.disabled=!T());let u=y(`btnAddDirectorFB`);u&&(u.disabled=!T());let d=y(`f_comment_new`);d&&(d.disabled=n||!j);let f=y(`btnAddComment`);f&&(f.disabled=n||!j);let p=y(`f_reference`);p&&(p.disabled=!j);let ee=y(`f_reference_shared`);ee&&(ee.disabled=!j),[`f_len`,`f_status`,`f_note`,`f_in`,`f_out`].forEach(e=>{let t=y(e);t&&(t.disabled=n)});let m=y(`statusList`);m&&m.querySelectorAll(`input, button`).forEach(e=>{e.disabled=!t});let h=y(`btnAddStatus`);h&&(h.disabled=!t);let g=y(`btnSaveStatuses`);if(g&&(g.disabled=!t),V(),Xe)try{L.updateColumnDefinition(`__handle`,{visible:t})}catch{}if(U){let e=L.getRow(U)?.getData?.()||{};J(e.directorLog||[]),Y(e.commentLog||[])}}y(`btnUndo`)?.addEventListener(`click`,()=>{rt().catch(console.error)});async function nt(e,{pushUndo:t=!0}={}){if(!e||e.length===0)return;let n=_(v),r=D();for(let t of e){let e=p(v,`projects`,M,`cues`,t.id);n.update(e,{...t.after,updatedAt:u(),updatedBy:r})}await n.commit(),t&&(B.push(e.map(e=>({id:e.id,before:{...e.before},after:{...e.after}}))),B.length>Ze&&B.shift())}async function rt(){if(!j){b(`ログインしてね`);return}if(!C()){b(`管理者のみ利用できます`);return}let e=B.pop();if(!e){b(`Undoできる操作がありません`);return}let t=_(v),n=D();for(let r of e){let e=p(v,`projects`,M,`cues`,r.id);t.update(e,{...r.before,updatedAt:u(),updatedBy:n})}await t.commit(),b(`Undoしました`),setTimeout(()=>b(``),800)}L.on(`cellEdited`,async e=>{if(!z)try{let t=e.getRow().getData();if(!t?.id)return;if(!j){b(`ログインしてね（保存できない）`);return}let n=e.getField(),r=e.getValue(),i=e.getOldValue?.()??t[n],a=window.__FPS_DEFAULT__||`24`;if(!w(n)){z=!0,e.setValue(i,!0),z=!1,b(`ゲストは監督FBと参考曲のみ編集できます`),setTimeout(()=>b(``),900);return}n===`reference`&&U===t.id&&q(r??``);let o=L.getSelectedRows().map(e=>e.getData()).filter(e=>e?.id),s=R&&o.length>=2&&Qe.has(n),c=n===`in`||n===`out`;if(s){z=!0;let e=o.map(e=>{let o={[n]:e.id===t.id?i:e[n]??``},s={[n]:r};if(c){let t=Z(n===`in`?r:e.in||``,n===`out`?r:e.out||``,a);o.interval=e.interval??``,s.interval=t}return{id:e.id,before:o,after:s}});o.forEach(e=>{if(e.id===t.id)return;let i=L.getRow(e.id);if(i?.getCell(n)?.setValue(r,!0),c){let t=Z(n===`in`?r:e.in||``,n===`out`?r:e.out||``,a);i?.getCell(`interval`)?.setValue(t,!0)}}),z=!1,await nt(e,{pushUndo:!0}),b(`一括反映しました（${o.length}行）`),setTimeout(()=>b(``),900);return}let l={[n]:i},u={[n]:r};if(c){let e=Z(n===`in`?r:t.in||``,n===`out`?r:t.out||``,a);l.interval=t.interval??``,u.interval=e,L.getRow(t.id)?.getCell(`interval`)?.setValue(e,!0)}await nt([{id:t.id,before:l,after:u}],{pushUndo:!0}),b(`保存しました`),setTimeout(()=>b(``),800)}catch(e){console.error(e),b(`保存エラー: ${e.code||e.message}`)}});function it(){let e=L?.getData?.()||[],t=0;for(let n of e){let e=parseInt((n.m??n.M??n[`#M`]??``).toString(),10);Number.isNaN(e)||(t=Math.max(t,e))}return String(t+1)}var U=null,at=[`f_m`,`f_v`,`f_demo`,`f_scene`,`f_director_new`,`f_comment_new`,`f_reference_shared`,`f_reference`,`f_status`,`f_len`,`f_note`,`f_in`,`f_out`];function ot(e){at.forEach(t=>{let n=y(t);n&&(n.disabled=!e)});let t=y(`f_interval`);t&&(t.disabled=!0)}ot(!1);function W(e){let t=y(`f_director_new`),n=y(`btnAddDirectorFB`),r=y(`f_comment_new`),i=y(`btnAddComment`);if(!e){U=null,ot(!1),y(`selMeta`)&&(y(`selMeta`).textContent=`先に行を選択してね`,y(`selMeta`).classList.add(`selMetaEmpty`)),J([]),Y([]),t&&(t.value=``,t.disabled=!0),n&&(n.disabled=!0),r&&(r.value=``,r.disabled=!0),i&&(i.disabled=!0),y(`f_m`)&&(y(`f_m`).value=``),y(`f_v`)&&(y(`f_v`).value=``),y(`f_demo`)&&(y(`f_demo`).value=``),y(`f_scene`)&&(y(`f_scene`).value=``),y(`f_status`)&&(y(`f_status`).value=``),y(`f_len`)&&(y(`f_len`).value=``),y(`f_note`)&&(y(`f_note`).value=``),q(``),y(`f_in`).value=``,y(`f_out`).value=``,y(`f_interval`).value=``;return}ot(!0),t&&(t.disabled=!T()),n&&(n.disabled=!T()),r&&(r.disabled=!E()),i&&(i.disabled=!E());let a=e.getData();if(U=a.id,y(`selMeta`)){let e=[];a.m!=null&&String(a.m).trim()!==``&&e.push(`#M ${a.m}`),a.demo&&e.push(String(a.demo).trim());let t=e.length?e.join(` / `):`選択中の行`;y(`selMeta`).textContent=`選択中: ${t}`,y(`selMeta`).classList.remove(`selMetaEmpty`)}y(`f_m`)&&(y(`f_m`).value=a.m??``),y(`f_v`)&&(y(`f_v`).value=a.v??``),y(`f_demo`)&&(y(`f_demo`).value=a.demo??``),y(`f_scene`)&&(y(`f_scene`).value=a.scene??``),y(`f_status`).value=a.status??``,y(`f_len`).value=a.len??``,y(`f_note`).value=a.note??``,q(a.reference??``),y(`f_in`).value=a.in??``,y(`f_out`).value=a.out??``;let o=window.__FPS_DEFAULT__||`24`;y(`f_interval`).value=a.interval??Z(a.in||``,a.out||``,o),J(a.directorLog||[]),Y(a.commentLog||[]),t&&(t.value=a.director||``),r&&(r.value=a.comment||``)}var st=Array.from(document.querySelectorAll(`.insTab`)),ct=Array.from(document.querySelectorAll(`.insTabPanel`));function lt(e,{persist:t=!0}={}){if(!e)return;let n=!1;st.forEach(t=>{let r=t.dataset.tab===e;r&&(n=!0),t.classList.toggle(`is-active`,r)}),ct.forEach(t=>{let n=t.dataset.tab===e;t.classList.toggle(`is-active`,n)}),n&&t&&localStorage.setItem(`inspectorTab`,e)}document.addEventListener(`click`,e=>{let t=e.target?.closest?.(`.insTab`);if(!t)return;let n=t.dataset.tab;lt(n)});var ut=localStorage.getItem(`inspectorTab`);ut&&lt(ut,{persist:!1});function dt(e){let t=String(e||``).match(/https?:\/\/[^\s<>"']+/g);return t?[...new Set(t)]:[]}function G(e){try{let t=new URL(e);if(t.hostname===`youtu.be`)return t.pathname.slice(1)||null;if(t.hostname.includes(`youtube.com`)){let e=t.searchParams.get(`v`);if(e)return e;let n=t.pathname.match(/\/shorts\/([^\/]+)/);if(n)return n[1];let r=t.pathname.match(/\/embed\/([^\/]+)/);if(r)return r[1]}}catch{}return null}function ft(e){let t=dt(e).slice(0,4);return t.length===0?``:`<div class="linkPreviewGrid">${t.map(e=>{let t=G(e);return t?`
        <a class="linkCard" href="${e}" target="_blank" rel="noopener">
          <img class="linkThumb" src="${`https://img.youtube.com/vi/${t}/hqdefault.jpg`}" loading="lazy" alt="YouTube">
          <div class="linkMeta">
            <div class="linkTitle">YouTube</div>
            <div class="linkUrl">${X(e)}</div>
          </div>
        </a>`:`
      <a class="linkCard" href="${e}" target="_blank" rel="noopener">
        <div class="linkMeta">
          <div class="linkTitle">リンク</div>
          <div class="linkUrl">${X(e)}</div>
        </div>
      </a>`}).join(``)}</div>`}var pt=new Map,K=new Set;function mt(e){let t=String(e||``).trim();if(!t)return``;try{return new URL(t).toString()}catch{return t}}function ht(e){if(G(e))return`YouTube`;try{let t=new URL(e).hostname.replace(/^www\./,``);return t.includes(`spotify.com`)?`Spotify`:t.includes(`music.apple.com`)?`Apple Music`:t||`Link`}catch{return`Link`}}async function gt(e){let t=encodeURIComponent(e),n=G(e),r=/spotify\.com/i.test(e),i=/music\.apple\.com/i.test(e),a=``;if(n?a=`https://www.youtube.com/oembed?format=json&url=${t}`:r?a=`https://open.spotify.com/oembed?url=${t}`:i&&(a=`https://embed.music.apple.com/oembed?url=${t}`),!a)return``;let o=await fetch(a);if(!o.ok)return``;let s=await o.json().catch(()=>null);return s&&s.title?String(s.title).trim():``}function _t(e,t,n){return`<a class="linkMini" href="${t}" target="_blank" rel="noopener">${X(`${ht(t)}: ${n?k(n,30):k(t||e,34)}`)}</a>`}function vt(e,t,n){let r=String(e.getValue()||``).trim();if(!r)return``;let i=dt(r)[0]||``;if(!i)return`<span class="muted">${X(k(r,34))}</span>`;let a=mt(i),o=pt.has(a),s=o?pt.get(a):``;if(!o&&!K.has(a)){K.add(a);let t=r;n(()=>{gt(a).then(n=>{if(K.delete(a),pt.set(a,n||``),String(e.getValue()||``).trim()!==t||!n)return;let r=e.getElement();r&&(r.innerHTML=_t(t,a,n))}).catch(()=>{K.delete(a)})})}return _t(r,a,s||``)}function yt(e,t=y(`referencePreview`)){if(!t)return;let n=String(e||``).trim(),r=dt(n);if(!n){t.innerHTML=`<div class="muted">YouTubeリンクを入れるとプレビューできます</div>`;return}if(r.length===0){t.innerHTML=`<div class="muted">${X(n)}</div>`;return}let i=r.find(e=>G(e));if(i){t.innerHTML=`<iframe src="https://www.youtube.com/embed/${G(i)}" title="YouTube preview" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>`;return}t.innerHTML=`<a href="${r[0]}" target="_blank" rel="noopener">リンクを開く</a>`}function bt(e){yt(e,y(`referencePreview`)),yt(e,y(`referencePreviewShared`))}function q(e,t){let n=e??``,r=y(`f_reference`),i=y(`f_reference_shared`);r&&r.id!==t&&(r.value=n),i&&i.id!==t&&(i.value=n),bt(n)}function J(e){let t=document.getElementById(`directorLog`),n=document.getElementById(`showDirectorArchived`)?.checked,r=U?L.getRow(U)?.getData?.():{},i=r?.v?String(r.v).trim():``;if(!t)return;let o=Array.isArray(e)?e.slice():[],s=n?o:o.filter(e=>!(e?.archived||e?.archivedAt));if(s.length===0){t.innerHTML=`<div class="muted">まだFBはありません</div>`,t.onclick=null;return}let c=s.sort((e,t)=>(e?.at?.seconds||0)-(t?.at?.seconds||0)),l=T();if(t.innerHTML=c.map((e,t)=>{let n=e.by||``,r=e.at?.toDate?e.at.toDate():null,a=r?r.toLocaleString():``,o=e.text||``,s=(e?.v==null?``:String(e.v).trim())||i,c=!!e.archived||!!e.archivedAt,u=c?`restoreDirector`:`archiveDirector`,d=c?`戻す`:`アーカイブ`,f=[];s&&f.push(`V:${X(s)}`),a&&f.push(a),n&&f.push(X(n));let p=l?`
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="smallBtn" type="button" data-act="${u}" data-idx="${t}">${d}</button>
            <button class="smallBtn danger" type="button" data-act="deleteDirector" data-idx="${t}">消去</button>
          </div>
        `:``;return`
        <div class="logItem">
          <div class="logMeta">${f.join(` / `)}${c?` <span class="muted">（アーカイブ）</span>`:``}</div>
          <div class="logText">${X(o)}</div>
          ${ft(o)}
          ${p}
        </div>
      `}).join(``),!l){t.onclick=null;return}t.onclick=async e=>{let t=e.target?.closest(`button[data-act]`);if(!t||!j||!U)return;let n=Number(t.dataset.idx),r=t.dataset.act,i=L.getRow(U)?.getData?.()||{},o=Array.isArray(i.directorLog)?i.directorLog.slice():[],s=c[n];if(!s)return;let l=o.findIndex(e=>(e?.text||``)===(s.text||``)&&(e?.by||``)===(s.by||``)&&(e?.at?.seconds||0)===(s.at?.seconds||0));if(!(l<0)){if(r===`deleteDirector`){if(!confirm(`このFBを消去しますか？`))return;o.splice(l,1)}else{let e=r===`archiveDirector`;o[l]={...o[l],archived:e,archivedAt:e?g.now():null,archivedBy:e?D():null}}try{await a(p(v,`projects`,M,`cues`,U),{directorLog:o,updatedAt:u(),updatedBy:D()}),L.updateData([{id:U,directorLog:o}]),J(o)}catch(e){console.error(e),b(`${r===`deleteDirector`?`消去`:r===`archiveDirector`?`アーカイブ`:`復帰`}失敗: ${e.code||e.message}`)}}}}function Y(e){let t=document.getElementById(`commentLog`),n=document.getElementById(`showCommentArchived`)?.checked,r=U?L.getRow(U)?.getData?.():{},i=r?.v?String(r.v).trim():``;if(!t)return;let o=Array.isArray(e)?e.slice():[],s=n?o:o.filter(e=>!(e?.archived||e?.archivedAt));if(s.length===0){t.innerHTML=`<div class="muted">まだコメントはありません</div>`,t.onclick=null;return}let c=s.sort((e,t)=>(e?.at?.seconds||0)-(t?.at?.seconds||0)),l=E();if(t.innerHTML=c.map((e,t)=>{let n=e.by||``,r=e.at?.toDate?e.at.toDate():null,a=r?r.toLocaleString():``,o=e.text||``,s=(e?.v==null?``:String(e.v).trim())||i,c=!!e.archived||!!e.archivedAt,u=c?`restoreComment`:`archiveComment`,d=c?`戻す`:`アーカイブ`,f=[];s&&f.push(`V:${X(s)}`),a&&f.push(a),n&&f.push(X(n));let p=l?`
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="smallBtn" type="button" data-act="${u}" data-idx="${t}">${d}</button>
            <button class="smallBtn danger" type="button" data-act="deleteComment" data-idx="${t}">消去</button>
          </div>
        `:``;return`
        <div class="logItem">
          <div class="logMeta">${f.join(` / `)}${c?` <span class="muted">（アーカイブ）</span>`:``}</div>
          <div class="logText">${X(o)}</div>
          ${ft(o)}
          ${p}
        </div>
      `}).join(``),!l){t.onclick=null;return}t.onclick=async e=>{let t=e.target?.closest(`button[data-act]`);if(!t||!j||!U)return;let n=Number(t.dataset.idx),r=t.dataset.act,i=L.getRow(U)?.getData?.()||{},o=Array.isArray(i.commentLog)?i.commentLog.slice():[],s=c[n];if(!s)return;let l=o.findIndex(e=>(e?.text||``)===(s.text||``)&&(e?.by||``)===(s.by||``)&&(e?.at?.seconds||0)===(s.at?.seconds||0));if(!(l<0)){if(r===`deleteComment`){if(!confirm(`このコメントを消去しますか？`))return;o.splice(l,1)}else{let e=r===`archiveComment`;o[l]={...o[l],archived:e,archivedAt:e?g.now():null,archivedBy:e?D():null}}try{await a(p(v,`projects`,M,`cues`,U),{commentLog:o,updatedAt:u(),updatedBy:D()}),L.updateData([{id:U,commentLog:o}]),Y(o)}catch(e){console.error(e),b(`${r===`deleteComment`?`消去`:r===`archiveComment`?`アーカイブ`:`復帰`}失敗: ${e.code||e.message}`)}}}}function X(e){return String(e).replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#039;`)}function xt(e,t){let n=String(e||``).trim().match(/^(\d{2}):(\d{2}):(\d{2}):(\d{2})$/);if(!n)return null;let[r,i,a,o,s]=n,c=Number(String(t||`24`).trim());return!c||Number.isNaN(c)?null:{frames:(Number(i)*3600+Number(a)*60+Number(o))*c+Number(s),fps:c}}function St(e,t){let n=Number(String(t||`24`).trim());if(!n||Number.isNaN(n))return``;let r=e<0?`-`:``;e=Math.abs(e);let i=Math.floor(e/n),a=e%n,o=Math.floor(i/3600),s=Math.floor(i%3600/60),c=i%60,l=e=>String(e).padStart(2,`0`);return`${r}${l(o)}:${l(s)}:${l(c)}:${l(a)}`}function Z(e,t,n){let r=xt(e,n),i=xt(t,n);return!r||!i?``:St(i.frames-r.frames,n)}L.on(`rowClick`,(e,t)=>{let n=navigator.platform.toLowerCase().includes(`mac`);e.shiftKey||(n?e.metaKey:e.ctrlKey)||L.deselectRow(),t.select(),W(t)}),document.addEventListener(`mousedown`,e=>{let t=e.target.closest(`#grid`),n=e.target.closest(`#inspector`),r=e.target.closest(`button, input, select, textarea, a, .cardHead, .modal`);!t&&!n&&!r&&(L.deselectRow(),W(null))});var Ct=!1;L.on(`rowMoved`,async()=>{if(!(!j||!C())&&!Ct){Ct=!0;try{await Tt(),b(`並び替えを保存しました`),setTimeout(()=>b(``),800)}catch(e){console.error(e),b(`並び替え保存失敗: ${e.code||e.message}`)}finally{Ct=!1}}});function wt(e){N&&N();let t=!0;M=e,Be(e),Ue(e),N=s(ee(m(v,`projects`,e,`cues`),c(`m`)),e=>{let n=[],r=null,i=``;if(e.forEach(e=>{let t={id:e.id,...e.data()};t.nextSchedule=F.get(e.id)||null,n.push(t);let a=t.updatedAt;O(a)>O(r)&&(r=a,i=t.updatedBy||``)}),L.replaceData(n),n.length===0&&W(null),r&&(de=r,fe=i,_e()),P){let e=L.getRow(P);e&&(e.select(),W(e),P=null)}else if(t&&n.length>0){let e=L.getRow(n[0].id);e&&(e.select(),W(e))}t&&=!1,b(``)},e=>{console.error(e),b(`同期エラー: ${e.code||e.message}`)})}y(`btnLogin`).onclick=async()=>{try{await e(ae,oe)}catch(e){console.error(e),b(`ログイン失敗: ${e.code||e.message}`)}},y(`btnLogout`).onclick=async()=>{await te(ae)},r(ae,async e=>{async function t(e){if(!e?.uid)return;let t=p(v,`users`,e.uid),n=await h(t),r=e.email||``,i=r.trim().toLowerCase();n.exists()?await a(t,{lastSeenAt:u(),email:r,emailNorm:i,displayName:e.displayName||null,photoURL:e.photoURL||null}):await l(t,{email:r,emailNorm:i,displayName:e.displayName||null,photoURL:e.photoURL||null,status:`active`,roleGlobal:`user`,plan:`free`,subscriptionStatus:`inactive`,createdAt:u(),lastSeenAt:u()})}if(await t(e),j=e,e){y(`userPill`).textContent=e.email||e.uid,y(`btnLogin`).style.display=`none`,y(`btnLogout`).style.display=`inline-block`;let t=y(`projectId`).value.trim();if(!await Oe(t,e)){b(`このプロジェクトの閲覧権限がありません`),location.replace(se);return}Je||(Je=!0,(async()=>{if(t)try{let e=await h(p(v,`projects`,t)),n=e.exists()&&e.data().name||t,r=document.getElementById(`projectNamePill`);r&&(r.textContent=n);let i=document.getElementById(`sheetTitle`);i&&(i.textContent=n),document.title=`Music Sheet | ${n}`}catch(e){console.warn(e)}})()),wt(t)}else y(`userPill`).textContent=`未ログイン`,y(`btnLogin`).style.display=`inline-block`,y(`btnLogout`).style.display=`none`,N&&N(),L.replaceData([]),W(null);H()}),y(`btnAddRow`).onclick=async()=>{if(!j){b(`ログインしてね`);return}if(!C()){b(`管理者のみ追加できます`);return}try{let e=it();P=(await f(m(v,`projects`,M,`cues`),{m:e,v:``,demo:``,status:``,scene:``,len:``,reference:``,in:``,out:``,interval:``,note:``,createdAt:u(),createdBy:D(),updatedAt:u(),updatedBy:D()})).id,b(`行を追加しました`)}catch(e){console.error(e),b(`追加失敗: ${e.code||e.message}`)}};async function Tt(){if(!j)return;let e=L.getRows(),t=_(v);e.forEach((e,n)=>{let r=e.getData();t.update(p(v,`projects`,M,`cues`,r.id),{m:String(n+1),updatedAt:u(),updatedBy:D()})}),await t.commit()}y(`btnDeleteRow`)?.addEventListener(`click`,async e=>{if(e.preventDefault(),!j){b(`ログインしてね`);return}if(!C()){b(`管理者のみ削除できます`);return}let t=(L.getSelectedRows?.()||[]).map(e=>e.getData?.()?.id).filter(Boolean);if(t.length===0&&U&&t.push(U),t.length===0){b(`削除する行を選択してね`);return}if(t.length===1){let e=L.getRow(t[0])?.getData?.()||{};if(!confirm(`#M ${e.m||``} を削除する？`))return}else if(!confirm(`選択中の${t.length}行を削除する？`))return;try{let e=_(v);t.forEach(t=>{e.delete(p(v,`projects`,M,`cues`,t))}),await e.commit(),U&&t.includes(U)&&(U=null,W(null)),b(t.length>1?`削除しました（${t.length}行）`:`削除しました`),setTimeout(()=>b(``),900)}catch(e){console.error(e),b(`削除失敗: ${e.code||e.message}`)}});var Et={};function Q(e,t){U&&(j&&!C()&&![`reference`].includes(e)||(Et[e]&&clearTimeout(Et[e]),Et[e]=setTimeout(()=>{let n={[e]:t,updatedAt:u(),updatedBy:D()};if(e===`in`||e===`out`){let r=L.getRow(U)?.getData?.()||{},i=Z(e===`in`?t:r.in||``,e===`out`?t:r.out||``,window.__FPS_DEFAULT__||`24`);n.interval=i;let a=y(`f_interval`);a&&(a.value=i)}a(p(v,`projects`,M,`cues`,U),n).then(()=>{b(`自動保存しました`),setTimeout(()=>b(``),1200)}).catch(e=>{console.error(e),b(`自動保存エラー: ${e.code||e.message}`)})},750)))}for(let[e,t]of Object.entries({f_director_new:`director`,f_comment_new:`comment`,f_status:`status`,f_len:`len`,f_note:`note`,f_in:`in`,f_out:`out`})){let n=y(e);if(!n)continue;let r=n.tagName===`SELECT`?`change`:`input`;n.addEventListener(r,e=>{Q(t,e.target.value)})}var Dt=y(`f_reference`),Ot=y(`f_reference_shared`),kt=e=>{let t=e.target.value;q(t,e.target.id),Q(`reference`,t)};Dt&&Dt.addEventListener(`input`,kt),Ot&&Ot.addEventListener(`input`,kt);var At=y(`btnSaveDetail`);At&&(At.style.display=`none`),y(`btnAddDirectorFB`)?.addEventListener(`click`,async()=>{if(!j){b(`ログインしてね`);return}if(!T()){b(`ゲストは監督FBと参考曲のみ編集できます`);return}if(!U){b(`行を選択してね`);return}let e=(y(`f_director_new`)?.value||``).trim();if(!e){b(`追加するFBを入力してね`);return}let t=D(),n=p(v,`projects`,M,`cues`,U),r=L.getRow(U)?.getData?.()||{},i=Array.isArray(r.directorLog)?r.directorLog.slice():[],o=r?.v==null?``:String(r.v).trim(),s={text:e,at:g.now(),by:t,archived:!1};o&&(s.v=o),i.push(s);try{await a(n,{directorLog:i,updatedAt:u(),updatedBy:t}),L.updateData([{id:U,directorLog:i}]),J(i),y(`f_director_new`).value=``,b(`FBを追加しました`),setTimeout(()=>b(``),900)}catch(e){console.error(e),b(`FBの追加に失敗: ${e.code||e.message}`)}}),y(`btnAddComment`)?.addEventListener(`click`,async()=>{if(!j){b(`ログインしてね`);return}if(!E()){b(`コメントは管理者のみ編集できます`);return}if(!U){b(`行を選択してね`);return}let e=(y(`f_comment_new`)?.value||``).trim();if(!e){b(`追加するコメントを入力してね`);return}let t=p(v,`projects`,M,`cues`,U),n=L.getRow(U)?.getData?.()||{},r=Array.isArray(n.commentLog)?n.commentLog.slice():[],i=n?.v==null?``:String(n.v).trim(),o={text:e,at:g.now(),by:D(),archived:!1};i&&(o.v=i),r.push(o);try{await a(t,{commentLog:r,updatedAt:u(),updatedBy:D()}),L.updateData([{id:U,commentLog:r}]),Y(r),y(`f_comment_new`).value=``,b(`コメントを追加しました`),setTimeout(()=>b(``),900)}catch(e){console.error(e),b(`コメントの追加に失敗: ${e.code||e.message}`)}}),document.getElementById(`showDirectorArchived`)?.addEventListener(`change`,()=>{J((U?L.getRow(U):null)?.getData?.().directorLog||[])}),document.getElementById(`showCommentArchived`)?.addEventListener(`change`,()=>{Y((U?L.getRow(U):null)?.getData?.().commentLog||[])});var jt=document.getElementById(`divider`),Mt=!1,$=(localStorage.getItem(`inspectorOpen`)||`0`)===`1`,Nt=Number(localStorage.getItem(`inspectorWidth`)||`420`);function Pt(){let e=document.querySelector(`.layout`);if(e){if(!$)e.classList.add(`inspectorClosed`),y(`btnToggleInspector`).textContent=`詳細を開く`;else{e.classList.remove(`inspectorClosed`);let t=Math.min(560,Math.max(320,Nt));e.style.gridTemplateColumns=`1fr 10px ${t}px`,y(`btnToggleInspector`).textContent=`詳細を閉じる`}localStorage.setItem(`inspectorOpen`,$?`1`:`0`),localStorage.setItem(`inspectorWidth`,String(Nt))}}y(`btnToggleInspector`)?.addEventListener(`click`,()=>{$=!$,Pt()}),Pt(),jt?.addEventListener(`mousedown`,()=>{$&&(Mt=!0)}),window.addEventListener(`mouseup`,()=>{Mt=!1}),window.addEventListener(`mousemove`,e=>{if(!Mt||!$)return;let t=Math.min(560,Math.max(320,window.innerWidth-e.clientX-12));Nt=t,document.querySelector(`.layout`).style.gridTemplateColumns=`1fr 10px ${t}px`,localStorage.setItem(`inspectorWidth`,String(Nt))}),window.addEventListener(`keydown`,e=>{let t=navigator.platform.toLowerCase().includes(`mac`)?e.metaKey:e.ctrlKey;t&&e.key.toLowerCase()===`s`&&e.preventDefault(),t&&e.key.toLowerCase()===`n`&&(e.preventDefault(),document.getElementById(`btnAddRow`)?.click()),t&&e.key.toLowerCase()===`z`&&(e.preventDefault(),rt().catch(console.error))});function Ft(){let e=(y(`q`)?.value||``).trim().toLowerCase(),t=y(`statusFilter`)?.value||``;L.clearFilter(!0),L.setFilter(n=>t&&n.status!==t?!1:e?[n.scene,n.demo,n.status,n.len,n.director,n.memo,n.reference,n.in,n.out].join(` `).toLowerCase().includes(e):!0)}y(`q`)?.addEventListener(`input`,Ft),y(`statusFilter`)?.addEventListener(`change`,Ft),y(`fpsDefault`)?.addEventListener(`change`,async()=>{if(!j){b(`ログインしてね`);return}if(!C()){b(`管理者のみ変更できます`);return}let e=p(v,`projects`,M,`settings`,`ui`),t=y(`fpsDefault`).value;window.__FPS_DEFAULT__=t,await l(e,{fpsDefault:t,updatedAt:u(),updatedBy:D()},{merge:!0}),b(`FPSを保存しました`),setTimeout(()=>b(``),900)}),y(`btnSettings`)?.addEventListener(`click`,Ie),y(`btnCloseStatus`)?.addEventListener(`click`,Le),y(`overlay`)?.addEventListener(`click`,Le),y(`btnAddStatus`)?.addEventListener(`click`,()=>{C()&&(A.push({value:`new`,label:`new`,color:`#a78bfa`}),Re())}),y(`btnSaveStatuses`)?.addEventListener(`click`,async()=>{if(!j){b(`ログインしてね`);return}if(!C()){b(`管理者のみ変更できます`);return}await ze()}),y(`f_status`)?.addEventListener(`change`,()=>{We(),Q(`status`,y(`f_status`).value)}),y(`f_len`)?.addEventListener(`change`,()=>Q(`len`,y(`f_len`).value)),y(`f_note`)?.addEventListener(`input`,()=>Q(`note`,y(`f_note`).value)),y(`f_in`)?.addEventListener(`input`,()=>Q(`in`,y(`f_in`).value)),y(`f_out`)?.addEventListener(`input`,()=>Q(`out`,y(`f_out`).value)),document.getElementById(`f_reference`)?.addEventListener(`input`,e=>{let t=e.target?.value||``;q(t,`f_reference`),Q(`reference`,t)}),document.getElementById(`f_reference_shared`)?.addEventListener(`input`,e=>{let t=e.target?.value||``;q(t,`f_reference_shared`),Q(`reference`,t)});