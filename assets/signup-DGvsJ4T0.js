import{a as e,n as t,o as n,r,t as i}from"./firebase-DUzmoriO.js";import{C as a,S as o,c as s,h as c,i as l,m as u,o as d,p as f,s as p,v as m,w as h}from"./index.esm-BYm7NlOb.js";import{i as g,t as _}from"./nav-B79d_qBo.js";var v=`/music-sheet/`,y=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean),b=`member`,x=document.getElementById(`userPill`),S=document.getElementById(`btnLogin`),C=document.getElementById(`btnLogout`),w=document.getElementById(`btnNewProject`),T=document.getElementById(`accountLink`),E=document.getElementById(`adminLink`),D=document.getElementById(`inviteMsg`),O=document.getElementById(`inviteList`),k={metaDescription:`アカウント作成とログインのページです。`,lead:`ログインしてアカウントを作成します。招待されたプロジェクトは下に表示されます。`,notLoggedIn:`未ログイン`,login:`Googleでログイン`,logout:`ログアウト`,account:`アカウント管理へ`,admin:`サービス管理へ`,inviteTitle:`参加中のプロジェクト`,loginHint:`ログインすると招待されたプロジェクトが表示されます。`,emailMissing:`メールアドレスが取得できませんでした。`,loading:`読み込み中...`,inviteLoadFail:`招待一覧の読み込みに失敗しました。ログイン状態や権限を確認してください。`,noInvites:`招待中のプロジェクトはありません。`,inviteLoadFailShort:`招待一覧の読み込みに失敗しました。`,noProjects:`参照できるプロジェクトがありません。`,statusJoined:`参加済み`,statusInvite:`招待中`,noteJoin:`参加するを押すと入室できます`,join:`参加する`,joining:`参加中...`,joinFail:`参加に失敗しました: `,newProject:`新しいプロジェクト名を入力してください`,creatingProject:`プロジェクトを作成中...`,projectCreated:`プロジェクトを作成しました`,createProjectFail:`プロジェクトの作成に失敗しました: `},A=null,j=e=>{D&&(D.textContent=e||``)},M=e=>String(e||``).trim().toLowerCase();function N(){let e=document.querySelector(`meta[name="description"]`);e&&e.setAttribute(`content`,k.metaDescription);let t=document.querySelector(`.lead`);t&&(t.textContent=k.lead),S&&(S.textContent=k.login),C&&(C.textContent=k.logout),T&&(T.textContent=k.account),E&&(E.textContent=k.admin);let n=document.getElementById(`inviteTitle`);n&&(n.textContent=k.inviteTitle),x&&(x.textContent=k.notLoggedIn)}N();async function P(e){if(!e)return[];let t=await s(f(l(r,`members`),m(`uid`,`==`,e))),n=[];return t.forEach(e=>{let t=e.ref.parent.parent.id;n.push(t)}),[...new Set(n)]}async function F(e){let t=M(e);if(!t)return[];let n=new Map,i=e=>{let t=e.data()||{};if(t.usedBy!=null)return;let r=e.ref.parent.parent?.id;if(!r)return;let i=`${r}:${e.id}`;n.set(i,{inviteId:e.id,projectId:r,projectName:t.projectName||``,role:t.role||b})},a=null;try{a=await s(f(l(r,`invites`),m(`emailLower`,`==`,t),m(`usedBy`,`==`,null)))}catch(e){if(e?.code!==`failed-precondition`)throw e;a=await s(f(l(r,`invites`),m(`emailLower`,`==`,t)))}return a.docs.forEach(i),[...n.values()]}g();var I=e=>!!e?.email&&y.includes(e.email);S?.addEventListener(`click`,async()=>{await a(i,e)}),C?.addEventListener(`click`,async()=>{await h(i)}),w?.addEventListener(`click`,async()=>{if(!A){j(`ログインしてください`);return}let e=prompt(k.newProject);if(!e||!e.trim())return;w.disabled=!0;let n=D.textContent;j(k.creatingProject);try{await t({name:e,user:A}),j(k.projectCreated),await R(A)}catch(e){console.error(e),e?.code===`plan-limit`?j(`無料プランではプロジェクトは2件までです。`):j(k.createProjectFail+(e.code||e.message))}finally{w.disabled=!1,setTimeout(()=>{(D.textContent===k.creatingProject||D.textContent===k.projectCreated)&&j(n)},2e3)}}),o(i,async e=>{if(A=e,await n(e),_({current:`signup`,hideAdmin:!I(e)}),x&&(x.textContent=e?.email||k.notLoggedIn),S&&(S.style.display=e?`none`:`inline-flex`),C&&(C.style.display=e?`inline-flex`:`none`),w&&(w.style.display=e?`inline-flex`:`none`),T&&(T.style.display=e?`inline-flex`:`none`),E&&(E.style.display=I(e)?`inline-flex`:`none`),!e){j(k.loginHint),O&&(O.innerHTML=``),w&&(w.style.display=`none`),T&&(T.style.display=`none`),E&&(E.style.display=`none`);return}await R(e)});async function L(e,t){return e.length?(await Promise.all(e.map(async e=>{if(I(t))try{let t=await p(d(r,`projects`,e));if(!t.exists())return null;let n=t.data()||{};return n.deleted?null:{id:e,name:String(n.name||n.projectName||n.title||e).trim()||e,registered:!0}}catch(t){return console.warn(`project doc read failed`,t),{id:e,name:e,registered:!0}}try{let t=await p(d(r,`projects`,e));if(!t.exists())return null;let n=t.data()||{};return n.deleted?null:{id:e,name:String(n.name||n.projectName||n.title||e).trim()||e,registered:!0}}catch(t){return t?.code!==`permission-denied`&&console.warn(`project doc read failed`,t),{id:e,name:e,registered:!1}}}))).filter(Boolean):[]}async function R(e){let t=M(e?.email||``),n=e?.uid||``;if(!t||!n){j(k.emailMissing);return}j(k.loading);let i=[],a=[],o=!1;try{i=await P(n)}catch(e){e?.code===`permission-denied`&&(o=!0),console.warn(`member project list failed`,e)}try{a=await F(t)}catch(e){e?.code===`permission-denied`&&(o=!0),console.warn(`invite collectionGroup read failed`,e)}let s=new Set(i),l=a.filter(e=>!s.has(e.projectId)),f=[...new Set([...i,...l.map(e=>e.projectId)])];if(!f.length){O&&(O.innerHTML=``),j(o?k.inviteLoadFail:k.noProjects);return}let p=await L(f,e),m=new Map(p.map(e=>[e.id,e])),h=i.map(e=>m.get(e)).filter(Boolean),g=l.map(e=>{let t=m.get(e.projectId);return{...e,name:t?.name||e.projectName||e.projectId,registered:!!t}}),_=[...h.map(e=>({...e,type:`member`})),...g.map(e=>({...e,type:`invite`}))];if(_.sort((e,t)=>String(e.name||e.id).localeCompare(String(t.name||t.id))),!_.length){j(o?k.inviteLoadFailShort:k.noProjects),O&&(O.innerHTML=``);return}O&&(O.innerHTML=_.map(e=>{let t=e.type===`member`,n=t?k.statusJoined:k.statusInvite,r=t?`border-brand-200 bg-brand-50 text-brand-700`:`border-slate-200 bg-slate-50 text-slate-600`,i=t?``:`<p class="mt-2 text-xs text-slate-500">${k.noteJoin}</p>`,a=t?``:`<button type="button" class="inline-flex items-center justify-center rounded-full bg-brand-700 px-4 py-2 text-xs font-semibold text-white shadow-sm shadow-brand-600/30 hover:bg-brand-800" data-act="join" data-project="${e.id}" data-invite="${e.inviteId}">${k.join}</button>`,o=t?`<a class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm hover:border-slate-300" data-project="${e.id}" href="${v}portal.html?project=${encodeURIComponent(e.id)}">Portal</a>`:`<span class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-100 px-4 py-2 text-xs font-semibold text-slate-400 cursor-not-allowed" aria-disabled="true">Portal</span>`,s=t?`<a class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm hover:border-slate-300" data-project="${e.id}" href="${v}sheet.html?project=${encodeURIComponent(e.id)}">Music Sheet</a>`:`<span class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-100 px-4 py-2 text-xs font-semibold text-slate-400 cursor-not-allowed" aria-disabled="true">Music Sheet</span>`;return`
        <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-md shadow-slate-200/50">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-semibold text-slate-900">${e.name}</div>
              <div class="mt-2 inline-flex items-center gap-2 text-xs">
                <span class="inline-flex items-center rounded-full border ${r} px-3 py-1 text-xs font-semibold">${n}</span>
              </div>
              ${i}
            </div>
            <div class="text-xs text-slate-400">ID: ${e.id}</div>
          </div>
          <div class="mt-4 flex flex-wrap items-center gap-2">
            ${a}
            ${o}
            ${s}
          </div>
          <div class="mt-3 text-xs text-slate-400">project: ${e.id}</div>
        </div>
      `}).join(``),O.onclick=async i=>{let a=i.target,o=a?.closest?.(`button[data-act='join']`);if(o){let i=o.getAttribute(`data-project`)||``,a=o.getAttribute(`data-invite`)||``;if(!i||!a)return;o.disabled=!0;let s=o.textContent;o.textContent=k.joining;try{await u(r,async o=>{let s=d(r,`projects`,i,`members`,n),l=d(r,`projects`,i,`invites`,a),u=await o.get(l);if(!u.exists()){let e=Error(`invite-missing`);throw e.code=`invite-missing`,e}let f=u.data()||{},p=M(f.emailLower);if(!p||p!==t){let e=Error(`invite-email-mismatch`);throw e.code=`invite-email-mismatch`,e}if(f.usedBy!=null){let e=Error(`invite-used`);throw e.code=`invite-used`,e}if((await o.get(s)).exists()){let e=Error(`already-member`);throw e.code=`already-member`,e}o.set(s,{uid:n,role:f.role||b,email:e?.email||null,displayName:e?.displayName||null,joinedAt:c(),inviteId:a}),o.update(l,{usedBy:n,usedAt:c()})}),await R(e)}catch(e){console.error(e),j(k.joinFail+(e.code||e.message)),o.disabled=!1,o.textContent=s||k.join}return}let s=a?.closest?.(`a[data-project]`);if(!s)return;let l=s.getAttribute(`data-project`);l&&localStorage.setItem(`lastProject`,l)}),j(``)}