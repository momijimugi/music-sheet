import{a as e,n as t,o as n,r,t as i}from"./firebase-B6LBwd9E.js";import{D as a,E as o,S as s,T as c,_ as l,d as u,f as d,s as f,u as p,v as m,x as h}from"./index.esm-B0-OTnKT.js";import{r as g}from"./ui_common-Bmq5Fv_e.js";var _=`/music-sheet/`,v=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean),y=`member`,b=document.getElementById(`userPill`),x=document.getElementById(`btnLogin`),S=document.getElementById(`btnLogout`),C=document.getElementById(`btnNewProject`),w=document.getElementById(`adminLink`),T=document.getElementById(`inviteMsg`),E=document.getElementById(`inviteList`),D={metaDescription:`音楽制作チーム向けのプロジェクト共有ハブ`,lead:`ようこそ。音楽制作やスケジュールを共有して、プロジェクトを一緒に進めるためのポータルです。`,notLoggedIn:`未ログイン`,login:`Googleでログイン`,logout:`ログアウト`,admin:`管理画面へ`,inviteTitle:`参加中のプロジェクト`,loginHint:`ログインすると招待されたプロジェクトが表示されます。`,emailMissing:`メールアドレスが取得できませんでした。`,loading:`読み込み中...`,inviteLoadFail:`招待一覧の読み込みに失敗しました。ログイン状態や権限を確認してください。`,noInvites:`招待中のプロジェクトはありません。`,inviteLoadFailShort:`招待一覧の読み込みに失敗しました。`,noProjects:`参照できるプロジェクトがありません。`,statusJoined:`参加済み`,statusInvite:`招待中`,noteJoin:`参加するを押すと入室できます`,join:`参加する`,joining:`参加中...`,joinFail:`参加に失敗しました: `,newProject:`新しいプロジェクト名を入力してください`,creatingProject:`プロジェクトを作成中...`,projectCreated:`プロジェクトを作成しました`,createProjectFail:`プロジェクトの作成に失敗しました: `},O=null,k=e=>{T&&(T.textContent=e||``)},A=e=>String(e||``).trim().toLowerCase();function j(){let e=document.querySelector(`meta[name="description"]`);e&&e.setAttribute(`content`,D.metaDescription);let t=document.querySelector(`.lead`);t&&(t.textContent=D.lead),x&&(x.textContent=D.login),S&&(S.textContent=D.logout),w&&(w.textContent=D.admin);let n=document.getElementById(`inviteTitle`);n&&(n.textContent=D.inviteTitle),b&&(b.textContent=D.notLoggedIn)}j();async function M(e){if(!e)return[];let t=await d(l(f(r,`members`),h(`uid`,`==`,e))),n=[];return t.forEach(e=>{let t=e.ref.parent.parent.id;n.push(t)}),[...new Set(n)]}async function N(e){if(!e)return[];let t=new Map;return(await d(l(f(r,`invites`),h(`emailLower`,`==`,e)))).docs.forEach(e=>{let n=e.data()||{};if(n.usedBy!=null)return;let r=e.ref.parent.parent?.id;if(!r)return;let i=`${r}:${e.id}`;t.set(i,{inviteId:e.id,projectId:r,projectName:n.projectName||``,role:n.role||y})}),[...t.values()]}g();var P=e=>!!e?.email&&v.includes(e.email);x?.addEventListener(`click`,async()=>{await o(i,e)}),S?.addEventListener(`click`,async()=>{await a(i)}),C?.addEventListener(`click`,async()=>{if(!O){k(`ログインしてください`);return}let e=prompt(D.newProject);if(!e||!e.trim())return;C.disabled=!0;let n=T.textContent;k(D.creatingProject);try{await t({name:e,user:O}),k(D.projectCreated),await I(O)}catch(e){console.error(e),k(D.createProjectFail+(e.code||e.message))}finally{C.disabled=!1,setTimeout(()=>{(T.textContent===D.creatingProject||T.textContent===D.projectCreated)&&k(n)},2e3)}}),c(i,async e=>{if(O=e,await n(e),b&&(b.textContent=e?.email||D.notLoggedIn),x&&(x.style.display=e?`none`:`inline-flex`),S&&(S.style.display=e?`inline-flex`:`none`),C&&(C.style.display=e?`inline-flex`:`none`),w&&(w.style.display=P(e)?`inline-flex`:`none`),!e){k(D.loginHint),E&&(E.innerHTML=``),C&&(C.style.display=`none`);return}await I(e)});async function F(e,t){return e.length?(await Promise.all(e.map(async e=>{if(P(t))try{let t=await u(p(r,`projects`,e));if(!t.exists())return null;let n=t.data()||{};return n.deleted?null:{id:e,name:String(n.name||n.projectName||n.title||e).trim()||e,registered:!0}}catch(t){return console.warn(`project doc read failed`,t),{id:e,name:e,registered:!0}}try{let t=await u(p(r,`projects`,e));if(!t.exists())return null;let n=t.data()||{};return n.deleted?null:{id:e,name:String(n.name||n.projectName||n.title||e).trim()||e,registered:!0}}catch(t){return t?.code!==`permission-denied`&&console.warn(`project doc read failed`,t),{id:e,name:e,registered:!1}}}))).filter(Boolean):[]}async function I(e){let t=A(e?.email||``),n=e?.uid||``;if(!t||!n){k(D.emailMissing);return}k(D.loading);let i=[],a=[],o=!1;try{i=await M(n)}catch(e){e?.code===`permission-denied`&&(o=!0),console.warn(`member project list failed`,e)}try{a=await N(t)}catch(e){e?.code===`permission-denied`&&(o=!0),console.warn(`invite collectionGroup read failed`,e)}let c=new Set(i),l=a.filter(e=>!c.has(e.projectId)),u=[...new Set([...i,...l.map(e=>e.projectId)])];if(!u.length){E&&(E.innerHTML=``),k(o?D.inviteLoadFail:D.noProjects);return}let d=await F(u,e),f=new Map(d.map(e=>[e.id,e])),h=i.map(e=>f.get(e)).filter(Boolean),g=l.map(e=>{let t=f.get(e.projectId);return{...e,name:t?.name||e.projectName||e.projectId,registered:!!t}}),v=[...h.map(e=>({...e,type:`member`})),...g.map(e=>({...e,type:`invite`}))];if(v.sort((e,t)=>String(e.name||e.id).localeCompare(String(t.name||t.id))),!v.length){k(o?D.inviteLoadFailShort:D.noProjects),E&&(E.innerHTML=``);return}E&&(E.innerHTML=v.map(e=>{let t=e.type===`member`,n=t?D.statusJoined:D.statusInvite,r=t?`ok`:`ng`,i=t?``:`<span class="inviteNote">${D.noteJoin}</span>`,a=t?``:`<button class="btn primary small" data-act="join" data-project="${e.id}" data-invite="${e.inviteId}">${D.join}</button>`,o=t?`<a class="btn ghost" data-project="${e.id}" href="${_}portal.html?project=${encodeURIComponent(e.id)}">Portal</a>`:`<span class="btn ghost disabled" aria-disabled="true">Portal</span>`,s=t?`<a class="btn ghost" data-project="${e.id}" href="${_}sheet.html?project=${encodeURIComponent(e.id)}">Music Sheet</a>`:`<span class="btn ghost disabled" aria-disabled="true">Music Sheet</span>`;return`
        <div class="inviteItem">
          <div class="inviteTitle">${e.name}</div>
          <div class="inviteMeta">
            <span class="inviteStatus ${r}">${n}</span>
            ${i}
          </div>
          <div class="inviteActions">
            ${a}
            ${o}
            ${s}
          </div>
          <div class="inviteHint">project: ${e.id}</div>
        </div>
      `}).join(``),E.onclick=async i=>{let a=i.target,o=a?.closest?.(`button[data-act='join']`);if(o){let i=o.getAttribute(`data-project`)||``,a=o.getAttribute(`data-invite`)||``;if(!i||!a)return;o.disabled=!0;let c=o.textContent;o.textContent=D.joining;try{let o=s(r),c=p(r,`projects`,i,`members`,n),l=p(r,`projects`,i,`invites`,a);o.set(c,{role:y,emailLower:t,joinedAt:m(),uid:n,inviteId:a}),o.update(l,{usedBy:n,usedAt:m()}),await o.commit(),await I(e)}catch(e){console.error(e),k(D.joinFail+(e.code||e.message)),o.disabled=!1,o.textContent=c||D.join}return}let c=a?.closest?.(`a[data-project]`);if(!c)return;let l=c.getAttribute(`data-project`);l&&localStorage.setItem(`lastProject`,l)}),k(``)}