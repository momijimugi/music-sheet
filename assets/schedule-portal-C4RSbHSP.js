import{r as e,t}from"./firebase-DUzmoriO.js";import{S as n,d as r,f as i,g as a,h as o,o as s,p as c,r as l,s as u}from"./index.esm-BYm7NlOb.js";import"./tabulator_esm-7yQEXY9l.js";var d=new URLSearchParams(location.search),f=!0,p=d.get(`theme`),m=d.get(`client`)===`1`||d.get(`client`)===`true`||d.get(`view`)===`client`,h=m,g=d.get(`project`)||``;if(document.querySelectorAll(`[data-embed-hide]`).forEach(e=>{e.style.display=`none`}),!g&&f)try{g=new URL(window.parent.location.href).searchParams.get(`project`)||``}catch{}var _=null,ee=g?`composerScheduleBoard_v10_${g}`:`composerScheduleBoard_v10`,v=g?s(e,`projects`,g,`scheduleBoard`,`state`):null;`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);var te=(()=>{let e=`csb_clientId`,t=sessionStorage.getItem(e);if(t)return t;let n=Math.random().toString(36).slice(2,10)+`_`+Date.now().toString(36);return sessionStorage.setItem(e,n),n})(),y=null,ne=0,re=null,ie=null,ae=new Map,oe=new Map,se=new Map,ce=new Map,le=new Map([{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}].map(e=>[e.value,e])),b=null,ue=null,de=new Map;function fe(e){let t=document.getElementById(`topError`),n=String(e||``);t&&(t.textContent=n),n&&console.warn(`[schedule]`,n)}function pe(){b&&=(b(),null)}function me(){re&&=(re(),null),oe=new Map}function he(){ie&&=(ie(),null),ae.size&&(ae.forEach(e=>e&&e()),ae.clear()),ce=new Map,se.clear()}var ge=null,_e=null,ve=!1,ye=0,be=()=>!!y&&!h,x=[{name:`ä½œæ›²`,color:`#f5576c`},{name:`ã‚¢ãƒ¬ãƒ³ã‚¸`,color:`#84fab0`},{name:`REC`,color:`#ff9a9e`},{name:`MIX`,color:`#a18cd1`},{name:`ãƒã‚¹ã‚¿ãƒªãƒ³ã‚°`,color:`#f6d365`},{name:`æµ„æ›¸`,color:`#fda085`},{name:`ä¿®æ­£`,color:`#f093fb`},{name:`æ‰“ã¡åˆã‚ã›`,color:`#4facfe`}],S=21,xe=`theme`;function C(){let e=localStorage.getItem(xe);return e===`light`||e===`dark`?e:window.matchMedia&&window.matchMedia(`(prefers-color-scheme: light)`).matches?`light`:`dark`}var w=null,T=!1,E=``,D=new Set,O=!1,k=!1,A=null,j=null,M=null,N=null,P=[],F=[],I={},Se={},Ce=null,L={projectId:null,trackId:null},R={trackId:null,date:null},z={type:null,anchorBtn:null},B=`ALL`,we=m,V=[],Te=20,H=je();async function Ee(r){if(pe(),he(),r&&(g=r),y=await new Promise(e=>n(t,e)),y||n(t,e=>{e&&location.reload()}),g){if(y){let e=await Ne();e?H=e:g&&(H=Ze(g))}let t=(H.projects||[]).find(e=>e.id===g)||{id:g,name:g||`ï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]};H.projects=[t],w=g,T=!0;let n=document.getElementById(`addProjectBtn`);n&&(n.style.display=`none`);let r=document.getElementById(`addTrackBtn`);r&&(r.style.display=`none`);let i=document.getElementById(`trackSyncNote`);i&&(i.style.display=`block`);let a=document.getElementById(`showAllBtn`),o=document.getElementById(`showSelectedBtn`);if(a&&(a.style.display=`none`),o&&(o.style.display=`none`),!y)console.warn(`not logged in (schedule)`);else try{let n=await u(s(e,`projects`,g));if(n.exists()){let e=n.data()||{};if(e.deleted){alert(`ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æ¶ˆå»ã•ã‚Œã¦ã„ã¾ã™ï¼ˆç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ï¼‰`),window.top.location.replace(`./account.html`);return}t.name=e.name||t.name}else t.name=`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰`;_=t.name;try{K()}catch{}}catch(e){console.error(e),t.name=g||`ï¼ˆã‚¿ã‚¤ãƒˆãƒ«å–å¾—å¤±æ•—ï¼‰`}y&&ze(),y&&(Ye(g),Xe())}$(),H.settings.theme||(H.settings.theme=C(),K()),(p===`light`||p===`dark`)&&(H.settings.theme=p),typeof H.settings.showProjectTags!=`boolean`&&(H.settings.showProjectTags=!1),Q(H.settings.theme),nn(!1),m&&Yt(!0)}(async()=>{let e=new URLSearchParams(location.search),t=g||e.get(`project`)||``;if(t){await Ee(t);return}fe(`project ãŒæœªæŒ‡å®šã§ã™`)})();function U(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function W(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,`0`)}-${String(e.getDate()).padStart(2,`0`)}`}function De(e){if(!e||typeof e!=`string`)return U(new Date);let t=e.split(`-`);if(t.length<3)return U(new Date);let n=Number(t[0]),r=Number(t[1]),i=Number(t[2]);return!n||!r||!i?U(new Date):new Date(n,r-1,i)}function G(e,t){let n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function Oe(e){return`${e.getMonth()+1}/${e.getDate()}ï¼ˆ${[`æ—¥`,`æœˆ`,`ç«`,`æ°´`,`æœ¨`,`é‡‘`,`åœŸ`][e.getDay()]}ï¼‰`}function ke(e){return`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)} ${String(e.getHours()).padStart(2,`0`)}:${String(e.getMinutes()).padStart(2,`0`)}`}function Ae(){return`id_`+Math.random().toString(36).slice(2,9)+`_`+Date.now().toString(36)}function je(){let e=localStorage.getItem(ee);if(!e){let e=U(new Date),t=Ae(),n=Ae(),r=Ae();return{startDate:W(e),daysToShow:S,lastBackupAt:null,projects:[{id:t,name:`ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[{id:n,name:`Main Theme`,memo:``},{id:r,name:`Ending`,memo:``}]}],schedule:{[n]:{[W(e)]:`ä½œæ›²`,[W(G(e,1))]:`ä½œæ›²`,[W(G(e,2))]:`MIX`},[r]:{[W(G(e,3))]:`ä½œæ›²`,[W(G(e,4))]:`REC`}},statuses:x,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:C()},cellNotes:{}}}try{let t=JSON.parse(e);if(!t.projects)throw Error(`invalid data`);return t.settings||={},typeof t.settings.cellWidth!=`number`&&(t.settings.cellWidth=70),typeof t.settings.cellHeight!=`number`&&(t.settings.cellHeight=28),typeof t.settings.heatmapEnabled!=`boolean`&&(t.settings.heatmapEnabled=!0),typeof t.settings.showProjectTags!=`boolean`&&(t.settings.showProjectTags=!0),t.settings.theme||(t.settings.theme=C()),t.cellNotes||={},t.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),(e.tracks||[]).forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),t.startDate||=W(U(new Date)),t.daysToShow||=S,(!t.statuses||!Array.isArray(t.statuses)||t.statuses.length===0)&&(t.statuses=x),t}catch(e){return console.warn(`failed to parse state, init new`,e),localStorage.removeItem(ee),je()}}function Me(e){if(!e||!Array.isArray(e.projects))throw Error(`invalid data`);return e.startDate||=W(U(new Date)),e.daysToShow||=S,(!e.statuses||!Array.isArray(e.statuses)||e.statuses.length===0)&&(e.statuses=x),e.settings||={},typeof e.settings.cellWidth!=`number`&&(e.settings.cellWidth=70),typeof e.settings.cellHeight!=`number`&&(e.settings.cellHeight=28),typeof e.settings.heatmapEnabled!=`boolean`&&(e.settings.heatmapEnabled=!0),typeof e.settings.showProjectTags!=`boolean`&&(e.settings.showProjectTags=!0),e.settings.theme||(e.settings.theme=C()),(!e.cellNotes||typeof e.cellNotes!=`object`)&&(e.cellNotes={}),e.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),Array.isArray(e.tracks)||(e.tracks=[]),e.tracks.forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),(!e.schedule||typeof e.schedule!=`object`)&&(e.schedule={}),e}async function Ne(){if(!v||!y)return null;try{let e=await u(v);if(!e.exists())return null;let t=e.data()||{};return t.state?Me(t.state):null}catch(e){return console.error(e),null}}var Pe=null,Fe=null;function Ie(){if(O||k||_e||Date.now()-ne<800)return!0;let e=document.activeElement;if(e){let t=e.tagName;if(t===`SELECT`&&e.classList.contains(`cell-select`)||t===`INPUT`||t===`TEXTAREA`||e.isContentEditable)return!0;let n=document.getElementById(`inputPopover`);if(n&&!n.classList.contains(`hidden`)&&e.closest(`#inputPopover`))return!0}let t=document.getElementById(`trackMemoOverlay`);if(t&&!t.classList.contains(`hidden`))return!0;let n=document.getElementById(`cellNoteOverlay`);return!!(n&&!n.classList.contains(`hidden`))}function Le(e){ve=!0;try{if(H=e,ue&&Je(ue),g){let e=(H.projects||[]).find(e=>e.id===g)||{id:g,name:_||g||`Loading`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]};_&&(e.name=_),H.projects=[e],w=g,T=!0}$();let t=p===`light`||p===`dark`?p:null;t&&(H.settings.theme=t),Q(t||H.settings.theme||C()),D.clear(),M=null,X()}finally{ve=!1}}function Re(){Fe||=setTimeout(()=>{if(Fe=null,!Pe)return;if(Ie()){Re();return}let e=Pe;Pe=null,Le(e)},300)}function ze(){!v||!y||(ge&&ge(),ge=r(v,e=>{if(!e.exists())return;let t=e.data()||{};if(!t.state||t.clientId&&t.clientId===te)return;let n=t.updatedAt,r=n?.seconds?n.seconds*1e3+(n.nanoseconds||0)/1e6:Date.now();if(r<=ye)return;ye=r;let i=new Set([y?.displayName,y?.email,y?.uid].filter(Boolean)).has(t.updatedBy),a=Date.now()-ne<1500;if(i&&a)return;let o=Me(t.state);if(Ie()){Pe=o,Re();return}Le(o)},e=>{console.error(e)}))}function Be(e,t){let n=(e?.m??``).toString().trim(),r=(e?.scene??``).toString().trim(),i=(e?.demo??``).toString().trim(),a=(e?.v??``).toString().trim(),o=[];return n&&o.push(`#${n}`),r?o.push(r):i?o.push(i):a&&o.push(`v:${a}`),o.join(` `)||(t?`cue:${t.slice(0,6)}`:`cue`)}function Ve(e){let t=new Map;return Array.isArray(e)&&e.forEach(e=>{!e||!e.value||t.set(e.value,{label:e.label||e.value,color:e.color||`#6fd6ff`})}),t}function He(e,t){if(!t)return null;let n=oe;return n&&n.has(t)?n.get(t):{label:t,color:`#6fd6ff`}}function Ue(e){return e?le.has(e)?le.get(e):{label:e,color:`#6fd6ff`}:null}function We(e){let t=String(e||``).trim();return/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t)?{bg:t+`22`,bd:t+`55`}:{bg:`rgba(111,214,255,0.18)`,bd:`rgba(111,214,255,0.55)`}}function Ge(e,t){let n=We(t);return`<span class="row-meta-pill" style="background:${n.bg};border-color:${n.bd};">${Z(e)}</span>`}function Ke(e,t){let n=e?.status||``,r=e?.len||``,i=t||``,a=ce.get(e.id);return a&&(n=a.status||n||``,r=a.len||r||``,i=a.projectId||i||``),{status:n,len:r,projectId:i}}function qe(e,t){let n=Ke(e,t),r=[];if(n.status){let e=He(n.projectId,n.status),t=e?.label||n.status;r.push(Ge(`é€²æ—: ${t}`,e?.color))}if(n.len){let e=Ue(n.len),t=e?.label||n.len;r.push(Ge(`é•·ã•: ${t}`,e?.color))}return r.length?`<div class="row-header-meta">${r.join(``)}</div>`:`<div class="row-header-meta row-header-meta-empty"></div>`}function Je(e){if(!g)return;H?.projects||(H.projects=[]);let t=H.projects.find(e=>e.id===g);t||(t={id:g,name:_||g,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]},H.projects=[t]);let n=new Map((t.tracks||[]).map(e=>[e.id,e.memo||``]));t.tracks=e.map(e=>({id:e.id,name:e.name,memo:n.get(e.id)||``,status:e.status||``,len:e.len||``})),H.schedule||={};let r=new Set(e.map(e=>e.id));Object.keys(H.schedule).forEach(e=>{r.has(e)||delete H.schedule[e]}),e.forEach(e=>{H.schedule[e.id]||(H.schedule[e.id]={})})}function Ye(t){me(),t&&(re=r(s(e,`projects`,t,`settings`,`ui`),e=>{oe=Ve((e.exists()&&e.data()||{}).statuses||[]),X()},e=>{console.warn(`[schedule] sheet ui settings error`,e)}))}function Xe(){!g||!y||(b&&b(),b=r(c(l(e,`projects`,g,`cues`),i(`m`)),e=>{let t=e.docs.map(e=>{let t=e.data()||{};return{id:e.id,name:Be(t,e.id),m:t?.m??null,status:t?.status||``,len:t?.len||``}});t.sort((e,t)=>{let n=parseInt(e.m,10),r=parseInt(t.m,10),i=Number.isFinite(n),a=Number.isFinite(r);return i&&a?n-r:i&&!a?-1:!i&&a?1:e.name.localeCompare(t.name,`ja`)}),ue=t.map(({id:e,name:t,status:n,len:r})=>({id:e,name:t,status:n,len:r})),Je(ue),X()},e=>{console.error(e),fe(`æ›²ãƒªã‚¹ãƒˆåŒæœŸã‚¨ãƒ©ãƒ¼: ${e.code||e.message}`)}))}function Ze(e){return Me({projects:[{id:e,name:de.get(e)||e,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]}],schedule:{},cellNotes:{},statuses:x.slice(),daysToShow:S,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:C()}})}function Qe(){ve||be()&&(!v||!y||(_e&&clearTimeout(_e),_e=setTimeout(async()=>{try{let e=JSON.parse(JSON.stringify(H));if(g){let t=(e.projects||[]).find(e=>e.id===g)||e.projects?.[0];t?_&&(!t.name||t.name.includes(`?????`)||t.name.includes(`????`))&&(t.name=_):t={id:g,name:_||`Untitled`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]},e.projects=[t]}await a(v,{state:e,updatedAt:o(),updatedBy:y?.displayName||y?.email||y?.uid||``,clientId:te,version:1},{merge:!0})}catch(e){console.error(e)}},500)))}function K(){try{localStorage.setItem(ee,JSON.stringify(H))}catch{}ve||(ne=Date.now()),Qe()}function q(){let e=JSON.parse(JSON.stringify(H));V.push(e),V.length>Te&&V.shift()}function $e(){V.length&&(H=V.pop(),K(),D.clear(),M=null,N=null,nn(H.settings.showProjectTags),Q(H.settings.theme),X())}function et(){return[``,...H.statuses.map(e=>e.name)]}function tt(e){return e&&H.statuses.find(t=>t.name===e)||null}function nt(e){if(!e)return null;let t=e.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function rt(e){let t=e.value,n=tt(t),r=e.closest(`.cell`);if(!r)return;let i=r.querySelector(`.cell-label`);i&&(i.textContent=t||``);let a=getComputedStyle(document.body),o=a.getPropertyValue(`--text-main`).trim()||`#fdfdfd`,s=a.getPropertyValue(`--cell-bg`).trim()||`rgba(5,6,11,0.7)`,c=document.body.classList.contains(`theme-light`),l=r.classList.contains(`today`),u=c?`linear-gradient(to bottom, rgba(111,214,255,0.45), rgba(111,214,255,0.2))`:`linear-gradient(to bottom, rgba(111,214,255,0.7), rgba(111,214,255,0.3))`,d=c?`rgba(8,12,22,0.12)`:`rgba(255,255,255,0.16)`;if(!n){r.style.background=l?u:s,e.style.borderColor=d,i&&(i.style.color=o);return}let f=nt(n.color)||{r:111,g:214,b:255},p=f.r,m=f.g,h=f.b,g;g=l?c?`linear-gradient(to bottom, rgba(${p},${m},${h},0.55), rgba(${p},${m},${h},0.3))`:`linear-gradient(to bottom, rgba(${p},${m},${h},0.9), rgba(${p},${m},${h},0.5))`:c?`linear-gradient(135deg, rgba(${p},${m},${h},0.16), rgba(${p},${m},${h},0.42))`:`linear-gradient(135deg, rgba(${p},${m},${h},0.22), rgba(${p},${m},${h},0.6))`,r.style.background=g,e.style.borderColor=`rgba(${p},${m},${h},${c?.7:.85})`,i&&(i.style.color=c?`#1f2430`:`#fdfdfd`)}function it(){document.querySelectorAll(`.cell-select`).forEach(rt)}function J(e,t){return e+`|`+t}function at(){document.querySelectorAll(`.cell`).forEach(e=>{let t=e.dataset.trackId,n=e.dataset.date,r=t&&n?J(t,n):null;r&&D.has(r)?e.classList.add(`selected`):e.classList.remove(`selected`)})}var ot=null;function st(e,t){if(!P.length||!F.length)return;let n=Math.min(e.rowIndex,t.rowIndex),r=Math.max(e.rowIndex,t.rowIndex),i=Math.min(e.colIndex,t.colIndex),a=Math.max(e.colIndex,t.colIndex);D.clear();for(let e=n;e<=r;e++){if(!P[e])continue;let t=P[e].track;for(let e=i;e<=a;e++){if(!F[e])continue;let n=W(F[e]);D.add(J(t.id,n))}}at()}function ct(){let e=[];return D.forEach(t=>{let[n,r]=t.split(`|`),i=I[n],a=Se[r];i!=null&&a!=null&&e.push({trackId:n,date:r,rowIndex:i,colIndex:a})}),e}function lt(){let e=document.getElementById(`projectList`);e.innerHTML=``;let t=H.projects.filter(e=>!e.archived),n=H.projects.filter(e=>e.archived);if(!t.length&&!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>ã¾ã æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            æ¡ˆä»¶ã¯ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£å‹•ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦æ›²ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
          </div>
        `;return}if(t.forEach(t=>{let n=(t.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item`+(t.id===w?` active`:``),r.dataset.projectId=t.id,r.innerHTML=`
          <div class="project-name">
            <span class="project-dot" style="background:${t.color||`#62c3ff`}"></span>
            <span>${Z(t.name)}</span>
          </div>
          <div style="display:flex; align-items:center; gap:4px;">
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-up-btn"
                    data-project-id="${t.id}"
                    title="ä¸Šã¸">
              â–²
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-down-btn"
                    data-project-id="${t.id}"
                    title="ä¸‹ã¸">
              â–¼
            </button>
            <div class="project-meta">${n}æ›²</div>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-archive-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
              ğŸ“¦
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’å‰Šé™¤">
              ğŸ—‘
            </button>
          </div>
        `,r.addEventListener(`click`,e=>{e.target.closest(`.project-delete-btn`)||e.target.closest(`.project-move-up-btn`)||e.target.closest(`.project-move-down-btn`)||e.target.closest(`.project-archive-btn`)||(w=t.id,At(),X())}),e.appendChild(r)}),n.length){let t=document.createElement(`div`);t.style.marginTop=`20px`,t.style.borderTop=`1px solid #e0e0e0`,t.style.paddingTop=`10px`;let r=document.createElement(`div`);r.style.fontSize=`12px`,r.style.fontWeight=`bold`,r.style.color=`#999`,r.style.marginBottom=`8px`,r.textContent=`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿`,t.appendChild(r),n.forEach(e=>{let n=(e.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item archived`,r.dataset.projectId=e.id,r.style.opacity=`0.6`,r.innerHTML=`
            <div class="project-name">
              <span class="project-dot" style="background:${e.color||`#62c3ff`}"></span>
              <span>${Z(e.name)}</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
              <div class="project-meta">${n}æ›²</div>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-unarchive-btn"
                      data-project-id="${e.id}"
                      title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’è§£é™¤">
                â†©ï¸
              </button>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                      data-project-id="${e.id}"
                      title="æ¡ˆä»¶ã‚’å‰Šé™¤">
                ğŸ—‘
              </button>
            </div>
          `,t.appendChild(r)}),e.appendChild(t)}e.querySelectorAll(`.project-delete-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=H.projects.find(e=>e.id===n);r&&window.confirm(`æ¡ˆä»¶ã€Œ${r.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ¡ˆä»¶å†…ã®æ›²ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)&&(q(),(r.tracks||[]).forEach(e=>{H.schedule[e.id]&&delete H.schedule[e.id]}),H.projects=H.projects.filter(e=>e.id!==n),w===n&&(w=H.projects.length?H.projects.find(e=>!e.archived)?.id||H.projects[0].id:null),K(),D.clear(),M=null,N=null,X())})}),e.querySelectorAll(`.project-archive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=H.projects.find(e=>e.id===n);r&&(q(),r.archived=!0,w===n&&(w=H.projects.find(e=>!e.archived)?.id||null),K(),X())})}),e.querySelectorAll(`.project-unarchive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=H.projects.find(e=>e.id===n);r&&(q(),r.archived=!1,K(),X())})}),e.querySelectorAll(`.project-move-up-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),ut(e.dataset.projectId,-1)})}),e.querySelectorAll(`.project-move-down-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),ut(e.dataset.projectId,1)})})}function ut(e,t){let n=H.projects.findIndex(t=>t.id===e);if(n<0)return;let r=n+t;if(r<0||r>=H.projects.length)return;q();let[i]=H.projects.splice(n,1);H.projects.splice(r,0,i),K(),X()}function dt(){let e=De(H.startDate),t=H.daysToShow||S,n=[];for(let r=0;r<t;r++){let t=G(e,r);n.push(t)}return n}function ft(){let e=dt(),t=document.getElementById(`dateRangeLabel`);if(!e.length)t.textContent=`---`;else{let n=e[0],r=e[e.length-1];t.textContent=`${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ã€œ ${r.getFullYear()}/${r.getMonth()+1}/${r.getDate()}`}let n=document.getElementById(`daysToShowInput`);n&&(n.value=H.daysToShow||S)}function pt(){let e=[];return H.projects.forEach(t=>{t.archived||T&&w&&t.id!==w||(t.tracks||[]).forEach(n=>{e.push({project:t,track:n})})}),e}function mt(e,t){let n={},r=e.map(e=>W(e));return r.forEach(e=>{n[e]=0}),t.forEach(({track:e})=>{let t=H.schedule[e.id]||{};r.forEach(e=>{let r=t[e];r&&r!==`none`&&(n[e]+=1)})}),n}function Y(){let e=document.getElementById(`gridWrapper`),t=dt(),n=pt();if(P=n,F=t,I={},Se={},n.forEach((e,t)=>{I[e.track.id]=t}),t.forEach((e,t)=>{Se[W(e)]=t}),!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>è¡¨ç¤ºã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            å·¦ã®ã€Œæ¡ˆä»¶ã‚’è¿½åŠ ã€â†’ã€Œæ›²ã‚’è¿½åŠ ã€ã§æ›²ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€
            ã“ã“ã« <strong>æ¡ˆä»¶ Ã— æ›² Ã— æ—¥ä»˜</strong> ã®ã‚°ãƒªãƒƒãƒ‰ãŒå‡ºã¦ãã¾ã™ã€‚
          </div>
        `;return}let r=W(U(new Date)),i=et(),a={};H.projects.forEach(e=>{e.deadline&&(a[e.id]=e.deadline)});let o=H.settings&&H.settings.heatmapEnabled,s=o?mt(t,n):{},c=0;o&&(Object.values(s).forEach(e=>{e>c&&(c=e)}),c<1&&(c=1));let l=``,u=``,d=`<table class="schedule-grid"><thead><tr>`;t.forEach(e=>{let t=W(e),n=t===r,i=Object.values(a).includes(t),c=0;if(o){let e=s[t]||0;c=Math.max(0,Math.min(1,e/5))}let l=[`date-header`,`date-header-heat`,n?`today`:``,i?`deadline`:``].filter(Boolean).join(` `);d+=`
          <th class="${l}"
              data-date="${t}"
              style="--heat-intensity:${c};">
            <span class="date-header-main">${Oe(e)}</span>
            <span class="date-header-sub">${t}</span>
          </th>
        `}),d+=`</tr></thead><tbody>`;let f=[];H.projects.forEach(e=>{if(e.archived||T&&w&&e.id!==w)return;let t=(e.tracks||[]).filter(e=>I[e.id]!=null);t.length&&f.push({project:e,tracks:t})}),f.forEach(e=>{let n=e.project,o=a[n.id]||null,s=n.deadline?`ç· åˆ‡: ${n.deadline}`:`ç· åˆ‡: æœªè¨­å®š`,c=!!n.collapsed;l+=`
          <tr class="project-group-row" data-project-id="${n.id}">
            <td class="project-group-cell">
              <div class="project-group-inner">
                <span class="project-group-dot" style="background:${n.color||`#62c3ff`}"></span>
                <span class="project-group-name">${Z(n.name)}</span>
                <span class="project-group-deadline">${s}</span>
                <button type="button"
                        class="btn btn-ghost btn-sm project-deadline-btn"
                        data-project-id="${n.id}"
                        title="ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’è¨­å®š">
                  â±
                </button>
                <span class="project-group-toggle">
                  ${c?`â–¶`:`â–¼`}
                </span>
              </div>
            </td>
          </tr>
        `,u+=`
          <tr class="project-group-spacer" data-project-id="${n.id}">
            <td colspan="${t.length}"></td>
          </tr>
        `,!c&&e.tracks.forEach(e=>{let a=I[e.id],s=H.schedule[e.id]||{},c=qe(e,n.id);l+=`
            <tr>
              <td class="row-header-cell" data-track-id="${e.id}">
                <div class="row-header-inner">
                  <div class="row-header-main">
                    <div class="row-header-top">
                      <div class="row-header-title"
                           data-project-id="${n.id}"
                           data-track-id="${e.id}"
                           data-track-name="${Z(e.name)}"
                           data-project-name="${Z(n.name)}">${Z(e.name)}</div>
                      <div class="row-header-actions">
                        <button type="button"
                                class="btn btn-ghost btn-sm btn-icon-only row-header-memo-btn"
                                data-project-id="${n.id}"
                                data-track-id="${e.id}"
                                title="${Z(e.memo||`ãƒ¡ãƒ¢æœªè¨­å®š`)}">
                          ğŸ“
                        </button>
                      </div>
                    </div>
                    <div class="row-header-tag">${Z(n.name)}</div>
                  </div>
                  ${c}
                </div>
              </td>
            </tr>
          `;let d=`<tr>`;t.forEach((t,c)=>{let l=W(t),u=l===r,f=o&&o===l,p=s[l]||``,m=J(e.id,l),h=D.has(m),g=J(e.id,l),_=H.cellNotes[g],ee=[`cell`,u?`today`:``,h?`selected`:``,f?`deadline-col`:``,_?`has-note`:``].filter(Boolean).join(` `);d+=`
              <td class="${ee}"
                  data-project-id="${n.id}"
                  data-track-id="${e.id}"
                  data-date="${l}"
                  data-row-index="${a}"
                  data-col-index="${c}"
                  data-status="${Z(p)}"
                  title="${Z(_||``)}">
                <div class="cell-inner">
                  <span class="cell-label">${p?Z(p):``}</span>
                  <button type="button"
                          class="cell-dropdown-btn"
                          data-project-id="${n.id}"
                          data-track-id="${e.id}"
                          data-date="${l}"
                          data-row-index="${a}"
                          data-col-index="${c}">â–¼</button>
                  <select
                    class="cell-select"
                    data-project-id="${n.id}"
                    data-track-id="${e.id}"
                    data-date="${l}"
                    data-row-index="${a}"
                    data-col-index="${c}"
                    onchange="handleCellChange(this)"
                  >
                    ${i.map(e=>`<option value="${e}" ${e===p?`selected`:``}>${e||`---`}</option>`).join(``)}
                  </select>
                </div>
              </td>
            `}),d+=`</tr>`,u+=d})}),e.innerHTML=`
        <div class="grid-split">
          <div class="grid-left" id="gridLeftPane">${`
        <table class="schedule-grid row-header-table">
          <thead>
            <tr>
              <th class="row-header"></th>
            </tr>
          </thead>
          <tbody>
      `+l+`</tbody></table>`}</div>
          <div class="grid-right" id="gridRightPane">${d+u+`</tbody></table>`}</div>
        </div>
      `;let p=document.getElementById(`gridLeftPane`),m=document.getElementById(`gridRightPane`);p&&m&&(m.addEventListener(`scroll`,()=>{p.scrollTop!==m.scrollTop&&(p.scrollTop=m.scrollTop)}),p.addEventListener(`scroll`,()=>{m.scrollTop!==p.scrollTop&&(m.scrollTop=p.scrollTop)})),ht(),gt(),it(),Ct(),wt(),Tt(),at(),Et(),Zt()}function ht(){let e=document.getElementById(`gridRightPane`);if(!e)return;let t=e.querySelector(`table.schedule-grid thead`);if(!t)return;let n=t.getBoundingClientRect(),r=Math.ceil(n.height);document.documentElement.style.setProperty(`--project-group-offset`,`${r}px`),document.documentElement.style.setProperty(`--grid-header-height`,`${r}px`)}function gt(){let e=document.querySelectorAll(`#gridLeftPane tbody tr`),t=document.querySelectorAll(`#gridRightPane tbody tr`),n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e[r].getBoundingClientRect().height,i=t[r].getBoundingClientRect().height,a=Math.max(n,i);e[r].style.height=`${a}px`,t[r].style.height=`${a}px`}}function _t(){H.settings||={cellWidth:70,cellHeight:28};let{cellWidth:e,cellHeight:t}=H.settings,n=document.documentElement;n.style.setProperty(`--cell-width`,(e||70)+`px`),n.style.setProperty(`--cell-height`,(t||28)+`px`),n.style.setProperty(`--cell-font-size`,`0.68rem`);let r=document.getElementById(`colWidthInput`),i=document.getElementById(`rowHeightInput`);r&&(r.value=e||70),i&&(i.value=t||28)}function vt(){let e=document.getElementById(`backupStatus`),t=document.getElementById(`backupStatusText`);if(!H.lastBackupAt){t.textContent=`ã¾ã ã‚ã‚Šã¾ã›ã‚“`,e.classList.remove(`overdue`);return}let n=new Date(H.lastBackupAt);if(isNaN(n.getTime())){t.textContent=`ä¸æ˜ï¼ˆå†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ï¼‰`,e.classList.add(`overdue`);return}t.textContent=ke(n),new Date().getTime()-n.getTime()>2880*60*1e3?e.classList.add(`overdue`):e.classList.remove(`overdue`)}function yt(){let e=document.getElementById(`statusFilterSelect`);if(!e)return;let t=H.statuses||[],n=`<option value="ALL">ã™ã¹ã¦</option>`;if(t.forEach(e=>{let t=Z(e.name);n+=`<option value="${t}">${t}</option>`}),e.innerHTML=n,B!==`ALL`){let n=t.some(e=>e.name===B);e.value=n?B:`ALL`,n||(B=`ALL`)}else e.value=`ALL`}function X(){!w&&H.projects.length&&(w=H.projects[0].id),_t(),lt(),ft(),Y(),vt(),yt(),At(),Xt(),$t()}function bt(e,t,n){if(St(),!e)return;let r=document.createElement(`div`);r.className=`alt-ghost`,r.textContent=e,r.style.left=t+`px`,r.style.top=n+`px`,document.body.appendChild(r),j=r}function xt(e,t){j&&(j.style.left=e+`px`,j.style.top=t+`px`)}function St(){j&&=(j.remove(),null)}function Ct(){document.querySelectorAll(`.cell`).forEach(e=>{e.addEventListener(`mousedown`,Dt),e.addEventListener(`mouseenter`,Ot),e.addEventListener(`mouseup`,kt),e.addEventListener(`dblclick`,t=>{t.stopPropagation();let n=e.dataset.trackId,r=e.dataset.date;ln(n,r)})}),document.querySelectorAll(`.cell-select`).forEach(e=>{e.addEventListener(`focus`,()=>{M={rowIndex:parseInt(e.dataset.rowIndex,10),colIndex:parseInt(e.dataset.colIndex,10),trackId:e.dataset.trackId,date:e.dataset.date}})})}function wt(){document.querySelectorAll(`.row-header-memo-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=e.dataset.trackId;on(n,r)})}),document.querySelectorAll(`.row-header-title`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId||``,r=e.dataset.trackId||``;E=r,Et();let i=r;n&&i.startsWith(`${n}__`)&&(i=i.slice(n.length+2));let a={type:`SCHEDULE_TRACK_SELECT`,projectId:n,trackId:r,cueId:i,trackName:e.dataset.trackName||e.textContent||``,projectName:e.dataset.projectName||``};window.parent&&window.parent!==window&&window.parent.postMessage(a,`*`)})}),document.querySelectorAll(`.project-deadline-btn`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.projectId,n=H.projects.find(e=>e.id===t);if(!n)return;let r=n.deadline||``,i=window.prompt(`ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’ YYYY-MM-DD å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºã§è§£é™¤ï¼‰`,r);if(i===null)return;let a=i.trim();if(q(),!a)delete n.deadline;else{if(!a.match(/^(\d{4})-(\d{2})-(\d{2})$/)){window.alert(`æ—¥ä»˜ã¯ YYYY-MM-DD ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹: 2025-12-31`);return}n.deadline=a}K(),X()})})}function Tt(){document.querySelectorAll(`.project-group-row`).forEach(e=>{let t=e.dataset.projectId,n=t?H.projects.find(e=>e.id===t):null,r=e.querySelector(`.project-group-toggle`);r&&r.addEventListener(`click`,e=>{e.stopPropagation(),n&&(q(),n.collapsed=!n.collapsed,K(),Y())});let i=e.querySelector(`.project-group-name`);i&&i.addEventListener(`click`,e=>{if(e.stopPropagation(),!window.parent||window.parent===window||!t)return;let r={type:`SCHEDULE_PROJECT_SELECT`,projectId:t,projectName:n?.name||i.textContent||``};window.parent.postMessage(r,`*`)})})}function Et(){document.querySelectorAll(`.row-header-cell`).forEach(e=>{let t=E&&e.dataset.trackId===E;e.classList.toggle(`track-selected`,t)}),document.querySelectorAll(`.cell`).forEach(e=>{let t=E&&e.dataset.trackId===E;e.classList.toggle(`track-selected`,t)})}function Dt(e){if(e.button!==0||e.target.closest(`.cell-dropdown-btn`))return;let t=e.currentTarget,n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10),o=J(n,r);if(It(),n&&E!==n&&(E=n,Et()),e.altKey){let t=(H.schedule[n]||{})[r]||``;A={trackId:n,date:r,value:t},k=!0,t&&bt(t,e.clientX,e.clientY);return}O=!0,ot={rowIndex:i,colIndex:a},e.ctrlKey||e.metaKey?D.has(o)?D.delete(o):D.add(o):e.shiftKey&&M?st({rowIndex:M.rowIndex,colIndex:M.colIndex},{rowIndex:i,colIndex:a}):(D.clear(),D.add(o)),M={rowIndex:i,colIndex:a,trackId:n,date:r},at()}function Ot(e){if(!O||!ot)return;let t=e.currentTarget,n={rowIndex:parseInt(t.dataset.rowIndex,10),colIndex:parseInt(t.dataset.colIndex,10)};st(ot,n)}function kt(e){let t=e.currentTarget;t.dataset.projectId;let n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10);if(k&&A){q();let e=A;H.schedule[n]||(H.schedule[n]={}),e.value?H.schedule[n][r]=e.value:delete H.schedule[n][r],K();let i=t.querySelector(`.cell-select`);i&&(i.value=e.value||``,rt(i)),Y()}O=!1,k=!1,A=null,St(),M={rowIndex:i,colIndex:a,trackId:n,date:r}}window.addEventListener(`mouseup`,()=>{O=!1,k=!1,A=null,St()}),window.addEventListener(`mousemove`,e=>{k&&xt(e.clientX,e.clientY)}),window.handleCellChange=function(e){e.dataset.projectId;let t=e.dataset.trackId,n=e.dataset.date,r=e.value,i=J(t,n);function a(e,t,n){H.schedule[e]||(H.schedule[e]={}),n?H.schedule[e][t]=n:delete H.schedule[e][t]}if(q(),D.size>1&&D.has(i)){let e=new Set;D.forEach(t=>{let[n,i]=t.split(`|`);a(n,i,r),e.add(n)}),e.forEach(e=>void 0)}else a(t,n,r);K(),Y()};function At(){let e=document.getElementById(`showAllBtn`),t=document.getElementById(`showSelectedBtn`);T?(t.classList.add(`active`),e.classList.remove(`active`)):(e.classList.add(`active`),t.classList.remove(`active`))}function jt(){document.getElementById(`statusEditorOverlay`).classList.remove(`hidden`),Nt()}function Mt(){document.getElementById(`statusEditorOverlay`).classList.add(`hidden`)}function Nt(){let e=document.getElementById(`statusListContainer`);e.innerHTML=``,(!H.statuses||!Array.isArray(H.statuses)||H.statuses.length===0)&&(H.statuses=x),H.statuses.forEach(t=>{let n=document.createElement(`div`);n.className=`status-row`,n.innerHTML=`
          <input type="text" class="status-name-input" value="${Z(t.name)}" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šä½œæ›²ï¼‰">
          <input type="color" class="status-color-input" value="${t.color||`#f5576c`}">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,n.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{n.remove()}),e.appendChild(n)})}function Pt(){let e=document.getElementById(`statusListContainer`),t=Array.from(e.querySelectorAll(`.status-row`)),n=[];return t.forEach(e=>{let t=e.querySelector(`.status-name-input`),r=e.querySelector(`.status-color-input`),i=t.value.trim(),a=r.value||`#f5576c`;i&&n.push({name:i,color:a})}),n.length===0?x:n}function Ft(e,t){let n=document.getElementById(`contextMenu`);n.classList.remove(`hidden`);let r=n.getBoundingClientRect(),i=e,a=t;i+r.width>window.innerWidth&&(i=window.innerWidth-r.width-4),a+r.height>window.innerHeight&&(a=window.innerHeight-r.height-4),n.style.left=i+`px`,n.style.top=a+`px`}function It(){document.getElementById(`contextMenu`).classList.add(`hidden`),Ce=null}function Lt(e){if(h)return;let t=e.target.closest(`.cell`);if(!t){It();return}e.preventDefault();let n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10);M={rowIndex:i,colIndex:a,trackId:n,date:r},Ce={rowIndex:i,colIndex:a,trackId:n,date:r},at(),Ft(e.clientX,e.clientY)}function Rt(){if(h)return;let e=ct();if(!e.length&&M&&P.length&&F.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=M;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}if(!e.length)return;let t=e.map(e=>e.rowIndex),n=e.map(e=>e.colIndex),r=Math.min(...t),i=Math.max(...t),a=Math.min(...n),o=Math.max(...n),s=i-r+1,c=o-a+1,l=Array.from({length:s},()=>Array.from({length:c},()=>``));e.forEach(e=>{let t=e.rowIndex-r,n=e.colIndex-a,i=e.trackId,o=e.date,s=(H.schedule[i]||{})[o]||``;l[t][n]=s}),N={data:l,width:c,height:s}}function zt(e){if(h||!N)return;let t=e||M;if(!t){let e=ct();if(!e.length)return;let n=e.map(e=>e.rowIndex),r=e.map(e=>e.colIndex);t={rowIndex:Math.min(...n),colIndex:Math.min(...r)}}let{data:n,width:r,height:i}=N;q();for(let e=0;e<i;e++){let i=t.rowIndex+e;if(!P[i])continue;let a=P[i].track.id;for(let i=0;i<r;i++){let r=t.colIndex+i;if(!F[r])continue;let o=W(F[r]),s=n[e][i];H.schedule[a]||(H.schedule[a]={}),s?H.schedule[a][o]=s:delete H.schedule[a][o]}}K(),Y()}function Bt(){if(h)return;let e=ct();if(!e.length&&M&&P.length&&F.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=M;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}e.length&&(q(),e.forEach(e=>{H.schedule[e.trackId]&&delete H.schedule[e.trackId][e.date]}),K(),Y())}function Vt(){let e=new Date;H.lastBackupAt=e.toISOString(),K(),vt();let t=JSON.stringify(H,null,2),n=new Blob([t],{type:`application/json`}),r=`schedule_backup_${e.getFullYear()}${String(e.getMonth()+1).padStart(2,`0`)}${String(e.getDate()).padStart(2,`0`)}_${String(e.getHours()).padStart(2,`0`)}${String(e.getMinutes()).padStart(2,`0`)}.json`,i=URL.createObjectURL(n),a=document.createElement(`a`);a.href=i,a.download=r,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(i)}function Z(e){return e==null?``:String(e).replace(/&/g,`&amp;`).replace(/</g,`&lt;`).replace(/>/g,`&gt;`).replace(/"/g,`&quot;`).replace(/'/g,`&#039;`)}function Ht(e,t){let n=document.getElementById(`inputPopover`),r=document.getElementById(`inputPopoverTitle`),i=document.getElementById(`inputPopoverField`),a=document.getElementById(`inputPopoverOkBtn`);z.type=e,z.anchorBtn=t,e===`project`?(r.textContent=`æ–°ã—ã„æ¡ˆä»¶å`,a.textContent=`è¿½åŠ `):e===`track`&&(r.textContent=`æ–°ã—ã„æ›²å`,a.textContent=`è¿½åŠ `),i.value=``,n.classList.remove(`hidden`);let o=t.getBoundingClientRect();n.style.left=o.left+`px`,n.style.top=o.bottom+6+`px`;let s=n.getBoundingClientRect(),c=o.left,l=o.bottom+6;c+s.width>window.innerWidth-8&&(c=window.innerWidth-s.width-8),l+s.height>window.innerHeight-8&&(l=o.top-s.height-6),n.style.left=c+`px`,n.style.top=l+`px`,i.focus(),i.select()}function Ut(){document.getElementById(`inputPopover`).classList.add(`hidden`),z.type=null,z.anchorBtn=null}function Wt(){let e=document.getElementById(`inputPopoverField`).value.trim();if(!e){Ut();return}z.type===`project`?Gt(e):z.type===`track`&&Kt(e),Ut()}function Gt(e){q();let t={id:Ae(),name:e.trim(),color:`#62c3ff`,tracks:[]};H.projects.push(t),w=t.id,K(),X()}function Kt(e){if(!w){window.alert(`ã¾ãšå·¦ã®æ¡ˆä»¶ãƒªã‚¹ãƒˆã‹ã‚‰ã€æ›²ã‚’è¿½åŠ ã—ãŸã„æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);return}let t=H.projects.find(e=>e.id===w);if(!t){window.alert(`é¸æŠä¸­ã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);return}q();let n={id:Ae(),name:e.trim()};t.tracks.push(n),K(),X()}function qt(e){let t=H.schedule[e];if(!t)return null;let n=null;return Object.keys(t).forEach(e=>{let t=De(e);isNaN(t.getTime())||(!n||t<n)&&(n=t)}),n}function Jt(){q(),H.projects.forEach(e=>{!e.tracks||e.tracks.length<=1||e.tracks.sort((e,t)=>{let n=qt(e.id),r=qt(t.id);if(n&&r){let i=n-r;return i===0?e.name.localeCompare(t.name,`ja`):i}else if(n&&!r)return-1;else if(!n&&r)return 1;else return e.name.localeCompare(t.name,`ja`)})}),K(),X()}function Yt(e){we=m?!0:e,document.body.classList.toggle(`client-view-mode`,we),Xt()}function Xt(){let e=document.getElementById(`clientViewToggleBtn`);e&&(m?e.style.display=`none`:(e.style.display=``,we?(e.classList.add(`active`),e.textContent=`ğŸ‘ é€šå¸¸ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹`):(e.classList.remove(`active`),e.textContent=`ğŸ‘ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼`)));let t=document.getElementById(`clientViewBanner`);t&&t.classList.toggle(`hidden`,!we);let n=document.getElementById(`clientViewBackBtn`);n&&(n.style.display=m?`none`:``)}function Zt(){document.querySelectorAll(`.cell`).forEach(e=>{if(e.classList.remove(`dim`),B&&B!==`ALL`){let t=e.dataset.status||``;(!t||t!==B)&&e.classList.add(`dim`)}})}function Qt(){document.querySelectorAll(`[data-nav-href]`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.getAttribute(`data-nav-href`);t&&(location.href=t)})});let e=document.getElementById(`addTrackBtn`);e.addEventListener(`click`,()=>{Ht(`track`,e)});let t=document.getElementById(`settingsMenuBtn`),n=document.getElementById(`settingsPopover`);t&&n&&(t.addEventListener(`click`,e=>{e.stopPropagation(),n.classList.toggle(`settings-closed`)}),document.addEventListener(`click`,e=>{n.classList.contains(`settings-closed`)||!e.target.closest(`#settingsPopover`)&&!e.target.closest(`#settingsMenuBtn`)&&n.classList.add(`settings-closed`)})),document.getElementById(`autoStairSortBtn`).addEventListener(`click`,()=>{Jt()}),document.getElementById(`showAllBtn`).addEventListener(`click`,()=>{T=!1,At(),X()}),document.getElementById(`showSelectedBtn`).addEventListener(`click`,()=>{T=!0,At(),X()}),document.getElementById(`prevRangeBtn`).addEventListener(`click`,()=>{let e=H.daysToShow||S,t=G(De(H.startDate),-e);q(),H.startDate=W(t),K(),X()}),document.getElementById(`nextRangeBtn`).addEventListener(`click`,()=>{let e=H.daysToShow||S,t=G(De(H.startDate),e);q(),H.startDate=W(t),K(),X()});let r=document.getElementById(`themeToggleBtn`);r&&r.addEventListener(`click`,()=>{tn(H.settings&&H.settings.theme===`light`?`dark`:`light`)});let i=document.getElementById(`tagToggleBtn`);i&&i.addEventListener(`click`,()=>{rn(!!(H.settings&&H.settings.showProjectTags===!1))}),document.getElementById(`exportBtn`).addEventListener(`click`,()=>{Vt()}),document.getElementById(`importInput`).addEventListener(`change`,e=>{let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=t=>{try{let e=t.target.result;H=Me(JSON.parse(e)),V=[],D.clear(),M=null,N=null,K(),Q(H.settings.theme),nn(H.settings.showProjectTags),X(),window.alert(`JSONã‹ã‚‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`)}catch(e){console.error(e),window.alert(`JSONã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚`)}finally{e.target.value=``}},n.readAsText(t,`utf-8`)}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.cell-dropdown-btn`);if(!t)return;let n=t.closest(`.cell`);if(!n)return;let r=n.querySelector(`.cell-select`);if(r)if(typeof r.showPicker==`function`)r.showPicker();else{r.focus();let e=new MouseEvent(`mousedown`,{bubbles:!0,cancelable:!0,view:window});r.dispatchEvent(e),r.click()}}),document.addEventListener(`contextmenu`,Lt),document.addEventListener(`mousedown`,e=>{document.getElementById(`contextMenu`).classList.contains(`hidden`)||e.target.closest(`#contextMenu`)||It(),document.getElementById(`inputPopover`).classList.contains(`hidden`)||!e.target.closest(`#inputPopover`)&&!e.target.closest(`#addProjectBtn`)&&!e.target.closest(`#addTrackBtn`)&&Ut()}),window.addEventListener(`scroll`,()=>{It()},!0),document.querySelectorAll(`#contextMenu .context-menu-item`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.action;t===`copy`?Rt():t===`paste`?zt(Ce||M||null):t===`clear`&&Bt(),It()})});let a=document.getElementById(`statusFilterSelect`);a.addEventListener(`change`,()=>{B=a.value,Zt()}),document.getElementById(`undoBtn`).addEventListener(`click`,()=>{$e()});let o=document.getElementById(`clientViewToggleBtn`);o&&!m&&o.addEventListener(`click`,()=>{Yt(!we)});let s=document.getElementById(`clientViewBackBtn`);s&&!m&&s.addEventListener(`click`,()=>{Yt(!1)}),document.addEventListener(`keydown`,e=>{let t=e.ctrlKey||e.metaKey,n=e.target,r=n.tagName,i=r===`SELECT`&&n.classList.contains(`cell-select`),a=(r===`INPUT`||r===`TEXTAREA`||n.isContentEditable)&&!i;if(!document.getElementById(`inputPopover`).classList.contains(`hidden`)){if(e.key===`Enter`){e.preventDefault(),Wt();return}if(e.key===`Escape`){e.preventDefault(),Ut();return}}if(t&&(e.key===`s`||e.key===`S`)){e.preventDefault(),Vt();return}if(h&&t&&(e.key===`c`||e.key===`C`)){e.preventDefault();return}if(t&&(e.key===`c`||e.key===`C`)){e.preventDefault(),Rt();return}if(h&&t&&(e.key===`v`||e.key===`V`)){e.preventDefault();return}if(t&&(e.key===`v`||e.key===`V`)){e.preventDefault(),zt();return}if(t&&(e.key===`z`||e.key===`Z`)){if(a)return;e.preventDefault(),$e();return}if(h&&(e.key===`Delete`||e.key===`Backspace`)){e.preventDefault();return}if(e.key===`Delete`||e.key===`Backspace`){if(a)return;e.preventDefault(),Bt();return}});let c=document.getElementById(`colWidthInput`),l=document.getElementById(`rowHeightInput`);c&&c.addEventListener(`change`,()=>{let e=parseInt(c.value,10);isNaN(e)&&(e=70),e=Math.max(20,Math.min(200,e)),q(),H.settings.cellWidth=e,K(),_t(),Y()}),l&&l.addEventListener(`change`,()=>{let e=parseInt(l.value,10);isNaN(e)&&(e=28),e=Math.max(14,Math.min(80,e)),q(),H.settings.cellHeight=e,K(),_t(),Y()});let u=document.getElementById(`daysToShowInput`);u&&u.addEventListener(`change`,()=>{let e=parseInt(u.value,10);isNaN(e)&&(e=S),e=Math.max(7,Math.min(90,e)),q(),H.daysToShow=e,K(),X()}),document.getElementById(`editStatusesBtn`).addEventListener(`click`,()=>{jt()}),document.getElementById(`closeStatusEditorBtn`).addEventListener(`click`,()=>{Mt()}),document.getElementById(`addStatusRowBtn`).addEventListener(`click`,()=>{let e=document.getElementById(`statusListContainer`),t=document.createElement(`div`);t.className=`status-row`,t.innerHTML=`
          <input type="text" class="status-name-input" value="" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šãƒªãƒŸãƒƒã‚¯ã‚¹ï¼‰">
          <input type="color" class="status-color-input" value="#f5576c">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,t.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{t.remove()}),e.appendChild(t)}),document.getElementById(`saveStatusesBtn`).addEventListener(`click`,()=>{let e=Pt();q(),H.statuses=e,K(),Mt(),X()}),document.getElementById(`statusEditorOverlay`).addEventListener(`click`,e=>{e.target.id===`statusEditorOverlay`&&Mt()}),document.getElementById(`inputPopoverCancelBtn`).addEventListener(`click`,()=>{Ut()}),document.getElementById(`inputPopoverOkBtn`).addEventListener(`click`,()=>{Wt()}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.row-header-memo-btn`);if(!t)return;e.stopPropagation();let n=t.dataset.projectId,r=t.dataset.trackId;on(n,r)}),document.addEventListener(`click`,e=>{let t=e.target;if(t.id===`trackMemoSaveBtn`){e.preventDefault(),cn();return}if(t.id===`trackMemoCancelBtn`){e.preventDefault(),sn();return}if(t.id===`trackMemoOverlay`){e.preventDefault(),sn();return}if(t.id===`cellNoteSaveBtn`){e.preventDefault(),dn();return}if(t.id===`cellNoteCloseBtn`){e.preventDefault(),un();return}if(t.id===`cellNoteOverlay`){e.preventDefault(),un();return}}),document.getElementById(`heatmapToggleBtn`)?.addEventListener(`click`,()=>{H.settings||={},q(),H.settings.heatmapEnabled=!H.settings.heatmapEnabled,K(),X()})}function $t(){let e=document.getElementById(`heatmapToggleBtn`);e&&(H.settings&&H.settings.heatmapEnabled?(e.classList.add(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ON`):(e.classList.remove(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—OFF`))}function en(e){let t=document.getElementById(`themeToggleBtn`);if(!t)return;let n=(e||H.settings&&H.settings.theme||`dark`)===`light`;t.textContent=n?`ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰`:`â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰`,t.classList.toggle(`active`,n)}function Q(e){let t=e===`light`?`light`:`dark`;document.body.classList.toggle(`theme-light`,t===`light`),document.body.classList.toggle(`theme-dark`,t===`dark`),document.documentElement.style.colorScheme=t===`light`?`light`:`dark`,en(t),typeof styleAllCellSelect==`function`&&styleAllCellSelect()}function tn(e){$();let t=e===`light`?`light`:`dark`;localStorage.setItem(xe,t),H.settings.theme=t,K(),Q(t),X()}function nn(e){let t=e!==!1;document.body.classList.toggle(`hide-row-tags`,!t),an(t)}function rn(e){$(),H.settings.showProjectTags=!!e,K(),nn(e)}function an(e){let t=document.getElementById(`tagToggleBtn`);if(!t)return;let n=e!==!1;t.textContent=n?`ğŸ· ã‚¿ã‚°éè¡¨ç¤º`:`ğŸ· ã‚¿ã‚°è¡¨ç¤º`,t.classList.toggle(`active`,n)}function on(e,t){L.projectId=e,L.trackId=t;let n=H.projects.find(t=>t.id===e),r=n?.tracks.find(e=>e.id===t);if(!n||!r)return;let i=document.getElementById(`trackMemoOverlay`),a=document.getElementById(`trackMemoTitle`),o=document.getElementById(`trackMemoText`);a.textContent=`${Z(n.name)} - ${Z(r.name)}`,o.value=r.memo||``,i.classList.remove(`hidden`),o.focus()}function sn(){let e=document.getElementById(`trackMemoOverlay`);e&&e.classList.add(`hidden`),L.projectId=null,L.trackId=null}function cn(){if(!L.projectId||!L.trackId)return;let e=H.projects.find(e=>e.id===L.projectId),t=e?.tracks.find(e=>e.id===L.trackId);if(!e||!t){sn();return}let n=document.getElementById(`trackMemoText`).value.trim();q(),t.memo=n,L.projectId,K(),sn(),Y()}function ln(e,t){R.trackId=e,R.dateIso=t;let n=document.getElementById(`cellNoteOverlay`),r=document.getElementById(`cellNoteTitle`),i=document.getElementById(`cellNoteTextarea`),a=J(e,t),o=H.cellNotes[a]||``;r.textContent=`${t} ã®ãƒ¡ãƒ¢`,i.value=o,n.classList.remove(`hidden`),i.focus()}function un(){let e=document.getElementById(`cellNoteOverlay`);e&&e.classList.add(`hidden`),R.trackId=null,R.dateIso=null}function dn(){if(!R.trackId||!R.dateIso)return;let e=document.getElementById(`cellNoteTextarea`).value.trim(),t=J(R.trackId,R.dateIso);q(),e?H.cellNotes[t]=e:delete H.cellNotes[t],R.trackId,K(),un(),Y()}function $(){H.settings||={}}function fn(){$();let e=new Date,t=W(U(e)),n=H.settings.lastRollDate||null;(e.getHours()>4||e.getHours()===4&&e.getMinutes()>=0)&&n!==t&&(q(),H.startDate=t,H.settings.lastRollDate=t,K())}function pn(){fn(),setInterval(fn,60*1e3)}function mn(){_t()}Qt(),mn(),window.addEventListener(`resize`,ht),window.addEventListener(`resize`,gt),(function(){document.body.classList.add(`embedded`),g?Yt(!0):(Yt(!1),console.warn(`[schedule] embed=1 ãªã®ã« project ãŒã‚ã‚Šã¾ã›ã‚“ã€‚portalã‹ã‚‰ ?project=... ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚`)),(p===`light`||p===`dark`)&&tn(p),window.addEventListener(`message`,e=>{let t=e.data;!t||typeof t!=`object`||t.type===`SET_THEME`&&(t.theme===`light`||t.theme===`dark`)&&($(),H.settings.theme=t.theme,localStorage.setItem(xe,t.theme),Q(t.theme))})})(),pn(),X();