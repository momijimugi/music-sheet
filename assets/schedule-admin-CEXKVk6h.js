import{n as e,t}from"./firebase-B4G0vEhV.js";import{T as n,h as r,o as i,s as a,u as o,v as s,y as c}from"./index.esm-B0-OTnKT.js";/* empty css                      */import"./tabulator_esm-D-Igvjbx.js";var l=new URLSearchParams(location.search).get(`theme`),u=!1,d=`composerScheduleBoard_v10`,f=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);function p(e){return!!e?.email&&f.includes(e.email)}function m(e){let t=String(e).split(`/`);return t[0]===`projects`?t[1]:``}var h=(()=>{let e=`csb_clientId`,t=sessionStorage.getItem(e);if(t)return t;let n=Math.random().toString(36).slice(2,10)+`_`+Date.now().toString(36);return sessionStorage.setItem(e,n),n})(),g=null,ee=null,_=null,v=new Map,te=new Map,ne=new Map,re=new Map([{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}].map(e=>[e.value,e])),ie=null,ae=null,y=[],oe=new Map,se=!1,ce=!1,b=new Set,le=new Map,x=new Map;function ue(e){let t=document.getElementById(`topError`),n=String(e||``);t&&(t.textContent=n),n&&console.warn(`[schedule]`,n)}function de(){let e=document.getElementById(`topError`);e&&(e.textContent=``)}function fe(e){e&&b.add(e)}function pe(e,t){if(t){b.add(t);return}let n=Ce(e);if(n?.projectId){b.add(n.projectId);return}T&&b.add(T)}function me(){ie&&=(ie(),null)}function he(){ee&&=(ee(),null)}function ge(){ae&&=(ae(),null)}function _e(){_&&=(_(),null),v.size&&(v.forEach(e=>e&&e()),v.clear()),ne=new Map,te.clear()}var ve=null,ye=null,be=!1,xe=()=>!!g&&!0,S=[{name:`ä½œæ›²`,color:`#f5576c`},{name:`ã‚¢ãƒ¬ãƒ³ã‚¸`,color:`#84fab0`},{name:`REC`,color:`#ff9a9e`},{name:`MIX`,color:`#a18cd1`},{name:`ãƒã‚¹ã‚¿ãƒªãƒ³ã‚°`,color:`#f6d365`},{name:`æµ„æ›¸`,color:`#fda085`},{name:`ä¿®æ­£`,color:`#f093fb`},{name:`æ‰“ã¡åˆã‚ã›`,color:`#4facfe`}],C=21;function Se(e,t){return`${e}__${t}`}function Ce(e){let t=String(e||``),n=t.indexOf(`__`);if(n<=0)return null;let r=t.slice(0,n).trim(),i=t.slice(n+2).trim();return!r||!i?null:{projectId:r,trackId:i}}function we(e){if(!e)return``;let t=(e.projects||[]).map(e=>{let t=(e.tracks||[]).map(e=>e.id).join(`,`);return`${e.id}:${t}`}).join(`|`),n=(e.statuses||[]).map(e=>`${e.name}:${e.color}`).join(`|`),r=e.settings||{};return[e.startDate||``,String(e.daysToShow||``),t,n,String(r.cellWidth||``),String(r.cellHeight||``),String(r.heatmapEnabled),String(r.showProjectTags),String(r.theme||``)].join(`~`)}function Te(e){let t=new Map;return e&&Object.entries(e).forEach(([e,n])=>{n&&Object.entries(n).forEach(([n,r])=>{let i=`${e}|${n}`;t.set(i,r||``)})}),t}function Ee(e){let t=new Map;return e&&Object.entries(e).forEach(([e,n])=>{t.set(e,n||``)}),t}function De(e,t){let n=[];return e.forEach((e,r)=>{let i=t.has(r)?t.get(r):``;(e||``)!==(i||``)&&n.push([r,i||``])}),t.forEach((t,r)=>{e.has(r)||n.push([r,t||``])}),n}function Oe(e){e.length&&(e.forEach(([e,t])=>{let n=e.indexOf(`|`);if(n===-1)return;let r=e.slice(0,n),i=e.slice(n+1),a=document.querySelector(`.cell-select[data-track-id="${r}"][data-date="${i}"]`);a&&(a.value=t||``,J(a))}),X())}function ke(e){e.length&&e.forEach(([e,t])=>{let n=e.indexOf(`|`);if(n===-1)return;let r=e.slice(0,n),i=e.slice(n+1),a=document.querySelector(`.cell[data-track-id="${r}"][data-date="${i}"]`);a&&(t?(a.classList.add(`has-note`),a.title=t):(a.classList.remove(`has-note`),a.title=``))})}function Ae(e){let t=qe();t.projects=[],t.schedule={},t.cellNotes={};let n=new Map,r=null,i=0;return e.forEach(e=>{if(!e?.state||!e.projectId)return;let a=e.state,o=e.projectId;a.startDate&&(!r||a.startDate<r)&&(r=a.startDate);let s=Number(a.daysToShow)||0;s>i&&(i=s);let c=Array.isArray(a.projects)?a.projects:[],l=c.find(e=>e.id===o)||c[0]||{id:o,name:o,tracks:[]},u=oe.get(o)||[],d=(l.tracks||[]).length?l.tracks:u,f=x.get(o)||l.name||o,p={...l,id:o,name:f,tracks:[]},m=new Map;(d||[]).forEach(e=>{if(!e?.id)return;let t=Se(o,e.id);m.set(e.id,t),p.tracks.push({...e,id:t})}),t.projects.push(p);let h=a.schedule||{};Object.keys(h).forEach(e=>{let n=m.get(e);n&&(t.schedule[n]=h[e])});let g=a.cellNotes||{};Object.keys(g).forEach(e=>{let n=String(e).split(`|`);if(n.length<2)return;let r=n.shift(),i=n.join(`|`),a=m.get(r);a&&(t.cellNotes[`${a}|${i}`]=g[e])}),(a.statuses||[]).forEach(e=>{e?.name&&(n.has(e.name)||n.set(e.name,e.color||`#6fd6ff`))})}),t.projects.sort((e,t)=>String(e.name||e.id).localeCompare(String(t.name||t.id))),t.statuses=n.size?Array.from(n.entries()).map(([e,t])=>({name:e,color:t})):S.slice(),r&&(t.startDate=r),i&&(t.daysToShow=i),t}function je(e,t){let n=x.get(e)||e;return{startDate:W(new Date),daysToShow:C,projects:[{id:e,name:n,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:Array.isArray(t)?t:[]}],schedule:{},cellNotes:{},statuses:S.slice(),settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:w()}}}function Me(){let e=y.slice(),t=new Set(e.map(e=>e.projectId));if(oe.forEach((n,r)=>{!n?.length||t.has(r)||e.push({projectId:r,state:je(r,n)})}),!e.length){if(!se&&!ce){ue(`èª­ã¿è¾¼ã¿ä¸­...`);return}ue(`ã¾ã å…¨æ¡ˆä»¶ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);return}de();let n=Ae(e),r=we(n);if(Le&&r===Le){let e=Te(n.schedule),t=Ee(n.cellNotes),r=De(Re,e),i=De(ze,t);H=n,Oe(r),ke(i),Re=e,ze=t;return}H=n,xn(),H.settings.theme||(H.settings.theme=w()),(l===`light`||l===`dark`)&&(H.settings.theme=l),un(H.settings.theme),fn(H.settings.showProjectTags),T=H.projects[0]?.id||null,E=!1,Q(),Le=r,Re=Te(H.schedule),ze=Ee(H.cellNotes)}var Ne=`theme`;function w(){let e=localStorage.getItem(Ne);return e===`light`||e===`dark`?e:window.matchMedia&&window.matchMedia(`(prefers-color-scheme: light)`).matches?`light`:`dark`}var T=null,E=!1,D=``,O=new Set,Pe=!1,Fe=!1,k=null,A=null,j=null,M=null,N=[],P=[],F={},Ie={},Le=``,Re=new Map,ze=new Map,Be=null,I={projectId:null,trackId:null},L={trackId:null,date:null},R={type:null,anchorBtn:null},z=`ALL`,B=u,V=[],Ve=20;async function He(){me(),ge(),he(),_e(),ve&&=(ve(),null),Le=``,Re=new Map,ze=new Map;let o=document.getElementById(`allMode`),s=document.querySelector(`.app-shell`);o&&(o.style.display=`none`),s&&(s.style.display=``),(l===`light`||l===`dark`)&&dn(l);let c=await new Promise(e=>n(t,e));if(g=c,!p(c)){document.body.innerHTML=`<p>ç®¡ç†è€…å°‚ç”¨ã§ã™</p>`;return}r(i(e,`projects`),e=>{x.clear(),e.forEach(e=>{let t=e.data()||{};x.set(e.id,t.name||e.id)}),rt(Array.from(x.keys())),y.length&&Me()},e=>{console.error(e),ue(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.code||e.message}`)}),ae=r(a(e,`scheduleBoard`),e=>{let t=new Map(y.map(e=>[e.projectId,e])),n=Date.now(),r=[];e.forEach(e=>{let i=e.data()||{},a=m(e.ref.path);if(!a||!i.state)return;let o=le.get(a);if(o&&n-o<1500){let e=t.get(a);if(e){r.push(e);return}}i.clientId===h&&le.delete(a);try{let e=Je(i.state);r.push({projectId:a,state:e})}catch(e){console.warn(e)}}),y=r,se=!0,Me()},e=>{console.error(e),ue(`å…¨æ¡ˆä»¶ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.code||e.message}`)}),it(),rt()}var H=qe();(async()=>{await He()})();function U(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function W(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,`0`)}-${String(e.getDate()).padStart(2,`0`)}`}function Ue(e){if(!e||typeof e!=`string`)return U(new Date);let t=e.split(`-`);if(t.length<3)return U(new Date);let n=Number(t[0]),r=Number(t[1]),i=Number(t[2]);return!n||!r||!i?U(new Date):new Date(n,r-1,i)}function G(e,t){let n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function We(e){return`${e.getMonth()+1}/${e.getDate()}ï¼ˆ${[`æ—¥`,`æœˆ`,`ç«`,`æ°´`,`æœ¨`,`é‡‘`,`åœŸ`][e.getDay()]}ï¼‰`}function Ge(e){return`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)} ${String(e.getHours()).padStart(2,`0`)}:${String(e.getMinutes()).padStart(2,`0`)}`}function Ke(){return`id_`+Math.random().toString(36).slice(2,9)+`_`+Date.now().toString(36)}function qe(){let e=localStorage.getItem(d);if(!e){let e=U(new Date),t=Ke(),n=Ke(),r=Ke();return{startDate:W(e),daysToShow:C,lastBackupAt:null,projects:[{id:t,name:`ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[{id:n,name:`Main Theme`,memo:``},{id:r,name:`Ending`,memo:``}]}],schedule:{[n]:{[W(e)]:`ä½œæ›²`,[W(G(e,1))]:`ä½œæ›²`,[W(G(e,2))]:`MIX`},[r]:{[W(G(e,3))]:`ä½œæ›²`,[W(G(e,4))]:`REC`}},statuses:S,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:w()},cellNotes:{}}}try{let t=JSON.parse(e);if(!t.projects)throw Error(`invalid data`);return t.settings||={},typeof t.settings.cellWidth!=`number`&&(t.settings.cellWidth=70),typeof t.settings.cellHeight!=`number`&&(t.settings.cellHeight=28),typeof t.settings.heatmapEnabled!=`boolean`&&(t.settings.heatmapEnabled=!0),typeof t.settings.showProjectTags!=`boolean`&&(t.settings.showProjectTags=!0),t.settings.theme||(t.settings.theme=w()),t.cellNotes||={},t.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),(e.tracks||[]).forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),t.startDate||=W(U(new Date)),t.daysToShow||=C,(!t.statuses||!Array.isArray(t.statuses)||t.statuses.length===0)&&(t.statuses=S),t}catch(e){return console.warn(`failed to parse state, init new`,e),localStorage.removeItem(d),qe()}}function Je(e){if(!e||!Array.isArray(e.projects))throw Error(`invalid data`);return e.startDate||=W(U(new Date)),e.daysToShow||=C,(!e.statuses||!Array.isArray(e.statuses)||e.statuses.length===0)&&(e.statuses=S),e.settings||={},typeof e.settings.cellWidth!=`number`&&(e.settings.cellWidth=70),typeof e.settings.cellHeight!=`number`&&(e.settings.cellHeight=28),typeof e.settings.heatmapEnabled!=`boolean`&&(e.settings.heatmapEnabled=!0),typeof e.settings.showProjectTags!=`boolean`&&(e.settings.showProjectTags=!0),e.settings.theme||(e.settings.theme=w()),(!e.cellNotes||typeof e.cellNotes!=`object`)&&(e.cellNotes={}),e.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),Array.isArray(e.tracks)||(e.tracks=[]),e.tracks.forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),(!e.schedule||typeof e.schedule!=`object`)&&(e.schedule={}),e}function Ye(e,t){let n=(e?.m??``).toString().trim(),r=(e?.scene??``).toString().trim(),i=(e?.demo??``).toString().trim(),a=(e?.v??``).toString().trim(),o=[];return n&&o.push(`#${n}`),r?o.push(r):i?o.push(i):a&&o.push(`v:${a}`),o.join(` `)||(t?`cue:${t.slice(0,6)}`:`cue`)}function Xe(e){let t=new Map;return Array.isArray(e)&&e.forEach(e=>{!e||!e.value||t.set(e.value,{label:e.label||e.value,color:e.color||`#6fd6ff`})}),t}function Ze(e,t){if(!t)return null;let n=te.get(e);return n&&n.has(t)?n.get(t):{label:t,color:`#6fd6ff`}}function Qe(e){return e?re.has(e)?re.get(e):{label:e,color:`#6fd6ff`}:null}function $e(e){let t=String(e||``).trim();return/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t)?{bg:t+`22`,bd:t+`55`}:{bg:`rgba(111,214,255,0.18)`,bd:`rgba(111,214,255,0.55)`}}function et(e,t){let n=$e(t);return`<span class="row-meta-pill" style="background:${n.bg};border-color:${n.bd};">${$(e)}</span>`}function tt(e,t){let n=e?.status||``,r=e?.len||``,i=t||``,a=ne.get(e.id);return a&&(n=a.status||n||``,r=a.len||r||``,i=a.projectId||i||``),{status:n,len:r,projectId:i}}function nt(e,t){let n=tt(e,t),r=[];if(n.status){let e=Ze(n.projectId,n.status),t=e?.label||n.status;r.push(et(`é€²æ—: ${t}`,e?.color))}if(n.len){let e=Qe(n.len),t=e?.label||n.len;r.push(et(`é•·ã•: ${t}`,e?.color))}return r.length?`<div class="row-header-meta">${r.join(``)}</div>`:`<div class="row-header-meta row-header-meta-empty"></div>`}function rt(t){let n=Array.isArray(t)?t:Array.from(x.keys()),i=new Set(n.filter(Boolean));v.forEach((e,t)=>{i.has(t)||(e&&e(),v.delete(t),te.delete(t))}),n.forEach(t=>{if(!t||v.has(t))return;let n=r(o(e,`projects`,t,`settings`,`ui`),e=>{let n=e.exists()&&e.data()||{};te.set(t,Xe(n.statuses||[])),Q()},e=>{console.warn(`[schedule] sheet ui settings(all) error`,e)});v.set(t,n)})}function it(){_&&=(_(),null),ne=new Map,_=r(a(e,`cues`),e=>{let t=new Map,n=new Map;e.forEach(e=>{let r=m(e.ref.path);if(!r)return;let i=e.data()||{},a=i.status||``,o=i.len||``;(a||o)&&t.set(Se(r,e.id),{status:a,len:o,projectId:r});let s=n.get(r)||[];s.push({id:e.id,name:Ye(i,e.id),m:i?.m??null}),n.set(r,s)}),ne=t,n.forEach((e,t)=>{e.sort((e,t)=>{let n=parseInt(e.m,10),r=parseInt(t.m,10),i=Number.isFinite(n),a=Number.isFinite(r);return i&&a?n-r:i&&!a?-1:!i&&a?1:String(e.name||``).localeCompare(String(t.name||``),`ja`)}),n.set(t,e.map(({id:e,name:t})=>({id:e,name:t})))}),oe=n,ce=!0,Me()},e=>{console.warn(`[schedule] cues(all) error`,e)})}function at(){let e=new Map,t=new Map;return(H.projects||[]).forEach(n=>{n?.id&&(e.set(n.id,{}),t.set(n.id,{}))}),Object.entries(H.schedule||{}).forEach(([t,n])=>{let r=Ce(t);r&&(e.has(r.projectId)||e.set(r.projectId,{}),e.get(r.projectId)[r.trackId]=n)}),Object.entries(H.cellNotes||{}).forEach(([e,n])=>{let r=String(e).split(`|`),i=Ce(r.shift());if(!i)return;let a=r.join(`|`);t.has(i.projectId)||t.set(i.projectId,{}),t.get(i.projectId)[`${i.trackId}|${a}`]=n}),{scheduleByProject:e,notesByProject:t}}function ot(e){if(!e||!e.size)return;let{scheduleByProject:t,notesByProject:n}=at(),r=new Set(e),i=[],a=new Set;y.forEach(e=>{if(!e?.projectId)return;if(a.add(e.projectId),!r.has(e.projectId)){i.push(e);return}let o=e?.state?JSON.parse(JSON.stringify(e.state)):st(e.projectId);o.schedule=t.get(e.projectId)||{},o.cellNotes=n.get(e.projectId)||{},i.push({projectId:e.projectId,state:o})}),r.forEach(e=>{if(a.has(e))return;let r=st(e);r.schedule=t.get(e)||{},r.cellNotes=n.get(e)||{},i.push({projectId:e,state:r})}),y=i}function st(e){return Je({projects:[{id:e,name:x.get(e)||e,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]}],schedule:{},cellNotes:{},statuses:S.slice(),daysToShow:C,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:w()}})}function ct(){be||xe()&&g&&b.size&&(ye&&clearTimeout(ye),ye=setTimeout(async()=>{let t=new Set(b);b.clear();try{let{scheduleByProject:n,notesByProject:r}=at(),i=[];n.forEach((n,a)=>{if(!t.has(a))return;let l=y.find(e=>e.projectId===a),u=l?.state?JSON.parse(JSON.stringify(l.state)):st(a);u.schedule=n,u.cellNotes=r.get(a)||{},i.push(c(o(e,`projects`,a,`scheduleBoard`,`state`),{state:u,updatedAt:s(),updatedBy:g?.displayName||g?.email||g?.uid||``,clientId:h,version:1},{merge:!0}))}),await Promise.all(i)}catch(e){console.error(e),t.forEach(e=>b.add(e))}},400))}function K(){try{localStorage.setItem(d,JSON.stringify(H))}catch{}{let e=new Set(b);!e.size&&T&&(b.add(T),e.add(T)),e.forEach(e=>le.set(e,Date.now())),ot(e)}ct()}function q(){let e=JSON.parse(JSON.stringify(H));V.push(e),V.length>Ve&&V.shift()}function lt(){V.length&&(H=V.pop(),K(),O.clear(),j=null,M=null,fn(H.settings.showProjectTags),un(H.settings.theme),Q())}function ut(){return[``,...H.statuses.map(e=>e.name)]}function dt(e){return e&&H.statuses.find(t=>t.name===e)||null}function ft(e){if(!e)return null;let t=e.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function J(e){let t=e.value,n=dt(t),r=e.closest(`.cell`);if(!r)return;let i=r.querySelector(`.cell-label`);i&&(i.textContent=t||``);let a=getComputedStyle(document.body),o=a.getPropertyValue(`--text-main`).trim()||`#fdfdfd`,s=a.getPropertyValue(`--cell-bg`).trim()||`rgba(5,6,11,0.7)`,c=document.body.classList.contains(`theme-light`),l=r.classList.contains(`today`),u=c?`linear-gradient(to bottom, rgba(111,214,255,0.45), rgba(111,214,255,0.2))`:`linear-gradient(to bottom, rgba(111,214,255,0.7), rgba(111,214,255,0.3))`,d=c?`rgba(8,12,22,0.12)`:`rgba(255,255,255,0.16)`;if(!n){r.style.background=l?u:s,e.style.borderColor=d,i&&(i.style.color=o);return}let f=ft(n.color)||{r:111,g:214,b:255},p=f.r,m=f.g,h=f.b,g;g=l?c?`linear-gradient(to bottom, rgba(${p},${m},${h},0.55), rgba(${p},${m},${h},0.3))`:`linear-gradient(to bottom, rgba(${p},${m},${h},0.9), rgba(${p},${m},${h},0.5))`:c?`linear-gradient(135deg, rgba(${p},${m},${h},0.16), rgba(${p},${m},${h},0.42))`:`linear-gradient(135deg, rgba(${p},${m},${h},0.22), rgba(${p},${m},${h},0.6))`,r.style.background=g,e.style.borderColor=`rgba(${p},${m},${h},${c?.7:.85})`,i&&(i.style.color=c?`#1f2430`:`#fdfdfd`)}function pt(){document.querySelectorAll(`.cell-select`).forEach(J)}function Y(e,t){return e+`|`+t}function X(){document.querySelectorAll(`.cell`).forEach(e=>{let t=e.dataset.trackId,n=e.dataset.date,r=t&&n?Y(t,n):null;r&&O.has(r)?e.classList.add(`selected`):e.classList.remove(`selected`)})}var mt=null;function ht(e,t){if(!N.length||!P.length)return;let n=Math.min(e.rowIndex,t.rowIndex),r=Math.max(e.rowIndex,t.rowIndex),i=Math.min(e.colIndex,t.colIndex),a=Math.max(e.colIndex,t.colIndex);O.clear();for(let e=n;e<=r;e++){if(!N[e])continue;let t=N[e].track;for(let e=i;e<=a;e++){if(!P[e])continue;let n=W(P[e]);O.add(Y(t.id,n))}}X()}function gt(){let e=[];return O.forEach(t=>{let[n,r]=t.split(`|`),i=F[n],a=Ie[r];i!=null&&a!=null&&e.push({trackId:n,date:r,rowIndex:i,colIndex:a})}),e}function _t(){let e=document.getElementById(`projectList`);e.innerHTML=``;let t=H.projects.filter(e=>!e.archived),n=H.projects.filter(e=>e.archived);if(!t.length&&!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>ã¾ã æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            æ¡ˆä»¶ã¯ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£å‹•ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦æ›²ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
          </div>
        `;return}if(t.forEach(t=>{let n=(t.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item`+(t.id===T?` active`:``),r.dataset.projectId=t.id,r.innerHTML=`
          <div class="project-name">
            <span class="project-dot" style="background:${t.color||`#62c3ff`}"></span>
            <span>${$(t.name)}</span>
          </div>
          <div style="display:flex; align-items:center; gap:4px;">
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-up-btn"
                    data-project-id="${t.id}"
                    title="ä¸Šã¸">
              â–²
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-down-btn"
                    data-project-id="${t.id}"
                    title="ä¸‹ã¸">
              â–¼
            </button>
            <div class="project-meta">${n}æ›²</div>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-archive-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
              ğŸ“¦
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’å‰Šé™¤">
              ğŸ—‘
            </button>
          </div>
        `,r.addEventListener(`click`,e=>{e.target.closest(`.project-delete-btn`)||e.target.closest(`.project-move-up-btn`)||e.target.closest(`.project-move-down-btn`)||e.target.closest(`.project-archive-btn`)||(T=t.id,Rt(),Q())}),e.appendChild(r)}),n.length){let t=document.createElement(`div`);t.style.marginTop=`20px`,t.style.borderTop=`1px solid #e0e0e0`,t.style.paddingTop=`10px`;let r=document.createElement(`div`);r.style.fontSize=`12px`,r.style.fontWeight=`bold`,r.style.color=`#999`,r.style.marginBottom=`8px`,r.textContent=`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿`,t.appendChild(r),n.forEach(e=>{let n=(e.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item archived`,r.dataset.projectId=e.id,r.style.opacity=`0.6`,r.innerHTML=`
            <div class="project-name">
              <span class="project-dot" style="background:${e.color||`#62c3ff`}"></span>
              <span>${$(e.name)}</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
              <div class="project-meta">${n}æ›²</div>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-unarchive-btn"
                      data-project-id="${e.id}"
                      title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’è§£é™¤">
                â†©ï¸
              </button>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                      data-project-id="${e.id}"
                      title="æ¡ˆä»¶ã‚’å‰Šé™¤">
                ğŸ—‘
              </button>
            </div>
          `,t.appendChild(r)}),e.appendChild(t)}e.querySelectorAll(`.project-delete-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=H.projects.find(e=>e.id===n);r&&window.confirm(`æ¡ˆä»¶ã€Œ${r.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ¡ˆä»¶å†…ã®æ›²ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)&&(q(),(r.tracks||[]).forEach(e=>{H.schedule[e.id]&&delete H.schedule[e.id]}),H.projects=H.projects.filter(e=>e.id!==n),T===n&&(T=H.projects.length?H.projects.find(e=>!e.archived)?.id||H.projects[0].id:null),K(),O.clear(),j=null,M=null,Q())})}),e.querySelectorAll(`.project-archive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=H.projects.find(e=>e.id===n);r&&(q(),r.archived=!0,T===n&&(T=H.projects.find(e=>!e.archived)?.id||null),K(),Q())})}),e.querySelectorAll(`.project-unarchive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=H.projects.find(e=>e.id===n);r&&(q(),r.archived=!1,K(),Q())})}),e.querySelectorAll(`.project-move-up-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),vt(e.dataset.projectId,-1)})}),e.querySelectorAll(`.project-move-down-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),vt(e.dataset.projectId,1)})})}function vt(e,t){let n=H.projects.findIndex(t=>t.id===e);if(n<0)return;let r=n+t;if(r<0||r>=H.projects.length)return;q();let[i]=H.projects.splice(n,1);H.projects.splice(r,0,i),K(),Q()}function yt(){let e=Ue(H.startDate),t=H.daysToShow||C,n=[];for(let r=0;r<t;r++){let t=G(e,r);n.push(t)}return n}function bt(){let e=yt(),t=document.getElementById(`dateRangeLabel`);if(!e.length)t.textContent=`---`;else{let n=e[0],r=e[e.length-1];t.textContent=`${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ã€œ ${r.getFullYear()}/${r.getMonth()+1}/${r.getDate()}`}let n=document.getElementById(`daysToShowInput`);n&&(n.value=H.daysToShow||C)}function xt(){let e=[];return H.projects.forEach(t=>{t.archived||E&&T&&t.id!==T||(t.tracks||[]).forEach(n=>{e.push({project:t,track:n})})}),e}function St(e,t){let n={},r=e.map(e=>W(e));return r.forEach(e=>{n[e]=0}),t.forEach(({track:e})=>{let t=H.schedule[e.id]||{};r.forEach(e=>{let r=t[e];r&&r!==`none`&&(n[e]+=1)})}),n}function Z(){let e=document.getElementById(`gridWrapper`),t=yt(),n=xt();if(N=n,P=t,F={},Ie={},n.forEach((e,t)=>{F[e.track.id]=t}),t.forEach((e,t)=>{Ie[W(e)]=t}),!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>è¡¨ç¤ºã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            å·¦ã®ã€Œæ¡ˆä»¶ã‚’è¿½åŠ ã€â†’ã€Œæ›²ã‚’è¿½åŠ ã€ã§æ›²ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€
            ã“ã“ã« <strong>æ¡ˆä»¶ Ã— æ›² Ã— æ—¥ä»˜</strong> ã®ã‚°ãƒªãƒƒãƒ‰ãŒå‡ºã¦ãã¾ã™ã€‚
          </div>
        `;return}let r=W(U(new Date)),i=ut(),a={};H.projects.forEach(e=>{e.deadline&&(a[e.id]=e.deadline)});let o=H.settings&&H.settings.heatmapEnabled,s=o?St(t,n):{},c=0;o&&(Object.values(s).forEach(e=>{e>c&&(c=e)}),c<1&&(c=1));let l=``,u=``,d=`<table class="schedule-grid"><thead><tr>`;t.forEach(e=>{let t=W(e),n=t===r,i=Object.values(a).includes(t),c=0;if(o){let e=s[t]||0;c=Math.max(0,Math.min(1,e/5))}let l=[`date-header`,`date-header-heat`,n?`today`:``,i?`deadline`:``].filter(Boolean).join(` `);d+=`
          <th class="${l}"
              data-date="${t}"
              style="--heat-intensity:${c};">
            <span class="date-header-main">${We(e)}</span>
            <span class="date-header-sub">${t}</span>
          </th>
        `}),d+=`</tr></thead><tbody>`;let f=[];H.projects.forEach(e=>{if(e.archived||E&&T&&e.id!==T)return;let t=(e.tracks||[]).filter(e=>F[e.id]!=null);t.length&&f.push({project:e,tracks:t})}),f.forEach(e=>{let n=e.project,o=a[n.id]||null,s=n.deadline?`ç· åˆ‡: ${n.deadline}`:`ç· åˆ‡: æœªè¨­å®š`,c=!!n.collapsed;l+=`
          <tr class="project-group-row" data-project-id="${n.id}">
            <td class="project-group-cell">
              <div class="project-group-inner">
                <span class="project-group-dot" style="background:${n.color||`#62c3ff`}"></span>
                <span class="project-group-name">${$(n.name)}</span>
                <span class="project-group-deadline">${s}</span>
                <button type="button"
                        class="btn btn-ghost btn-sm project-deadline-btn"
                        data-project-id="${n.id}"
                        title="ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’è¨­å®š">
                  â±
                </button>
                <span class="project-group-toggle">
                  ${c?`â–¶`:`â–¼`}
                </span>
              </div>
            </td>
          </tr>
        `,u+=`
          <tr class="project-group-spacer" data-project-id="${n.id}">
            <td colspan="${t.length}"></td>
          </tr>
        `,!c&&e.tracks.forEach(e=>{let a=F[e.id],s=H.schedule[e.id]||{},c=nt(e,n.id);l+=`
            <tr>
              <td class="row-header-cell" data-track-id="${e.id}">
                <div class="row-header-inner">
                  <div class="row-header-main">
                    <div class="row-header-top">
                      <div class="row-header-title"
                           data-project-id="${n.id}"
                           data-track-id="${e.id}"
                           data-track-name="${$(e.name)}"
                           data-project-name="${$(n.name)}">${$(e.name)}</div>
                      <div class="row-header-actions">
                        <button type="button"
                                class="btn btn-ghost btn-sm btn-icon-only row-header-memo-btn"
                                data-project-id="${n.id}"
                                data-track-id="${e.id}"
                                title="${$(e.memo||`ãƒ¡ãƒ¢æœªè¨­å®š`)}">
                          ğŸ“
                        </button>
                      </div>
                    </div>
                    <div class="row-header-tag">${$(n.name)}</div>
                  </div>
                  ${c}
                </div>
              </td>
            </tr>
          `;let d=`<tr>`;t.forEach((t,c)=>{let l=W(t),u=l===r,f=o&&o===l,p=s[l]||``,m=Y(e.id,l),h=O.has(m),g=Y(e.id,l),ee=H.cellNotes[g],_=[`cell`,u?`today`:``,h?`selected`:``,f?`deadline-col`:``,ee?`has-note`:``].filter(Boolean).join(` `);d+=`
              <td class="${_}"
                  data-project-id="${n.id}"
                  data-track-id="${e.id}"
                  data-date="${l}"
                  data-row-index="${a}"
                  data-col-index="${c}"
                  data-status="${$(p)}"
                  title="${$(ee||``)}">
                <div class="cell-inner">
                  <span class="cell-label">${p?$(p):``}</span>
                  <button type="button"
                          class="cell-dropdown-btn"
                          data-project-id="${n.id}"
                          data-track-id="${e.id}"
                          data-date="${l}"
                          data-row-index="${a}"
                          data-col-index="${c}">â–¼</button>
                  <select
                    class="cell-select"
                    data-project-id="${n.id}"
                    data-track-id="${e.id}"
                    data-date="${l}"
                    data-row-index="${a}"
                    data-col-index="${c}"
                    onchange="handleCellChange(this)"
                  >
                    ${i.map(e=>`<option value="${e}" ${e===p?`selected`:``}>${e||`---`}</option>`).join(``)}
                  </select>
                </div>
              </td>
            `}),d+=`</tr>`,u+=d})}),e.innerHTML=`
        <div class="grid-split">
          <div class="grid-left" id="gridLeftPane">${`
        <table class="schedule-grid row-header-table">
          <thead>
            <tr>
              <th class="row-header"></th>
            </tr>
          </thead>
          <tbody>
      `+l+`</tbody></table>`}</div>
          <div class="grid-right" id="gridRightPane">${d+u+`</tbody></table>`}</div>
        </div>
      `;let p=document.getElementById(`gridLeftPane`),m=document.getElementById(`gridRightPane`);p&&m&&(m.addEventListener(`scroll`,()=>{p.scrollTop!==m.scrollTop&&(p.scrollTop=m.scrollTop)}),p.addEventListener(`scroll`,()=>{m.scrollTop!==p.scrollTop&&(m.scrollTop=p.scrollTop)})),Ct(),wt(),pt(),jt(),Mt(),Nt(),X(),Pt(),on()}function Ct(){let e=document.getElementById(`gridRightPane`);if(!e)return;let t=e.querySelector(`table.schedule-grid thead`);if(!t)return;let n=t.getBoundingClientRect(),r=Math.ceil(n.height);document.documentElement.style.setProperty(`--project-group-offset`,`${r}px`),document.documentElement.style.setProperty(`--grid-header-height`,`${r}px`)}function wt(){let e=document.querySelectorAll(`#gridLeftPane tbody tr`),t=document.querySelectorAll(`#gridRightPane tbody tr`),n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e[r].getBoundingClientRect().height,i=t[r].getBoundingClientRect().height,a=Math.max(n,i);e[r].style.height=`${a}px`,t[r].style.height=`${a}px`}}function Tt(){H.settings||={cellWidth:70,cellHeight:28};let{cellWidth:e,cellHeight:t}=H.settings,n=document.documentElement;n.style.setProperty(`--cell-width`,(e||70)+`px`),n.style.setProperty(`--cell-height`,(t||28)+`px`),n.style.setProperty(`--cell-font-size`,`0.68rem`);let r=document.getElementById(`colWidthInput`),i=document.getElementById(`rowHeightInput`);r&&(r.value=e||70),i&&(i.value=t||28)}function Et(){let e=document.getElementById(`backupStatus`),t=document.getElementById(`backupStatusText`);if(!H.lastBackupAt){t.textContent=`ã¾ã ã‚ã‚Šã¾ã›ã‚“`,e.classList.remove(`overdue`);return}let n=new Date(H.lastBackupAt);if(isNaN(n.getTime())){t.textContent=`ä¸æ˜ï¼ˆå†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ï¼‰`,e.classList.add(`overdue`);return}t.textContent=Ge(n),new Date().getTime()-n.getTime()>2880*60*1e3?e.classList.add(`overdue`):e.classList.remove(`overdue`)}function Dt(){let e=document.getElementById(`statusFilterSelect`);if(!e)return;let t=H.statuses||[],n=`<option value="ALL">ã™ã¹ã¦</option>`;if(t.forEach(e=>{let t=$(e.name);n+=`<option value="${t}">${t}</option>`}),e.innerHTML=n,z!==`ALL`){let n=t.some(e=>e.name===z);e.value=n?z:`ALL`,n||(z=`ALL`)}else e.value=`ALL`}function Q(){!T&&H.projects.length&&(T=H.projects[0].id),Tt(),_t(),bt(),Z(),Et(),Dt(),Rt(),an(),cn()}function Ot(e,t,n){if(At(),!e)return;let r=document.createElement(`div`);r.className=`alt-ghost`,r.textContent=e,r.style.left=t+`px`,r.style.top=n+`px`,document.body.appendChild(r),A=r}function kt(e,t){A&&(A.style.left=e+`px`,A.style.top=t+`px`)}function At(){A&&=(A.remove(),null)}function jt(){document.querySelectorAll(`.cell`).forEach(e=>{e.addEventListener(`mousedown`,Ft),e.addEventListener(`mouseenter`,It),e.addEventListener(`mouseup`,Lt),e.addEventListener(`dblclick`,t=>{t.stopPropagation();let n=e.dataset.trackId,r=e.dataset.date;vn(n,r)})}),document.querySelectorAll(`.cell-select`).forEach(e=>{e.addEventListener(`focus`,()=>{j={rowIndex:parseInt(e.dataset.rowIndex,10),colIndex:parseInt(e.dataset.colIndex,10),trackId:e.dataset.trackId,date:e.dataset.date}})})}function Mt(){document.querySelectorAll(`.row-header-memo-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=e.dataset.trackId;hn(n,r)})}),document.querySelectorAll(`.row-header-title`).forEach(e=>{e.addEventListener(`click`,e=>{})}),document.querySelectorAll(`.project-deadline-btn`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.projectId,n=H.projects.find(e=>e.id===t);if(!n)return;let r=n.deadline||``,i=window.prompt(`ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’ YYYY-MM-DD å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºã§è§£é™¤ï¼‰`,r);if(i===null)return;let a=i.trim();if(q(),!a)delete n.deadline;else{if(!a.match(/^(\d{4})-(\d{2})-(\d{2})$/)){window.alert(`æ—¥ä»˜ã¯ YYYY-MM-DD ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹: 2025-12-31`);return}n.deadline=a}K(),Q()})})}function Nt(){document.querySelectorAll(`.project-group-row`).forEach(e=>{let t=e.dataset.projectId,n=t?H.projects.find(e=>e.id===t):null,r=e.querySelector(`.project-group-toggle`);r&&r.addEventListener(`click`,e=>{e.stopPropagation(),n&&(q(),n.collapsed=!n.collapsed,K(),Z())});let i=e.querySelector(`.project-group-name`);i&&i.addEventListener(`click`,e=>{e.stopPropagation()})})}function Pt(){document.querySelectorAll(`.row-header-cell`).forEach(e=>{let t=D&&e.dataset.trackId===D;e.classList.toggle(`track-selected`,t)}),document.querySelectorAll(`.cell`).forEach(e=>{let t=D&&e.dataset.trackId===D;e.classList.toggle(`track-selected`,t)})}function Ft(e){if(e.button!==0||e.target.closest(`.cell-dropdown-btn`))return;let t=e.currentTarget,n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10),o=Y(n,r);if(Wt(),n&&D!==n&&(D=n,Pt()),e.altKey){let t=(H.schedule[n]||{})[r]||``;k={trackId:n,date:r,value:t},Fe=!0,t&&Ot(t,e.clientX,e.clientY);return}Pe=!0,mt={rowIndex:i,colIndex:a},e.ctrlKey||e.metaKey?O.has(o)?O.delete(o):O.add(o):e.shiftKey&&j?ht({rowIndex:j.rowIndex,colIndex:j.colIndex},{rowIndex:i,colIndex:a}):(O.clear(),O.add(o)),j={rowIndex:i,colIndex:a,trackId:n,date:r},X()}function It(e){if(!Pe||!mt)return;let t=e.currentTarget,n={rowIndex:parseInt(t.dataset.rowIndex,10),colIndex:parseInt(t.dataset.colIndex,10)};ht(mt,n)}function Lt(e){let t=e.currentTarget,n=t.dataset.projectId,r=t.dataset.trackId,i=t.dataset.date,a=parseInt(t.dataset.rowIndex,10),o=parseInt(t.dataset.colIndex,10);if(Fe&&k){q();let e=k;H.schedule[r]||(H.schedule[r]={}),e.value?H.schedule[r][i]=e.value:delete H.schedule[r][i],pe(r,n),K();let a=t.querySelector(`.cell-select`);a&&(a.value=e.value||``,J(a))}Pe=!1,Fe=!1,k=null,At(),j={rowIndex:a,colIndex:o,trackId:r,date:i}}window.addEventListener(`mouseup`,()=>{Pe=!1,Fe=!1,k=null,At()}),window.addEventListener(`mousemove`,e=>{Fe&&kt(e.clientX,e.clientY)}),window.handleCellChange=function(e){let t=e.dataset.projectId,n=e.dataset.trackId,r=e.dataset.date,i=e.value,a=Y(n,r);function o(e,t,n){H.schedule[e]||(H.schedule[e]={}),n?H.schedule[e][t]=n:delete H.schedule[e][t]}if(q(),O.size>1&&O.has(a)){let e=new Set;O.forEach(t=>{let[n,r]=t.split(`|`);o(n,r,i),e.add(n)}),e.forEach(e=>pe(e))}else o(n,r,i),pe(n,t);K(),O.size>1&&O.has(a)?O.forEach(e=>{let[t,n]=e.split(`|`),r=document.querySelector(`.cell-select[data-track-id="${t}"][data-date="${n}"]`);r&&(r.value=i,J(r))}):J(e),X()};function Rt(){let e=document.getElementById(`showAllBtn`),t=document.getElementById(`showSelectedBtn`);E?(t.classList.add(`active`),e.classList.remove(`active`)):(e.classList.add(`active`),t.classList.remove(`active`))}function zt(){document.getElementById(`statusEditorOverlay`).classList.remove(`hidden`),Vt()}function Bt(){document.getElementById(`statusEditorOverlay`).classList.add(`hidden`)}function Vt(){let e=document.getElementById(`statusListContainer`);e.innerHTML=``,(!H.statuses||!Array.isArray(H.statuses)||H.statuses.length===0)&&(H.statuses=S),H.statuses.forEach(t=>{let n=document.createElement(`div`);n.className=`status-row`,n.innerHTML=`
          <input type="text" class="status-name-input" value="${$(t.name)}" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šä½œæ›²ï¼‰">
          <input type="color" class="status-color-input" value="${t.color||`#f5576c`}">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,n.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{n.remove()}),e.appendChild(n)})}function Ht(){let e=document.getElementById(`statusListContainer`),t=Array.from(e.querySelectorAll(`.status-row`)),n=[];return t.forEach(e=>{let t=e.querySelector(`.status-name-input`),r=e.querySelector(`.status-color-input`),i=t.value.trim(),a=r.value||`#f5576c`;i&&n.push({name:i,color:a})}),n.length===0?S:n}function Ut(e,t){let n=document.getElementById(`contextMenu`);n.classList.remove(`hidden`);let r=n.getBoundingClientRect(),i=e,a=t;i+r.width>window.innerWidth&&(i=window.innerWidth-r.width-4),a+r.height>window.innerHeight&&(a=window.innerHeight-r.height-4),n.style.left=i+`px`,n.style.top=a+`px`}function Wt(){document.getElementById(`contextMenu`).classList.add(`hidden`),Be=null}function Gt(e){let t=e.target.closest(`.cell`);if(!t){Wt();return}e.preventDefault();let n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10);j={rowIndex:i,colIndex:a,trackId:n,date:r},Be={rowIndex:i,colIndex:a,trackId:n,date:r},X(),Ut(e.clientX,e.clientY)}function Kt(){let e=gt();if(!e.length&&j&&N.length&&P.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=j;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}if(!e.length)return;let t=e.map(e=>e.rowIndex),n=e.map(e=>e.colIndex),r=Math.min(...t),i=Math.max(...t),a=Math.min(...n),o=Math.max(...n),s=i-r+1,c=o-a+1,l=Array.from({length:s},()=>Array.from({length:c},()=>``));e.forEach(e=>{let t=e.rowIndex-r,n=e.colIndex-a,i=e.trackId,o=e.date,s=(H.schedule[i]||{})[o]||``;l[t][n]=s}),M={data:l,width:c,height:s}}function qt(e){if(!M)return;let t=e||j;if(!t){let e=gt();if(!e.length)return;let n=e.map(e=>e.rowIndex),r=e.map(e=>e.colIndex);t={rowIndex:Math.min(...n),colIndex:Math.min(...r)}}let{data:n,width:r,height:i}=M;q();for(let e=0;e<i;e++){let i=t.rowIndex+e;if(!N[i])continue;let a=N[i].track.id;for(let i=0;i<r;i++){let r=t.colIndex+i;if(!P[r])continue;let o=W(P[r]),s=n[e][i];H.schedule[a]||(H.schedule[a]={}),s?H.schedule[a][o]=s:delete H.schedule[a][o]}}K(),Z()}function Jt(){let e=gt();if(!e.length&&j&&N.length&&P.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=j;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}e.length&&(q(),e.forEach(e=>{H.schedule[e.trackId]&&delete H.schedule[e.trackId][e.date]}),K(),Z())}function Yt(){let e=new Date;H.lastBackupAt=e.toISOString(),K(),Et();let t=JSON.stringify(H,null,2),n=new Blob([t],{type:`application/json`}),r=`schedule_backup_${e.getFullYear()}${String(e.getMonth()+1).padStart(2,`0`)}${String(e.getDate()).padStart(2,`0`)}_${String(e.getHours()).padStart(2,`0`)}${String(e.getMinutes()).padStart(2,`0`)}.json`,i=URL.createObjectURL(n),a=document.createElement(`a`);a.href=i,a.download=r,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(i)}function $(e){return e==null?``:String(e).replace(/&/g,`&amp;`).replace(/</g,`&lt;`).replace(/>/g,`&gt;`).replace(/"/g,`&quot;`).replace(/'/g,`&#039;`)}function Xt(e,t){let n=document.getElementById(`inputPopover`),r=document.getElementById(`inputPopoverTitle`),i=document.getElementById(`inputPopoverField`),a=document.getElementById(`inputPopoverOkBtn`);R.type=e,R.anchorBtn=t,e===`project`?(r.textContent=`æ–°ã—ã„æ¡ˆä»¶å`,a.textContent=`è¿½åŠ `):e===`track`&&(r.textContent=`æ–°ã—ã„æ›²å`,a.textContent=`è¿½åŠ `),i.value=``,n.classList.remove(`hidden`);let o=t.getBoundingClientRect();n.style.left=o.left+`px`,n.style.top=o.bottom+6+`px`;let s=n.getBoundingClientRect(),c=o.left,l=o.bottom+6;c+s.width>window.innerWidth-8&&(c=window.innerWidth-s.width-8),l+s.height>window.innerHeight-8&&(l=o.top-s.height-6),n.style.left=c+`px`,n.style.top=l+`px`,i.focus(),i.select()}function Zt(){document.getElementById(`inputPopover`).classList.add(`hidden`),R.type=null,R.anchorBtn=null}function Qt(){let e=document.getElementById(`inputPopoverField`).value.trim();if(!e){Zt();return}R.type===`project`?$t(e):R.type===`track`&&en(e),Zt()}function $t(e){q();let t={id:Ke(),name:e.trim(),color:`#62c3ff`,tracks:[]};H.projects.push(t),T=t.id,K(),Q()}function en(e){if(!T){window.alert(`ã¾ãšå·¦ã®æ¡ˆä»¶ãƒªã‚¹ãƒˆã‹ã‚‰ã€æ›²ã‚’è¿½åŠ ã—ãŸã„æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);return}let t=H.projects.find(e=>e.id===T);if(!t){window.alert(`é¸æŠä¸­ã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);return}q();let n={id:Ke(),name:e.trim()};t.tracks.push(n),K(),Q()}function tn(e){let t=H.schedule[e];if(!t)return null;let n=null;return Object.keys(t).forEach(e=>{let t=Ue(e);isNaN(t.getTime())||(!n||t<n)&&(n=t)}),n}function nn(){q(),H.projects.forEach(e=>{!e.tracks||e.tracks.length<=1||e.tracks.sort((e,t)=>{let n=tn(e.id),r=tn(t.id);if(n&&r){let i=n-r;return i===0?e.name.localeCompare(t.name,`ja`):i}else if(n&&!r)return-1;else if(!n&&r)return 1;else return e.name.localeCompare(t.name,`ja`)})}),K(),Q()}function rn(e){B=e,document.body.classList.toggle(`client-view-mode`,B),an()}function an(){let e=document.getElementById(`clientViewToggleBtn`);e&&(e.style.display=``,B?(e.classList.add(`active`),e.textContent=`ğŸ‘ é€šå¸¸ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹`):(e.classList.remove(`active`),e.textContent=`ğŸ‘ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼`));let t=document.getElementById(`clientViewBanner`);t&&t.classList.toggle(`hidden`,!B);let n=document.getElementById(`clientViewBackBtn`);n&&(n.style.display=``)}function on(){document.querySelectorAll(`.cell`).forEach(e=>{if(e.classList.remove(`dim`),z&&z!==`ALL`){let t=e.dataset.status||``;(!t||t!==z)&&e.classList.add(`dim`)}})}function sn(){document.querySelectorAll(`[data-nav-href]`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.getAttribute(`data-nav-href`);t&&(location.href=t)})});let e=document.getElementById(`addTrackBtn`);e.addEventListener(`click`,()=>{Xt(`track`,e)});let t=document.getElementById(`settingsMenuBtn`),n=document.getElementById(`settingsPopover`);t&&n&&(t.addEventListener(`click`,e=>{e.stopPropagation(),n.classList.toggle(`settings-closed`)}),document.addEventListener(`click`,e=>{n.classList.contains(`settings-closed`)||!e.target.closest(`#settingsPopover`)&&!e.target.closest(`#settingsMenuBtn`)&&n.classList.add(`settings-closed`)})),document.getElementById(`autoStairSortBtn`).addEventListener(`click`,()=>{nn()}),document.getElementById(`showAllBtn`).addEventListener(`click`,()=>{E=!1,Rt(),Q()}),document.getElementById(`showSelectedBtn`).addEventListener(`click`,()=>{E=!0,Rt(),Q()}),document.getElementById(`prevRangeBtn`).addEventListener(`click`,()=>{let e=H.daysToShow||C,t=G(Ue(H.startDate),-e);q(),H.startDate=W(t),K(),Q()}),document.getElementById(`nextRangeBtn`).addEventListener(`click`,()=>{let e=H.daysToShow||C,t=G(Ue(H.startDate),e);q(),H.startDate=W(t),K(),Q()});let r=document.getElementById(`themeToggleBtn`);r&&r.addEventListener(`click`,()=>{dn(H.settings&&H.settings.theme===`light`?`dark`:`light`)});let i=document.getElementById(`tagToggleBtn`);i&&i.addEventListener(`click`,()=>{pn(!!(H.settings&&H.settings.showProjectTags===!1))}),document.getElementById(`exportBtn`).addEventListener(`click`,()=>{Yt()}),document.getElementById(`importInput`).addEventListener(`change`,e=>{let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=t=>{try{let e=t.target.result;H=Je(JSON.parse(e)),V=[],O.clear(),j=null,M=null,K(),un(H.settings.theme),fn(H.settings.showProjectTags),Q(),window.alert(`JSONã‹ã‚‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`)}catch(e){console.error(e),window.alert(`JSONã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚`)}finally{e.target.value=``}},n.readAsText(t,`utf-8`)}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.cell-dropdown-btn`);if(!t)return;let n=t.closest(`.cell`);if(!n)return;let r=n.querySelector(`.cell-select`);if(r)if(typeof r.showPicker==`function`)r.showPicker();else{r.focus();let e=new MouseEvent(`mousedown`,{bubbles:!0,cancelable:!0,view:window});r.dispatchEvent(e),r.click()}}),document.addEventListener(`contextmenu`,Gt),document.addEventListener(`mousedown`,e=>{document.getElementById(`contextMenu`).classList.contains(`hidden`)||e.target.closest(`#contextMenu`)||Wt(),document.getElementById(`inputPopover`).classList.contains(`hidden`)||!e.target.closest(`#inputPopover`)&&!e.target.closest(`#addProjectBtn`)&&!e.target.closest(`#addTrackBtn`)&&Zt()}),window.addEventListener(`scroll`,()=>{Wt()},!0),document.querySelectorAll(`#contextMenu .context-menu-item`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.action;t===`copy`?Kt():t===`paste`?qt(Be||j||null):t===`clear`&&Jt(),Wt()})});let a=document.getElementById(`statusFilterSelect`);a.addEventListener(`change`,()=>{z=a.value,on()}),document.getElementById(`undoBtn`).addEventListener(`click`,()=>{lt()});let o=document.getElementById(`clientViewToggleBtn`);o&&o.addEventListener(`click`,()=>{rn(!B)});let s=document.getElementById(`clientViewBackBtn`);s&&s.addEventListener(`click`,()=>{rn(!1)}),document.addEventListener(`keydown`,e=>{let t=e.ctrlKey||e.metaKey,n=e.target,r=n.tagName,i=r===`SELECT`&&n.classList.contains(`cell-select`),a=(r===`INPUT`||r===`TEXTAREA`||n.isContentEditable)&&!i;if(!document.getElementById(`inputPopover`).classList.contains(`hidden`)){if(e.key===`Enter`){e.preventDefault(),Qt();return}if(e.key===`Escape`){e.preventDefault(),Zt();return}}if(t&&(e.key===`s`||e.key===`S`)){e.preventDefault(),Yt();return}if(t&&(e.key===`c`||e.key===`C`)){e.preventDefault(),Kt();return}if(t&&(e.key===`v`||e.key===`V`)){e.preventDefault(),qt();return}if(t&&(e.key===`z`||e.key===`Z`)){if(a)return;e.preventDefault(),lt();return}if(e.key===`Delete`||e.key===`Backspace`){if(a)return;e.preventDefault(),Jt();return}});let c=document.getElementById(`colWidthInput`),l=document.getElementById(`rowHeightInput`);c&&c.addEventListener(`change`,()=>{let e=parseInt(c.value,10);isNaN(e)&&(e=70),e=Math.max(20,Math.min(200,e)),q(),H.settings.cellWidth=e,K(),Tt(),Z()}),l&&l.addEventListener(`change`,()=>{let e=parseInt(l.value,10);isNaN(e)&&(e=28),e=Math.max(14,Math.min(80,e)),q(),H.settings.cellHeight=e,K(),Tt(),Z()});let u=document.getElementById(`daysToShowInput`);u&&u.addEventListener(`change`,()=>{let e=parseInt(u.value,10);isNaN(e)&&(e=C),e=Math.max(7,Math.min(90,e)),q(),H.daysToShow=e,K(),Q()}),document.getElementById(`editStatusesBtn`).addEventListener(`click`,()=>{zt()}),document.getElementById(`closeStatusEditorBtn`).addEventListener(`click`,()=>{Bt()}),document.getElementById(`addStatusRowBtn`).addEventListener(`click`,()=>{let e=document.getElementById(`statusListContainer`),t=document.createElement(`div`);t.className=`status-row`,t.innerHTML=`
          <input type="text" class="status-name-input" value="" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šãƒªãƒŸãƒƒã‚¯ã‚¹ï¼‰">
          <input type="color" class="status-color-input" value="#f5576c">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,t.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{t.remove()}),e.appendChild(t)}),document.getElementById(`saveStatusesBtn`).addEventListener(`click`,()=>{let e=Ht();q(),H.statuses=e,K(),Bt(),Q()}),document.getElementById(`statusEditorOverlay`).addEventListener(`click`,e=>{e.target.id===`statusEditorOverlay`&&Bt()}),document.getElementById(`inputPopoverCancelBtn`).addEventListener(`click`,()=>{Zt()}),document.getElementById(`inputPopoverOkBtn`).addEventListener(`click`,()=>{Qt()}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.row-header-memo-btn`);if(!t)return;e.stopPropagation();let n=t.dataset.projectId,r=t.dataset.trackId;hn(n,r)}),document.addEventListener(`click`,e=>{let t=e.target;if(t.id===`trackMemoSaveBtn`){e.preventDefault(),_n();return}if(t.id===`trackMemoCancelBtn`){e.preventDefault(),gn();return}if(t.id===`trackMemoOverlay`){e.preventDefault(),gn();return}if(t.id===`cellNoteSaveBtn`){e.preventDefault(),bn();return}if(t.id===`cellNoteCloseBtn`){e.preventDefault(),yn();return}if(t.id===`cellNoteOverlay`){e.preventDefault(),yn();return}}),document.getElementById(`heatmapToggleBtn`)?.addEventListener(`click`,()=>{H.settings||={},q(),H.settings.heatmapEnabled=!H.settings.heatmapEnabled,K(),Q()})}function cn(){let e=document.getElementById(`heatmapToggleBtn`);e&&(H.settings&&H.settings.heatmapEnabled?(e.classList.add(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ON`):(e.classList.remove(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—OFF`))}function ln(e){let t=document.getElementById(`themeToggleBtn`);if(!t)return;let n=(e||H.settings&&H.settings.theme||`dark`)===`light`;t.textContent=n?`ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰`:`â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰`,t.classList.toggle(`active`,n)}function un(e){let t=e===`light`?`light`:`dark`;document.body.classList.toggle(`theme-light`,t===`light`),document.body.classList.toggle(`theme-dark`,t===`dark`),document.documentElement.style.colorScheme=t===`light`?`light`:`dark`,ln(t),typeof styleAllCellSelect==`function`&&styleAllCellSelect()}function dn(e){xn();let t=e===`light`?`light`:`dark`;localStorage.setItem(Ne,t),H.settings.theme=t,K(),un(t),Q()}function fn(e){let t=e!==!1;document.body.classList.toggle(`hide-row-tags`,!t),mn(t)}function pn(e){xn(),H.settings.showProjectTags=!!e,K(),fn(e)}function mn(e){let t=document.getElementById(`tagToggleBtn`);if(!t)return;let n=e!==!1;t.textContent=n?`ğŸ· ã‚¿ã‚°éè¡¨ç¤º`:`ğŸ· ã‚¿ã‚°è¡¨ç¤º`,t.classList.toggle(`active`,n)}function hn(e,t){I.projectId=e,I.trackId=t;let n=H.projects.find(t=>t.id===e),r=n?.tracks.find(e=>e.id===t);if(!n||!r)return;let i=document.getElementById(`trackMemoOverlay`),a=document.getElementById(`trackMemoTitle`),o=document.getElementById(`trackMemoText`);a.textContent=`${$(n.name)} - ${$(r.name)}`,o.value=r.memo||``,i.classList.remove(`hidden`),o.focus()}function gn(){let e=document.getElementById(`trackMemoOverlay`);e&&e.classList.add(`hidden`),I.projectId=null,I.trackId=null}function _n(){if(!I.projectId||!I.trackId)return;let e=H.projects.find(e=>e.id===I.projectId),t=e?.tracks.find(e=>e.id===I.trackId);if(!e||!t){gn();return}let n=document.getElementById(`trackMemoText`).value.trim();q(),t.memo=n,fe(I.projectId),K(),gn(),Z()}function vn(e,t){L.trackId=e,L.dateIso=t;let n=document.getElementById(`cellNoteOverlay`),r=document.getElementById(`cellNoteTitle`),i=document.getElementById(`cellNoteTextarea`),a=Y(e,t),o=H.cellNotes[a]||``;r.textContent=`${t} ã®ãƒ¡ãƒ¢`,i.value=o,n.classList.remove(`hidden`),i.focus()}function yn(){let e=document.getElementById(`cellNoteOverlay`);e&&e.classList.add(`hidden`),L.trackId=null,L.dateIso=null}function bn(){if(!L.trackId||!L.dateIso)return;let e=document.getElementById(`cellNoteTextarea`).value.trim(),t=Y(L.trackId,L.dateIso);q(),e?H.cellNotes[t]=e:delete H.cellNotes[t],pe(L.trackId),K(),yn(),Z()}function xn(){H.settings||={}}function Sn(){xn();let e=new Date,t=W(U(e)),n=H.settings.lastRollDate||null;(e.getHours()>4||e.getHours()===4&&e.getMinutes()>=0)&&n!==t&&(q(),H.startDate=t,H.settings.lastRollDate=t,K())}function Cn(){Sn(),setInterval(Sn,60*1e3)}function wn(){Tt()}sn(),wn(),window.addEventListener(`resize`,Ct),window.addEventListener(`resize`,wt),(function(){(l===`light`||l===`dark`)&&dn(l),window.addEventListener(`message`,e=>{let t=e.data;!t||typeof t!=`object`||t.type===`SET_THEME`&&(t.theme===`light`||t.theme===`dark`)&&dn(t.theme)})})(),Cn(),Q();