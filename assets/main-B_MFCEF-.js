import{A as e,C as t,D as n,E as r,O as i,S as a,T as o,_ as s,b as c,d as l,g as u,h as d,k as f,n as p,o as m,p as ee,r as h,u as g,v as _,w as te,y as ne}from"./index.esm-B0-OTnKT.js";/* empty css              *//* empty css                      */import{t as re}from"./tabulator_esm-D-Igvjbx.js";var ie=f().length?i():e({apiKey:`AIzaSyCCp7D78NDqKR2c8cbb29BUUE_5qBOaI_U`,authDomain:`msheet-b7efc.firebaseapp.com`,projectId:`msheet-b7efc`,storageBucket:`sheet-b7efc.firebasestorage.app`,messagingSenderId:`398789467878`,appId:`1:398789467878:web:67a33361881568c6b96527`}),ae=te(ie),v=ee(ie),oe=new t,se=`/music-sheet/index.html`,y=e=>document.getElementById(e),b=e=>y(`msg`).textContent=e||``,ce=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);function x(e){return!!e?.email&&ce.includes(e.email)}var S=localStorage.getItem(`debugGuestMode`)===`1`;function C(){return!!A&&x(A)&&!S}function le(){return!!A&&!C()}function w(e){return A?C()?!0:e===`reference`:!1}function T(){return!!A&&(C()||le())}function ue(){return C()}function E(){return A?.displayName||A?.email||A?.uid||``}var de=y(`lastUpdated`),fe=null,pe=``,me=null,he=``;function D(e){return e?e?.seconds==null?e instanceof Date?e.getTime():0:e.seconds*1e3+(e.nanoseconds||0)/1e6:0}function ge(e,t){if(!de)return;if(!e){de.textContent=`更新: --`;return}let n=_e(t),r=e?.toDate?e.toDate():e instanceof Date?e:null;de.textContent=`更新: ${[r?r.toLocaleString():``,n].filter(Boolean).join(` `)||`--`}`}function _e(e){let t=String(e||``).trim();return t?t.includes(`@`)?t.split(`@`)[0]:t:``}function ve(){D(fe)>=D(me)?ge(fe,pe):ge(me,he)}function O(e,t=40){let n=String(e||``).replace(/\s+/g,` `).trim();return n?n.length>t?`${n.slice(0,t)}…`:n:``}function ye(e){let t=(Array.isArray(e)?e:[]).filter(e=>!(e?.archived||e?.archivedAt));return t.length&&t.reduce((e,t)=>(e?.at?.seconds||0)>=(t?.at?.seconds||0)?e:t)?.text||``}function be(e,t,n){return O(ye(e)||t||``,n)}var xe=[{value:`wip`,label:`wip`,color:`#f59e0b`},{value:`rev`,label:`rev`,color:`#60a5fa`},{value:`fix`,label:`fix`,color:`#2dd4bf`}],k=[...xe],Se=new Map,Ce=null;function we(){Se=new Map(k.map(e=>[e.value,e]))}function Te(e){let t=Se.get(e);return e?t?`<span class="tagPill" style="background:${t.color+`22`};border-color:${t.color+`55`};color:var(--tag-text)">${t.label}</span>`:`<span class="tagPill">${e}</span>`:`<span class="tagPill">—</span>`}function Ee(e){let t=String(e||``).split(`-`).map(e=>parseInt(e,10));if(t.length<3||t.some(e=>Number.isNaN(e)))return null;let[n,r,i]=t;return new Date(n,r-1,i)}function De(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?``:`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)}`}function Oe(e){if(!e||!e.status)return`<span class="muted">—</span>`;let t=e.color||`#6fd6ff`;return`<span class="tagPill" style="background:${t+`22`};border-color:${t+`55`};color:var(--tag-text)">${X(`${e.dateLabel||e.date||``} ${e.status}`.trim())}</span>`}async function ke(e,t){if(!e||!t)return!1;if(x(t))return!0;let n=t?.uid;if(n)try{if((await l(g(v,`projects`,e,`members`,n))).exists())return!0}catch(e){e?.code!==`permission-denied`&&console.warn(`member access check failed`,e)}try{let r=await l(g(v,`projects`,e));if(!r.exists())return!1;let i=r.data()||{};if(i.deleted)return!1;if(n&&Array.isArray(i.members)&&i.members.includes(n)||n&&i?.roleByUid&&i.roleByUid[n])return!0;let a=String(t?.email||``).trim().toLowerCase();return!!(a&&String(i.ownerEmail||``).trim().toLowerCase()===a)}catch(e){return e?.code!==`permission-denied`&&console.warn(`project access check failed`,e),!1}}function Ae(e){return`
    <div class="ddCell">
      <div class="ddValue">${e||`<span class="muted">&mdash;</span>`}</div>
      <button class="ddBtn" type="button" tabindex="-1">&#9662;</button>
    </div>
  `}function je(e,t,n,r,i){let a=typeof i==`function`?i(e):i||{},o=a.values??a,s=document.createElement(`select`);s.className=`sheetSelect`,s.style.width=`100%`,s.style.height=`28px`,s.style.borderRadius=`8px`,s.style.border=`1px solid var(--line)`,s.style.background=`var(--panel)`,s.style.color=`var(--text)`;let c=(e,t)=>{let n=document.createElement(`option`);n.value=e??``,n.textContent=t??``,s.appendChild(n)};return c(``,``),Array.isArray(o)?o.forEach(e=>{e&&typeof e==`object`?c(e.value??e.label??``,e.label??e.value??``):c(e,e)}):o&&typeof o==`object`&&Object.entries(o).forEach(([e,t])=>c(e,t)),s.value=e.getValue()??``,t(()=>{s.focus()}),s.addEventListener(`change`,()=>n(s.value)),s.addEventListener(`blur`,()=>r()),s.addEventListener(`keydown`,e=>{e.key===`Enter`&&(e.preventDefault(),n(s.value)),e.key===`Escape`&&(e.preventDefault(),r())}),s}var Me=[{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}],Ne=new Map(Me.map(e=>[e.value,e]));function Pe(e){if(!e)return`<span class="tagPill">&mdash;</span>`;let t=Ne.get(e);return t?`<span class="tagPill" style="background:${t.color}22;border-color:${t.color}55;color:var(--tag-text)">${t.label}</span>`:`<span class="tagPill">${e}</span>`}function Fe(){let e=y(`f_len`);e&&(e.innerHTML=`<option value=""></option>`+Me.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``))}function Ie(){we();let e=y(`f_status`);e&&(e.innerHTML=`<option value=""></option>`+k.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``));let t=y(`statusFilter`);if(t){let e=t.value;t.innerHTML=`<option value="">進捗：すべて</option>`+k.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``),t.value=e}if(Ge(),Xe)try{L.updateColumnDefinition(`status`,{title:`進捗`,field:`status`,width:130,formatter:e=>Ae(Te(e.getValue())),editor:je,editable:()=>w(`status`),editorParams:()=>{let e={};return k.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),w(`status`)&&t.edit(!0)}})}catch{}}function Le(){y(`overlay`).classList.remove(`hidden`),y(`statusModal`).classList.remove(`hidden`),ze(),$e(),V(),H()}function Re(){y(`overlay`).classList.add(`hidden`),y(`statusModal`).classList.add(`hidden`)}function ze(){let e=y(`statusList`);e.innerHTML=``;let t=C();if(k.forEach((n,r)=>{let i=document.createElement(`div`);i.className=`statusRow`,i.innerHTML=`
      <input type="text" value="${n.label||n.value||``}" data-k="label" data-i="${r}" placeholder="表示名" ${t?``:`disabled`} />
      <input type="color" value="${n.color}" data-k="color" data-i="${r}" ${t?``:`disabled`} />
      <button class="smallBtn" data-act="del" data-i="${r}" ${t?``:`disabled`}>削除</button>
    `,e.appendChild(i)}),!t){e.oninput=null,e.onclick=null;return}e.oninput=e=>{let t=e.target,n=Number(t?.dataset?.i),r=t?.dataset?.k;if(!(Number.isNaN(n)||!r)){if(r===`label`){let e=t.value;k[n]={...k[n],label:e,value:e};return}k[n]={...k[n],[r]:t.value}}},e.onclick=e=>{let t=e.target?.closest(`button`);if(t&&t.dataset.act===`del`){let e=Number(t.dataset.i);k.splice(e,1),ze()}}}async function Be(){if(!C()){b(`管理者のみ変更できます`);return}k=k.map(e=>{let t=(e.label||e.value||``).trim(),n=t;return{...e,label:t,value:n}}).filter(e=>e.value&&e.label);let e=new Set;k=k.filter(t=>e.has(t.value)?!1:(e.add(t.value),!0)),await ne(g(v,`projects`,j,`settings`,`ui`),{statuses:k,fpsDefault:y(`fpsDefault`)?.value||`24`,updatedAt:_(),updatedBy:E()},{merge:!0}),Ie(),Re(),b(`進捗設定を保存しました`)}function Ve(e){Ce&&Ce();let t=g(v,`projects`,e,`settings`,`ui`);Ce=d(t,async e=>{if(e.exists()){let t=e.data();t?.updatedAt&&(me=t.updatedAt,he=t.updatedBy||``,ve()),k=Array.isArray(t.statuses)&&t.statuses.length?t.statuses:[...xe];let n=String(t.fpsDefault??`24`);y(`fpsDefault`)&&(y(`fpsDefault`).value=n),window.__FPS_DEFAULT__=n}else k=[...xe],y(`fpsDefault`)&&(y(`fpsDefault`).value=`24`),window.__FPS_DEFAULT__=`24`,C()&&await ne(t,{statuses:k,fpsDefault:`24`,createdAt:_()},{merge:!0});Ie()},e=>{console.error(e),b(`設定同期エラー: ${e.code||e.message}`)})}function He(e){I=new Map,(e?.statuses||[]).forEach(e=>{!e||!e.name||I.set(e.name,e.color||`#6fd6ff`)});let t=e?.schedule||{},n=new Date;n.setHours(0,0,0,0);let r=new Map;Object.keys(t).forEach(e=>{let i=t[e];if(!i||typeof i!=`object`)return;let a=null;if(Object.keys(i).forEach(e=>{let t=i[e];if(!t||t===`none`)return;let r=Ee(e);r&&(r<n||(!a||r<a.dt)&&(a={dt:r,dateStr:e,status:t}))}),!a)return;let o=I.get(a.status)||`#6fd6ff`;r.set(e,{status:a.status,date:a.dateStr,dateLabel:De(a.dt),color:o})}),F=r}function Ue(){if(!L||!L.getData)return;let e=L.getData();if(!e.length)return;let t=e.map(e=>({id:e.id,nextSchedule:F.get(e.id)||null}));L.updateData(t)}function We(e){if(P&&P(),F=new Map,I=new Map,!e){Ue();return}P=d(g(v,`projects`,e,`scheduleBoard`,`state`),e=>{if(!e.exists()){F=new Map,I=new Map,Ue();return}let t=e.data()||{};He(t.state||t),Ue()},e=>{console.error(e)})}function Ge(){let e=y(`f_status`)?.value||``;y(`statusTagPreview`).outerHTML=`<span id="statusTagPreview" class="tagPill">${Se.get(e)?.label||e||`—`}</span>`}var A=null,Ke=new URLSearchParams(location.search),qe=(Ke.get(`project`)||``).trim(),Je=(Ke.get(`cue`)||``).trim();qe&&(y(`projectId`).value=qe,y(`projectId`).disabled=!0,localStorage.setItem(`lastProject`,qe));var j=y(`projectId`).value.trim(),M=null,N=null;Je&&(N=Je);var Ye=!1,P=null,F=new Map,I=new Map,Xe=!1,L=new re(`#grid`,{height:`100%`,layout:`fitColumns`,rowHeight:40,selectable:!0,selectableRangeMode:`click`,movableRows:!0,index:`id`,columns:[{formatter:`handle`,field:`__handle`,width:34,hozAlign:`center`,headerSort:!1,rowHandle:!0,frozen:!0},{title:`#M`,field:`m`,width:70,headerSort:!0,frozen:!0},{title:`V`,field:`v`,width:55,editor:`input`,editable:()=>w(`v`),frozen:!0},{title:`demo`,field:`demo`,width:80,editor:`input`,editable:()=>w(`demo`),frozen:!0},{title:`scene`,field:`scene`,minWidth:180,editor:`input`,editable:()=>w(`scene`)},{title:`長さ`,field:`len`,width:120,formatter:e=>Ae(Pe(e.getValue())),editor:je,editable:()=>w(`len`),editorParams:()=>{let e={};return Me.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),w(`len`)&&t.edit(!0)}},{title:`進捗`,field:`status`,width:130,formatter:e=>Ae(Te(e.getValue())),editor:je,editable:()=>w(`status`),editorParams:()=>{let e={};return k.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),w(`status`)&&t.edit(!0)}},{title:`直近予定`,field:`nextSchedule`,width:180,headerSort:!1,formatter:e=>Oe(e.getValue())},{title:`監督FB(省略)`,field:`director`,minWidth:220,headerSort:!1,formatter:e=>{let t=e.getData();return be(t.directorLog,t.director,40)}},{title:`コメント(省略)`,field:`commentLog`,minWidth:220,headerSort:!1,formatter:e=>{let t=e.getData();return be(t.commentLog,t.comment,40)}},{title:`参考曲`,field:`reference`,minWidth:200,headerSort:!1,editor:`input`,editable:()=>w(`reference`),formatter:gt},{title:`更新`,field:`updatedAt`,width:190,headerSort:!1,formatter:e=>{let t=e.getData(),n=t.updatedAt?.toDate?t.updatedAt.toDate():null;return`<div style="font-size:12px;line-height:1.15">
          <div>${n?n.toLocaleString():``}</div><div style="opacity:.75">${t.updatedBy||``}</div>
        </div>`}},{title:`IN TC`,field:`in`,width:110,editor:`input`,editable:()=>w(`in`)},{title:`OUT TC`,field:`out`,width:110,editor:`input`,editable:()=>w(`out`)},{title:`INT TC`,field:`interval`,width:110,headerSort:!1}]});L.on(`tableBuilt`,()=>{Xe=!0,Ie(),H()}),Fe();var R=!1,z=!1,B=[],Ze=50,Qe=new Set([`status`,`len`,`scene`,`demo`,`in`,`out`]);function $e(){let e=y(`toggleBulk`);e&&(e.checked=R);let t=y(`bulkState`);t&&(t.textContent=R?`ON`:`OFF`)}function et(e){R=!!e,$e()}y(`toggleBulk`)?.addEventListener(`change`,()=>{if(!C()){et(!1);return}et(y(`toggleBulk`).checked)});function V(){let e=y(`toggleGuest`);if(!e)return;e.checked=S,e.disabled=!x(A);let t=y(`guestState`);t&&(t.textContent=S?`ON`:`OFF`)}function tt(e){S=!!e,localStorage.setItem(`debugGuestMode`,S?`1`:`0`),V(),H()}y(`toggleGuest`)?.addEventListener(`change`,()=>{if(!x(A)){V();return}tt(y(`toggleGuest`).checked)});function H(){let e=x(A),t=C(),n=!!A&&!t,r=y(`btnSettings`);r&&(r.style.display=e?``:`none`);let i=y(`btnAddRow`);i&&(i.style.display=t?``:`none`);let a=y(`btnDeleteRow`);a&&(a.style.display=t?``:`none`);let o=y(`btnUndo`);o&&(o.style.display=t?``:`none`),t||et(!1);let s=y(`toggleBulk`);s&&(s.disabled=!t),$e();let c=y(`fpsDefault`);c&&(c.disabled=!t);let l=y(`f_director_new`);l&&(l.disabled=!T());let u=y(`btnAddDirectorFB`);u&&(u.disabled=!T());let d=y(`f_comment_new`);d&&(d.disabled=n||!A);let f=y(`btnAddComment`);f&&(f.disabled=n||!A);let p=y(`f_reference`);p&&(p.disabled=!A);let m=y(`f_reference_shared`);m&&(m.disabled=!A),[`f_len`,`f_status`,`f_note`,`f_in`,`f_out`].forEach(e=>{let t=y(e);t&&(t.disabled=n)});let ee=y(`statusList`);ee&&ee.querySelectorAll(`input, button`).forEach(e=>{e.disabled=!t});let h=y(`btnAddStatus`);h&&(h.disabled=!t);let g=y(`btnSaveStatuses`);if(g&&(g.disabled=!t),V(),Xe)try{L.updateColumnDefinition(`__handle`,{visible:t})}catch{}if(U){let e=L.getRow(U)?.getData?.()||{};J(e.directorLog||[]),Y(e.commentLog||[])}}y(`btnUndo`)?.addEventListener(`click`,()=>{rt().catch(console.error)});async function nt(e,{pushUndo:t=!0}={}){if(!e||e.length===0)return;let n=a(v),r=E();for(let t of e){let e=g(v,`projects`,j,`cues`,t.id);n.update(e,{...t.after,updatedAt:_(),updatedBy:r})}await n.commit(),t&&(B.push(e.map(e=>({id:e.id,before:{...e.before},after:{...e.after}}))),B.length>Ze&&B.shift())}async function rt(){if(!A){b(`ログインしてね`);return}if(!C()){b(`管理者のみ利用できます`);return}let e=B.pop();if(!e){b(`Undoできる操作がありません`);return}let t=a(v),n=E();for(let r of e){let e=g(v,`projects`,j,`cues`,r.id);t.update(e,{...r.before,updatedAt:_(),updatedBy:n})}await t.commit(),b(`Undoしました`),setTimeout(()=>b(``),800)}L.on(`cellEdited`,async e=>{if(!z)try{let t=e.getRow().getData();if(!t?.id)return;if(!A){b(`ログインしてね（保存できない）`);return}let n=e.getField(),r=e.getValue(),i=e.getOldValue?.()??t[n],a=window.__FPS_DEFAULT__||`24`;if(!w(n)){z=!0,e.setValue(i,!0),z=!1,b(`ゲストは監督FBと参考曲のみ編集できます`),setTimeout(()=>b(``),900);return}n===`reference`&&U===t.id&&q(r??``);let o=L.getSelectedRows().map(e=>e.getData()).filter(e=>e?.id),s=R&&o.length>=2&&Qe.has(n),c=n===`in`||n===`out`;if(s){z=!0;let e=o.map(e=>{let o={[n]:e.id===t.id?i:e[n]??``},s={[n]:r};if(c){let t=Z(n===`in`?r:e.in||``,n===`out`?r:e.out||``,a);o.interval=e.interval??``,s.interval=t}return{id:e.id,before:o,after:s}});o.forEach(e=>{if(e.id===t.id)return;let i=L.getRow(e.id);if(i?.getCell(n)?.setValue(r,!0),c){let t=Z(n===`in`?r:e.in||``,n===`out`?r:e.out||``,a);i?.getCell(`interval`)?.setValue(t,!0)}}),z=!1,await nt(e,{pushUndo:!0}),b(`一括反映しました（${o.length}行）`),setTimeout(()=>b(``),900);return}let l={[n]:i},u={[n]:r};if(c){let e=Z(n===`in`?r:t.in||``,n===`out`?r:t.out||``,a);l.interval=t.interval??``,u.interval=e,L.getRow(t.id)?.getCell(`interval`)?.setValue(e,!0)}await nt([{id:t.id,before:l,after:u}],{pushUndo:!0}),b(`保存しました`),setTimeout(()=>b(``),800)}catch(e){console.error(e),b(`保存エラー: ${e.code||e.message}`)}});function it(){let e=L?.getData?.()||[],t=0;for(let n of e){let e=parseInt((n.m??n.M??n[`#M`]??``).toString(),10);Number.isNaN(e)||(t=Math.max(t,e))}return String(t+1)}var U=null;function W(e){if(!e){U=null,y(`selMeta`)&&(y(`selMeta`).textContent=`行を選択すると表示されます`,y(`selMeta`).classList.add(`selMetaEmpty`)),J([]),Y([]),y(`f_director_new`).value=``,y(`f_comment_new`).value=``,q(``),y(`f_in`).value=``,y(`f_out`).value=``,y(`f_interval`).value=``;return}let t=e.getData();if(U=t.id,y(`selMeta`)){let e=[];t.m!=null&&String(t.m).trim()!==``&&e.push(`#M ${t.m}`),t.demo&&e.push(String(t.demo).trim());let n=e.length?e.join(` / `):`選択中の行`;y(`selMeta`).textContent=`選択中: ${n}`,y(`selMeta`).classList.remove(`selMetaEmpty`)}y(`f_m`)&&(y(`f_m`).value=t.m??``),y(`f_v`)&&(y(`f_v`).value=t.v??``),y(`f_demo`)&&(y(`f_demo`).value=t.demo??``),y(`f_scene`)&&(y(`f_scene`).value=t.scene??``),y(`f_status`).value=t.status??``,y(`f_len`).value=t.len??``,y(`f_note`).value=t.note??``,q(t.reference??``),y(`f_in`).value=t.in??``,y(`f_out`).value=t.out??``;let n=window.__FPS_DEFAULT__||`24`;y(`f_interval`).value=t.interval??Z(t.in||``,t.out||``,n),J(t.directorLog||[]),Y(t.commentLog||[]),y(`f_director_new`).value=``,y(`f_comment_new`).value=``}var at=Array.from(document.querySelectorAll(`.insTab`)),ot=Array.from(document.querySelectorAll(`.insTabPanel`));function st(e,{persist:t=!0}={}){if(!e)return;let n=!1;at.forEach(t=>{let r=t.dataset.tab===e;r&&(n=!0),t.classList.toggle(`is-active`,r)}),ot.forEach(t=>{let n=t.dataset.tab===e;t.classList.toggle(`is-active`,n)}),n&&t&&localStorage.setItem(`inspectorTab`,e)}document.addEventListener(`click`,e=>{let t=e.target?.closest?.(`.insTab`);if(!t)return;let n=t.dataset.tab;st(n)});var ct=localStorage.getItem(`inspectorTab`);ct&&st(ct,{persist:!1});function lt(e){let t=String(e||``).match(/https?:\/\/[^\s<>"']+/g);return t?[...new Set(t)]:[]}function G(e){try{let t=new URL(e);if(t.hostname===`youtu.be`)return t.pathname.slice(1)||null;if(t.hostname.includes(`youtube.com`)){let e=t.searchParams.get(`v`);if(e)return e;let n=t.pathname.match(/\/shorts\/([^\/]+)/);if(n)return n[1];let r=t.pathname.match(/\/embed\/([^\/]+)/);if(r)return r[1]}}catch{}return null}function ut(e){let t=lt(e).slice(0,4);return t.length===0?``:`<div class="linkPreviewGrid">${t.map(e=>{let t=G(e);return t?`
        <a class="linkCard" href="${e}" target="_blank" rel="noopener">
          <img class="linkThumb" src="${`https://img.youtube.com/vi/${t}/hqdefault.jpg`}" loading="lazy" alt="YouTube">
          <div class="linkMeta">
            <div class="linkTitle">YouTube</div>
            <div class="linkUrl">${X(e)}</div>
          </div>
        </a>`:`
      <a class="linkCard" href="${e}" target="_blank" rel="noopener">
        <div class="linkMeta">
          <div class="linkTitle">リンク</div>
          <div class="linkUrl">${X(e)}</div>
        </div>
      </a>`}).join(``)}</div>`}var dt=new Map,K=new Set;function ft(e){let t=String(e||``).trim();if(!t)return``;try{return new URL(t).toString()}catch{return t}}function pt(e){if(G(e))return`YouTube`;try{let t=new URL(e).hostname.replace(/^www\./,``);return t.includes(`spotify.com`)?`Spotify`:t.includes(`music.apple.com`)?`Apple Music`:t||`Link`}catch{return`Link`}}async function mt(e){let t=encodeURIComponent(e),n=G(e),r=/spotify\.com/i.test(e),i=/music\.apple\.com/i.test(e),a=``;if(n?a=`https://www.youtube.com/oembed?format=json&url=${t}`:r?a=`https://open.spotify.com/oembed?url=${t}`:i&&(a=`https://embed.music.apple.com/oembed?url=${t}`),!a)return``;let o=await fetch(a);if(!o.ok)return``;let s=await o.json().catch(()=>null);return s&&s.title?String(s.title).trim():``}function ht(e,t,n){return`<a class="linkMini" href="${t}" target="_blank" rel="noopener">${X(`${pt(t)}: ${n?O(n,30):O(t||e,34)}`)}</a>`}function gt(e,t,n){let r=String(e.getValue()||``).trim();if(!r)return``;let i=lt(r)[0]||``;if(!i)return`<span class="muted">${X(O(r,34))}</span>`;let a=ft(i),o=dt.has(a),s=o?dt.get(a):``;if(!o&&!K.has(a)){K.add(a);let t=r;n(()=>{mt(a).then(n=>{if(K.delete(a),dt.set(a,n||``),String(e.getValue()||``).trim()!==t||!n)return;let r=e.getElement();r&&(r.innerHTML=ht(t,a,n))}).catch(()=>{K.delete(a)})})}return ht(r,a,s||``)}function _t(e,t=y(`referencePreview`)){if(!t)return;let n=String(e||``).trim(),r=lt(n);if(!n){t.innerHTML=`<div class="muted">YouTubeリンクを入れるとプレビューできます</div>`;return}if(r.length===0){t.innerHTML=`<div class="muted">${X(n)}</div>`;return}let i=r.find(e=>G(e));if(i){t.innerHTML=`<iframe src="https://www.youtube.com/embed/${G(i)}" title="YouTube preview" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>`;return}t.innerHTML=`<a href="${r[0]}" target="_blank" rel="noopener">リンクを開く</a>`}function vt(e){_t(e,y(`referencePreview`)),_t(e,y(`referencePreviewShared`))}function q(e,t){let n=e??``,r=y(`f_reference`),i=y(`f_reference_shared`);r&&r.id!==t&&(r.value=n),i&&i.id!==t&&(i.value=n),vt(n)}function yt(){return(y(`f_reference`)||y(`f_reference_shared`))?.value||``}function J(e){let t=document.getElementById(`directorLog`),n=document.getElementById(`showDirectorArchived`)?.checked,r=U?L.getRow(U)?.getData?.():{},i=r?.v?String(r.v).trim():``;if(!t)return;let a=Array.isArray(e)?e.slice():[],o=n?a:a.filter(e=>!(e?.archived||e?.archivedAt));if(o.length===0){t.innerHTML=`<div class="muted">まだFBはありません</div>`,t.onclick=null;return}let s=o.sort((e,t)=>(e?.at?.seconds||0)-(t?.at?.seconds||0)),l=T();if(t.innerHTML=s.map((e,t)=>{let n=e.by||``,r=e.at?.toDate?e.at.toDate():null,a=r?r.toLocaleString():``,o=e.text||``,s=(e?.v==null?``:String(e.v).trim())||i,c=!!e.archived||!!e.archivedAt,u=c?`restoreDirector`:`archiveDirector`,d=c?`戻す`:`アーカイブ`,f=[];s&&f.push(`V:${X(s)}`),a&&f.push(a),n&&f.push(X(n));let p=l?`
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="smallBtn" type="button" data-act="${u}" data-idx="${t}">${d}</button>
            <button class="smallBtn danger" type="button" data-act="deleteDirector" data-idx="${t}">消去</button>
          </div>
        `:``;return`
        <div class="logItem">
          <div class="logMeta">${f.join(` / `)}${c?` <span class="muted">（アーカイブ）</span>`:``}</div>
          <div class="logText">${X(o)}</div>
          ${ut(o)}
          ${p}
        </div>
      `}).join(``),!l){t.onclick=null;return}t.onclick=async e=>{let t=e.target?.closest(`button[data-act]`);if(!t||!A||!U)return;let n=Number(t.dataset.idx),r=t.dataset.act,i=L.getRow(U)?.getData?.()||{},a=Array.isArray(i.directorLog)?i.directorLog.slice():[],o=s[n];if(!o)return;let l=a.findIndex(e=>(e?.text||``)===(o.text||``)&&(e?.by||``)===(o.by||``)&&(e?.at?.seconds||0)===(o.at?.seconds||0));if(!(l<0)){if(r===`deleteDirector`){if(!confirm(`このFBを消去しますか？`))return;a.splice(l,1)}else{let e=r===`archiveDirector`;a[l]={...a[l],archived:e,archivedAt:e?p.now():null,archivedBy:e?E():null}}try{await c(g(v,`projects`,j,`cues`,U),{directorLog:a,updatedAt:_(),updatedBy:E()}),L.updateData([{id:U,directorLog:a}]),J(a)}catch(e){console.error(e),b(`${r===`deleteDirector`?`消去`:r===`archiveDirector`?`アーカイブ`:`復帰`}失敗: ${e.code||e.message}`)}}}}function Y(e){let t=document.getElementById(`commentLog`),n=document.getElementById(`showCommentArchived`)?.checked,r=U?L.getRow(U)?.getData?.():{},i=r?.v?String(r.v).trim():``;if(!t)return;let a=Array.isArray(e)?e.slice():[],o=n?a:a.filter(e=>!(e?.archived||e?.archivedAt));if(o.length===0){t.innerHTML=`<div class="muted">まだコメントはありません</div>`,t.onclick=null;return}let s=o.sort((e,t)=>(e?.at?.seconds||0)-(t?.at?.seconds||0)),l=ue();if(t.innerHTML=s.map((e,t)=>{let n=e.by||``,r=e.at?.toDate?e.at.toDate():null,a=r?r.toLocaleString():``,o=e.text||``,s=(e?.v==null?``:String(e.v).trim())||i,c=!!e.archived||!!e.archivedAt,u=c?`restoreComment`:`archiveComment`,d=c?`戻す`:`アーカイブ`,f=[];s&&f.push(`V:${X(s)}`),a&&f.push(a),n&&f.push(X(n));let p=l?`
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="smallBtn" type="button" data-act="${u}" data-idx="${t}">${d}</button>
            <button class="smallBtn danger" type="button" data-act="deleteComment" data-idx="${t}">消去</button>
          </div>
        `:``;return`
        <div class="logItem">
          <div class="logMeta">${f.join(` / `)}${c?` <span class="muted">（アーカイブ）</span>`:``}</div>
          <div class="logText">${X(o)}</div>
          ${ut(o)}
          ${p}
        </div>
      `}).join(``),!l){t.onclick=null;return}t.onclick=async e=>{let t=e.target?.closest(`button[data-act]`);if(!t||!A||!U)return;let n=Number(t.dataset.idx),r=t.dataset.act,i=L.getRow(U)?.getData?.()||{},a=Array.isArray(i.commentLog)?i.commentLog.slice():[],o=s[n];if(!o)return;let l=a.findIndex(e=>(e?.text||``)===(o.text||``)&&(e?.by||``)===(o.by||``)&&(e?.at?.seconds||0)===(o.at?.seconds||0));if(!(l<0)){if(r===`deleteComment`){if(!confirm(`このコメントを消去しますか？`))return;a.splice(l,1)}else{let e=r===`archiveComment`;a[l]={...a[l],archived:e,archivedAt:e?p.now():null,archivedBy:e?E():null}}try{await c(g(v,`projects`,j,`cues`,U),{commentLog:a,updatedAt:_(),updatedBy:E()}),L.updateData([{id:U,commentLog:a}]),Y(a)}catch(e){console.error(e),b(`${r===`deleteComment`?`消去`:r===`archiveComment`?`アーカイブ`:`復帰`}失敗: ${e.code||e.message}`)}}}}function X(e){return String(e).replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#039;`)}function bt(e,t){let n=String(e||``).trim().match(/^(\d{2}):(\d{2}):(\d{2}):(\d{2})$/);if(!n)return null;let[r,i,a,o,s]=n,c=Number(String(t||`24`).trim());return!c||Number.isNaN(c)?null:{frames:(Number(i)*3600+Number(a)*60+Number(o))*c+Number(s),fps:c}}function xt(e,t){let n=Number(String(t||`24`).trim());if(!n||Number.isNaN(n))return``;let r=e<0?`-`:``;e=Math.abs(e);let i=Math.floor(e/n),a=e%n,o=Math.floor(i/3600),s=Math.floor(i%3600/60),c=i%60,l=e=>String(e).padStart(2,`0`);return`${r}${l(o)}:${l(s)}:${l(c)}:${l(a)}`}function Z(e,t,n){let r=bt(e,n),i=bt(t,n);return!r||!i?``:xt(i.frames-r.frames,n)}L.on(`rowClick`,(e,t)=>{let n=navigator.platform.toLowerCase().includes(`mac`);e.shiftKey||(n?e.metaKey:e.ctrlKey)||L.deselectRow(),t.select(),W(t)}),document.addEventListener(`mousedown`,e=>{let t=e.target.closest(`#grid`),n=e.target.closest(`#inspector`),r=e.target.closest(`button, input, select, textarea, a, .cardHead, .modal`);!t&&!n&&!r&&L.deselectRow()});var St=!1;L.on(`rowMoved`,async()=>{if(!(!A||!C())&&!St){St=!0;try{await wt(),b(`並び替えを保存しました`),setTimeout(()=>b(``),800)}catch(e){console.error(e),b(`並び替え保存失敗: ${e.code||e.message}`)}finally{St=!1}}});function Ct(e){M&&M(),j=e,Ve(e),We(e),M=d(s(m(v,`projects`,e,`cues`),u(`m`)),e=>{let t=[],n=null,r=``;if(e.forEach(e=>{let i={id:e.id,...e.data()};i.nextSchedule=F.get(e.id)||null,t.push(i);let a=i.updatedAt;D(a)>D(n)&&(n=a,r=i.updatedBy||``)}),L.replaceData(t),n&&(fe=n,pe=r,ve()),N){let e=L.getRow(N);e&&(e.select(),W(e),N=null)}b(``)},e=>{console.error(e),b(`同期エラー: ${e.code||e.message}`)})}y(`btnLogin`).onclick=async()=>{try{await r(ae,oe)}catch(e){console.error(e),b(`ログイン失敗: ${e.code||e.message}`)}},y(`btnLogout`).onclick=async()=>{await n(ae)},o(ae,async e=>{if(A=e,e){y(`userPill`).textContent=e.email||e.uid,y(`btnLogin`).style.display=`none`,y(`btnLogout`).style.display=`inline-block`;let t=y(`projectId`).value.trim();if(!await ke(t,e)){b(`このプロジェクトの閲覧権限がありません`),location.replace(se);return}Ye||(Ye=!0,(async()=>{if(t)try{let e=await l(g(v,`projects`,t)),n=e.exists()&&e.data().name||t,r=document.getElementById(`projectNamePill`);r&&(r.textContent=n);let i=document.getElementById(`sheetTitle`);i&&(i.textContent=n),document.title=`Music Sheet | ${n}`}catch(e){console.warn(e)}})()),Ct(t)}else y(`userPill`).textContent=`未ログイン`,y(`btnLogin`).style.display=`inline-block`,y(`btnLogout`).style.display=`none`,M&&M(),L.replaceData([]),W(null);H()}),y(`btnAddRow`).onclick=async()=>{if(!A){b(`ログインしてね`);return}if(!C()){b(`管理者のみ追加できます`);return}try{let e=it();N=(await h(m(v,`projects`,j,`cues`),{m:e,v:``,demo:``,status:``,scene:``,len:``,reference:``,in:``,out:``,interval:``,note:``,createdAt:_(),createdBy:E(),updatedAt:_(),updatedBy:E()})).id,b(`行を追加しました`)}catch(e){console.error(e),b(`追加失敗: ${e.code||e.message}`)}};async function wt(){if(!A)return;let e=L.getRows(),t=a(v);e.forEach((e,n)=>{let r=e.getData();t.update(g(v,`projects`,j,`cues`,r.id),{m:String(n+1),updatedAt:_(),updatedBy:E()})}),await t.commit()}y(`btnDeleteRow`)?.addEventListener(`click`,async e=>{if(e.preventDefault(),!A){b(`ログインしてね`);return}if(!C()){b(`管理者のみ削除できます`);return}let t=(L.getSelectedRows?.()||[]).map(e=>e.getData?.()?.id).filter(Boolean);if(t.length===0&&U&&t.push(U),t.length===0){b(`削除する行を選択してね`);return}if(t.length===1){let e=L.getRow(t[0])?.getData?.()||{};if(!confirm(`#M ${e.m||``} を削除する？`))return}else if(!confirm(`選択中の${t.length}行を削除する？`))return;try{let e=a(v);t.forEach(t=>{e.delete(g(v,`projects`,j,`cues`,t))}),await e.commit(),U&&t.includes(U)&&(U=null,W(null)),b(t.length>1?`削除しました（${t.length}行）`:`削除しました`),setTimeout(()=>b(``),900)}catch(e){console.error(e),b(`削除失敗: ${e.code||e.message}`)}}),y(`btnSaveDetail`).onclick=async()=>{if(!A){b(`ログインしてね`);return}let e=window.__FPS_DEFAULT__||`24`,t=y(`f_in`).value.trim()||``,n=y(`f_out`).value.trim()||``,r=Z(t,n,e);y(`f_interval`).value=r;let i=U?L.getRow(U)?.getData?.():{},a=y(`f_m`)?y(`f_m`).value.trim():i?.m??``,o=y(`f_v`)?y(`f_v`).value.trim():i?.v??``,s=y(`f_demo`)?y(`f_demo`).value.trim():i?.demo??``,l=y(`f_scene`)?y(`f_scene`).value.trim():i?.scene??``,u=yt().trim(),d={m:a||null,v:o||null,demo:s||``,scene:l||``,status:y(`f_status`).value.trim()||``,len:y(`f_len`).value.trim()||``,note:y(`f_note`).value||``,reference:u,in:t,out:n,interval:r,updatedAt:_(),updatedBy:E()},f=C()?d:{reference:u,updatedAt:_(),updatedBy:E()};try{if(U)await c(g(v,`projects`,j,`cues`,U),f),b(`保存しました`);else{if(!C()){b(`ゲストは新規行を作成できません`);return}await h(m(v,`projects`,j,`cues`),{...f,createdAt:_(),createdBy:E()}),b(`新規行を作って保存しました`)}}catch(e){console.error(e),b(`保存失敗: ${e.code||e.message}`)}},y(`btnAddDirectorFB`)?.addEventListener(`click`,async()=>{if(!A){b(`ログインしてね`);return}if(!T()){b(`ゲストは監督FBと参考曲のみ編集できます`);return}if(!U){b(`行を選択してね`);return}let e=(y(`f_director_new`)?.value||``).trim();if(!e){b(`追加するFBを入力してね`);return}let t=E(),n=g(v,`projects`,j,`cues`,U),r=L.getRow(U)?.getData?.()||{},i=Array.isArray(r.directorLog)?r.directorLog.slice():[],a=r?.v==null?``:String(r.v).trim(),o={text:e,at:p.now(),by:t,archived:!1};a&&(o.v=a),i.push(o);try{await c(n,{directorLog:i,updatedAt:_(),updatedBy:t}),L.updateData([{id:U,directorLog:i}]),J(i),y(`f_director_new`).value=``,b(`FBを追加しました`),setTimeout(()=>b(``),900)}catch(e){console.error(e),b(`FBの追加に失敗: ${e.code||e.message}`)}}),y(`btnAddComment`)?.addEventListener(`click`,async()=>{if(!A){b(`ログインしてね`);return}if(!ue()){b(`コメントは管理者のみ編集できます`);return}if(!U){b(`行を選択してね`);return}let e=(y(`f_comment_new`)?.value||``).trim();if(!e){b(`追加するコメントを入力してね`);return}let t=g(v,`projects`,j,`cues`,U),n=L.getRow(U)?.getData?.()||{},r=Array.isArray(n.commentLog)?n.commentLog.slice():[],i=n?.v==null?``:String(n.v).trim(),a={text:e,at:p.now(),by:E(),archived:!1};i&&(a.v=i),r.push(a);try{await c(t,{commentLog:r,updatedAt:_(),updatedBy:E()}),L.updateData([{id:U,commentLog:r}]),Y(r),y(`f_comment_new`).value=``,b(`コメントを追加しました`),setTimeout(()=>b(``),900)}catch(e){console.error(e),b(`コメントの追加に失敗: ${e.code||e.message}`)}}),document.getElementById(`showDirectorArchived`)?.addEventListener(`change`,()=>{J((U?L.getRow(U):null)?.getData?.().directorLog||[])}),document.getElementById(`showCommentArchived`)?.addEventListener(`change`,()=>{Y((U?L.getRow(U):null)?.getData?.().commentLog||[])});var Tt=document.getElementById(`divider`),Et=!1,Q=(localStorage.getItem(`inspectorOpen`)||`0`)===`1`,$=Number(localStorage.getItem(`inspectorWidth`)||`420`);function Dt(){let e=document.querySelector(`.layout`);if(e){if(!Q)e.classList.add(`inspectorClosed`),y(`btnToggleInspector`).textContent=`詳細を開く`;else{e.classList.remove(`inspectorClosed`);let t=Math.min(560,Math.max(320,$));e.style.gridTemplateColumns=`1fr 10px ${t}px`,y(`btnToggleInspector`).textContent=`詳細を閉じる`}localStorage.setItem(`inspectorOpen`,Q?`1`:`0`),localStorage.setItem(`inspectorWidth`,String($))}}y(`btnToggleInspector`)?.addEventListener(`click`,()=>{Q=!Q,Dt()}),Dt(),Tt?.addEventListener(`mousedown`,()=>{Q&&(Et=!0)}),window.addEventListener(`mouseup`,()=>{Et=!1}),window.addEventListener(`mousemove`,e=>{if(!Et||!Q)return;let t=Math.min(560,Math.max(320,window.innerWidth-e.clientX-12));$=t,document.querySelector(`.layout`).style.gridTemplateColumns=`1fr 10px ${t}px`,localStorage.setItem(`inspectorWidth`,String($))}),window.addEventListener(`keydown`,e=>{let t=navigator.platform.toLowerCase().includes(`mac`)?e.metaKey:e.ctrlKey;t&&e.key.toLowerCase()===`s`&&(e.preventDefault(),document.getElementById(`btnSaveDetail`)?.click()),t&&e.key.toLowerCase()===`n`&&(e.preventDefault(),document.getElementById(`btnAddRow`)?.click()),t&&e.key.toLowerCase()===`z`&&(e.preventDefault(),rt().catch(console.error))});function Ot(){let e=(y(`q`)?.value||``).trim().toLowerCase(),t=y(`statusFilter`)?.value||``;L.clearFilter(!0),L.setFilter(n=>t&&n.status!==t?!1:e?[n.scene,n.demo,n.status,n.len,n.director,n.memo,n.reference,n.in,n.out].join(` `).toLowerCase().includes(e):!0)}y(`q`)?.addEventListener(`input`,Ot),y(`statusFilter`)?.addEventListener(`change`,Ot),y(`fpsDefault`)?.addEventListener(`change`,async()=>{if(!A){b(`ログインしてね`);return}if(!C()){b(`管理者のみ変更できます`);return}let e=g(v,`projects`,j,`settings`,`ui`),t=y(`fpsDefault`).value;window.__FPS_DEFAULT__=t,await ne(e,{fpsDefault:t,updatedAt:_(),updatedBy:E()},{merge:!0}),b(`FPSを保存しました`),setTimeout(()=>b(``),900)}),y(`btnSettings`)?.addEventListener(`click`,Le),y(`btnCloseStatus`)?.addEventListener(`click`,Re),y(`overlay`)?.addEventListener(`click`,Re),y(`btnAddStatus`)?.addEventListener(`click`,()=>{C()&&(k.push({value:`new`,label:`new`,color:`#a78bfa`}),ze())}),y(`btnSaveStatuses`)?.addEventListener(`click`,async()=>{if(!A){b(`ログインしてね`);return}if(!C()){b(`管理者のみ変更できます`);return}await Be()}),y(`f_status`)?.addEventListener(`change`,Ge),document.getElementById(`f_reference`)?.addEventListener(`input`,e=>{q(e.target?.value||``,`f_reference`)}),document.getElementById(`f_reference_shared`)?.addEventListener(`input`,e=>{q(e.target?.value||``,`f_reference_shared`)});