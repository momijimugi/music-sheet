import{n as e,r as t,t as n}from"./firebase-B4G0vEhV.js";import{D as r,E as i,S as a,T as o,_ as s,d as c,f as l,s as u,u as d,v as f,x as p}from"./index.esm-B0-OTnKT.js";import{r as m}from"./ui_common-C-_HnKRf.js";var h=`/music-sheet/`,g=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean),_=`member`,v=document.getElementById(`userPill`),y=document.getElementById(`btnLogin`),b=document.getElementById(`btnLogout`),x=document.getElementById(`adminLink`),S=document.getElementById(`inviteMsg`),C=document.getElementById(`inviteList`),w={metaDescription:`音楽制作チーム向けのプロジェクト共有ハブ`,lead:`ようこそ。音楽制作やスケジュールを共有して、プロジェクトを一緒に進めるためのポータルです。`,notLoggedIn:`未ログイン`,login:`Googleでログイン`,logout:`ログアウト`,admin:`管理画面へ`,inviteTitle:`招待されているプロジェクト`,loginHint:`ログインすると招待されたプロジェクトが表示されます。`,emailMissing:`メールアドレスが取得できませんでした。`,loading:`読み込み中...`,inviteLoadFail:`招待一覧の読み込みに失敗しました。ログイン状態や権限を確認してください。`,noInvites:`招待中のプロジェクトはありません。`,inviteLoadFailShort:`招待一覧の読み込みに失敗しました。`,noProjects:`参照できるプロジェクトがありません。`,statusJoined:`参加済み`,statusInvite:`招待中`,noteJoin:`参加するを押すと入室できます`,join:`参加する`,joining:`参加中...`,joinFail:`参加に失敗しました: `},T=e=>{S&&(S.textContent=e||``)},E=e=>String(e||``).trim().toLowerCase();function D(){let e=document.querySelector(`meta[name="description"]`);e&&e.setAttribute(`content`,w.metaDescription);let t=document.querySelector(`.lead`);t&&(t.textContent=w.lead),y&&(y.textContent=w.login),b&&(b.textContent=w.logout),x&&(x.textContent=w.admin);let n=document.getElementById(`inviteTitle`);n&&(n.textContent=w.inviteTitle),v&&(v.textContent=w.notLoggedIn)}D();async function O(t){return t?(await l(s(u(e,`members`),p(`memberUid`,`==`,t)))).docs.map(e=>e.ref.parent.parent?.id).filter(Boolean):[]}async function k(t){if(!t)return[];let n=new Map;return(await l(s(u(e,`invites`),p(`emailLower`,`==`,t)))).docs.forEach(e=>{let t=e.data()||{};if(t.usedBy!=null)return;let r=e.ref.parent.parent?.id;if(!r)return;let i=`${r}:${e.id}`;n.set(i,{inviteId:e.id,projectId:r,projectName:t.projectName||``,role:t.role||_})}),[...n.values()]}m();var A=e=>!!e?.email&&g.includes(e.email);y?.addEventListener(`click`,async()=>{await i(n,t)}),b?.addEventListener(`click`,async()=>{await r(n)}),o(n,async e=>{if(v&&(v.textContent=e?.email||w.notLoggedIn),y&&(y.style.display=e?`none`:`inline-flex`),b&&(b.style.display=e?`inline-flex`:`none`),x&&(x.style.display=A(e)?`inline-flex`:`none`),!e){T(w.loginHint),C&&(C.innerHTML=``);return}await M(e)});async function j(t,n){return t.length?(await Promise.all(t.map(async t=>{if(A(n))try{let n=await c(d(e,`projects`,t));if(!n.exists())return null;let r=n.data()||{};return r.deleted?null:{id:t,name:String(r.name||r.projectName||r.title||t).trim()||t,registered:!0}}catch(e){return console.warn(`project doc read failed`,e),{id:t,name:t,registered:!0}}try{let n=await c(d(e,`projects`,t));if(!n.exists())return null;let r=n.data()||{};return r.deleted?null:{id:t,name:String(r.name||r.projectName||r.title||t).trim()||t,registered:!0}}catch(e){return e?.code!==`permission-denied`&&console.warn(`project doc read failed`,e),{id:t,name:t,registered:!1}}}))).filter(Boolean):[]}async function M(t){let n=E(t?.email||``),r=t?.uid||``;if(!n||!r){T(w.emailMissing);return}T(w.loading);let i=[],o=[],s=!1;try{i=await O(r)}catch(e){e?.code===`permission-denied`&&(s=!0),console.warn(`member project list failed`,e)}try{o=await k(n)}catch(e){e?.code===`permission-denied`&&(s=!0),console.warn(`invite collectionGroup read failed`,e)}let c=new Set(i);if(o=o.filter(e=>!c.has(e.projectId)),!i.length&&!o.length){T(s?w.inviteLoadFail:w.noInvites),C&&(C.innerHTML=``);return}let l=await j(i,t),u=o.map(e=>({id:e.projectId,name:e.projectName||e.projectId,registered:!1,type:`invite`,inviteId:e.inviteId})),p=[...l.map(e=>({...e,type:`member`})),...u];if(p.sort((e,t)=>String(e.name||e.id).localeCompare(String(t.name||t.id))),!p.length){T(s?w.inviteLoadFailShort:w.noProjects),C&&(C.innerHTML=``);return}C&&(C.innerHTML=p.map(e=>{let n=A(t)||e.type===`member`,r=n?w.statusJoined:w.statusInvite,i=n?`ok`:`ng`,a=n?``:`<span class="inviteNote">${w.noteJoin}</span>`,o=n?``:`<button class="btn primary small" data-act="join" data-project="${e.id}" data-invite="${e.inviteId}">${w.join}</button>`,s=n?`<a class="btn ghost" data-project="${e.id}" href="${h}portal.html?project=${encodeURIComponent(e.id)}">Portal</a>`:`<span class="btn ghost disabled" aria-disabled="true">Portal</span>`,c=n?`<a class="btn ghost" data-project="${e.id}" href="${h}sheet.html?project=${encodeURIComponent(e.id)}">Music Sheet</a>`:`<span class="btn ghost disabled" aria-disabled="true">Music Sheet</span>`;return`
        <div class="inviteItem">
          <div class="inviteTitle">${e.name}</div>
          <div class="inviteMeta">
            <span class="inviteStatus ${i}">${r}</span>
            ${a}
          </div>
          <div class="inviteActions">
            ${o}
            ${s}
            ${c}
          </div>
          <div class="inviteHint">project: ${e.id}</div>
        </div>
      `}).join(``),C.onclick=async i=>{let o=i.target,s=o?.closest?.(`button[data-act='join']`);if(s){let i=s.getAttribute(`data-project`)||``,o=s.getAttribute(`data-invite`)||``;if(!i||!o)return;s.disabled=!0;let c=s.textContent;s.textContent=w.joining;try{let s=a(e),c=d(e,`projects`,i,`members`,r),l=d(e,`projects`,i,`invites`,o);s.set(c,{role:_,emailLower:n,joinedAt:f(),memberUid:r,inviteId:o}),s.update(l,{usedBy:r,usedAt:f()}),await s.commit(),await M(t)}catch(e){console.error(e),T(w.joinFail+(e.code||e.message)),s.disabled=!1,s.textContent=c||w.join}return}let c=o?.closest?.(`a[data-project]`);if(!c)return;let l=c.getAttribute(`data-project`);l&&localStorage.setItem(`lastProject`,l)}),T(``)}