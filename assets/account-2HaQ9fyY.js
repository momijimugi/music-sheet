import{n as e,r as t}from"./firebase-DUzmoriO.js";import{a as n,c as r,d as i,f as a,g as o,h as s,i as c,o as l,p as u,r as d,s as f,u as p,v as m}from"./index.esm-BYm7NlOb.js";import{a as h,r as g,t as _}from"./nav-B79d_qBo.js";/* empty css              */var v=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean),y=`/music-sheet/`;function b(e){return!!e?.email&&v.includes(e.email)}var x=e=>document.getElementById(e),S={msg:x(`msg`),projectSelect:x(`memberProjectPicker`),btnCreate:x(`btnCreate`),btnInitProjectDoc:x(`btnInitProjectDoc`),ownerEmailView:x(`ownerEmailView`),memberEmailInput:x(`memberEmailInput`),btnAddMember:x(`btnAddMember`),btnCopyInvite:x(`btnCopyInvite`),memberList:x(`memberList`),scheduleFrame:x(`adminScheduleFrame`),openSchedule:x(`openSchedule`),selTitle:x(`scheduleSelectionTitle`),selMeta:x(`scheduleSelectionMeta`),toSheet:x(`scheduleToSheet`),directorLogBox:x(`scheduleDirectorLog`),writerLogBox:x(`scheduleWriterLog`),meetingTitle:x(`scheduleMeetingTitle`),meetingMeta:x(`scheduleMeetingMeta`),meetingLogBox:x(`scheduleMeetingLog`)},C=null,w=null,T=``,E=null,D=null;function O(e=``){S.msg&&(S.msg.textContent=e)}function k(e){return String(e??``).replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#39;`)}function A(e){try{let t=e?.toDate?e.toDate():e instanceof Date?e:null;if(!t)return``;let n=e=>String(e).padStart(2,`0`);return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}`}catch{return``}}async function j(e){try{await navigator.clipboard.writeText(e),O(`コピーしました`)}catch{let t=document.createElement(`textarea`);t.value=e,t.style.position=`fixed`,t.style.left=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t),O(`コピーしました`)}}function M(e){return String(e||``).trim().toLowerCase()}function N(e){return btoa(unescape(encodeURIComponent(e))).replaceAll(`+`,`-`).replaceAll(`/`,`_`).replaceAll(`=`,``)}function P(){S.selTitle&&(S.selTitle.textContent=`（スケジュールでトラックを選択すると表示されます）`),S.selMeta&&(S.selMeta.textContent=``),S.toSheet&&(S.toSheet.href=`sheet.html`),S.directorLogBox&&(S.directorLogBox.innerHTML=`<div class='muted'>—</div>`),S.writerLogBox&&(S.writerLogBox.innerHTML=`<div class='muted'>—</div>`),S.meetingTitle&&(S.meetingTitle.textContent=`最新の打合せメモ`),S.meetingMeta&&(S.meetingMeta.textContent=``),S.meetingLogBox&&(S.meetingLogBox.innerHTML=`<div class='muted'>—</div>`)}function F(){return document.documentElement.dataset.theme||g()}function I(e){S.scheduleFrame?.contentWindow&&S.scheduleFrame.contentWindow.postMessage({type:`SET_THEME`,theme:e},`*`)}function L(e){let t=F(),n=new URL(`${y}schedule-admin.html`,location.href);return e&&n.searchParams.set(`embed`,`1`),n.searchParams.set(`theme`,t),n.pathname+n.search}function R({reloadFrame:e=!1}={}){S.scheduleFrame&&(e?S.scheduleFrame.src=L(!0):I(F())),S.openSchedule&&(S.openSchedule.href=L(!1))}async function z(e){if(!e)return[];let n=await r(u(c(t,`members`),m(`uid`,`==`,e))),i=[];return n.forEach(e=>{let t=e.ref.parent.parent?.id;t&&i.push(t)}),[...new Set(i)]}async function B(){if(!C)return;O(`プロジェクト読み込み中…`);let e=await z(C.uid),n=[];for(let r of e)try{let e=await f(l(t,`projects`,r));if(e.exists()){let t=e.data();n.push({id:r,name:t?.name||`(no name)`,ownerUid:t?.ownerUid||``,updatedAt:t?.updatedAt||t?.createdAt||null})}}catch(e){console.warn(`project read failed:`,r,e)}if(n.sort((e,t)=>{let n=e.updatedAt?.toMillis?e.updatedAt.toMillis():0;return(t.updatedAt?.toMillis?t.updatedAt.toMillis():0)-n}),S.projectSelect){S.projectSelect.innerHTML=``;let e=document.createElement(`option`);e.value=``,e.textContent=`（プロジェクトを選択）`,S.projectSelect.appendChild(e);for(let e of n){let t=document.createElement(`option`);t.value=e.id,t.textContent=e.name,S.projectSelect.appendChild(t)}}let r=localStorage.getItem(`lastProject`)||``,i=r&&n.find(e=>e.id===r)?r:n[0]?.id||``;i?(S.projectSelect&&(S.projectSelect.value=i),await V(i,{from:`picker`})):O(`プロジェクトがまだありません。右上から新規作成してください。`)}async function V(e,{from:r=`code`}={}){if(e&&!(w===e&&r!==`iframe`)){w=e,localStorage.setItem(`lastProject`,e),S.projectSelect&&S.projectSelect.value!==e&&(S.projectSelect.value=e);try{E?.()}catch{}try{D?.()}catch{}if(E=null,D=null,P(),E=i(l(t,`projects`,e),async n=>{if(!n.exists()){O(`このプロジェクトは存在しないか、権限がありません。`);return}let r=n.data()||{};if(O(``),S.ownerEmailView){let n=r.ownerUid?`ownerUid: ${r.ownerUid}`:``;if(r.ownerUid)try{let i=await f(l(t,`projects`,e,`members`,r.ownerUid));if(i.exists()){let e=i.data(),t=[e?.displayName,e?.email].filter(Boolean).join(` / `);t&&(n+=` (${t})`)}}catch{}S.ownerEmailView.value=n||`(unknown)`}},e=>{console.error(e),O(`プロジェクト読込失敗: ${e.code||e.message}`)}),D=i(d(t,`projects`,e,`members`),e=>{let r=[];e.forEach(e=>r.push({id:e.id,...e.data()||{}})),r.sort((e,t)=>{let n=e.role===`owner`?0:1,r=t.role===`owner`?0:1;return n===r?String(e.email||``).localeCompare(String(t.email||``)):n-r}),S.memberList&&(r.length?(S.memberList.innerHTML=r.map(e=>{let t=k(e.displayName||``),n=k(e.email||``),r=k(e.role||`member`),i=k(e.uid||e.id||``),a=C&&e.id!==C.uid&&r!==`owner`;return`
                <div class="card" style="padding:10px; margin:8px 0;">
                  <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                    <div style="min-width:0;">
                      <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${t||n||i}
                      </div>
                      <div class="muted" style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${n?n+` · `:``}${i} · ${r}
                      </div>
                    </div>
                    ${a?`<button class="btn small" data-act="rm-member" data-uid="${k(e.id)}">削除</button>`:``}
                  </div>
                </div>
              `}).join(``),S.memberList.querySelectorAll(`[data-act="rm-member"]`).forEach(e=>{e.onclick=async()=>{let r=e.getAttribute(`data-uid`);if(!(!r||!w)&&confirm(`このメンバーを削除しますか？`))try{await n(l(t,`projects`,w,`members`,r)),O(`メンバーを削除しました`)}catch(e){console.error(e),O(`削除失敗: ${e.code||e.message}`)}}})):S.memberList.innerHTML=`<div class='muted'>メンバーがいません</div>`)},e=>{console.error(e),O(`メンバー読込失敗: ${e.code||e.message}`)}),K(e),r===`picker`&&S.scheduleFrame){let e=new URL(S.scheduleFrame.src,location.href);e.searchParams.set(`_ts`,String(Date.now())),S.scheduleFrame.src=e.pathname+e.search}}}async function H(e,n){let r=N(n);return await o(l(t,`projects`,e,`invites`,r),{emailLower:n,role:`member`,projectName:``,usedBy:null,usedAt:null,createdAt:s(),createdBy:C?.uid||null},{merge:!0}),T=`MusicSheet に招待しました！\n1) このURLを開く: ${`${location.origin}${location.pathname.replace(/\/[^/]*$/,`/`)}index.html`}\n2) 招待されたGoogleアカウントでログイン\n3) 「招待されているプロジェクト」に表示されたら参加\n\n招待先: ${n}`,r}function U(e,t){if(e){if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class='muted'>—</div>`;return}e.innerHTML=t.slice(-20).reverse().map(e=>{let t=A(e?.at),n=k(e?.by||``),r=k(e?.text||``);return`
        <div style="padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08);">
          <div class="muted" style="font-size:12px;">${t}${n?` · `+n:``}</div>
          <div style="white-space:pre-wrap;">${r||`（空）`}</div>
        </div>
      `}).join(``)}}async function W(e,n){if(!(!e||!n))try{let r=await f(l(t,`projects`,e,`cues`,n)),i=r.exists()?r.data():null,a=i?.directorLog||i?.commentLog||[],o=i?.writerLog||[];U(S.directorLogBox,a),U(S.writerLogBox,o)}catch(e){console.error(e),S.directorLogBox&&(S.directorLogBox.innerHTML=`<div class='muted'>読み込み失敗</div>`),S.writerLogBox&&(S.writerLogBox.innerHTML=`<div class='muted'>読み込み失敗</div>`)}}var G=null;function K(e){try{G?.()}catch{}G=null,e&&(G=i(u(d(t,`projects`,e,`portalLogs`),a(`createdAt`,`desc`),p(1)),e=>{if(!S.meetingLogBox||!S.meetingMeta||!S.meetingTitle)return;if(e.empty){S.meetingTitle.textContent=`最新の打合せメモ`,S.meetingMeta.textContent=``,S.meetingLogBox.innerHTML=`<div class='muted'>—</div>`;return}let t=e.docs[0].data()||{},n=t.title||`最新の打合せメモ`,r=A(t.createdAt),i=t.createdByName||t.createdBy||``,a=t.memo||``;S.meetingTitle.textContent=n,S.meetingMeta.textContent=`${r}${i?` · `+i:``}`,S.meetingLogBox.innerHTML=`<div style="white-space:pre-wrap; padding:10px;">${k(a)}</div>`},e=>{console.error(e)}))}(async function(){if(S.btnInitProjectDoc&&(S.btnInitProjectDoc.style.display=`none`),C=await h(),!C){O(`ログインしてください`);return}_({current:`account`,hideAdmin:!b(C)}),R({reloadFrame:!0}),S.scheduleFrame?.addEventListener(`load`,()=>I(F())),window.addEventListener(`themechange`,()=>R()),S.btnCreate&&(S.btnCreate.onclick=async()=>{let t=prompt(`新規プロジェクト名を入力してください`);if(!(!t||!t.trim())){S.btnCreate.disabled=!0,O(`作成中…`);try{let n=await e({name:t,user:C});O(`プロジェクトを作成しました`),await B(),S.projectSelect&&(S.projectSelect.value=n),await V(n,{from:`picker`})}catch(e){console.error(e),e?.code===`plan-limit`?O(`無料プランではプロジェクトは2件までです。`):O(`作成失敗: ${e.code||e.message}`)}finally{S.btnCreate.disabled=!1}}}),S.projectSelect&&(S.projectSelect.onchange=async()=>{let e=S.projectSelect.value;e&&await V(e,{from:`picker`})}),S.btnAddMember&&(S.btnAddMember.onclick=async()=>{if(!w){O(`先にプロジェクトを選択してください`);return}let e=M(S.memberEmailInput?.value||``);if(!e){O(`招待したいメールアドレスを入力してください`);return}S.btnAddMember.disabled=!0,O(`招待を作成中…`);try{await H(w,e),O(`招待を作成しました（右のボタンで案内文をコピーできます）`),S.memberEmailInput&&(S.memberEmailInput.value=``)}catch(e){console.error(e),O(`招待作成失敗: ${e.code||e.message}`)}finally{S.btnAddMember.disabled=!1}}),S.btnCopyInvite&&(S.btnCopyInvite.onclick=async()=>{if(!T){O(`先に招待を作成してください`);return}await j(T)}),window.addEventListener(`message`,async e=>{let t=e?.data;if(!(!t||typeof t!=`object`)){if(t.type===`SCHEDULE_PROJECT_SELECT`){let e=t.projectId;e&&await V(e,{from:`iframe`});return}if(t.type===`SCHEDULE_TRACK_SELECT`){let e=t.projectId||w,n=t.cueId||``,r=t.trackName||`(no title)`;S.selTitle&&(S.selTitle.textContent=r),S.selMeta&&(S.selMeta.textContent=`cueId: ${n}${t.trackId?` · trackId: ${t.trackId}`:``}`),S.toSheet&&(S.toSheet.href=e?`sheet.html?project=${encodeURIComponent(e)}`:`sheet.html`),e&&n?await W(e,n):(U(S.directorLogBox,[]),U(S.writerLogBox,[]))}}}),await B()})();