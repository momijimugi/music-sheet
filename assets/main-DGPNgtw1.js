import{A as e,C as t,D as n,E as r,O as i,S as a,T as o,_ as s,b as c,d as l,g as u,h as d,k as f,n as p,o as m,p as ee,r as te,u as h,v as g,w as ne,y as re}from"./index.esm-B0-OTnKT.js";/* empty css              *//* empty css                      */import{t as ie}from"./tabulator_esm-D-Igvjbx.js";var ae=f().length?i():e({apiKey:`AIzaSyCCp7D78NDqKR2c8cbb29BUUE_5qBOaI_U`,authDomain:`msheet-b7efc.firebaseapp.com`,projectId:`msheet-b7efc`,storageBucket:`sheet-b7efc.firebasestorage.app`,messagingSenderId:`398789467878`,appId:`1:398789467878:web:67a33361881568c6b96527`}),oe=ne(ae),_=ee(ae),se=new t,ce=`/music-sheet/index.html`,v=e=>document.getElementById(e),y=e=>v(`msg`).textContent=e||``,le=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);function b(e){return!!e?.email&&le.includes(e.email)}var x=localStorage.getItem(`debugGuestMode`)===`1`;function S(){return!!A&&b(A)&&!x}function ue(){return!!A&&!S()}function C(e){return A?S()?!0:e===`reference`:!1}function w(){return!!A&&(S()||ue())}function T(){return S()}function E(){return A?.displayName||A?.email||A?.uid||``}var de=v(`lastUpdated`),fe=null,pe=``,me=null,he=``;function D(e){return e?e?.seconds==null?e instanceof Date?e.getTime():0:e.seconds*1e3+(e.nanoseconds||0)/1e6:0}function ge(e,t){if(!de)return;if(!e){de.textContent=`更新: --`;return}let n=_e(t),r=e?.toDate?e.toDate():e instanceof Date?e:null;de.textContent=`更新: ${[r?r.toLocaleString():``,n].filter(Boolean).join(` `)||`--`}`}function _e(e){let t=String(e||``).trim();return t?t.includes(`@`)?t.split(`@`)[0]:t:``}function ve(){D(fe)>=D(me)?ge(fe,pe):ge(me,he)}function O(e,t=40){let n=String(e||``).replace(/\s+/g,` `).trim();return n?n.length>t?`${n.slice(0,t)}…`:n:``}function ye(e){let t=(Array.isArray(e)?e:[]).filter(e=>!(e?.archived||e?.archivedAt));return t.length&&t.reduce((e,t)=>(e?.at?.seconds||0)>=(t?.at?.seconds||0)?e:t)?.text||``}function be(e,t,n){return O(ye(e)||t||``,n)}var xe=[{value:`wip`,label:`wip`,color:`#f59e0b`},{value:`rev`,label:`rev`,color:`#60a5fa`},{value:`fix`,label:`fix`,color:`#2dd4bf`}],k=[...xe],Se=new Map,Ce=null;function we(){Se=new Map(k.map(e=>[e.value,e]))}function Te(e){let t=Se.get(e);return e?t?`<span class="tagPill" style="background:${t.color+`22`};border-color:${t.color+`55`};color:var(--tag-text)">${t.label}</span>`:`<span class="tagPill">${e}</span>`:`<span class="tagPill">—</span>`}function Ee(e){let t=String(e||``).split(`-`).map(e=>parseInt(e,10));if(t.length<3||t.some(e=>Number.isNaN(e)))return null;let[n,r,i]=t;return new Date(n,r-1,i)}function De(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?``:`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)}`}function Oe(e){if(!e||!e.status)return`<span class="muted">—</span>`;let t=e.color||`#6fd6ff`;return`<span class="tagPill" style="background:${t+`22`};border-color:${t+`55`};color:var(--tag-text)">${Y(`${e.dateLabel||e.date||``} ${e.status}`.trim())}</span>`}async function ke(e,t){if(!e||!t)return!1;if(b(t))return!0;let n=t?.uid;if(n)try{if((await l(h(_,`projects`,e,`members`,n))).exists())return!0}catch(e){e?.code!==`permission-denied`&&console.warn(`member access check failed`,e)}try{let r=await l(h(_,`projects`,e));if(!r.exists())return!1;let i=r.data()||{};if(i.deleted)return!1;if(n&&Array.isArray(i.members)&&i.members.includes(n)||n&&i?.roleByUid&&i.roleByUid[n])return!0;let a=String(t?.email||``).trim().toLowerCase();return!!(a&&String(i.ownerEmail||``).trim().toLowerCase()===a)}catch(e){return e?.code!==`permission-denied`&&console.warn(`project access check failed`,e),!1}}function Ae(e){return`
    <div class="ddCell">
      <div class="ddValue">${e||`<span class="muted">&mdash;</span>`}</div>
      <button class="ddBtn" type="button" tabindex="-1">&#9662;</button>
    </div>
  `}function je(e,t,n,r,i){let a=typeof i==`function`?i(e):i||{},o=a.values??a,s=document.createElement(`select`);s.className=`sheetSelect`,s.style.width=`100%`,s.style.height=`28px`,s.style.borderRadius=`8px`,s.style.border=`1px solid var(--line)`,s.style.background=`var(--panel)`,s.style.color=`var(--text)`;let c=(e,t)=>{let n=document.createElement(`option`);n.value=e??``,n.textContent=t??``,s.appendChild(n)};return c(``,``),Array.isArray(o)?o.forEach(e=>{e&&typeof e==`object`?c(e.value??e.label??``,e.label??e.value??``):c(e,e)}):o&&typeof o==`object`&&Object.entries(o).forEach(([e,t])=>c(e,t)),s.value=e.getValue()??``,t(()=>{s.focus()}),s.addEventListener(`change`,()=>n(s.value)),s.addEventListener(`blur`,()=>r()),s.addEventListener(`keydown`,e=>{e.key===`Enter`&&(e.preventDefault(),n(s.value)),e.key===`Escape`&&(e.preventDefault(),r())}),s}var Me=[{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}],Ne=new Map(Me.map(e=>[e.value,e]));function Pe(e){if(!e)return`<span class="tagPill">&mdash;</span>`;let t=Ne.get(e);return t?`<span class="tagPill" style="background:${t.color}22;border-color:${t.color}55;color:var(--tag-text)">${t.label}</span>`:`<span class="tagPill">${e}</span>`}function Fe(){let e=v(`f_len`);e&&(e.innerHTML=`<option value=""></option>`+Me.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``))}function Ie(){we();let e=v(`f_status`);e&&(e.innerHTML=`<option value=""></option>`+k.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``));let t=v(`statusFilter`);if(t){let e=t.value;t.innerHTML=`<option value="">進捗：すべて</option>`+k.map(e=>`<option value="${e.value}">${e.label}</option>`).join(``),t.value=e}if(Ge(),Ze)try{I.updateColumnDefinition(`status`,{title:`進捗`,field:`status`,width:130,formatter:e=>Ae(Te(e.getValue())),editor:je,editable:()=>C(`status`),editorParams:()=>{let e={};return k.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),C(`status`)&&t.edit(!0)}})}catch{}}function Le(){v(`overlay`).classList.remove(`hidden`),v(`statusModal`).classList.remove(`hidden`),ze(),et(),B(),V()}function Re(){v(`overlay`).classList.add(`hidden`),v(`statusModal`).classList.add(`hidden`)}function ze(){let e=v(`statusList`);e.innerHTML=``;let t=S();if(k.forEach((n,r)=>{let i=document.createElement(`div`);i.className=`statusRow`,i.innerHTML=`
      <input type="text" value="${n.label||n.value||``}" data-k="label" data-i="${r}" placeholder="表示名" ${t?``:`disabled`} />
      <input type="color" value="${n.color}" data-k="color" data-i="${r}" ${t?``:`disabled`} />
      <button class="smallBtn" data-act="del" data-i="${r}" ${t?``:`disabled`}>削除</button>
    `,e.appendChild(i)}),!t){e.oninput=null,e.onclick=null;return}e.oninput=e=>{let t=e.target,n=Number(t?.dataset?.i),r=t?.dataset?.k;if(!(Number.isNaN(n)||!r)){if(r===`label`){let e=t.value;k[n]={...k[n],label:e,value:e};return}k[n]={...k[n],[r]:t.value}}},e.onclick=e=>{let t=e.target?.closest(`button`);if(t&&t.dataset.act===`del`){let e=Number(t.dataset.i);k.splice(e,1),ze()}}}async function Be(){if(!S()){y(`管理者のみ変更できます`);return}k=k.map(e=>{let t=(e.label||e.value||``).trim(),n=t;return{...e,label:t,value:n}}).filter(e=>e.value&&e.label);let e=new Set;k=k.filter(t=>e.has(t.value)?!1:(e.add(t.value),!0)),await re(h(_,`projects`,j,`settings`,`ui`),{statuses:k,fpsDefault:v(`fpsDefault`)?.value||`24`,updatedAt:g(),updatedBy:E()},{merge:!0}),Ie(),Re(),y(`進捗設定を保存しました`)}function Ve(e){Ce&&Ce();let t=h(_,`projects`,e,`settings`,`ui`);Ce=d(t,async e=>{if(e.exists()){let t=e.data();t?.updatedAt&&(me=t.updatedAt,he=t.updatedBy||``,ve()),k=Array.isArray(t.statuses)&&t.statuses.length?t.statuses:[...xe];let n=String(t.fpsDefault??`24`);v(`fpsDefault`)&&(v(`fpsDefault`).value=n),window.__FPS_DEFAULT__=n}else k=[...xe],v(`fpsDefault`)&&(v(`fpsDefault`).value=`24`),window.__FPS_DEFAULT__=`24`,S()&&await re(t,{statuses:k,fpsDefault:`24`,createdAt:g()},{merge:!0});Ie()},e=>{console.error(e),y(`設定同期エラー: ${e.code||e.message}`)})}function He(e){F=new Map,(e?.statuses||[]).forEach(e=>{!e||!e.name||F.set(e.name,e.color||`#6fd6ff`)});let t=e?.schedule||{},n=new Date;n.setHours(0,0,0,0);let r=new Map;Object.keys(t).forEach(e=>{let i=t[e];if(!i||typeof i!=`object`)return;let a=null;if(Object.keys(i).forEach(e=>{let t=i[e];if(!t||t===`none`)return;let r=Ee(e);r&&(r<n||(!a||r<a.dt)&&(a={dt:r,dateStr:e,status:t}))}),!a)return;let o=F.get(a.status)||`#6fd6ff`;r.set(e,{status:a.status,date:a.dateStr,dateLabel:De(a.dt),color:o})}),P=r}function Ue(){if(!I||!I.getData)return;let e=I.getData();if(!e.length)return;let t=e.map(e=>({id:e.id,nextSchedule:P.get(e.id)||null}));I.updateData(t)}function We(e){if(Xe&&Xe(),P=new Map,F=new Map,!e){Ue();return}Xe=d(h(_,`projects`,e,`scheduleBoard`,`state`),e=>{if(!e.exists()){P=new Map,F=new Map,Ue();return}let t=e.data()||{};He(t.state||t),Ue()},e=>{console.error(e)})}function Ge(){let e=v(`f_status`)?.value||``;v(`statusTagPreview`).outerHTML=`<span id="statusTagPreview" class="tagPill">${Se.get(e)?.label||e||`—`}</span>`}var A=null,Ke=new URLSearchParams(location.search),qe=(Ke.get(`project`)||``).trim(),Je=(Ke.get(`cue`)||``).trim();qe&&(v(`projectId`).value=qe,v(`projectId`).disabled=!0,localStorage.setItem(`lastProject`,qe));var j=v(`projectId`).value.trim(),M=null,N=null;Je&&(N=Je);var Ye=!1,Xe=null,P=new Map,F=new Map,Ze=!1,I=new ie(`#grid`,{height:`100%`,layout:`fitColumns`,rowHeight:40,selectable:!0,selectableRangeMode:`click`,movableRows:!0,index:`id`,columns:[{formatter:`handle`,field:`__handle`,width:34,hozAlign:`center`,headerSort:!1,rowHandle:!0,frozen:!0},{title:`#M`,field:`m`,width:70,headerSort:!0,frozen:!0},{title:`V`,field:`v`,width:55,editor:`input`,editable:()=>C(`v`),frozen:!0},{title:`demo`,field:`demo`,width:80,editor:`input`,editable:()=>C(`demo`),frozen:!0},{title:`scene`,field:`scene`,minWidth:180,editor:`input`,editable:()=>C(`scene`)},{title:`長さ`,field:`len`,width:120,formatter:e=>Ae(Pe(e.getValue())),editor:je,editable:()=>C(`len`),editorParams:()=>{let e={};return Me.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),C(`len`)&&t.edit(!0)}},{title:`進捗`,field:`status`,width:130,formatter:e=>Ae(Te(e.getValue())),editor:je,editable:()=>C(`status`),editorParams:()=>{let e={};return k.forEach(t=>{e[t.value]=t.label}),{values:e}},cellClick:(e,t)=>{e.preventDefault(),e.stopPropagation(),C(`status`)&&t.edit(!0)}},{title:`直近予定`,field:`nextSchedule`,width:180,headerSort:!1,formatter:e=>Oe(e.getValue())},{title:`監督FB(省略)`,field:`director`,minWidth:220,headerSort:!1,formatter:e=>{let t=e.getData();return be(t.directorLog,t.director,40)}},{title:`コメント(省略)`,field:`commentLog`,minWidth:220,headerSort:!1,formatter:e=>{let t=e.getData();return be(t.commentLog,t.comment,40)}},{title:`参考曲`,field:`reference`,minWidth:200,headerSort:!1,editor:`input`,editable:()=>C(`reference`),formatter:_t},{title:`更新`,field:`updatedAt`,width:190,headerSort:!1,formatter:e=>{let t=e.getData(),n=t.updatedAt?.toDate?t.updatedAt.toDate():null;return`<div style="font-size:12px;line-height:1.15">
          <div>${n?n.toLocaleString():``}</div><div style="opacity:.75">${t.updatedBy||``}</div>
        </div>`}},{title:`IN TC`,field:`in`,width:110,editor:`input`,editable:()=>C(`in`)},{title:`OUT TC`,field:`out`,width:110,editor:`input`,editable:()=>C(`out`)},{title:`INT TC`,field:`interval`,width:110,headerSort:!1}]});I.on(`tableBuilt`,()=>{Ze=!0,Ie(),V()}),Fe();var L=!1,R=!1,z=[],Qe=50,$e=new Set([`status`,`len`,`scene`,`demo`,`in`,`out`]);function et(){let e=v(`toggleBulk`);e&&(e.checked=L);let t=v(`bulkState`);t&&(t.textContent=L?`ON`:`OFF`)}function tt(e){L=!!e,et()}v(`toggleBulk`)?.addEventListener(`change`,()=>{if(!S()){tt(!1);return}tt(v(`toggleBulk`).checked)});function B(){let e=v(`toggleGuest`);if(!e)return;e.checked=x,e.disabled=!b(A);let t=v(`guestState`);t&&(t.textContent=x?`ON`:`OFF`)}function nt(e){x=!!e,localStorage.setItem(`debugGuestMode`,x?`1`:`0`),B(),V()}v(`toggleGuest`)?.addEventListener(`change`,()=>{if(!b(A)){B();return}nt(v(`toggleGuest`).checked)});function V(){let e=b(A),t=S(),n=!!A&&!t,r=v(`btnSettings`);r&&(r.style.display=e?``:`none`);let i=v(`btnAddRow`);i&&(i.style.display=t?``:`none`);let a=v(`btnDeleteRow`);a&&(a.style.display=t?``:`none`);let o=v(`btnUndo`);o&&(o.style.display=t?``:`none`),t||tt(!1);let s=v(`toggleBulk`);s&&(s.disabled=!t),et();let c=v(`fpsDefault`);c&&(c.disabled=!t);let l=v(`f_director_new`);l&&(l.disabled=!w());let u=v(`btnAddDirectorFB`);u&&(u.disabled=!w());let d=v(`f_comment_new`);d&&(d.disabled=n||!A);let f=v(`btnAddComment`);f&&(f.disabled=n||!A);let p=v(`f_reference`);p&&(p.disabled=!A);let m=v(`f_reference_shared`);m&&(m.disabled=!A),[`f_len`,`f_status`,`f_note`,`f_in`,`f_out`].forEach(e=>{let t=v(e);t&&(t.disabled=n)});let ee=v(`statusList`);ee&&ee.querySelectorAll(`input, button`).forEach(e=>{e.disabled=!t});let te=v(`btnAddStatus`);te&&(te.disabled=!t);let h=v(`btnSaveStatuses`);if(h&&(h.disabled=!t),B(),Ze)try{I.updateColumnDefinition(`__handle`,{visible:t})}catch{}if(H){let e=I.getRow(H)?.getData?.()||{};q(e.directorLog||[]),J(e.commentLog||[])}}v(`btnUndo`)?.addEventListener(`click`,()=>{it().catch(console.error)});async function rt(e,{pushUndo:t=!0}={}){if(!e||e.length===0)return;let n=a(_),r=E();for(let t of e){let e=h(_,`projects`,j,`cues`,t.id);n.update(e,{...t.after,updatedAt:g(),updatedBy:r})}await n.commit(),t&&(z.push(e.map(e=>({id:e.id,before:{...e.before},after:{...e.after}}))),z.length>Qe&&z.shift())}async function it(){if(!A){y(`ログインしてね`);return}if(!S()){y(`管理者のみ利用できます`);return}let e=z.pop();if(!e){y(`Undoできる操作がありません`);return}let t=a(_),n=E();for(let r of e){let e=h(_,`projects`,j,`cues`,r.id);t.update(e,{...r.before,updatedAt:g(),updatedBy:n})}await t.commit(),y(`Undoしました`),setTimeout(()=>y(``),800)}I.on(`cellEdited`,async e=>{if(!R)try{let t=e.getRow().getData();if(!t?.id)return;if(!A){y(`ログインしてね（保存できない）`);return}let n=e.getField(),r=e.getValue(),i=e.getOldValue?.()??t[n],a=window.__FPS_DEFAULT__||`24`;if(!C(n)){R=!0,e.setValue(i,!0),R=!1,y(`ゲストは監督FBと参考曲のみ編集できます`),setTimeout(()=>y(``),900);return}n===`reference`&&H===t.id&&K(r??``);let o=I.getSelectedRows().map(e=>e.getData()).filter(e=>e?.id),s=L&&o.length>=2&&$e.has(n),c=n===`in`||n===`out`;if(s){R=!0;let e=o.map(e=>{let o={[n]:e.id===t.id?i:e[n]??``},s={[n]:r};if(c){let t=X(n===`in`?r:e.in||``,n===`out`?r:e.out||``,a);o.interval=e.interval??``,s.interval=t}return{id:e.id,before:o,after:s}});o.forEach(e=>{if(e.id===t.id)return;let i=I.getRow(e.id);if(i?.getCell(n)?.setValue(r,!0),c){let t=X(n===`in`?r:e.in||``,n===`out`?r:e.out||``,a);i?.getCell(`interval`)?.setValue(t,!0)}}),R=!1,await rt(e,{pushUndo:!0}),y(`一括反映しました（${o.length}行）`),setTimeout(()=>y(``),900);return}let l={[n]:i},u={[n]:r};if(c){let e=X(n===`in`?r:t.in||``,n===`out`?r:t.out||``,a);l.interval=t.interval??``,u.interval=e,I.getRow(t.id)?.getCell(`interval`)?.setValue(e,!0)}await rt([{id:t.id,before:l,after:u}],{pushUndo:!0}),y(`保存しました`),setTimeout(()=>y(``),800)}catch(e){console.error(e),y(`保存エラー: ${e.code||e.message}`)}});function at(){let e=I?.getData?.()||[],t=0;for(let n of e){let e=parseInt((n.m??n.M??n[`#M`]??``).toString(),10);Number.isNaN(e)||(t=Math.max(t,e))}return String(t+1)}var H=null;function U(e){let t=v(`f_director_new`),n=v(`btnAddDirectorFB`),r=v(`f_comment_new`),i=v(`btnAddComment`);if(!e){H=null,v(`selMeta`)&&(v(`selMeta`).textContent=`行を選択すると表示されます`,v(`selMeta`).classList.add(`selMetaEmpty`)),q([]),J([]),t&&(t.value=``,t.disabled=!0),n&&(n.disabled=!0),r&&(r.value=``,r.disabled=!0),i&&(i.disabled=!0),K(``),v(`f_in`).value=``,v(`f_out`).value=``,v(`f_interval`).value=``;return}t&&(t.disabled=!w()),n&&(n.disabled=!w()),r&&(r.disabled=!T()),i&&(i.disabled=!T());let a=e.getData();if(H=a.id,v(`selMeta`)){let e=[];a.m!=null&&String(a.m).trim()!==``&&e.push(`#M ${a.m}`),a.demo&&e.push(String(a.demo).trim());let t=e.length?e.join(` / `):`選択中の行`;v(`selMeta`).textContent=`選択中: ${t}`,v(`selMeta`).classList.remove(`selMetaEmpty`)}v(`f_m`)&&(v(`f_m`).value=a.m??``),v(`f_v`)&&(v(`f_v`).value=a.v??``),v(`f_demo`)&&(v(`f_demo`).value=a.demo??``),v(`f_scene`)&&(v(`f_scene`).value=a.scene??``),v(`f_status`).value=a.status??``,v(`f_len`).value=a.len??``,v(`f_note`).value=a.note??``,K(a.reference??``),v(`f_in`).value=a.in??``,v(`f_out`).value=a.out??``;let o=window.__FPS_DEFAULT__||`24`;v(`f_interval`).value=a.interval??X(a.in||``,a.out||``,o),q(a.directorLog||[]),J(a.commentLog||[]),t&&(t.value=a.director||``),r&&(r.value=a.comment||``)}var ot=Array.from(document.querySelectorAll(`.insTab`)),st=Array.from(document.querySelectorAll(`.insTabPanel`));function ct(e,{persist:t=!0}={}){if(!e)return;let n=!1;ot.forEach(t=>{let r=t.dataset.tab===e;r&&(n=!0),t.classList.toggle(`is-active`,r)}),st.forEach(t=>{let n=t.dataset.tab===e;t.classList.toggle(`is-active`,n)}),n&&t&&localStorage.setItem(`inspectorTab`,e)}document.addEventListener(`click`,e=>{let t=e.target?.closest?.(`.insTab`);if(!t)return;let n=t.dataset.tab;ct(n)});var lt=localStorage.getItem(`inspectorTab`);lt&&ct(lt,{persist:!1});function ut(e){let t=String(e||``).match(/https?:\/\/[^\s<>"']+/g);return t?[...new Set(t)]:[]}function W(e){try{let t=new URL(e);if(t.hostname===`youtu.be`)return t.pathname.slice(1)||null;if(t.hostname.includes(`youtube.com`)){let e=t.searchParams.get(`v`);if(e)return e;let n=t.pathname.match(/\/shorts\/([^\/]+)/);if(n)return n[1];let r=t.pathname.match(/\/embed\/([^\/]+)/);if(r)return r[1]}}catch{}return null}function dt(e){let t=ut(e).slice(0,4);return t.length===0?``:`<div class="linkPreviewGrid">${t.map(e=>{let t=W(e);return t?`
        <a class="linkCard" href="${e}" target="_blank" rel="noopener">
          <img class="linkThumb" src="${`https://img.youtube.com/vi/${t}/hqdefault.jpg`}" loading="lazy" alt="YouTube">
          <div class="linkMeta">
            <div class="linkTitle">YouTube</div>
            <div class="linkUrl">${Y(e)}</div>
          </div>
        </a>`:`
      <a class="linkCard" href="${e}" target="_blank" rel="noopener">
        <div class="linkMeta">
          <div class="linkTitle">リンク</div>
          <div class="linkUrl">${Y(e)}</div>
        </div>
      </a>`}).join(``)}</div>`}var ft=new Map,G=new Set;function pt(e){let t=String(e||``).trim();if(!t)return``;try{return new URL(t).toString()}catch{return t}}function mt(e){if(W(e))return`YouTube`;try{let t=new URL(e).hostname.replace(/^www\./,``);return t.includes(`spotify.com`)?`Spotify`:t.includes(`music.apple.com`)?`Apple Music`:t||`Link`}catch{return`Link`}}async function ht(e){let t=encodeURIComponent(e),n=W(e),r=/spotify\.com/i.test(e),i=/music\.apple\.com/i.test(e),a=``;if(n?a=`https://www.youtube.com/oembed?format=json&url=${t}`:r?a=`https://open.spotify.com/oembed?url=${t}`:i&&(a=`https://embed.music.apple.com/oembed?url=${t}`),!a)return``;let o=await fetch(a);if(!o.ok)return``;let s=await o.json().catch(()=>null);return s&&s.title?String(s.title).trim():``}function gt(e,t,n){return`<a class="linkMini" href="${t}" target="_blank" rel="noopener">${Y(`${mt(t)}: ${n?O(n,30):O(t||e,34)}`)}</a>`}function _t(e,t,n){let r=String(e.getValue()||``).trim();if(!r)return``;let i=ut(r)[0]||``;if(!i)return`<span class="muted">${Y(O(r,34))}</span>`;let a=pt(i),o=ft.has(a),s=o?ft.get(a):``;if(!o&&!G.has(a)){G.add(a);let t=r;n(()=>{ht(a).then(n=>{if(G.delete(a),ft.set(a,n||``),String(e.getValue()||``).trim()!==t||!n)return;let r=e.getElement();r&&(r.innerHTML=gt(t,a,n))}).catch(()=>{G.delete(a)})})}return gt(r,a,s||``)}function vt(e,t=v(`referencePreview`)){if(!t)return;let n=String(e||``).trim(),r=ut(n);if(!n){t.innerHTML=`<div class="muted">YouTubeリンクを入れるとプレビューできます</div>`;return}if(r.length===0){t.innerHTML=`<div class="muted">${Y(n)}</div>`;return}let i=r.find(e=>W(e));if(i){t.innerHTML=`<iframe src="https://www.youtube.com/embed/${W(i)}" title="YouTube preview" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>`;return}t.innerHTML=`<a href="${r[0]}" target="_blank" rel="noopener">リンクを開く</a>`}function yt(e){vt(e,v(`referencePreview`)),vt(e,v(`referencePreviewShared`))}function K(e,t){let n=e??``,r=v(`f_reference`),i=v(`f_reference_shared`);r&&r.id!==t&&(r.value=n),i&&i.id!==t&&(i.value=n),yt(n)}function q(e){let t=document.getElementById(`directorLog`),n=document.getElementById(`showDirectorArchived`)?.checked,r=H?I.getRow(H)?.getData?.():{},i=r?.v?String(r.v).trim():``;if(!t)return;let a=Array.isArray(e)?e.slice():[],o=n?a:a.filter(e=>!(e?.archived||e?.archivedAt));if(o.length===0){t.innerHTML=`<div class="muted">まだFBはありません</div>`,t.onclick=null;return}let s=o.sort((e,t)=>(e?.at?.seconds||0)-(t?.at?.seconds||0)),l=w();if(t.innerHTML=s.map((e,t)=>{let n=e.by||``,r=e.at?.toDate?e.at.toDate():null,a=r?r.toLocaleString():``,o=e.text||``,s=(e?.v==null?``:String(e.v).trim())||i,c=!!e.archived||!!e.archivedAt,u=c?`restoreDirector`:`archiveDirector`,d=c?`戻す`:`アーカイブ`,f=[];s&&f.push(`V:${Y(s)}`),a&&f.push(a),n&&f.push(Y(n));let p=l?`
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="smallBtn" type="button" data-act="${u}" data-idx="${t}">${d}</button>
            <button class="smallBtn danger" type="button" data-act="deleteDirector" data-idx="${t}">消去</button>
          </div>
        `:``;return`
        <div class="logItem">
          <div class="logMeta">${f.join(` / `)}${c?` <span class="muted">（アーカイブ）</span>`:``}</div>
          <div class="logText">${Y(o)}</div>
          ${dt(o)}
          ${p}
        </div>
      `}).join(``),!l){t.onclick=null;return}t.onclick=async e=>{let t=e.target?.closest(`button[data-act]`);if(!t||!A||!H)return;let n=Number(t.dataset.idx),r=t.dataset.act,i=I.getRow(H)?.getData?.()||{},a=Array.isArray(i.directorLog)?i.directorLog.slice():[],o=s[n];if(!o)return;let l=a.findIndex(e=>(e?.text||``)===(o.text||``)&&(e?.by||``)===(o.by||``)&&(e?.at?.seconds||0)===(o.at?.seconds||0));if(!(l<0)){if(r===`deleteDirector`){if(!confirm(`このFBを消去しますか？`))return;a.splice(l,1)}else{let e=r===`archiveDirector`;a[l]={...a[l],archived:e,archivedAt:e?p.now():null,archivedBy:e?E():null}}try{await c(h(_,`projects`,j,`cues`,H),{directorLog:a,updatedAt:g(),updatedBy:E()}),I.updateData([{id:H,directorLog:a}]),q(a)}catch(e){console.error(e),y(`${r===`deleteDirector`?`消去`:r===`archiveDirector`?`アーカイブ`:`復帰`}失敗: ${e.code||e.message}`)}}}}function J(e){let t=document.getElementById(`commentLog`),n=document.getElementById(`showCommentArchived`)?.checked,r=H?I.getRow(H)?.getData?.():{},i=r?.v?String(r.v).trim():``;if(!t)return;let a=Array.isArray(e)?e.slice():[],o=n?a:a.filter(e=>!(e?.archived||e?.archivedAt));if(o.length===0){t.innerHTML=`<div class="muted">まだコメントはありません</div>`,t.onclick=null;return}let s=o.sort((e,t)=>(e?.at?.seconds||0)-(t?.at?.seconds||0)),l=T();if(t.innerHTML=s.map((e,t)=>{let n=e.by||``,r=e.at?.toDate?e.at.toDate():null,a=r?r.toLocaleString():``,o=e.text||``,s=(e?.v==null?``:String(e.v).trim())||i,c=!!e.archived||!!e.archivedAt,u=c?`restoreComment`:`archiveComment`,d=c?`戻す`:`アーカイブ`,f=[];s&&f.push(`V:${Y(s)}`),a&&f.push(a),n&&f.push(Y(n));let p=l?`
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="smallBtn" type="button" data-act="${u}" data-idx="${t}">${d}</button>
            <button class="smallBtn danger" type="button" data-act="deleteComment" data-idx="${t}">消去</button>
          </div>
        `:``;return`
        <div class="logItem">
          <div class="logMeta">${f.join(` / `)}${c?` <span class="muted">（アーカイブ）</span>`:``}</div>
          <div class="logText">${Y(o)}</div>
          ${dt(o)}
          ${p}
        </div>
      `}).join(``),!l){t.onclick=null;return}t.onclick=async e=>{let t=e.target?.closest(`button[data-act]`);if(!t||!A||!H)return;let n=Number(t.dataset.idx),r=t.dataset.act,i=I.getRow(H)?.getData?.()||{},a=Array.isArray(i.commentLog)?i.commentLog.slice():[],o=s[n];if(!o)return;let l=a.findIndex(e=>(e?.text||``)===(o.text||``)&&(e?.by||``)===(o.by||``)&&(e?.at?.seconds||0)===(o.at?.seconds||0));if(!(l<0)){if(r===`deleteComment`){if(!confirm(`このコメントを消去しますか？`))return;a.splice(l,1)}else{let e=r===`archiveComment`;a[l]={...a[l],archived:e,archivedAt:e?p.now():null,archivedBy:e?E():null}}try{await c(h(_,`projects`,j,`cues`,H),{commentLog:a,updatedAt:g(),updatedBy:E()}),I.updateData([{id:H,commentLog:a}]),J(a)}catch(e){console.error(e),y(`${r===`deleteComment`?`消去`:r===`archiveComment`?`アーカイブ`:`復帰`}失敗: ${e.code||e.message}`)}}}}function Y(e){return String(e).replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#039;`)}function bt(e,t){let n=String(e||``).trim().match(/^(\d{2}):(\d{2}):(\d{2}):(\d{2})$/);if(!n)return null;let[r,i,a,o,s]=n,c=Number(String(t||`24`).trim());return!c||Number.isNaN(c)?null:{frames:(Number(i)*3600+Number(a)*60+Number(o))*c+Number(s),fps:c}}function xt(e,t){let n=Number(String(t||`24`).trim());if(!n||Number.isNaN(n))return``;let r=e<0?`-`:``;e=Math.abs(e);let i=Math.floor(e/n),a=e%n,o=Math.floor(i/3600),s=Math.floor(i%3600/60),c=i%60,l=e=>String(e).padStart(2,`0`);return`${r}${l(o)}:${l(s)}:${l(c)}:${l(a)}`}function X(e,t,n){let r=bt(e,n),i=bt(t,n);return!r||!i?``:xt(i.frames-r.frames,n)}I.on(`rowClick`,(e,t)=>{let n=navigator.platform.toLowerCase().includes(`mac`);e.shiftKey||(n?e.metaKey:e.ctrlKey)||I.deselectRow(),t.select(),U(t)}),document.addEventListener(`mousedown`,e=>{let t=e.target.closest(`#grid`),n=e.target.closest(`#inspector`),r=e.target.closest(`button, input, select, textarea, a, .cardHead, .modal`);!t&&!n&&!r&&I.deselectRow()});var St=!1;I.on(`rowMoved`,async()=>{if(!(!A||!S())&&!St){St=!0;try{await wt(),y(`並び替えを保存しました`),setTimeout(()=>y(``),800)}catch(e){console.error(e),y(`並び替え保存失敗: ${e.code||e.message}`)}finally{St=!1}}});function Ct(e){M&&M();let t=!0;j=e,Ve(e),We(e),M=d(s(m(_,`projects`,e,`cues`),u(`m`)),e=>{let n=[],r=null,i=``;if(e.forEach(e=>{let t={id:e.id,...e.data()};t.nextSchedule=P.get(e.id)||null,n.push(t);let a=t.updatedAt;D(a)>D(r)&&(r=a,i=t.updatedBy||``)}),I.replaceData(n),r&&(fe=r,pe=i,ve()),N){let e=I.getRow(N);e&&(e.select(),U(e),N=null)}else if(t&&n.length>0){let e=I.getRow(n[0].id);e&&(e.select(),U(e))}t&&=!1,y(``)},e=>{console.error(e),y(`同期エラー: ${e.code||e.message}`)})}v(`btnLogin`).onclick=async()=>{try{await r(oe,se)}catch(e){console.error(e),y(`ログイン失敗: ${e.code||e.message}`)}},v(`btnLogout`).onclick=async()=>{await n(oe)},o(oe,async e=>{if(A=e,e){v(`userPill`).textContent=e.email||e.uid,v(`btnLogin`).style.display=`none`,v(`btnLogout`).style.display=`inline-block`;let t=v(`projectId`).value.trim();if(!await ke(t,e)){y(`このプロジェクトの閲覧権限がありません`),location.replace(ce);return}Ye||(Ye=!0,(async()=>{if(t)try{let e=await l(h(_,`projects`,t)),n=e.exists()&&e.data().name||t,r=document.getElementById(`projectNamePill`);r&&(r.textContent=n);let i=document.getElementById(`sheetTitle`);i&&(i.textContent=n),document.title=`Music Sheet | ${n}`}catch(e){console.warn(e)}})()),Ct(t)}else v(`userPill`).textContent=`未ログイン`,v(`btnLogin`).style.display=`inline-block`,v(`btnLogout`).style.display=`none`,M&&M(),I.replaceData([]),U(null);V()}),v(`btnAddRow`).onclick=async()=>{if(!A){y(`ログインしてね`);return}if(!S()){y(`管理者のみ追加できます`);return}try{let e=at();N=(await te(m(_,`projects`,j,`cues`),{m:e,v:``,demo:``,status:``,scene:``,len:``,reference:``,in:``,out:``,interval:``,note:``,createdAt:g(),createdBy:E(),updatedAt:g(),updatedBy:E()})).id,y(`行を追加しました`)}catch(e){console.error(e),y(`追加失敗: ${e.code||e.message}`)}};async function wt(){if(!A)return;let e=I.getRows(),t=a(_);e.forEach((e,n)=>{let r=e.getData();t.update(h(_,`projects`,j,`cues`,r.id),{m:String(n+1),updatedAt:g(),updatedBy:E()})}),await t.commit()}v(`btnDeleteRow`)?.addEventListener(`click`,async e=>{if(e.preventDefault(),!A){y(`ログインしてね`);return}if(!S()){y(`管理者のみ削除できます`);return}let t=(I.getSelectedRows?.()||[]).map(e=>e.getData?.()?.id).filter(Boolean);if(t.length===0&&H&&t.push(H),t.length===0){y(`削除する行を選択してね`);return}if(t.length===1){let e=I.getRow(t[0])?.getData?.()||{};if(!confirm(`#M ${e.m||``} を削除する？`))return}else if(!confirm(`選択中の${t.length}行を削除する？`))return;try{let e=a(_);t.forEach(t=>{e.delete(h(_,`projects`,j,`cues`,t))}),await e.commit(),H&&t.includes(H)&&(H=null,U(null)),y(t.length>1?`削除しました（${t.length}行）`:`削除しました`),setTimeout(()=>y(``),900)}catch(e){console.error(e),y(`削除失敗: ${e.code||e.message}`)}});var Tt={};function Z(e,t){H&&(A&&!S()&&![`reference`].includes(e)||(Tt[e]&&clearTimeout(Tt[e]),Tt[e]=setTimeout(()=>{let n={[e]:t,updatedAt:g(),updatedBy:E()};if(e===`in`||e===`out`){let r=I.getRow(H)?.getData?.()||{},i=X(e===`in`?t:r.in||``,e===`out`?t:r.out||``,window.__FPS_DEFAULT__||`24`);n.interval=i;let a=v(`f_interval`);a&&(a.value=i)}c(h(_,`projects`,j,`cues`,H),n).then(()=>{y(`自動保存しました`),setTimeout(()=>y(``),1200)}).catch(e=>{console.error(e),y(`自動保存エラー: ${e.code||e.message}`)})},750)))}for(let[e,t]of Object.entries({f_director_new:`director`,f_comment_new:`comment`,f_status:`status`,f_len:`len`,f_note:`note`,f_in:`in`,f_out:`out`})){let n=v(e);if(!n)continue;let r=n.tagName===`SELECT`?`change`:`input`;n.addEventListener(r,e=>{Z(t,e.target.value)})}var Et=v(`f_reference`),Dt=v(`f_reference_shared`),Ot=e=>{let t=e.target.value;K(t,e.target.id),Z(`reference`,t)};Et&&Et.addEventListener(`input`,Ot),Dt&&Dt.addEventListener(`input`,Ot);var kt=v(`btnSaveDetail`);kt&&(kt.style.display=`none`),v(`btnAddDirectorFB`)?.addEventListener(`click`,async()=>{if(!A){y(`ログインしてね`);return}if(!w()){y(`ゲストは監督FBと参考曲のみ編集できます`);return}if(!H){y(`行を選択してね`);return}let e=(v(`f_director_new`)?.value||``).trim();if(!e){y(`追加するFBを入力してね`);return}let t=E(),n=h(_,`projects`,j,`cues`,H),r=I.getRow(H)?.getData?.()||{},i=Array.isArray(r.directorLog)?r.directorLog.slice():[],a=r?.v==null?``:String(r.v).trim(),o={text:e,at:p.now(),by:t,archived:!1};a&&(o.v=a),i.push(o);try{await c(n,{directorLog:i,updatedAt:g(),updatedBy:t}),I.updateData([{id:H,directorLog:i}]),q(i),v(`f_director_new`).value=``,y(`FBを追加しました`),setTimeout(()=>y(``),900)}catch(e){console.error(e),y(`FBの追加に失敗: ${e.code||e.message}`)}}),v(`btnAddComment`)?.addEventListener(`click`,async()=>{if(!A){y(`ログインしてね`);return}if(!T()){y(`コメントは管理者のみ編集できます`);return}if(!H){y(`行を選択してね`);return}let e=(v(`f_comment_new`)?.value||``).trim();if(!e){y(`追加するコメントを入力してね`);return}let t=h(_,`projects`,j,`cues`,H),n=I.getRow(H)?.getData?.()||{},r=Array.isArray(n.commentLog)?n.commentLog.slice():[],i=n?.v==null?``:String(n.v).trim(),a={text:e,at:p.now(),by:E(),archived:!1};i&&(a.v=i),r.push(a);try{await c(t,{commentLog:r,updatedAt:g(),updatedBy:E()}),I.updateData([{id:H,commentLog:r}]),J(r),v(`f_comment_new`).value=``,y(`コメントを追加しました`),setTimeout(()=>y(``),900)}catch(e){console.error(e),y(`コメントの追加に失敗: ${e.code||e.message}`)}}),document.getElementById(`showDirectorArchived`)?.addEventListener(`change`,()=>{q((H?I.getRow(H):null)?.getData?.().directorLog||[])}),document.getElementById(`showCommentArchived`)?.addEventListener(`change`,()=>{J((H?I.getRow(H):null)?.getData?.().commentLog||[])});var At=document.getElementById(`divider`),jt=!1,Q=(localStorage.getItem(`inspectorOpen`)||`0`)===`1`,$=Number(localStorage.getItem(`inspectorWidth`)||`420`);function Mt(){let e=document.querySelector(`.layout`);if(e){if(!Q)e.classList.add(`inspectorClosed`),v(`btnToggleInspector`).textContent=`詳細を開く`;else{e.classList.remove(`inspectorClosed`);let t=Math.min(560,Math.max(320,$));e.style.gridTemplateColumns=`1fr 10px ${t}px`,v(`btnToggleInspector`).textContent=`詳細を閉じる`}localStorage.setItem(`inspectorOpen`,Q?`1`:`0`),localStorage.setItem(`inspectorWidth`,String($))}}v(`btnToggleInspector`)?.addEventListener(`click`,()=>{Q=!Q,Mt()}),Mt(),At?.addEventListener(`mousedown`,()=>{Q&&(jt=!0)}),window.addEventListener(`mouseup`,()=>{jt=!1}),window.addEventListener(`mousemove`,e=>{if(!jt||!Q)return;let t=Math.min(560,Math.max(320,window.innerWidth-e.clientX-12));$=t,document.querySelector(`.layout`).style.gridTemplateColumns=`1fr 10px ${t}px`,localStorage.setItem(`inspectorWidth`,String($))}),window.addEventListener(`keydown`,e=>{let t=navigator.platform.toLowerCase().includes(`mac`)?e.metaKey:e.ctrlKey;t&&e.key.toLowerCase()===`s`&&e.preventDefault(),t&&e.key.toLowerCase()===`n`&&(e.preventDefault(),document.getElementById(`btnAddRow`)?.click()),t&&e.key.toLowerCase()===`z`&&(e.preventDefault(),it().catch(console.error))});function Nt(){let e=(v(`q`)?.value||``).trim().toLowerCase(),t=v(`statusFilter`)?.value||``;I.clearFilter(!0),I.setFilter(n=>t&&n.status!==t?!1:e?[n.scene,n.demo,n.status,n.len,n.director,n.memo,n.reference,n.in,n.out].join(` `).toLowerCase().includes(e):!0)}v(`q`)?.addEventListener(`input`,Nt),v(`statusFilter`)?.addEventListener(`change`,Nt),v(`fpsDefault`)?.addEventListener(`change`,async()=>{if(!A){y(`ログインしてね`);return}if(!S()){y(`管理者のみ変更できます`);return}let e=h(_,`projects`,j,`settings`,`ui`),t=v(`fpsDefault`).value;window.__FPS_DEFAULT__=t,await re(e,{fpsDefault:t,updatedAt:g(),updatedBy:E()},{merge:!0}),y(`FPSを保存しました`),setTimeout(()=>y(``),900)}),v(`btnSettings`)?.addEventListener(`click`,Le),v(`btnCloseStatus`)?.addEventListener(`click`,Re),v(`overlay`)?.addEventListener(`click`,Re),v(`btnAddStatus`)?.addEventListener(`click`,()=>{S()&&(k.push({value:`new`,label:`new`,color:`#a78bfa`}),ze())}),v(`btnSaveStatuses`)?.addEventListener(`click`,async()=>{if(!A){y(`ログインしてね`);return}if(!S()){y(`管理者のみ変更できます`);return}await Be()}),v(`f_status`)?.addEventListener(`change`,()=>{Ge(),Z(`status`,v(`f_status`).value)}),v(`f_len`)?.addEventListener(`change`,()=>Z(`len`,v(`f_len`).value)),v(`f_note`)?.addEventListener(`input`,()=>Z(`note`,v(`f_note`).value)),v(`f_in`)?.addEventListener(`input`,()=>Z(`in`,v(`f_in`).value)),v(`f_out`)?.addEventListener(`input`,()=>Z(`out`,v(`f_out`).value)),document.getElementById(`f_reference`)?.addEventListener(`input`,e=>{let t=e.target?.value||``;K(t,`f_reference`),Z(`reference`,t)}),document.getElementById(`f_reference_shared`)?.addEventListener(`input`,e=>{let t=e.target?.value||``;K(t,`f_reference_shared`),Z(`reference`,t)});