import{r as e,t}from"./firebase-B6LBwd9E.js";import{T as n,h as r,o as i,s as a,u as o,v as s,y as c}from"./index.esm-B0-OTnKT.js";/* empty css                      */import"./tabulator_esm-D-Igvjbx.js";var l=new URLSearchParams(location.search),u=l.has(`embed`);u&&document.body.classList.add(`embedded`);var d=l.get(`theme`),f=!1,p=`composerScheduleBoard_v10`,m=`/music-sheet/`,h=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);function g(e){return!!e?.email&&h.includes(e.email)}function ee(e){let t=String(e).split(`/`);return t[0]===`projects`?t[1]:``}var te=(()=>{let e=`csb_clientId`,t=sessionStorage.getItem(e);if(t)return t;let n=Math.random().toString(36).slice(2,10)+`_`+Date.now().toString(36);return sessionStorage.setItem(e,n),n})(),_=null,ne=null,re=null,v=new Map,ie=new Map,ae=new Map,oe=new Map([{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}].map(e=>[e.value,e])),se=null,ce=null,y=[],le=new Map,ue=!1,de=!1,b=new Set,fe=new Map,x=new Map;function pe(e){let t=document.getElementById(`topError`),n=String(e||``);t&&(t.textContent=n),n&&console.warn(`[schedule]`,n)}function me(){let e=document.getElementById(`topError`);e&&(e.textContent=``)}function he(e){e&&b.add(e)}function S(e,t){if(t){b.add(t);return}let n=Te(e);if(n?.projectId){b.add(n.projectId);return}E&&b.add(E)}function ge(){se&&=(se(),null)}function _e(){ne&&=(ne(),null)}function ve(){ce&&=(ce(),null)}function ye(){re&&=(re(),null),v.size&&(v.forEach(e=>e&&e()),v.clear()),ae=new Map,ie.clear()}var be=null,xe=null,Se=!1,Ce=()=>!!_&&!0,C=[{name:`ä½œæ›²`,color:`#f5576c`},{name:`ã‚¢ãƒ¬ãƒ³ã‚¸`,color:`#84fab0`},{name:`REC`,color:`#ff9a9e`},{name:`MIX`,color:`#a18cd1`},{name:`ãƒã‚¹ã‚¿ãƒªãƒ³ã‚°`,color:`#f6d365`},{name:`æµ„æ›¸`,color:`#fda085`},{name:`ä¿®æ­£`,color:`#f093fb`},{name:`æ‰“ã¡åˆã‚ã›`,color:`#4facfe`}],w=21;function we(e,t){return`${e}__${t}`}function Te(e){let t=String(e||``),n=t.indexOf(`__`);if(n<=0)return null;let r=t.slice(0,n).trim(),i=t.slice(n+2).trim();return!r||!i?null:{projectId:r,trackId:i}}function Ee(e){if(!e)return``;let t=(e.projects||[]).map(e=>{let t=(e.tracks||[]).map(e=>e.id).join(`,`);return`${e.id}:${t}`}).join(`|`),n=(e.statuses||[]).map(e=>`${e.name}:${e.color}`).join(`|`),r=e.settings||{};return[e.startDate||``,String(e.daysToShow||``),t,n,String(r.cellWidth||``),String(r.cellHeight||``),String(r.heatmapEnabled),String(r.showProjectTags),String(r.theme||``)].join(`~`)}function De(e){let t=new Map;return e&&Object.entries(e).forEach(([e,n])=>{n&&Object.entries(n).forEach(([n,r])=>{let i=`${e}|${n}`;t.set(i,r||``)})}),t}function Oe(e){let t=new Map;return e&&Object.entries(e).forEach(([e,n])=>{t.set(e,n||``)}),t}function ke(e,t){let n=[];return e.forEach((e,r)=>{let i=t.has(r)?t.get(r):``;(e||``)!==(i||``)&&n.push([r,i||``])}),t.forEach((t,r)=>{e.has(r)||n.push([r,t||``])}),n}function Ae(e){e.length&&(e.forEach(([e,t])=>{let n=e.indexOf(`|`);if(n===-1)return;let r=e.slice(0,n),i=e.slice(n+1),a=document.querySelector(`.cell-select[data-track-id="${r}"][data-date="${i}"]`);a&&(a.value=t||``,Y(a))}),Z())}function je(e){e.length&&e.forEach(([e,t])=>{let n=e.indexOf(`|`);if(n===-1)return;let r=e.slice(0,n),i=e.slice(n+1),a=document.querySelector(`.cell[data-track-id="${r}"][data-date="${i}"]`);a&&(t?(a.classList.add(`has-note`),a.title=t):(a.classList.remove(`has-note`),a.title=``))})}function Me(e){let t=Ye();t.projects=[],t.schedule={},t.cellNotes={};let n=new Map,r=null,i=0;return e.forEach(e=>{if(!e?.state||!e.projectId)return;let a=e.state,o=e.projectId;a.startDate&&(!r||a.startDate<r)&&(r=a.startDate);let s=Number(a.daysToShow)||0;s>i&&(i=s);let c=Array.isArray(a.projects)?a.projects:[],l=c.find(e=>e.id===o)||c[0]||{id:o,name:o,tracks:[]},u=le.get(o)||[],d=(l.tracks||[]).length?l.tracks:u,f=x.get(o)||l.name||o,p={...l,id:o,name:f,tracks:[]},m=new Map;(d||[]).forEach(e=>{if(!e?.id)return;let t=we(o,e.id);m.set(e.id,t),p.tracks.push({...e,id:t})}),t.projects.push(p);let h=a.schedule||{};Object.keys(h).forEach(e=>{let n=m.get(e);n&&(t.schedule[n]=h[e])});let g=a.cellNotes||{};Object.keys(g).forEach(e=>{let n=String(e).split(`|`);if(n.length<2)return;let r=n.shift(),i=n.join(`|`),a=m.get(r);a&&(t.cellNotes[`${a}|${i}`]=g[e])}),(a.statuses||[]).forEach(e=>{e?.name&&(n.has(e.name)||n.set(e.name,e.color||`#6fd6ff`))})}),t.projects.sort((e,t)=>String(e.name||e.id).localeCompare(String(t.name||t.id))),t.statuses=n.size?Array.from(n.entries()).map(([e,t])=>({name:e,color:t})):C.slice(),r&&(t.startDate=r),i&&(t.daysToShow=i),t}function Ne(e,t){let n=x.get(e)||e;return{startDate:G(new Date),daysToShow:w,projects:[{id:e,name:n,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:Array.isArray(t)?t:[]}],schedule:{},cellNotes:{},statuses:C.slice(),settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:T()}}}function Pe(){let e=y.slice(),t=new Set(e.map(e=>e.projectId));if(le.forEach((n,r)=>{!n?.length||t.has(r)||e.push({projectId:r,state:Ne(r,n)})}),!e.length){if(!ue&&!de){pe(`èª­ã¿è¾¼ã¿ä¸­...`);return}pe(`ã¾ã å…¨æ¡ˆä»¶ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);return}me();let n=Me(e),r=Ee(n);if(Re&&r===Re){let e=De(n.schedule),t=Oe(n.cellNotes),r=ke(ze,e),i=ke(Be,t);U=n,Ae(r),je(i),ze=e,Be=t;return}U=n,Tn(),U.settings.theme||(U.settings.theme=T()),(d===`light`||d===`dark`)&&(U.settings.theme=d),u&&typeof U.settings.showProjectTags!=`boolean`&&(U.settings.showProjectTags=!1),mn(U.settings.theme),gn(u?!1:U.settings.showProjectTags),E=U.projects[0]?.id||null,D=!1,Q(),Re=r,ze=De(U.schedule),Be=Oe(U.cellNotes)}var Fe=`theme`;function T(){let e=localStorage.getItem(Fe);return e===`light`||e===`dark`?e:window.matchMedia&&window.matchMedia(`(prefers-color-scheme: light)`).matches?`light`:`dark`}var E=null,D=!1,O=``,k=new Set,Ie=!1,A=!1,j=null,M=null,N=null,P=null,F=[],I=[],L={},Le={},Re=``,ze=new Map,Be=new Map,Ve=null,R={projectId:null,trackId:null},z={trackId:null,date:null},B={type:null,anchorBtn:null},V=`ALL`,He=f,H=[],Ue=20;async function We(){ge(),ve(),_e(),ye(),be&&=(be(),null),Re=``,ze=new Map,Be=new Map;let o=document.getElementById(`allMode`),s=document.querySelector(`.app-shell`);o&&(o.style.display=`none`),s&&(s.style.display=``),u&&document.body.classList.add(`embedded`),(d===`light`||d===`dark`)&&hn(d);let c=await new Promise(e=>n(t,e));if(_=c,!g(c)){document.body.innerHTML=`<p>ç®¡ç†è€…å°‚ç”¨ã§ã™</p>`;return}r(i(e,`projects`),e=>{x.clear(),e.forEach(e=>{let t=e.data()||{};x.set(e.id,t.name||e.id)}),at(Array.from(x.keys())),y.length&&Pe()},e=>{console.error(e),pe(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.code||e.message}`)}),ce=r(a(e,`scheduleBoard`),e=>{let t=new Map(y.map(e=>[e.projectId,e])),n=Date.now(),r=[];e.forEach(e=>{let i=e.data()||{},a=ee(e.ref.path);if(!a||!i.state)return;let o=fe.get(a);if(o&&n-o<1500){let e=t.get(a);if(e){r.push(e);return}}i.clientId===te&&fe.delete(a);try{let e=Xe(i.state);r.push({projectId:a,state:e})}catch(e){console.warn(e)}}),y=r,ue=!0,Pe()},e=>{console.error(e),pe(`å…¨æ¡ˆä»¶ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.code||e.message}`)}),ot(),at()}var U=Ye();(async()=>{await We()})();function W(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function G(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,`0`)}-${String(e.getDate()).padStart(2,`0`)}`}function Ge(e){if(!e||typeof e!=`string`)return W(new Date);let t=e.split(`-`);if(t.length<3)return W(new Date);let n=Number(t[0]),r=Number(t[1]),i=Number(t[2]);return!n||!r||!i?W(new Date):new Date(n,r-1,i)}function K(e,t){let n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function Ke(e){return`${e.getMonth()+1}/${e.getDate()}ï¼ˆ${[`æ—¥`,`æœˆ`,`ç«`,`æ°´`,`æœ¨`,`é‡‘`,`åœŸ`][e.getDay()]}ï¼‰`}function qe(e){return`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)} ${String(e.getHours()).padStart(2,`0`)}:${String(e.getMinutes()).padStart(2,`0`)}`}function Je(){return`id_`+Math.random().toString(36).slice(2,9)+`_`+Date.now().toString(36)}function Ye(){let e=localStorage.getItem(p);if(!e){let e=W(new Date),t=Je(),n=Je(),r=Je();return{startDate:G(e),daysToShow:w,lastBackupAt:null,projects:[{id:t,name:`ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[{id:n,name:`Main Theme`,memo:``},{id:r,name:`Ending`,memo:``}]}],schedule:{[n]:{[G(e)]:`ä½œæ›²`,[G(K(e,1))]:`ä½œæ›²`,[G(K(e,2))]:`MIX`},[r]:{[G(K(e,3))]:`ä½œæ›²`,[G(K(e,4))]:`REC`}},statuses:C,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:T()},cellNotes:{}}}try{let t=JSON.parse(e);if(!t.projects)throw Error(`invalid data`);return t.settings||={},typeof t.settings.cellWidth!=`number`&&(t.settings.cellWidth=70),typeof t.settings.cellHeight!=`number`&&(t.settings.cellHeight=28),typeof t.settings.heatmapEnabled!=`boolean`&&(t.settings.heatmapEnabled=!0),typeof t.settings.showProjectTags!=`boolean`&&(t.settings.showProjectTags=!0),t.settings.theme||(t.settings.theme=T()),t.cellNotes||={},t.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),(e.tracks||[]).forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),t.startDate||=G(W(new Date)),t.daysToShow||=w,(!t.statuses||!Array.isArray(t.statuses)||t.statuses.length===0)&&(t.statuses=C),t}catch(e){return console.warn(`failed to parse state, init new`,e),localStorage.removeItem(p),Ye()}}function Xe(e){if(!e||!Array.isArray(e.projects))throw Error(`invalid data`);return e.startDate||=G(W(new Date)),e.daysToShow||=w,(!e.statuses||!Array.isArray(e.statuses)||e.statuses.length===0)&&(e.statuses=C),e.settings||={},typeof e.settings.cellWidth!=`number`&&(e.settings.cellWidth=70),typeof e.settings.cellHeight!=`number`&&(e.settings.cellHeight=28),typeof e.settings.heatmapEnabled!=`boolean`&&(e.settings.heatmapEnabled=!0),typeof e.settings.showProjectTags!=`boolean`&&(e.settings.showProjectTags=!0),e.settings.theme||(e.settings.theme=T()),(!e.cellNotes||typeof e.cellNotes!=`object`)&&(e.cellNotes={}),e.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),Array.isArray(e.tracks)||(e.tracks=[]),e.tracks.forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),(!e.schedule||typeof e.schedule!=`object`)&&(e.schedule={}),e}function Ze(e,t){let n=(e?.m??``).toString().trim(),r=(e?.scene??``).toString().trim(),i=(e?.demo??``).toString().trim(),a=(e?.v??``).toString().trim(),o=[];return n&&o.push(`#${n}`),r?o.push(r):i?o.push(i):a&&o.push(`v:${a}`),o.join(` `)||(t?`cue:${t.slice(0,6)}`:`cue`)}function Qe(e){let t=new Map;return Array.isArray(e)&&e.forEach(e=>{!e||!e.value||t.set(e.value,{label:e.label||e.value,color:e.color||`#6fd6ff`})}),t}function $e(e,t){if(!t)return null;let n=ie.get(e);return n&&n.has(t)?n.get(t):{label:t,color:`#6fd6ff`}}function et(e){return e?oe.has(e)?oe.get(e):{label:e,color:`#6fd6ff`}:null}function tt(e){let t=String(e||``).trim();return/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t)?{bg:t+`22`,bd:t+`55`}:{bg:`rgba(111,214,255,0.18)`,bd:`rgba(111,214,255,0.55)`}}function nt(e,t){let n=tt(t);return`<span class="row-meta-pill" style="background:${n.bg};border-color:${n.bd};">${$(e)}</span>`}function rt(e,t){let n=e?.status||``,r=e?.len||``,i=t||``,a=ae.get(e.id);return a&&(n=a.status||n||``,r=a.len||r||``,i=a.projectId||i||``),{status:n,len:r,projectId:i}}function it(e,t){let n=rt(e,t),r=[];if(n.status){let e=$e(n.projectId,n.status),t=e?.label||n.status;r.push(nt(`é€²æ—: ${t}`,e?.color))}if(n.len){let e=et(n.len),t=e?.label||n.len;r.push(nt(`é•·ã•: ${t}`,e?.color))}return r.length?`<div class="row-header-meta">${r.join(``)}</div>`:`<div class="row-header-meta row-header-meta-empty"></div>`}function at(t){let n=Array.isArray(t)?t:Array.from(x.keys()),i=new Set(n.filter(Boolean));v.forEach((e,t)=>{i.has(t)||(e&&e(),v.delete(t),ie.delete(t))}),n.forEach(t=>{if(!t||v.has(t))return;let n=r(o(e,`projects`,t,`settings`,`ui`),e=>{let n=e.exists()&&e.data()||{};ie.set(t,Qe(n.statuses||[])),Q()},e=>{console.warn(`[schedule] sheet ui settings(all) error`,e)});v.set(t,n)})}function ot(){re&&=(re(),null),ae=new Map,re=r(a(e,`cues`),e=>{let t=new Map,n=new Map;e.forEach(e=>{let r=ee(e.ref.path);if(!r)return;let i=e.data()||{},a=i.status||``,o=i.len||``;(a||o)&&t.set(we(r,e.id),{status:a,len:o,projectId:r});let s=n.get(r)||[];s.push({id:e.id,name:Ze(i,e.id),m:i?.m??null}),n.set(r,s)}),ae=t,n.forEach((e,t)=>{e.sort((e,t)=>{let n=parseInt(e.m,10),r=parseInt(t.m,10),i=Number.isFinite(n),a=Number.isFinite(r);return i&&a?n-r:i&&!a?-1:!i&&a?1:String(e.name||``).localeCompare(String(t.name||``),`ja`)}),n.set(t,e.map(({id:e,name:t})=>({id:e,name:t})))}),le=n,de=!0,Pe()},e=>{console.warn(`[schedule] cues(all) error`,e)})}function st(){let e=new Map,t=new Map;return(U.projects||[]).forEach(n=>{n?.id&&(e.set(n.id,{}),t.set(n.id,{}))}),Object.entries(U.schedule||{}).forEach(([t,n])=>{let r=Te(t);r&&(e.has(r.projectId)||e.set(r.projectId,{}),e.get(r.projectId)[r.trackId]=n)}),Object.entries(U.cellNotes||{}).forEach(([e,n])=>{let r=String(e).split(`|`),i=Te(r.shift());if(!i)return;let a=r.join(`|`);t.has(i.projectId)||t.set(i.projectId,{}),t.get(i.projectId)[`${i.trackId}|${a}`]=n}),{scheduleByProject:e,notesByProject:t}}function ct(e){if(!e||!e.size)return;let{scheduleByProject:t,notesByProject:n}=st(),r=new Set(e),i=[],a=new Set;y.forEach(e=>{if(!e?.projectId)return;if(a.add(e.projectId),!r.has(e.projectId)){i.push(e);return}let o=e?.state?JSON.parse(JSON.stringify(e.state)):lt(e.projectId);o.schedule=t.get(e.projectId)||{},o.cellNotes=n.get(e.projectId)||{},i.push({projectId:e.projectId,state:o})}),r.forEach(e=>{if(a.has(e))return;let r=lt(e);r.schedule=t.get(e)||{},r.cellNotes=n.get(e)||{},i.push({projectId:e,state:r})}),y=i}function lt(e){return Xe({projects:[{id:e,name:x.get(e)||e,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]}],schedule:{},cellNotes:{},statuses:C.slice(),daysToShow:w,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:T()}})}function ut(){Se||Ce()&&_&&b.size&&(xe&&clearTimeout(xe),xe=setTimeout(async()=>{let t=new Set(b);b.clear();try{let{scheduleByProject:n,notesByProject:r}=st(),i=[];n.forEach((n,a)=>{if(!t.has(a))return;let l=y.find(e=>e.projectId===a),u=l?.state?JSON.parse(JSON.stringify(l.state)):lt(a);u.schedule=n,u.cellNotes=r.get(a)||{},i.push(c(o(e,`projects`,a,`scheduleBoard`,`state`),{state:u,updatedAt:s(),updatedBy:_?.displayName||_?.email||_?.uid||``,clientId:te,version:1},{merge:!0}))}),await Promise.all(i)}catch(e){console.error(e),t.forEach(e=>b.add(e))}},400))}function q(){try{localStorage.setItem(p,JSON.stringify(U))}catch{}{let e=new Set(b);!e.size&&E&&(b.add(E),e.add(E)),e.forEach(e=>fe.set(e,Date.now())),ct(e)}ut()}function J(){let e=JSON.parse(JSON.stringify(U));H.push(e),H.length>Ue&&H.shift()}function dt(){H.length&&(U=H.pop(),q(),k.clear(),N=null,P=null,gn(U.settings.showProjectTags),mn(U.settings.theme),Q())}function ft(){return[``,...U.statuses.map(e=>e.name)]}function pt(e){return e&&U.statuses.find(t=>t.name===e)||null}function mt(e){if(!e)return null;let t=e.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function Y(e){let t=e.value,n=pt(t),r=e.closest(`.cell`);if(!r)return;let i=r.querySelector(`.cell-label`);i&&(i.textContent=t||``);let a=getComputedStyle(document.body),o=a.getPropertyValue(`--text-main`).trim()||`#fdfdfd`,s=a.getPropertyValue(`--cell-bg`).trim()||`rgba(5,6,11,0.7)`,c=document.body.classList.contains(`theme-light`),l=r.classList.contains(`today`),u=c?`linear-gradient(to bottom, rgba(111,214,255,0.45), rgba(111,214,255,0.2))`:`linear-gradient(to bottom, rgba(111,214,255,0.7), rgba(111,214,255,0.3))`,d=c?`rgba(8,12,22,0.12)`:`rgba(255,255,255,0.16)`;if(!n){r.style.background=l?u:s,e.style.borderColor=d,i&&(i.style.color=o);return}let f=mt(n.color)||{r:111,g:214,b:255},p=f.r,m=f.g,h=f.b,g;g=l?c?`linear-gradient(to bottom, rgba(${p},${m},${h},0.55), rgba(${p},${m},${h},0.3))`:`linear-gradient(to bottom, rgba(${p},${m},${h},0.9), rgba(${p},${m},${h},0.5))`:c?`linear-gradient(135deg, rgba(${p},${m},${h},0.16), rgba(${p},${m},${h},0.42))`:`linear-gradient(135deg, rgba(${p},${m},${h},0.22), rgba(${p},${m},${h},0.6))`,r.style.background=g,e.style.borderColor=`rgba(${p},${m},${h},${c?.7:.85})`,i&&(i.style.color=c?`#1f2430`:`#fdfdfd`)}function ht(){document.querySelectorAll(`.cell-select`).forEach(Y)}function X(e,t){return e+`|`+t}function Z(){document.querySelectorAll(`.cell`).forEach(e=>{let t=e.dataset.trackId,n=e.dataset.date,r=t&&n?X(t,n):null;r&&k.has(r)?e.classList.add(`selected`):e.classList.remove(`selected`)})}var gt=null;function _t(e,t){if(!F.length||!I.length)return;let n=Math.min(e.rowIndex,t.rowIndex),r=Math.max(e.rowIndex,t.rowIndex),i=Math.min(e.colIndex,t.colIndex),a=Math.max(e.colIndex,t.colIndex);k.clear();for(let e=n;e<=r;e++){if(!F[e])continue;let t=F[e].track;for(let e=i;e<=a;e++){if(!I[e])continue;let n=G(I[e]);k.add(X(t.id,n))}}Z()}function vt(){let e=[];return k.forEach(t=>{let[n,r]=t.split(`|`),i=L[n],a=Le[r];i!=null&&a!=null&&e.push({trackId:n,date:r,rowIndex:i,colIndex:a})}),e}function yt(){let e=document.getElementById(`projectList`);e.innerHTML=``;let t=U.projects.filter(e=>!e.archived),n=U.projects.filter(e=>e.archived);if(!t.length&&!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>ã¾ã æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            æ¡ˆä»¶ã¯ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£å‹•ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦æ›²ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
          </div>
        `;return}if(t.forEach(t=>{let n=(t.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item`+(t.id===E?` active`:``),r.dataset.projectId=t.id,r.innerHTML=`
          <div class="project-name">
            <span class="project-dot" style="background:${t.color||`#62c3ff`}"></span>
            <span>${$(t.name)}</span>
          </div>
          <div style="display:flex; align-items:center; gap:4px;">
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-up-btn"
                    data-project-id="${t.id}"
                    title="ä¸Šã¸">
              â–²
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-down-btn"
                    data-project-id="${t.id}"
                    title="ä¸‹ã¸">
              â–¼
            </button>
            <div class="project-meta">${n}æ›²</div>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-archive-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
              ğŸ“¦
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’å‰Šé™¤">
              ğŸ—‘
            </button>
          </div>
        `,r.addEventListener(`click`,e=>{e.target.closest(`.project-delete-btn`)||e.target.closest(`.project-move-up-btn`)||e.target.closest(`.project-move-down-btn`)||e.target.closest(`.project-archive-btn`)||(E=t.id,Ht(),Q())}),e.appendChild(r)}),n.length){let t=document.createElement(`div`);t.style.marginTop=`20px`,t.style.borderTop=`1px solid #e0e0e0`,t.style.paddingTop=`10px`;let r=document.createElement(`div`);r.style.fontSize=`12px`,r.style.fontWeight=`bold`,r.style.color=`#999`,r.style.marginBottom=`8px`,r.textContent=`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿`,t.appendChild(r),n.forEach(e=>{let n=(e.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item archived`,r.dataset.projectId=e.id,r.style.opacity=`0.6`,r.innerHTML=`
            <div class="project-name">
              <span class="project-dot" style="background:${e.color||`#62c3ff`}"></span>
              <span>${$(e.name)}</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
              <div class="project-meta">${n}æ›²</div>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-unarchive-btn"
                      data-project-id="${e.id}"
                      title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’è§£é™¤">
                â†©ï¸
              </button>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                      data-project-id="${e.id}"
                      title="æ¡ˆä»¶ã‚’å‰Šé™¤">
                ğŸ—‘
              </button>
            </div>
          `,t.appendChild(r)}),e.appendChild(t)}e.querySelectorAll(`.project-delete-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=U.projects.find(e=>e.id===n);r&&window.confirm(`æ¡ˆä»¶ã€Œ${r.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ¡ˆä»¶å†…ã®æ›²ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)&&(J(),(r.tracks||[]).forEach(e=>{U.schedule[e.id]&&delete U.schedule[e.id]}),U.projects=U.projects.filter(e=>e.id!==n),E===n&&(E=U.projects.length?U.projects.find(e=>!e.archived)?.id||U.projects[0].id:null),q(),k.clear(),N=null,P=null,Q())})}),e.querySelectorAll(`.project-archive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=U.projects.find(e=>e.id===n);r&&(J(),r.archived=!0,E===n&&(E=U.projects.find(e=>!e.archived)?.id||null),q(),Q())})}),e.querySelectorAll(`.project-unarchive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=U.projects.find(e=>e.id===n);r&&(J(),r.archived=!1,q(),Q())})}),e.querySelectorAll(`.project-move-up-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),bt(e.dataset.projectId,-1)})}),e.querySelectorAll(`.project-move-down-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),bt(e.dataset.projectId,1)})})}function bt(e,t){let n=U.projects.findIndex(t=>t.id===e);if(n<0)return;let r=n+t;if(r<0||r>=U.projects.length)return;J();let[i]=U.projects.splice(n,1);U.projects.splice(r,0,i),q(),Q()}function xt(){let e=Ge(U.startDate),t=U.daysToShow||w,n=[];for(let r=0;r<t;r++){let t=K(e,r);n.push(t)}return n}function St(){let e=xt(),t=document.getElementById(`dateRangeLabel`);if(!e.length)t.textContent=`---`;else{let n=e[0],r=e[e.length-1];t.textContent=`${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ã€œ ${r.getFullYear()}/${r.getMonth()+1}/${r.getDate()}`}let n=document.getElementById(`daysToShowInput`);n&&(n.value=U.daysToShow||w)}function Ct(){let e=[];return U.projects.forEach(t=>{t.archived||D&&E&&t.id!==E||(t.tracks||[]).forEach(n=>{e.push({project:t,track:n})})}),e}function wt(e,t){let n={},r=e.map(e=>G(e));return r.forEach(e=>{n[e]=0}),t.forEach(({track:e})=>{let t=U.schedule[e.id]||{};r.forEach(e=>{let r=t[e];r&&r!==`none`&&(n[e]+=1)})}),n}function Tt(){let e=document.getElementById(`gridWrapper`),t=xt(),n=Ct();if(F=n,I=t,L={},Le={},n.forEach((e,t)=>{L[e.track.id]=t}),t.forEach((e,t)=>{Le[G(e)]=t}),!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>è¡¨ç¤ºã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            å·¦ã®ã€Œæ¡ˆä»¶ã‚’è¿½åŠ ã€â†’ã€Œæ›²ã‚’è¿½åŠ ã€ã§æ›²ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€
            ã“ã“ã« <strong>æ¡ˆä»¶ Ã— æ›² Ã— æ—¥ä»˜</strong> ã®ã‚°ãƒªãƒƒãƒ‰ãŒå‡ºã¦ãã¾ã™ã€‚
          </div>
        `;return}let r=G(W(new Date)),i=ft(),a={};U.projects.forEach(e=>{e.deadline&&(a[e.id]=e.deadline)});let o=U.settings&&U.settings.heatmapEnabled,s=o?wt(t,n):{},c=0;o&&(Object.values(s).forEach(e=>{e>c&&(c=e)}),c<1&&(c=1));let l=``,u=``,d=`<table class="schedule-grid"><thead><tr>`;t.forEach(e=>{let t=G(e),n=t===r,i=Object.values(a).includes(t),c=0;if(o){let e=s[t]||0;c=Math.max(0,Math.min(1,e/5))}let l=[`date-header`,`date-header-heat`,n?`today`:``,i?`deadline`:``].filter(Boolean).join(` `);d+=`
          <th class="${l}"
              data-date="${t}"
              style="--heat-intensity:${c};">
            <span class="date-header-main">${Ke(e)}</span>
            <span class="date-header-sub">${t}</span>
          </th>
        `}),d+=`</tr></thead><tbody>`;let f=[];U.projects.forEach(e=>{if(e.archived||D&&E&&e.id!==E)return;let t=(e.tracks||[]).filter(e=>L[e.id]!=null);t.length&&f.push({project:e,tracks:t})}),f.forEach(e=>{let n=e.project,o=a[n.id]||null,s=n.deadline?`ç· åˆ‡: ${n.deadline}`:`ç· åˆ‡: æœªè¨­å®š`,c=!!n.collapsed;l+=`
          <tr class="project-group-row" data-project-id="${n.id}">
            <td class="project-group-cell">
              <div class="project-group-inner">
                <span class="project-group-dot" style="background:${n.color||`#62c3ff`}"></span>
                <span class="project-group-name">${$(n.name)}</span>
                <span class="project-group-deadline">${s}</span>
                <button type="button"
                        class="btn btn-ghost btn-sm project-deadline-btn"
                        data-project-id="${n.id}"
                        title="ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’è¨­å®š">
                  â±
                </button>
                <span class="project-group-toggle">
                  ${c?`â–¶`:`â–¼`}
                </span>
              </div>
            </td>
          </tr>
        `,u+=`
          <tr class="project-group-spacer" data-project-id="${n.id}">
            <td colspan="${t.length}"></td>
          </tr>
        `,!c&&e.tracks.forEach(e=>{let a=L[e.id],s=U.schedule[e.id]||{},c=it(e,n.id);l+=`
            <tr>
              <td class="row-header-cell" data-track-id="${e.id}">
                <div class="row-header-inner">
                  <div class="row-header-main">
                    <div class="row-header-top">
                      <div class="row-header-title"
                           data-project-id="${n.id}"
                           data-track-id="${e.id}"
                           data-track-name="${$(e.name)}"
                           data-project-name="${$(n.name)}">${$(e.name)}</div>
                      <div class="row-header-actions">
                        <button type="button"
                                class="btn btn-ghost btn-sm btn-icon-only row-header-memo-btn"
                                data-project-id="${n.id}"
                                data-track-id="${e.id}"
                                title="${$(e.memo||`ãƒ¡ãƒ¢æœªè¨­å®š`)}">
                          ğŸ“
                        </button>
                      </div>
                    </div>
                    <div class="row-header-tag">${$(n.name)}</div>
                  </div>
                  ${c}
                </div>
              </td>
            </tr>
          `;let d=`<tr>`;t.forEach((t,c)=>{let l=G(t),u=l===r,f=o&&o===l,p=s[l]||``,m=X(e.id,l),h=k.has(m),g=X(e.id,l),ee=U.cellNotes[g],te=[`cell`,u?`today`:``,h?`selected`:``,f?`deadline-col`:``,ee?`has-note`:``].filter(Boolean).join(` `);d+=`
              <td class="${te}"
                  data-project-id="${n.id}"
                  data-track-id="${e.id}"
                  data-date="${l}"
                  data-row-index="${a}"
                  data-col-index="${c}"
                  data-status="${$(p)}"
                  title="${$(ee||``)}">
                <div class="cell-inner">
                  <span class="cell-label">${p?$(p):``}</span>
                  <button type="button"
                          class="cell-dropdown-btn"
                          data-project-id="${n.id}"
                          data-track-id="${e.id}"
                          data-date="${l}"
                          data-row-index="${a}"
                          data-col-index="${c}">â–¼</button>
                  <select
                    class="cell-select"
                    data-project-id="${n.id}"
                    data-track-id="${e.id}"
                    data-date="${l}"
                    data-row-index="${a}"
                    data-col-index="${c}"
                    onchange="handleCellChange(this)"
                  >
                    ${i.map(e=>`<option value="${e}" ${e===p?`selected`:``}>${e||`---`}</option>`).join(``)}
                  </select>
                </div>
              </td>
            `}),d+=`</tr>`,u+=d})}),e.innerHTML=`
        <div class="grid-split">
          <div class="grid-left" id="gridLeftPane">${`
        <table class="schedule-grid row-header-table">
          <thead>
            <tr>
              <th class="row-header"></th>
            </tr>
          </thead>
          <tbody>
      `+l+`</tbody></table>`}</div>
          <div class="grid-right" id="gridRightPane">${d+u+`</tbody></table>`}</div>
        </div>
      `;let p=document.getElementById(`gridLeftPane`),m=document.getElementById(`gridRightPane`);p&&m&&(m.addEventListener(`scroll`,()=>{p.scrollTop!==m.scrollTop&&(p.scrollTop=m.scrollTop)}),p.addEventListener(`scroll`,()=>{m.scrollTop!==p.scrollTop&&(m.scrollTop=p.scrollTop)})),Et(),Dt(),ht(),Pt(),Ft(),Lt(),Z(),Rt(),un()}function Et(){let e=document.getElementById(`gridRightPane`);if(!e)return;let t=e.querySelector(`table.schedule-grid thead`);if(!t)return;let n=t.getBoundingClientRect(),r=Math.ceil(n.height);document.documentElement.style.setProperty(`--project-group-offset`,`${r}px`),document.documentElement.style.setProperty(`--grid-header-height`,`${r}px`)}function Dt(){let e=document.querySelectorAll(`#gridLeftPane tbody tr`),t=document.querySelectorAll(`#gridRightPane tbody tr`),n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e[r].getBoundingClientRect().height,i=t[r].getBoundingClientRect().height,a=Math.max(n,i);e[r].style.height=`${a}px`,t[r].style.height=`${a}px`}}function Ot(){U.settings||={cellWidth:70,cellHeight:28};let{cellWidth:e,cellHeight:t}=U.settings,n=document.documentElement;n.style.setProperty(`--cell-width`,(e||70)+`px`),n.style.setProperty(`--cell-height`,(t||28)+`px`),n.style.setProperty(`--cell-font-size`,`0.68rem`);let r=document.getElementById(`colWidthInput`),i=document.getElementById(`rowHeightInput`);r&&(r.value=e||70),i&&(i.value=t||28)}function kt(){let e=document.getElementById(`backupStatus`),t=document.getElementById(`backupStatusText`);if(!U.lastBackupAt){t.textContent=`ã¾ã ã‚ã‚Šã¾ã›ã‚“`,e.classList.remove(`overdue`);return}let n=new Date(U.lastBackupAt);if(isNaN(n.getTime())){t.textContent=`ä¸æ˜ï¼ˆå†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ï¼‰`,e.classList.add(`overdue`);return}t.textContent=qe(n),new Date().getTime()-n.getTime()>2880*60*1e3?e.classList.add(`overdue`):e.classList.remove(`overdue`)}function At(){let e=document.getElementById(`statusFilterSelect`);if(!e)return;let t=U.statuses||[],n=`<option value="ALL">ã™ã¹ã¦</option>`;if(t.forEach(e=>{let t=$(e.name);n+=`<option value="${t}">${t}</option>`}),e.innerHTML=n,V!==`ALL`){let n=t.some(e=>e.name===V);e.value=n?V:`ALL`,n||(V=`ALL`)}else e.value=`ALL`}function Q(){!E&&U.projects.length&&(E=U.projects[0].id),Ot(),yt(),St(),Tt(),kt(),At(),Ht(),ln(),fn()}function jt(e,t,n){if(Nt(),!e)return;let r=document.createElement(`div`);r.className=`alt-ghost`,r.textContent=e,r.style.left=t+`px`,r.style.top=n+`px`,document.body.appendChild(r),M=r}function Mt(e,t){M&&(M.style.left=e+`px`,M.style.top=t+`px`)}function Nt(){M&&=(M.remove(),null)}function Pt(){document.querySelectorAll(`.cell`).forEach(e=>{e.addEventListener(`mousedown`,zt),e.addEventListener(`mouseenter`,Bt),e.addEventListener(`mouseup`,Vt),e.addEventListener(`dblclick`,t=>{t.stopPropagation();let n=e.dataset.trackId,r=e.dataset.date;Sn(n,r)})}),document.querySelectorAll(`.cell-select`).forEach(e=>{e.addEventListener(`focus`,()=>{N={rowIndex:parseInt(e.dataset.rowIndex,10),colIndex:parseInt(e.dataset.colIndex,10),trackId:e.dataset.trackId,date:e.dataset.date}})})}function Ft(){document.querySelectorAll(`.row-header-memo-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=e.dataset.trackId;yn(n,r)})}),document.querySelectorAll(`.row-header-title`).forEach(e=>{e.addEventListener(`click`,t=>{if(!u)return;t.stopPropagation();let n=e.dataset.projectId||``,r=e.dataset.trackId||``;O=r,Rt();let i=r;n&&i.startsWith(`${n}__`)&&(i=i.slice(n.length+2));let a={type:`SCHEDULE_TRACK_SELECT`,projectId:n,trackId:r,cueId:i,trackName:e.dataset.trackName||e.textContent||``,projectName:e.dataset.projectName||``};window.parent&&window.parent!==window&&window.parent.postMessage(a,`*`)})}),document.querySelectorAll(`.project-deadline-btn`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.projectId,n=U.projects.find(e=>e.id===t);if(!n)return;let r=n.deadline||``,i=window.prompt(`ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’ YYYY-MM-DD å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºã§è§£é™¤ï¼‰`,r);if(i===null)return;let a=i.trim();if(J(),!a)delete n.deadline;else{if(!a.match(/^(\d{4})-(\d{2})-(\d{2})$/)){window.alert(`æ—¥ä»˜ã¯ YYYY-MM-DD ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹: 2025-12-31`);return}n.deadline=a}q(),Q()})})}function It(e,t){let n=document.querySelector(`.project-group-row[data-project-id="${e}"] .project-group-toggle`);n&&(n.textContent=t?`â–¶`:`â–¼`);let r=U.projects.find(t=>t.id===e);if(!r)return;let i=new Set((r.tracks||[]).map(e=>e.id));if(!i.size)return;let a=document.querySelector(`#gridLeftPane .project-group-row[data-project-id="${e}"]`);if(a){let e=a.nextElementSibling;for(;e&&!e.classList.contains(`project-group-row`);){let n=e.querySelector(`.row-header-cell`);n&&i.has(n.dataset.trackId)&&(e.style.display=t?`none`:`table-row`),e=e.nextElementSibling}}let o=document.querySelector(`#gridRightPane .project-group-spacer[data-project-id="${e}"]`);if(o){let e=o.nextElementSibling;for(;e&&!e.classList.contains(`project-group-spacer`);){let n=e.querySelector(`.cell`);n&&i.has(n.dataset.trackId)&&(e.style.display=t?`none`:`table-row`),e=e.nextElementSibling}}Dt()}function Lt(){document.querySelectorAll(`.project-group-row`).forEach(e=>{let t=e.dataset.projectId,n=t?U.projects.find(e=>e.id===t):null,r=e.querySelector(`.project-group-toggle`);r&&r.addEventListener(`click`,e=>{e.stopPropagation(),n&&(J(),n.collapsed=!n.collapsed,q(),It(n.id,n.collapsed))});let i=e.querySelector(`.project-group-name`);i&&i.addEventListener(`click`,e=>{if(e.stopPropagation(),!u||!window.parent||window.parent===window||!t)return;let r={type:`SCHEDULE_PROJECT_SELECT`,projectId:t,projectName:n?.name||i.textContent||``};window.parent.postMessage(r,`*`)})})}function Rt(){document.querySelectorAll(`.row-header-cell`).forEach(e=>{let t=O&&e.dataset.trackId===O;e.classList.toggle(`track-selected`,t)}),document.querySelectorAll(`.cell`).forEach(e=>{let t=O&&e.dataset.trackId===O;e.classList.toggle(`track-selected`,t)})}function zt(e){if(e.button!==0||e.target.closest(`.cell-dropdown-btn`))return;let t=e.currentTarget,n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10),o=X(n,r);if(Jt(),n&&O!==n&&(O=n,Rt()),e.altKey){let t=(U.schedule[n]||{})[r]||``;j={trackId:n,date:r,value:t},A=!0,t&&jt(t,e.clientX,e.clientY);return}Ie=!0,gt={rowIndex:i,colIndex:a},e.ctrlKey||e.metaKey?k.has(o)?k.delete(o):k.add(o):e.shiftKey&&N?_t({rowIndex:N.rowIndex,colIndex:N.colIndex},{rowIndex:i,colIndex:a}):(k.clear(),k.add(o)),N={rowIndex:i,colIndex:a,trackId:n,date:r},Z()}function Bt(e){if(!Ie||!gt)return;let t=e.currentTarget,n={rowIndex:parseInt(t.dataset.rowIndex,10),colIndex:parseInt(t.dataset.colIndex,10)};_t(gt,n)}function Vt(e){let t=e.currentTarget,n=t.dataset.projectId,r=t.dataset.trackId,i=t.dataset.date,a=parseInt(t.dataset.rowIndex,10),o=parseInt(t.dataset.colIndex,10);if(A&&j){J();let e=j;U.schedule[r]||(U.schedule[r]={}),e.value?U.schedule[r][i]=e.value:delete U.schedule[r][i],S(r,n),q();let a=t.querySelector(`.cell-select`);a&&(a.value=e.value||``,Y(a))}Ie=!1,A=!1,j=null,Nt(),N={rowIndex:a,colIndex:o,trackId:r,date:i}}window.addEventListener(`mouseup`,()=>{Ie=!1,A=!1,j=null,Nt()}),window.addEventListener(`mousemove`,e=>{A&&Mt(e.clientX,e.clientY)}),window.handleCellChange=function(e){let t=e.dataset.projectId,n=e.dataset.trackId,r=e.dataset.date,i=e.value,a=X(n,r);function o(e,t,n){U.schedule[e]||(U.schedule[e]={}),n?U.schedule[e][t]=n:delete U.schedule[e][t]}if(J(),k.size>1&&k.has(a)){let e=new Set;k.forEach(t=>{let[n,r]=t.split(`|`);o(n,r,i),e.add(n)}),e.forEach(e=>S(e))}else o(n,r,i),S(n,t);q(),k.size>1&&k.has(a)?k.forEach(e=>{let[t,n]=e.split(`|`),r=document.querySelector(`.cell-select[data-track-id="${t}"][data-date="${n}"]`);r&&(r.value=i,Y(r))}):Y(e),Z()};function Ht(){let e=document.getElementById(`showAllBtn`),t=document.getElementById(`showSelectedBtn`);D?(t.classList.add(`active`),e.classList.remove(`active`)):(e.classList.add(`active`),t.classList.remove(`active`))}function Ut(){document.getElementById(`statusEditorOverlay`).classList.remove(`hidden`),Gt()}function Wt(){document.getElementById(`statusEditorOverlay`).classList.add(`hidden`)}function Gt(){let e=document.getElementById(`statusListContainer`);e.innerHTML=``,(!U.statuses||!Array.isArray(U.statuses)||U.statuses.length===0)&&(U.statuses=C),U.statuses.forEach(t=>{let n=document.createElement(`div`);n.className=`status-row`,n.innerHTML=`
          <input type="text" class="status-name-input" value="${$(t.name)}" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šä½œæ›²ï¼‰">
          <input type="color" class="status-color-input" value="${t.color||`#f5576c`}">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,n.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{n.remove()}),e.appendChild(n)})}function Kt(){let e=document.getElementById(`statusListContainer`),t=Array.from(e.querySelectorAll(`.status-row`)),n=[];return t.forEach(e=>{let t=e.querySelector(`.status-name-input`),r=e.querySelector(`.status-color-input`),i=t.value.trim(),a=r.value||`#f5576c`;i&&n.push({name:i,color:a})}),n.length===0?C:n}function qt(e,t){let n=document.getElementById(`contextMenu`);n.classList.remove(`hidden`);let r=n.getBoundingClientRect(),i=e,a=t;i+r.width>window.innerWidth&&(i=window.innerWidth-r.width-4),a+r.height>window.innerHeight&&(a=window.innerHeight-r.height-4),n.style.left=i+`px`,n.style.top=a+`px`}function Jt(){document.getElementById(`contextMenu`).classList.add(`hidden`),Ve=null}function Yt(e){let t=e.target.closest(`.cell`);if(!t){Jt();return}e.preventDefault();let n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10);N={rowIndex:i,colIndex:a,trackId:n,date:r},Ve={rowIndex:i,colIndex:a,trackId:n,date:r},Z(),qt(e.clientX,e.clientY)}function Xt(){let e=vt();if(!e.length&&N&&F.length&&I.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=N;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}if(!e.length)return;let t=e.map(e=>e.rowIndex),n=e.map(e=>e.colIndex),r=Math.min(...t),i=Math.max(...t),a=Math.min(...n),o=Math.max(...n),s=i-r+1,c=o-a+1,l=Array.from({length:s},()=>Array.from({length:c},()=>``));e.forEach(e=>{let t=e.rowIndex-r,n=e.colIndex-a,i=e.trackId,o=e.date,s=(U.schedule[i]||{})[o]||``;l[t][n]=s}),P={data:l,width:c,height:s}}function Zt(e){if(!P)return;let t=e||N;if(!t){let e=vt();if(!e.length)return;let n=e.map(e=>e.rowIndex),r=e.map(e=>e.colIndex);t={rowIndex:Math.min(...n),colIndex:Math.min(...r)}}let{data:n,width:r,height:i}=P;J();let a=[],o=new Set;for(let e=0;e<i;e++){let i=t.rowIndex+e;if(!F[i])continue;let s=F[i].track.id;o.add(s);for(let i=0;i<r;i++){let r=t.colIndex+i;if(!I[r])continue;let o=G(I[r]),c=n[e][i];U.schedule[s]||(U.schedule[s]={}),c?U.schedule[s][o]=c:delete U.schedule[s][o],a.push({trackId:s,dateIso:o,value:c})}}o.forEach(e=>S(e)),q(),a.forEach(({trackId:e,dateIso:t,value:n})=>{let r=document.querySelector(`.cell-select[data-track-id="${e}"][data-date="${t}"]`);r&&(r.value=n||``,Y(r))})}function Qt(){let e=vt();if(!e.length&&N&&F.length&&I.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=N;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}if(!e.length)return;J();let t=new Set;e.forEach(e=>{U.schedule[e.trackId]&&delete U.schedule[e.trackId][e.date],t.add(e.trackId)}),t.forEach(e=>S(e)),q(),e.forEach(e=>{let t=document.querySelector(`.cell-select[data-track-id="${e.trackId}"][data-date="${e.date}"]`);t&&(t.value=``,Y(t))})}function $t(){let e=new Date;U.lastBackupAt=e.toISOString(),q(),kt();let t=JSON.stringify(U,null,2),n=new Blob([t],{type:`application/json`}),r=`schedule_backup_${e.getFullYear()}${String(e.getMonth()+1).padStart(2,`0`)}${String(e.getDate()).padStart(2,`0`)}_${String(e.getHours()).padStart(2,`0`)}${String(e.getMinutes()).padStart(2,`0`)}.json`,i=URL.createObjectURL(n),a=document.createElement(`a`);a.href=i,a.download=r,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(i)}function $(e){return e==null?``:String(e).replace(/&/g,`&amp;`).replace(/</g,`&lt;`).replace(/>/g,`&gt;`).replace(/"/g,`&quot;`).replace(/'/g,`&#039;`)}function en(e,t){let n=document.getElementById(`inputPopover`),r=document.getElementById(`inputPopoverTitle`),i=document.getElementById(`inputPopoverField`),a=document.getElementById(`inputPopoverOkBtn`);B.type=e,B.anchorBtn=t,e===`project`?(r.textContent=`æ–°ã—ã„æ¡ˆä»¶å`,a.textContent=`è¿½åŠ `):e===`track`&&(r.textContent=`æ–°ã—ã„æ›²å`,a.textContent=`è¿½åŠ `),i.value=``,n.classList.remove(`hidden`);let o=t.getBoundingClientRect();n.style.left=o.left+`px`,n.style.top=o.bottom+6+`px`;let s=n.getBoundingClientRect(),c=o.left,l=o.bottom+6;c+s.width>window.innerWidth-8&&(c=window.innerWidth-s.width-8),l+s.height>window.innerHeight-8&&(l=o.top-s.height-6),n.style.left=c+`px`,n.style.top=l+`px`,i.focus(),i.select()}function tn(){document.getElementById(`inputPopover`).classList.add(`hidden`),B.type=null,B.anchorBtn=null}function nn(){let e=document.getElementById(`inputPopoverField`).value.trim();if(!e){tn();return}B.type===`project`?rn(e):B.type===`track`&&an(e),tn()}function rn(e){J();let t={id:Je(),name:e.trim(),color:`#62c3ff`,tracks:[]};U.projects.push(t),E=t.id,q(),Q()}function an(e){if(!E){window.alert(`ã¾ãšå·¦ã®æ¡ˆä»¶ãƒªã‚¹ãƒˆã‹ã‚‰ã€æ›²ã‚’è¿½åŠ ã—ãŸã„æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);return}let t=U.projects.find(e=>e.id===E);if(!t){window.alert(`é¸æŠä¸­ã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);return}J();let n={id:Je(),name:e.trim()};t.tracks.push(n),q(),Q()}function on(e){let t=U.schedule[e];if(!t)return null;let n=null;return Object.keys(t).forEach(e=>{let t=Ge(e);isNaN(t.getTime())||(!n||t<n)&&(n=t)}),n}function sn(){J(),U.projects.forEach(e=>{!e.tracks||e.tracks.length<=1||e.tracks.sort((e,t)=>{let n=on(e.id),r=on(t.id);if(n&&r){let i=n-r;return i===0?e.name.localeCompare(t.name,`ja`):i}else if(n&&!r)return-1;else if(!n&&r)return 1;else return e.name.localeCompare(t.name,`ja`)})}),q(),Q()}function cn(e){He=e,document.body.classList.toggle(`client-view-mode`,He),ln()}function ln(){let e=document.getElementById(`clientViewToggleBtn`);e&&(e.style.display=``,He?(e.classList.add(`active`),e.textContent=`ğŸ‘ é€šå¸¸ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹`):(e.classList.remove(`active`),e.textContent=`ğŸ‘ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼`));let t=document.getElementById(`clientViewBanner`);t&&t.classList.toggle(`hidden`,!He);let n=document.getElementById(`clientViewBackBtn`);n&&(n.style.display=``)}function un(){document.querySelectorAll(`.cell`).forEach(e=>{if(e.classList.remove(`dim`),V&&V!==`ALL`){let t=e.dataset.status||``;(!t||t!==V)&&e.classList.add(`dim`)}})}function dn(){document.querySelectorAll(`[data-nav-page]`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.navPage;if(!t)return;let n=``;if(t===`home`)n=`${m}index.html`;else if(t===`admin`)n=`${m}admin.html`;else if(t===`portal`)n=`${m}portal.html`;else if(t===`sheet`)n=`${m}sheet.html`;else return;if(t===`portal`||t===`sheet`){let e=E||localStorage.getItem(`lastProject`)||``;if(!e&&(e=prompt(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`)?.trim(),!e))return;localStorage.setItem(`lastProject`,e),n+=`?project=${encodeURIComponent(e)}`}let r=u?window.top:window;r.location.href=n})});let e=document.getElementById(`addTrackBtn`);e.addEventListener(`click`,()=>{en(`track`,e)});let t=document.getElementById(`settingsMenuBtn`),n=document.getElementById(`settingsPopover`);t&&n&&(t.addEventListener(`click`,e=>{e.stopPropagation(),n.classList.toggle(`settings-closed`)}),document.addEventListener(`click`,e=>{n.classList.contains(`settings-closed`)||!e.target.closest(`#settingsPopover`)&&!e.target.closest(`#settingsMenuBtn`)&&n.classList.add(`settings-closed`)})),document.getElementById(`autoStairSortBtn`).addEventListener(`click`,()=>{sn()}),document.getElementById(`showAllBtn`).addEventListener(`click`,()=>{D=!1,Ht(),Q()}),document.getElementById(`showSelectedBtn`).addEventListener(`click`,()=>{D=!0,Ht(),Q()}),document.getElementById(`prevRangeBtn`).addEventListener(`click`,()=>{let e=U.daysToShow||w,t=K(Ge(U.startDate),-e);J(),U.startDate=G(t),q(),Q()}),document.getElementById(`nextRangeBtn`).addEventListener(`click`,()=>{let e=U.daysToShow||w,t=K(Ge(U.startDate),e);J(),U.startDate=G(t),q(),Q()});let r=document.getElementById(`themeToggleBtn`);r&&r.addEventListener(`click`,()=>{hn(U.settings&&U.settings.theme===`light`?`dark`:`light`)});let i=document.getElementById(`tagToggleBtn`);i&&i.addEventListener(`click`,()=>{_n(!!(U.settings&&U.settings.showProjectTags===!1))}),document.getElementById(`exportBtn`).addEventListener(`click`,()=>{$t()}),document.getElementById(`importInput`).addEventListener(`change`,e=>{let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=t=>{try{let e=t.target.result;U=Xe(JSON.parse(e)),H=[],k.clear(),N=null,P=null,q(),mn(U.settings.theme),gn(U.settings.showProjectTags),Q(),window.alert(`JSONã‹ã‚‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`)}catch(e){console.error(e),window.alert(`JSONã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚`)}finally{e.target.value=``}},n.readAsText(t,`utf-8`)}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.cell-dropdown-btn`);if(!t)return;let n=t.closest(`.cell`);if(!n)return;let r=n.querySelector(`.cell-select`);if(r)if(typeof r.showPicker==`function`)r.showPicker();else{r.focus();let e=new MouseEvent(`mousedown`,{bubbles:!0,cancelable:!0,view:window});r.dispatchEvent(e),r.click()}}),document.addEventListener(`contextmenu`,Yt),document.addEventListener(`mousedown`,e=>{document.getElementById(`contextMenu`).classList.contains(`hidden`)||e.target.closest(`#contextMenu`)||Jt(),document.getElementById(`inputPopover`).classList.contains(`hidden`)||!e.target.closest(`#inputPopover`)&&!e.target.closest(`#addProjectBtn`)&&!e.target.closest(`#addTrackBtn`)&&tn()}),window.addEventListener(`scroll`,()=>{Jt()},!0),document.querySelectorAll(`#contextMenu .context-menu-item`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.action;t===`copy`?Xt():t===`paste`?Zt(Ve||N||null):t===`clear`&&Qt(),Jt()})});let a=document.getElementById(`statusFilterSelect`);a.addEventListener(`change`,()=>{V=a.value,un()}),document.getElementById(`undoBtn`).addEventListener(`click`,()=>{dt()});let o=document.getElementById(`clientViewToggleBtn`);o&&o.addEventListener(`click`,()=>{cn(!He)});let s=document.getElementById(`clientViewBackBtn`);s&&s.addEventListener(`click`,()=>{cn(!1)}),document.addEventListener(`keydown`,e=>{let t=e.ctrlKey||e.metaKey,n=e.target,r=n.tagName,i=r===`SELECT`&&n.classList.contains(`cell-select`),a=(r===`INPUT`||r===`TEXTAREA`||n.isContentEditable)&&!i;if(!document.getElementById(`inputPopover`).classList.contains(`hidden`)){if(e.key===`Enter`){e.preventDefault(),nn();return}if(e.key===`Escape`){e.preventDefault(),tn();return}}if(t&&(e.key===`s`||e.key===`S`)){e.preventDefault(),$t();return}if(t&&(e.key===`c`||e.key===`C`)){e.preventDefault(),Xt();return}if(t&&(e.key===`v`||e.key===`V`)){e.preventDefault(),Zt();return}if(t&&(e.key===`z`||e.key===`Z`)){if(a)return;e.preventDefault(),dt();return}if(e.key===`Delete`||e.key===`Backspace`){if(a)return;e.preventDefault(),Qt();return}});let c=document.getElementById(`colWidthInput`),l=document.getElementById(`rowHeightInput`);c&&c.addEventListener(`change`,()=>{let e=parseInt(c.value,10);isNaN(e)&&(e=70),e=Math.max(20,Math.min(200,e)),J(),U.settings.cellWidth=e,q(),Ot(),Tt()}),l&&l.addEventListener(`change`,()=>{let e=parseInt(l.value,10);isNaN(e)&&(e=28),e=Math.max(14,Math.min(80,e)),J(),U.settings.cellHeight=e,q(),Ot(),Tt()});let d=document.getElementById(`daysToShowInput`);d&&d.addEventListener(`change`,()=>{let e=parseInt(d.value,10);isNaN(e)&&(e=w),e=Math.max(7,Math.min(90,e)),J(),U.daysToShow=e,q(),Q()}),document.getElementById(`editStatusesBtn`).addEventListener(`click`,()=>{Ut()}),document.getElementById(`closeStatusEditorBtn`).addEventListener(`click`,()=>{Wt()}),document.getElementById(`addStatusRowBtn`).addEventListener(`click`,()=>{let e=document.getElementById(`statusListContainer`),t=document.createElement(`div`);t.className=`status-row`,t.innerHTML=`
          <input type="text" class="status-name-input" value="" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šãƒªãƒŸãƒƒã‚¯ã‚¹ï¼‰">
          <input type="color" class="status-color-input" value="#f5576c">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,t.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{t.remove()}),e.appendChild(t)}),document.getElementById(`saveStatusesBtn`).addEventListener(`click`,()=>{let e=Kt();J(),U.statuses=e,q(),Wt(),Q()}),document.getElementById(`statusEditorOverlay`).addEventListener(`click`,e=>{e.target.id===`statusEditorOverlay`&&Wt()}),document.getElementById(`inputPopoverCancelBtn`).addEventListener(`click`,()=>{tn()}),document.getElementById(`inputPopoverOkBtn`).addEventListener(`click`,()=>{nn()}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.row-header-memo-btn`);if(!t)return;e.stopPropagation();let n=t.dataset.projectId,r=t.dataset.trackId;yn(n,r)}),document.addEventListener(`click`,e=>{let t=e.target;if(t.id===`trackMemoSaveBtn`){e.preventDefault(),xn();return}if(t.id===`trackMemoCancelBtn`){e.preventDefault(),bn();return}if(t.id===`trackMemoOverlay`){e.preventDefault(),bn();return}if(t.id===`cellNoteSaveBtn`){e.preventDefault(),wn();return}if(t.id===`cellNoteCloseBtn`){e.preventDefault(),Cn();return}if(t.id===`cellNoteOverlay`){e.preventDefault(),Cn();return}}),document.getElementById(`heatmapToggleBtn`)?.addEventListener(`click`,()=>{U.settings||={},J(),U.settings.heatmapEnabled=!U.settings.heatmapEnabled,q(),Q()})}function fn(){let e=document.getElementById(`heatmapToggleBtn`);e&&(U.settings&&U.settings.heatmapEnabled?(e.classList.add(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ON`):(e.classList.remove(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—OFF`))}function pn(e){let t=document.getElementById(`themeToggleBtn`);if(!t)return;let n=(e||U.settings&&U.settings.theme||`dark`)===`light`;t.textContent=n?`ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰`:`â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰`,t.classList.toggle(`active`,n)}function mn(e){let t=e===`light`?`light`:`dark`;document.body.classList.toggle(`theme-light`,t===`light`),document.body.classList.toggle(`theme-dark`,t===`dark`),document.documentElement.style.colorScheme=t===`light`?`light`:`dark`,pn(t),typeof styleAllCellSelect==`function`&&styleAllCellSelect()}function hn(e){Tn();let t=e===`light`?`light`:`dark`;localStorage.setItem(Fe,t),U.settings.theme=t,q(),mn(t),Q()}function gn(e){let t=e!==!1;document.body.classList.toggle(`hide-row-tags`,!t),vn(t)}function _n(e){Tn(),U.settings.showProjectTags=!!e,q(),gn(e)}function vn(e){let t=document.getElementById(`tagToggleBtn`);if(!t)return;let n=e!==!1;t.textContent=n?`ğŸ· ã‚¿ã‚°éè¡¨ç¤º`:`ğŸ· ã‚¿ã‚°è¡¨ç¤º`,t.classList.toggle(`active`,n)}function yn(e,t){R.projectId=e,R.trackId=t;let n=U.projects.find(t=>t.id===e),r=n?.tracks.find(e=>e.id===t);if(!n||!r)return;let i=document.getElementById(`trackMemoOverlay`),a=document.getElementById(`trackMemoTitle`),o=document.getElementById(`trackMemoText`);a.textContent=`${$(n.name)} - ${$(r.name)}`,o.value=r.memo||``,i.classList.remove(`hidden`),o.focus()}function bn(){let e=document.getElementById(`trackMemoOverlay`);e&&e.classList.add(`hidden`),R.projectId=null,R.trackId=null}function xn(){if(!R.projectId||!R.trackId)return;let e=U.projects.find(e=>e.id===R.projectId),t=e?.tracks.find(e=>e.id===R.trackId);if(!e||!t){bn();return}let n=document.getElementById(`trackMemoText`).value.trim();J(),t.memo=n,he(R.projectId),q(),bn();{let e=document.querySelector(`.row-header-memo-btn[data-track-id="${R.trackId}"]`);e&&(e.title=n||`ãƒ¡ãƒ¢æœªè¨­å®š`)}}function Sn(e,t){z.trackId=e,z.dateIso=t;let n=document.getElementById(`cellNoteOverlay`),r=document.getElementById(`cellNoteTitle`),i=document.getElementById(`cellNoteTextarea`),a=X(e,t),o=U.cellNotes[a]||``;r.textContent=`${t} ã®ãƒ¡ãƒ¢`,i.value=o,n.classList.remove(`hidden`),i.focus()}function Cn(){let e=document.getElementById(`cellNoteOverlay`);e&&e.classList.add(`hidden`),z.trackId=null,z.dateIso=null}function wn(){if(!z.trackId||!z.dateIso)return;let e=document.getElementById(`cellNoteTextarea`).value.trim(),t=X(z.trackId,z.dateIso);J(),e?U.cellNotes[t]=e:delete U.cellNotes[t],S(z.trackId),q(),Cn();{let t=document.querySelector(`.cell[data-track-id="${z.trackId}"][data-date="${z.dateIso}"]`);t&&(e?(t.classList.add(`has-note`),t.title=e):(t.classList.remove(`has-note`),t.title=``))}}function Tn(){U.settings||={}}function En(){Tn();let e=new Date,t=G(W(e)),n=U.settings.lastRollDate||null;(e.getHours()>4||e.getHours()===4&&e.getMinutes()>=0)&&n!==t&&(J(),U.startDate=t,U.settings.lastRollDate=t,q())}function Dn(){En(),setInterval(En,60*1e3)}function On(){Ot()}dn(),On(),window.addEventListener(`resize`,Et),window.addEventListener(`resize`,Dt),(function(){u&&(document.body.classList.add(`embedded`),cn(!1)),(d===`light`||d===`dark`)&&hn(d),window.addEventListener(`message`,e=>{let t=e.data;!t||typeof t!=`object`||t.type===`SET_THEME`&&(t.theme===`light`||t.theme===`dark`)&&hn(t.theme)})})(),Dn(),Q();