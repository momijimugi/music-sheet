import{r as e,t}from"./firebase-B6LBwd9E.js";import{T as n,_ as r,b as i,c as a,d as o,f as s,g as c,h as l,o as ee,r as te,s as ne,u,v as d,x as re,y as f}from"./index.esm-B0-OTnKT.js";import{i as ie,n as p,t as ae}from"./ui_common-Bmq5Fv_e.js";/* empty css              */import{t as oe}from"./nav-BxOCraw_.js";var m=e=>document.getElementById(e),h=e=>m(`msg`).textContent=e||``,g=document.getElementById(`lastUpdated`),_=null,se=``,v=null,ce=``;function le(e){return e?e?.seconds==null?e instanceof Date?e.getTime():0:e.seconds*1e3+(e.nanoseconds||0)/1e6:0}function y(e,t){if(!g)return;if(!e){g.textContent=`更新: --`;return}let n=ue(t),r=e?.toDate?e.toDate():e instanceof Date?e:null;g.textContent=`更新: ${[r?r.toLocaleString():``,n].filter(Boolean).join(` `)||`--`}`}function ue(e){let t=String(e||``).trim();return t?t.includes(`@`)?t.split(`@`)[0]:t:``}function b(){let e=le(_);le(v)>=e?y(v,ce):y(_,se)}var x=await ie(),S=()=>x?.displayName||x?.email||x?.uid||``,C=`/music-sheet/`,w=`${C}index.html`;async function de(t){if(!t?.uid)return new Set;try{let n=(await s(r(ne(e,`members`),re(`memberUid`,`==`,t.uid)))).docs.map(e=>e.ref.parent.parent?.id).filter(Boolean);return new Set(n)}catch(e){return console.warn(`member project list failed`,e),new Set}}var fe=await de(x),{project:T}=ae();if(!T)throw location.replace(w),Error(`missing project`);if(localStorage.setItem(`lastProject`,T),!x)throw h(`ログインしてください`),n(t,e=>{e&&location.reload()}),Error(`not logged in`);var E=document.getElementById(`portalProjectPill`),D=document.getElementById(`projectSwitcher`),O=document.querySelector(`.portalActions a[href$='admin.html']`),pe=`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);function k(e){return!!e?.email&&pe.includes(e.email)}oe({current:`portal`,projectId:T,hideAdmin:!k(x)});function A(e){return String(e||``).trim().toLowerCase()}function j(e,t,n){if(!e)return!1;if(k(e))return!0;let r=A(e?.email);if(r&&A(t?.ownerEmail)===r)return!0;let i=e?.uid;return!!(i&&Array.isArray(t?.members)&&t.members.includes(i)||i&&t?.roleByUid&&t.roleByUid[i]||n&&fe.has(n))}var M=encodeURIComponent(T),N=m(`meetingEditor`);async function me(){if(D){if(!x){D.style.display=`none`;return}try{let t=[];if(k(x))(await s(ee(e,`projects`))).forEach(e=>t.push({id:e.id,...e.data()||{}}));else{let n=[...fe];n.length&&(t=(await Promise.all(n.map(async t=>{try{let n=await o(u(e,`projects`,t));if(!n.exists())return null;let r=n.data()||{};return r.deleted||!j(x,r,t)?null:{id:t,...r}}catch(e){return e?.code!==`permission-denied`&&console.warn(`project doc read failed`,e),null}}))).filter(Boolean))}let n=t.filter(e=>!e.deleted&&j(x,e,e.id));if(n.sort((e,t)=>String(e.name||e.id).localeCompare(String(t.name||t.id))),!n.length){D.style.display=`none`;return}D.innerHTML=``,n.forEach(e=>{let t=document.createElement(`option`);t.value=e.id,t.textContent=e.name||e.id,D.appendChild(t)});let r=n.find(e=>e.id===T),i=r||n[0];if(i?.id&&(D.value=i.id,E&&(E.textContent=i.name||i.id),!r)){location.replace(`${C}portal.html?project=${encodeURIComponent(i.id)}`);return}D.style.display=n.length>1?`inline-flex`:`none`}catch(e){console.error(e),D.style.display=`none`}}}D?.addEventListener(`change`,()=>{let e=D.value;!e||e===T||(localStorage.setItem(`lastProject`,e),location.href=`${C}portal.html?project=${encodeURIComponent(e)}`)}),m(`toSheet`).href=`${C}sheet.html?project=${encodeURIComponent(T)}`;var P=document.getElementById(`scheduleFrame`),F=document.getElementById(`openSchedule`),I=document.querySelector(`.portalSchedule`),L=!1,R=e=>{P?.contentWindow&&P.contentWindow.postMessage({type:`SET_THEME`,theme:e},`*`)};function z(){if(!L)return;let e=document.documentElement.dataset.theme||p(),t=`client=1`;P&&(P.src=`${C}schedule-portal.html?theme=${e}&${t}&project=${M}`,R(e)),F&&(F.href=`${C}schedule-portal.html?theme=${e}&${t}&project=${M}`)}function B(e){L=!!e,I&&(I.style.display=L?``:`none`),!L&&P&&(P.src=`about:blank`),L&&z()}B(!1),P?.addEventListener(`load`,()=>{R(document.documentElement.dataset.theme||p())}),window.addEventListener(`themechange`,()=>z());var he=u(e,`projects`,T),V=u(e,`projects`,T,`portal`,`main`),ge=ee(e,`projects`,T,`portalLogs`),H=null,U=null,_e=[],W=k(x),G=localStorage.getItem(`debugGuestMode`)===`1`,K=W&&!G,ve=document.getElementById(`dropboxAdmin`),ye=document.getElementById(`referenceAdmin`),be=document.getElementById(`pdfAdmin`),q=e=>{let t=document.getElementById(`referenceMsg`);t&&(t.textContent=e||``)},J=[],Y=e=>{let t=document.getElementById(`pdfMsg`);t&&(t.textContent=e||``)},xe=document.querySelector(`.portalEditor`),Se=document.querySelectorAll(`.toolbar button`),Ce=document.getElementById(`meetingTitle`);function we(){let e=document.getElementById(`portalGuestRow`);e&&(e.style.display=W?`flex`:`none`);let t=document.getElementById(`togglePortalGuest`);t&&(t.checked=G,t.disabled=!W);let n=document.getElementById(`portalGuestState`);n&&(n.textContent=G?`ON`:`OFF`)}function Te(){K=W&&!G,ve&&(ve.style.display=K?`flex`:`none`),ye&&(ye.style.display=K?`flex`:`none`),be&&(be.style.display=K?`flex`:`none`),O&&(O.href=`${C}admin.html`,O.style.display=W?`inline-flex`:`none`),N&&N.setAttribute(`contenteditable`,K?`true`:`false`),Se.forEach(e=>e.disabled=!K),Ce&&(Ce.disabled=!K),document.getElementById(`btnSave`)?.toggleAttribute(`disabled`,!K),document.getElementById(`btnMeetingClear`)?.toggleAttribute(`disabled`,!K),xe?.classList.toggle(`readOnly`,!K),we(),Q(J)}Te(),document.getElementById(`togglePortalGuest`)?.addEventListener(`change`,e=>{W&&(G=!!e.target?.checked,localStorage.setItem(`debugGuestMode`,G?`1`:`0`),Te())});var X=null;try{X=await o(he)}catch(e){throw e?.code===`permission-denied`?(h(`このプロジェクトの閲覧権限がありません`),location.replace(w),e):(console.warn(`project doc read failed`,e),h(`このプロジェクトの閲覧権限がありません`),location.replace(w),e)}if(X?.exists()){let e=X.data()||{};if(e.deleted)throw alert(`このプロジェクトは消去されています（管理者に連絡してください）`),location.replace(`${C}admin.html`),Error(`deleted project`);if(!j(x,e,T))throw h(`このプロジェクトの閲覧権限がありません`),location.replace(w),Error(`not member`);let t=e.name||T;m(`pTitle`).textContent=t,E&&(E.textContent=t),B(j(x,e,T))}else throw location.replace(w),Error(`project not found`);me(),l(V,e=>{let t=e.exists()?e.data():{};_=t?.updatedAt||null,se=t?.updatedBy||``,b();let n=(t?.dropboxLink||``).trim(),r=(t?.schedulePdfLink||``).trim();J=Array.isArray(t?.referenceLinks)?t.referenceLinks.filter(e=>typeof e==`string`&&e.trim()):[];let i=document.getElementById(`dropboxOpen`),a=document.getElementById(`dropboxUnset`),o=document.getElementById(`dropboxUrl`);n?(i&&(i.style.display=`inline-flex`,i.href=n),a&&(a.style.display=`none`),K&&o&&(o.value=n)):(i&&(i.style.display=`none`),a&&(a.style.display=`block`),K&&o&&(o.value=``)),Q(J),Ae(r)}),document.getElementById(`btnSaveDropbox`)?.addEventListener(`click`,async()=>{if(!K){h(`管理者のみ設定できます`);return}await f(V,{dropboxLink:(document.getElementById(`dropboxUrl`)?.value||``).trim(),updatedAt:d(),updatedBy:S()},{merge:!0}),h(`Dropboxリンクを保存しました`),setTimeout(()=>h(``),1e3)}),document.getElementById(`btnClearDropbox`)?.addEventListener(`click`,async()=>{if(!K){h(`管理者のみ設定できます`);return}await f(V,{dropboxLink:``,updatedAt:d(),updatedBy:S()},{merge:!0}),h(`Dropboxリンクをクリアしました`),setTimeout(()=>h(``),1e3)}),document.getElementById(`btnSavePdf`)?.addEventListener(`click`,async()=>{if(!K){Y(`管理者のみ設定できます`);return}let e=Oe((document.getElementById(`pdfUrl`)?.value||``).trim());if(!e){Y(`リンクの形式を確認してください`);return}await f(V,{schedulePdfLink:e,updatedAt:d(),updatedBy:S()},{merge:!0}),Y(`PDFリンクを保存しました`),setTimeout(()=>Y(``),1200)}),document.getElementById(`btnClearPdf`)?.addEventListener(`click`,async()=>{if(!K){Y(`管理者のみ設定できます`);return}await f(V,{schedulePdfLink:``,updatedAt:d(),updatedBy:S()},{merge:!0}),Y(`PDFリンクをクリアしました`),setTimeout(()=>Y(``),1200)}),document.getElementById(`pdfUrl`)?.addEventListener(`keydown`,e=>{e.key===`Enter`&&(e.preventDefault(),document.getElementById(`btnSavePdf`)?.click())}),document.getElementById(`btnAddReference`)?.addEventListener(`click`,async()=>{if(!K){q(`管理者のみ設定できます`);return}let e=Oe((document.getElementById(`referenceInput`)?.value||``).trim());if(!e){q(`リンクの形式を確認してください`);return}await f(V,{referenceLinks:[...new Set([...J,e])],updatedAt:d(),updatedBy:S()},{merge:!0});let t=document.getElementById(`referenceInput`);t&&(t.value=``),q(`参考曲を追加しました`),setTimeout(()=>q(``),1200)}),document.getElementById(`referenceInput`)?.addEventListener(`keydown`,e=>{e.key===`Enter`&&(e.preventDefault(),document.getElementById(`btnAddReference`)?.click())}),document.querySelectorAll(`.tb[data-cmd]`).forEach(e=>{e.addEventListener(`click`,t=>{if(t.preventDefault(),!K){h(`ゲストは閲覧のみです`);return}let n=e.dataset.cmd;document.execCommand(n,!1,null),N.focus()})}),m(`btnMeetingClear`).addEventListener(`click`,e=>{if(e.preventDefault(),!K){h(`ゲストは閲覧のみです`);return}confirm(`メモを全消去する？`)&&(N.innerHTML=``)});function Z(e){return String(e).replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#039;`)}function Ee(e){let t=new Set,n=/href=["']([^"']+)["']/gi,r;for(;r=n.exec(e||``);)t.add(r[1]);let i=(e||``).replace(/<[^>]+>/g,` `).replace(/\s+/g,` `),a=/(https?:\/\/[^\s<>"']+)/g;for(;r=a.exec(i);)t.add(r[1]);return[...t].filter(e=>e.startsWith(`http`))}function De(e){try{let t=new URL(e);if(t.hostname===`youtu.be`)return t.pathname.slice(1)||null;if(t.hostname.includes(`youtube.com`)){let e=t.searchParams.get(`v`);if(e)return e;let n=t.pathname.match(/\/shorts\/([^\/]+)/);if(n)return n[1];let r=t.pathname.match(/\/embed\/([^\/]+)/);if(r)return r[1]}}catch{}return null}function Oe(e){let t=String(e||``).trim();if(!t)return``;try{return new URL(t).toString()}catch{try{return new URL(`https://${t}`).toString()}catch{return``}}}function ke(e){try{let t=new URL(e),n=t.hostname.replace(/^www\./,``);if(n.includes(`drive.google.com`)){let e=``,n=t.pathname.match(/\/file\/d\/([^\/]+)/);if(n&&(e=n[1]),e||=t.searchParams.get(`id`)||``,e)return`https://drive.google.com/file/d/${e}/preview`}if(n.includes(`dropbox.com`))return t.searchParams.delete(`dl`),t.searchParams.set(`raw`,`1`),t.toString()}catch{return``}return e}function Ae(e){let t=document.getElementById(`pdfOpen`),n=document.getElementById(`pdfUnset`),r=document.getElementById(`pdfViewer`),i=document.getElementById(`pdfUrl`);if(!e){t&&(t.style.display=`none`),n&&(n.style.display=`block`),r&&(r.style.display=`none`),K&&i&&(i.value=``);return}if(t&&(t.style.display=`inline-flex`,t.href=e),n&&(n.style.display=`none`),r){let t=ke(e)||e;r.style.display=`block`,r.innerHTML=`<iframe class="pdfFrame" src="${t}" loading="lazy" title="Schedule PDF"></iframe>`}K&&i&&(i.value=e)}function je(e){let t=De(e);if(t)return{provider:`youtube`,label:`YouTube`,embedUrl:`https://www.youtube.com/embed/${t}`};try{let t=new URL(e),n=t.hostname.replace(/^www\./,``);if(n.includes(`spotify.com`)){let e=t.pathname.split(`/`).filter(Boolean);if(e.length>=2)return{provider:`spotify`,label:`Spotify`,embedUrl:`https://open.spotify.com/embed/${e[0]}/${e[1]}`}}if(n.includes(`music.apple.com`)){let e=new URL(t.toString());return e.hostname=`embed.music.apple.com`,{provider:`apple`,label:`Apple Music`,embedUrl:e.toString()}}}catch{}return null}function Q(e){let t=document.getElementById(`referenceList`),n=document.getElementById(`referenceUnset`),r=document.getElementById(`referenceCount`);if(t){if(!e.length){t.innerHTML=``,n&&(n.style.display=`block`),r&&(r.textContent=``);return}n&&(n.style.display=`none`),r&&(r.textContent=`${e.length}件`),t.innerHTML=e.map((e,t)=>{let n=je(e),r=n?.label||`リンク`,i=Z(e),a=K?`<button class="smallBtn ghost" type="button" data-act="removeReference" data-idx="${t}">削除</button>`:``;return`
      <details class="referenceItem"${t===0?` open`:``}>
        <summary>
          <span class="referenceTitle"><span class="tagPill">${r}</span>${i}</span>
          <span class="referenceActions">${a}</span>
        </summary>
        <div class="referenceBody">
          ${n?`
        <div class="referenceEmbed" data-provider="${n.provider}">
          <iframe data-src="${n.embedUrl}" loading="lazy" allow="autoplay *; encrypted-media *; clipboard-write" allowfullscreen></iframe>
        </div>
      `:``}
          <a class="referenceLink" href="${i}" target="_blank" rel="noopener">${i}</a>
        </div>
      </details>
    `}).join(``),t.querySelectorAll(`details.referenceItem`).forEach(e=>{let t=e.querySelector(`iframe[data-src]`);t&&(e.addEventListener(`toggle`,()=>{e.open&&!t.src&&(t.src=t.dataset.src||``)}),e.open&&!t.src&&(t.src=t.dataset.src||``))}),t.onclick=async e=>{let t=e.target?.closest(`button[data-act='removeReference']`);if(!t||!K)return;e.preventDefault(),e.stopPropagation();let n=Number(t.dataset.idx);Number.isNaN(n)||await f(V,{referenceLinks:J.filter((e,t)=>t!==n),updatedAt:d(),updatedBy:S()},{merge:!0})}}}function $(e){let t=Ee(e);return t.length===0?``:`<div class="linkPreviewGrid">${t.slice(0,6).map(e=>{let t=De(e);return t?`
        <a class="linkCard" href="${e}" target="_blank" rel="noopener">
          <img class="linkThumb" loading="lazy" src="${`https://img.youtube.com/vi/${t}/hqdefault.jpg`}" alt="YouTube thumbnail">
          <div class="linkMeta">
            <div class="linkTitle">YouTube</div>
            <div class="linkUrl">${e}</div>
          </div>
        </a>
      `:`
      <a class="linkCard" href="${e}" target="_blank" rel="noopener">
        <div class="linkMeta">
          <div class="linkTitle">リンク</div>
          <div class="linkUrl">${e}</div>
        </div>
      </a>
    `}).join(``)}</div>`}function Me(){return K}function Ne(e){let t=e.createdByName||e.createdBy||``,n=e.createdAt?.toDate?e.createdAt.toDate():null;return{t:n?n.toLocaleString():``,by:t,title:e.title||`打ち合わせメモ`,html:e.meetingHtml||``,archived:!!e.archived}}function Pe(e){let t=document.getElementById(`showArchived`)?.checked?e:e.filter(e=>!e.archived),n=document.getElementById(`latestMeeting`),r=document.getElementById(`latestMeta`),i=document.getElementById(`meetingHistory`);if(!n||!r||!i)return;if(t.length===0){H=null,U=null,n.innerHTML=`<div class="muted">まだログがありません</div>`,r.textContent=``,i.innerHTML=`<div class="muted">—</div>`,document.getElementById(`btnArchiveLatest`)?.setAttribute(`disabled`,`true`),document.getElementById(`btnDeleteLatest`)?.setAttribute(`disabled`,`true`);return}H=t[0].id,U=t[0];let a=Ne(t[0]);r.textContent=`${a.title}　${a.t}　${a.by}`.trim(),n.innerHTML=`
    <div class="logMeta"><b>${Z(a.title)}</b>${a.archived?` <span class="muted">（アーカイブ）</span>`:``}</div>
    <div class="logText">${a.html}</div>
    ${typeof $==`function`?$(a.html):``}
  `;let o=t.slice(1);o.length===0?i.innerHTML=`<div class="muted">過去ログはまだありません</div>`:i.innerHTML=o.map(e=>{let t=Ne(e),n=K&&t.archived?`<div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
             <button class="smallBtn danger" type="button" data-act="deleteLog" data-id="${e.id}">消去</button>
           </div>`:``;return`
        <details class="logToggle">
          <summary>
            <span>${Z(t.title)}　<span class="muted">${Z(t.t||``)}</span></span>
            <span class="muted">${Z(t.by||``)}${t.archived?`（A）`:``}</span>
          </summary>
          <div class="logItem" style="margin-top:8px;">
            <div class="logText">${t.html}</div>
            ${typeof $==`function`?$(t.html):``}
            ${n}
          </div>
        </details>
      `}).join(``);let s=Me(x,t[0]),c=document.getElementById(`btnArchiveLatest`),l=document.getElementById(`btnDeleteLatest`);c&&(c.disabled=!s),l&&(l.disabled=!s)}l(r(ge,c(`createdAt`,`desc`)),e=>{let t=[];e.forEach(e=>t.push({id:e.id,...e.data()})),_e=t,v=t[0]?.createdAt||null,ce=t[0]?.createdByName||t[0]?.createdBy||``,b(),Pe(t)},e=>{console.error(e),h(`ログ同期エラー: ${e.code||e.message}`)}),document.getElementById(`showArchived`)?.addEventListener(`change`,()=>{Pe(_e)}),document.getElementById(`meetingHistory`)?.addEventListener(`click`,async t=>{let n=t.target?.closest(`button[data-act='deleteLog']`);if(!n||!K)return;t.preventDefault(),t.stopPropagation();let r=n.dataset.id;if(r&&confirm(`このメモを消去しますか？（元に戻せません）`))try{await a(u(e,`projects`,T,`portalLogs`,r)),h(`消去しました`),setTimeout(()=>h(``),900)}catch(e){console.error(e),h(`消去失敗: ${e.code||e.message}`)}}),m(`btnSave`).addEventListener(`click`,async()=>{if(!x){h(`ログインしてね`);return}if(!K){h(`ゲストは閲覧のみです`);return}let e=document.getElementById(`meetingTitle`),t=(e?.value||``).trim()||`打ち合わせメモ`,n=N.innerHTML||``;if(!n.trim()){h(`空のメモは保存できないよ`);return}let r=A(x?.email||``);if(!r){h(`メールアドレスが取得できません`);return}await te(ge,{title:t,meetingHtml:n,createdAt:d(),createdBy:r,createdByName:S()}),e&&(e.value=``),N.innerHTML=``,h(`ログとして保存しました`),setTimeout(()=>h(``),1200)}),document.getElementById(`btnArchiveLatest`)?.addEventListener(`click`,async()=>{if(!x){h(`ログインしてね`);return}if(!K){h(`管理者のみ操作できます`);return}if(!H||!U){h(`対象ログがありません`);return}if(confirm(`最新ログをアーカイブする？（通常表示から外れます）`))try{await i(u(e,`projects`,T,`portalLogs`,H),{archived:!0,archivedAt:d(),archivedBy:S()}),h(`アーカイブしました`),setTimeout(()=>h(``),900)}catch(e){console.error(e),h(`アーカイブ失敗: ${e.code||e.message}`)}}),document.getElementById(`btnDeleteLatest`)?.addEventListener(`click`,async()=>{if(!x){h(`ログインしてね`);return}if(!K){h(`管理者のみ操作できます`);return}if(!H||!U){h(`対象ログがありません`);return}if(confirm(`最新ログを消去します。よろしいですか？（元に戻せません）`)&&prompt(`最終確認：DELETE と入力してください`)===`DELETE`)try{await a(u(e,`projects`,T,`portalLogs`,H)),h(`消去しました`),setTimeout(()=>h(``),900)}catch(e){console.error(e),h(`消去失敗: ${e.code||e.message}`)}}),window.addEventListener(`keydown`,e=>{(navigator.platform.toLowerCase().includes(`mac`)?e.metaKey:e.ctrlKey)&&e.key.toLowerCase()===`s`&&(e.preventDefault(),m(`btnSave`).click())});