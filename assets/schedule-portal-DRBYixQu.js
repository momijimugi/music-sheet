import{n as e,t}from"./firebase-B4G0vEhV.js";import{T as n,_ as r,d as i,g as a,h as o,o as s,u as c,v as l,y as u}from"./index.esm-B0-OTnKT.js";/* empty css                      */import"./tabulator_esm-D-Igvjbx.js";var d=new URLSearchParams(location.search),f=!0,p=d.get(`theme`),m=d.get(`client`)===`1`||d.get(`client`)===`true`||d.get(`view`)===`client`,h=m,g=d.get(`project`)||``;if(document.querySelectorAll(`[data-embed-hide]`).forEach(e=>{e.style.display=`none`}),!g&&f)try{g=new URL(window.parent.location.href).searchParams.get(`project`)||``}catch{}var _=null,ee=g?`composerScheduleBoard_v10_${g}`:`composerScheduleBoard_v10`,v=g?c(e,`projects`,g,`scheduleBoard`,`state`):null;`dmikorogi@gmail.com,`.split(`,`).map(e=>e.trim()).filter(Boolean);var te=(()=>{let e=`csb_clientId`,t=sessionStorage.getItem(e);if(t)return t;let n=Math.random().toString(36).slice(2,10)+`_`+Date.now().toString(36);return sessionStorage.setItem(e,n),n})(),y=null,ne=0,re=null,ie=null,ae=new Map,oe=new Map,se=new Map,ce=new Map,le=new Map([{value:`very_long`,label:`very long`,color:`#ef4444`},{value:`long`,label:`long`,color:`#f97316`},{value:`mid`,label:`mid`,color:`#60a5fa`},{value:`short`,label:`short`,color:`#34d399`}].map(e=>[e.value,e])),b=null,ue=null,de=new Map;function fe(e){let t=document.getElementById(`topError`),n=String(e||``);t&&(t.textContent=n),n&&console.warn(`[schedule]`,n)}function pe(){b&&=(b(),null)}function me(){re&&=(re(),null),oe=new Map}function he(){ie&&=(ie(),null),ae.size&&(ae.forEach(e=>e&&e()),ae.clear()),ce=new Map,se.clear()}var ge=null,_e=null,ve=!1,ye=0,be=()=>!!y&&!h,x=[{name:`ä½œæ›²`,color:`#f5576c`},{name:`ã‚¢ãƒ¬ãƒ³ã‚¸`,color:`#84fab0`},{name:`REC`,color:`#ff9a9e`},{name:`MIX`,color:`#a18cd1`},{name:`ãƒã‚¹ã‚¿ãƒªãƒ³ã‚°`,color:`#f6d365`},{name:`æµ„æ›¸`,color:`#fda085`},{name:`ä¿®æ­£`,color:`#f093fb`},{name:`æ‰“ã¡åˆã‚ã›`,color:`#4facfe`}],S=21,xe=`theme`;function C(){let e=localStorage.getItem(xe);return e===`light`||e===`dark`?e:window.matchMedia&&window.matchMedia(`(prefers-color-scheme: light)`).matches?`light`:`dark`}var w=null,T=!1,E=``,D=new Set,O=!1,k=!1,A=null,j=null,M=null,N=null,P=[],F=[],I={},Se={},Ce=null,L={projectId:null,trackId:null},R={trackId:null,date:null},z={type:null,anchorBtn:null},B=`ALL`,V=m,H=[],we=20,U=ke();async function Te(r){if(pe(),he(),r&&(g=r),y=await new Promise(e=>n(t,e)),y||n(t,e=>{e&&location.reload()}),g){if(y){let e=await je();e?U=e:g&&(U=Ye(g))}let t=(U.projects||[]).find(e=>e.id===g)||{id:g,name:g||`ï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]};U.projects=[t],w=g,T=!0;let n=document.getElementById(`addProjectBtn`);n&&(n.style.display=`none`);let r=document.getElementById(`addTrackBtn`);r&&(r.style.display=`none`);let a=document.getElementById(`trackSyncNote`);a&&(a.style.display=`block`);let o=document.getElementById(`showAllBtn`),s=document.getElementById(`showSelectedBtn`);if(o&&(o.style.display=`none`),s&&(s.style.display=`none`),!y)console.warn(`not logged in (schedule)`);else try{let n=await i(c(e,`projects`,g));if(n.exists()){let e=n.data()||{};if(e.deleted){alert(`ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æ¶ˆå»ã•ã‚Œã¦ã„ã¾ã™ï¼ˆç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ï¼‰`),window.top.location.replace(`./admin.html`);return}t.name=e.name||t.name}else t.name=`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰`;_=t.name;try{J()}catch{}}catch(e){console.error(e),t.name=g||`ï¼ˆã‚¿ã‚¤ãƒˆãƒ«å–å¾—å¤±æ•—ï¼‰`}y&&Le(),y&&(qe(g),Je())}dn(),U.settings.theme||(U.settings.theme=C(),J()),(p===`light`||p===`dark`)&&(U.settings.theme=p),typeof U.settings.showProjectTags!=`boolean`&&(U.settings.showProjectTags=!1),$t(U.settings.theme),tn(!1),m&&qt(!0)}(async()=>{let e=new URLSearchParams(location.search),t=g||e.get(`project`)||``;if(t){await Te(t);return}fe(`project ãŒæœªæŒ‡å®šã§ã™`)})();function W(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function G(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,`0`)}-${String(e.getDate()).padStart(2,`0`)}`}function Ee(e){if(!e||typeof e!=`string`)return W(new Date);let t=e.split(`-`);if(t.length<3)return W(new Date);let n=Number(t[0]),r=Number(t[1]),i=Number(t[2]);return!n||!r||!i?W(new Date):new Date(n,r-1,i)}function K(e,t){let n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function De(e){return`${e.getMonth()+1}/${e.getDate()}ï¼ˆ${[`æ—¥`,`æœˆ`,`ç«`,`æ°´`,`æœ¨`,`é‡‘`,`åœŸ`][e.getDay()]}ï¼‰`}function Oe(e){return`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,`0`)}/${String(e.getDate()).padStart(2,`0`)} ${String(e.getHours()).padStart(2,`0`)}:${String(e.getMinutes()).padStart(2,`0`)}`}function q(){return`id_`+Math.random().toString(36).slice(2,9)+`_`+Date.now().toString(36)}function ke(){let e=localStorage.getItem(ee);if(!e){let e=W(new Date),t=q(),n=q(),r=q();return{startDate:G(e),daysToShow:S,lastBackupAt:null,projects:[{id:t,name:`ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[{id:n,name:`Main Theme`,memo:``},{id:r,name:`Ending`,memo:``}]}],schedule:{[n]:{[G(e)]:`ä½œæ›²`,[G(K(e,1))]:`ä½œæ›²`,[G(K(e,2))]:`MIX`},[r]:{[G(K(e,3))]:`ä½œæ›²`,[G(K(e,4))]:`REC`}},statuses:x,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:C()},cellNotes:{}}}try{let t=JSON.parse(e);if(!t.projects)throw Error(`invalid data`);return t.settings||={},typeof t.settings.cellWidth!=`number`&&(t.settings.cellWidth=70),typeof t.settings.cellHeight!=`number`&&(t.settings.cellHeight=28),typeof t.settings.heatmapEnabled!=`boolean`&&(t.settings.heatmapEnabled=!0),typeof t.settings.showProjectTags!=`boolean`&&(t.settings.showProjectTags=!0),t.settings.theme||(t.settings.theme=C()),t.cellNotes||={},t.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),(e.tracks||[]).forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),t.startDate||=G(W(new Date)),t.daysToShow||=S,(!t.statuses||!Array.isArray(t.statuses)||t.statuses.length===0)&&(t.statuses=x),t}catch(e){return console.warn(`failed to parse state, init new`,e),localStorage.removeItem(ee),ke()}}function Ae(e){if(!e||!Array.isArray(e.projects))throw Error(`invalid data`);return e.startDate||=G(W(new Date)),e.daysToShow||=S,(!e.statuses||!Array.isArray(e.statuses)||e.statuses.length===0)&&(e.statuses=x),e.settings||={},typeof e.settings.cellWidth!=`number`&&(e.settings.cellWidth=70),typeof e.settings.cellHeight!=`number`&&(e.settings.cellHeight=28),typeof e.settings.heatmapEnabled!=`boolean`&&(e.settings.heatmapEnabled=!0),typeof e.settings.showProjectTags!=`boolean`&&(e.settings.showProjectTags=!0),e.settings.theme||(e.settings.theme=C()),(!e.cellNotes||typeof e.cellNotes!=`object`)&&(e.cellNotes={}),e.projects.forEach(e=>{typeof e.collapsed!=`boolean`&&(e.collapsed=!1),typeof e.archived!=`boolean`&&(e.archived=!1),Array.isArray(e.tracks)||(e.tracks=[]),e.tracks.forEach(e=>{typeof e.memo!=`string`&&(e.memo=``)})}),(!e.schedule||typeof e.schedule!=`object`)&&(e.schedule={}),e}async function je(){if(!v||!y)return null;try{let e=await i(v);if(!e.exists())return null;let t=e.data()||{};return t.state?Ae(t.state):null}catch(e){return console.error(e),null}}var Me=null,Ne=null;function Pe(){if(O||k||_e||Date.now()-ne<800)return!0;let e=document.activeElement;if(e){let t=e.tagName;if(t===`SELECT`&&e.classList.contains(`cell-select`)||t===`INPUT`||t===`TEXTAREA`||e.isContentEditable)return!0;let n=document.getElementById(`inputPopover`);if(n&&!n.classList.contains(`hidden`)&&e.closest(`#inputPopover`))return!0}let t=document.getElementById(`trackMemoOverlay`);if(t&&!t.classList.contains(`hidden`))return!0;let n=document.getElementById(`cellNoteOverlay`);return!!(n&&!n.classList.contains(`hidden`))}function Fe(e){ve=!0;try{if(U=e,ue&&Ke(ue),g){let e=(U.projects||[]).find(e=>e.id===g)||{id:g,name:_||g||`Loading`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]};_&&(e.name=_),U.projects=[e],w=g,T=!0}dn(),$t(U.settings.theme||C()),D.clear(),M=null,Q()}finally{ve=!1}}function Ie(){Ne||=setTimeout(()=>{if(Ne=null,!Me)return;if(Pe()){Ie();return}let e=Me;Me=null,Fe(e)},300)}function Le(){!v||!y||(ge&&ge(),ge=o(v,e=>{if(!e.exists())return;let t=e.data()||{};if(!t.state||t.clientId&&t.clientId===te)return;let n=t.updatedAt,r=n?.seconds?n.seconds*1e3+(n.nanoseconds||0)/1e6:Date.now();if(r<=ye)return;ye=r;let i=new Set([y?.displayName,y?.email,y?.uid].filter(Boolean)).has(t.updatedBy),a=Date.now()-ne<1500;if(i&&a)return;let o=Ae(t.state);if(Pe()){Me=o,Ie();return}Fe(o)},e=>{console.error(e)}))}function Re(e,t){let n=(e?.m??``).toString().trim(),r=(e?.scene??``).toString().trim(),i=(e?.demo??``).toString().trim(),a=(e?.v??``).toString().trim(),o=[];return n&&o.push(`#${n}`),r?o.push(r):i?o.push(i):a&&o.push(`v:${a}`),o.join(` `)||(t?`cue:${t.slice(0,6)}`:`cue`)}function ze(e){let t=new Map;return Array.isArray(e)&&e.forEach(e=>{!e||!e.value||t.set(e.value,{label:e.label||e.value,color:e.color||`#6fd6ff`})}),t}function Be(e,t){if(!t)return null;let n=oe;return n&&n.has(t)?n.get(t):{label:t,color:`#6fd6ff`}}function Ve(e){return e?le.has(e)?le.get(e):{label:e,color:`#6fd6ff`}:null}function He(e){let t=String(e||``).trim();return/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t)?{bg:t+`22`,bd:t+`55`}:{bg:`rgba(111,214,255,0.18)`,bd:`rgba(111,214,255,0.55)`}}function Ue(e,t){let n=He(t);return`<span class="row-meta-pill" style="background:${n.bg};border-color:${n.bd};">${$(e)}</span>`}function We(e,t){let n=e?.status||``,r=e?.len||``,i=t||``,a=ce.get(e.id);return a&&(n=a.status||n||``,r=a.len||r||``,i=a.projectId||i||``),{status:n,len:r,projectId:i}}function Ge(e,t){let n=We(e,t),r=[];if(n.status){let e=Be(n.projectId,n.status),t=e?.label||n.status;r.push(Ue(`é€²æ—: ${t}`,e?.color))}if(n.len){let e=Ve(n.len),t=e?.label||n.len;r.push(Ue(`é•·ã•: ${t}`,e?.color))}return r.length?`<div class="row-header-meta">${r.join(``)}</div>`:`<div class="row-header-meta row-header-meta-empty"></div>`}function Ke(e){if(!g)return;U?.projects||(U.projects=[]);let t=U.projects.find(e=>e.id===g);t||(t={id:g,name:_||g,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]},U.projects=[t]);let n=new Map((t.tracks||[]).map(e=>[e.id,e.memo||``]));t.tracks=e.map(e=>({id:e.id,name:e.name,memo:n.get(e.id)||``,status:e.status||``,len:e.len||``})),U.schedule||={};let r=new Set(e.map(e=>e.id));Object.keys(U.schedule).forEach(e=>{r.has(e)||delete U.schedule[e]}),e.forEach(e=>{U.schedule[e.id]||(U.schedule[e.id]={})})}function qe(t){me(),t&&(re=o(c(e,`projects`,t,`settings`,`ui`),e=>{oe=ze((e.exists()&&e.data()||{}).statuses||[]),Q()},e=>{console.warn(`[schedule] sheet ui settings error`,e)}))}function Je(){!g||!y||(b&&b(),b=o(r(s(e,`projects`,g,`cues`),a(`m`)),e=>{let t=e.docs.map(e=>{let t=e.data()||{};return{id:e.id,name:Re(t,e.id),m:t?.m??null,status:t?.status||``,len:t?.len||``}});t.sort((e,t)=>{let n=parseInt(e.m,10),r=parseInt(t.m,10),i=Number.isFinite(n),a=Number.isFinite(r);return i&&a?n-r:i&&!a?-1:!i&&a?1:e.name.localeCompare(t.name,`ja`)}),ue=t.map(({id:e,name:t,status:n,len:r})=>({id:e,name:t,status:n,len:r})),Ke(ue),Q()},e=>{console.error(e),fe(`æ›²ãƒªã‚¹ãƒˆåŒæœŸã‚¨ãƒ©ãƒ¼: ${e.code||e.message}`)}))}function Ye(e){return Ae({projects:[{id:e,name:de.get(e)||e,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]}],schedule:{},cellNotes:{},statuses:x.slice(),daysToShow:S,settings:{cellWidth:70,cellHeight:28,heatmapEnabled:!0,showProjectTags:!0,theme:C()}})}function Xe(){ve||be()&&(!v||!y||(_e&&clearTimeout(_e),_e=setTimeout(async()=>{try{let e=JSON.parse(JSON.stringify(U));if(g){let t=(e.projects||[]).find(e=>e.id===g)||e.projects?.[0];t?_&&(!t.name||t.name.includes(`?????`)||t.name.includes(`????`))&&(t.name=_):t={id:g,name:_||`Untitled`,color:`#62c3ff`,collapsed:!1,archived:!1,tracks:[]},e.projects=[t]}await u(v,{state:e,updatedAt:l(),updatedBy:y?.displayName||y?.email||y?.uid||``,clientId:te,version:1},{merge:!0})}catch(e){console.error(e)}},500)))}function J(){try{localStorage.setItem(ee,JSON.stringify(U))}catch{}ve||(ne=Date.now()),Xe()}function Y(){let e=JSON.parse(JSON.stringify(U));H.push(e),H.length>we&&H.shift()}function Ze(){H.length&&(U=H.pop(),J(),D.clear(),M=null,N=null,tn(U.settings.showProjectTags),$t(U.settings.theme),Q())}function Qe(){return[``,...U.statuses.map(e=>e.name)]}function $e(e){return e&&U.statuses.find(t=>t.name===e)||null}function et(e){if(!e)return null;let t=e.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function tt(e){let t=e.value,n=$e(t),r=e.closest(`.cell`);if(!r)return;let i=r.querySelector(`.cell-label`);i&&(i.textContent=t||``);let a=getComputedStyle(document.body),o=a.getPropertyValue(`--text-main`).trim()||`#fdfdfd`,s=a.getPropertyValue(`--cell-bg`).trim()||`rgba(5,6,11,0.7)`,c=document.body.classList.contains(`theme-light`),l=r.classList.contains(`today`),u=c?`linear-gradient(to bottom, rgba(111,214,255,0.45), rgba(111,214,255,0.2))`:`linear-gradient(to bottom, rgba(111,214,255,0.7), rgba(111,214,255,0.3))`,d=c?`rgba(8,12,22,0.12)`:`rgba(255,255,255,0.16)`;if(!n){r.style.background=l?u:s,e.style.borderColor=d,i&&(i.style.color=o);return}let f=et(n.color)||{r:111,g:214,b:255},p=f.r,m=f.g,h=f.b,g;g=l?c?`linear-gradient(to bottom, rgba(${p},${m},${h},0.55), rgba(${p},${m},${h},0.3))`:`linear-gradient(to bottom, rgba(${p},${m},${h},0.9), rgba(${p},${m},${h},0.5))`:c?`linear-gradient(135deg, rgba(${p},${m},${h},0.16), rgba(${p},${m},${h},0.42))`:`linear-gradient(135deg, rgba(${p},${m},${h},0.22), rgba(${p},${m},${h},0.6))`,r.style.background=g,e.style.borderColor=`rgba(${p},${m},${h},${c?.7:.85})`,i&&(i.style.color=c?`#1f2430`:`#fdfdfd`)}function nt(){document.querySelectorAll(`.cell-select`).forEach(tt)}function X(e,t){return e+`|`+t}function rt(){document.querySelectorAll(`.cell`).forEach(e=>{let t=e.dataset.trackId,n=e.dataset.date,r=t&&n?X(t,n):null;r&&D.has(r)?e.classList.add(`selected`):e.classList.remove(`selected`)})}var it=null;function at(e,t){if(!P.length||!F.length)return;let n=Math.min(e.rowIndex,t.rowIndex),r=Math.max(e.rowIndex,t.rowIndex),i=Math.min(e.colIndex,t.colIndex),a=Math.max(e.colIndex,t.colIndex);D.clear();for(let e=n;e<=r;e++){if(!P[e])continue;let t=P[e].track;for(let e=i;e<=a;e++){if(!F[e])continue;let n=G(F[e]);D.add(X(t.id,n))}}rt()}function ot(){let e=[];return D.forEach(t=>{let[n,r]=t.split(`|`),i=I[n],a=Se[r];i!=null&&a!=null&&e.push({trackId:n,date:r,rowIndex:i,colIndex:a})}),e}function st(){let e=document.getElementById(`projectList`);e.innerHTML=``;let t=U.projects.filter(e=>!e.archived),n=U.projects.filter(e=>e.archived);if(!t.length&&!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>ã¾ã æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            æ¡ˆä»¶ã¯ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£å‹•ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦æ›²ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
          </div>
        `;return}if(t.forEach(t=>{let n=(t.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item`+(t.id===w?` active`:``),r.dataset.projectId=t.id,r.innerHTML=`
          <div class="project-name">
            <span class="project-dot" style="background:${t.color||`#62c3ff`}"></span>
            <span>${$(t.name)}</span>
          </div>
          <div style="display:flex; align-items:center; gap:4px;">
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-up-btn"
                    data-project-id="${t.id}"
                    title="ä¸Šã¸">
              â–²
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-down-btn"
                    data-project-id="${t.id}"
                    title="ä¸‹ã¸">
              â–¼
            </button>
            <div class="project-meta">${n}æ›²</div>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-archive-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
              ğŸ“¦
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                    data-project-id="${t.id}"
                    title="æ¡ˆä»¶ã‚’å‰Šé™¤">
              ğŸ—‘
            </button>
          </div>
        `,r.addEventListener(`click`,e=>{e.target.closest(`.project-delete-btn`)||e.target.closest(`.project-move-up-btn`)||e.target.closest(`.project-move-down-btn`)||e.target.closest(`.project-archive-btn`)||(w=t.id,Ot(),Q())}),e.appendChild(r)}),n.length){let t=document.createElement(`div`);t.style.marginTop=`20px`,t.style.borderTop=`1px solid #e0e0e0`,t.style.paddingTop=`10px`;let r=document.createElement(`div`);r.style.fontSize=`12px`,r.style.fontWeight=`bold`,r.style.color=`#999`,r.style.marginBottom=`8px`,r.textContent=`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿`,t.appendChild(r),n.forEach(e=>{let n=(e.tracks||[]).length,r=document.createElement(`div`);r.className=`project-item archived`,r.dataset.projectId=e.id,r.style.opacity=`0.6`,r.innerHTML=`
            <div class="project-name">
              <span class="project-dot" style="background:${e.color||`#62c3ff`}"></span>
              <span>${$(e.name)}</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
              <div class="project-meta">${n}æ›²</div>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-unarchive-btn"
                      data-project-id="${e.id}"
                      title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’è§£é™¤">
                â†©ï¸
              </button>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                      data-project-id="${e.id}"
                      title="æ¡ˆä»¶ã‚’å‰Šé™¤">
                ğŸ—‘
              </button>
            </div>
          `,t.appendChild(r)}),e.appendChild(t)}e.querySelectorAll(`.project-delete-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=U.projects.find(e=>e.id===n);r&&window.confirm(`æ¡ˆä»¶ã€Œ${r.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ¡ˆä»¶å†…ã®æ›²ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)&&(Y(),(r.tracks||[]).forEach(e=>{U.schedule[e.id]&&delete U.schedule[e.id]}),U.projects=U.projects.filter(e=>e.id!==n),w===n&&(w=U.projects.length?U.projects.find(e=>!e.archived)?.id||U.projects[0].id:null),J(),D.clear(),M=null,N=null,Q())})}),e.querySelectorAll(`.project-archive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=U.projects.find(e=>e.id===n);r&&(Y(),r.archived=!0,w===n&&(w=U.projects.find(e=>!e.archived)?.id||null),J(),Q())})}),e.querySelectorAll(`.project-unarchive-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=U.projects.find(e=>e.id===n);r&&(Y(),r.archived=!1,J(),Q())})}),e.querySelectorAll(`.project-move-up-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),ct(e.dataset.projectId,-1)})}),e.querySelectorAll(`.project-move-down-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation(),ct(e.dataset.projectId,1)})})}function ct(e,t){let n=U.projects.findIndex(t=>t.id===e);if(n<0)return;let r=n+t;if(r<0||r>=U.projects.length)return;Y();let[i]=U.projects.splice(n,1);U.projects.splice(r,0,i),J(),Q()}function lt(){let e=Ee(U.startDate),t=U.daysToShow||S,n=[];for(let r=0;r<t;r++){let t=K(e,r);n.push(t)}return n}function ut(){let e=lt(),t=document.getElementById(`dateRangeLabel`);if(!e.length)t.textContent=`---`;else{let n=e[0],r=e[e.length-1];t.textContent=`${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ã€œ ${r.getFullYear()}/${r.getMonth()+1}/${r.getDate()}`}let n=document.getElementById(`daysToShowInput`);n&&(n.value=U.daysToShow||S)}function dt(){let e=[];return U.projects.forEach(t=>{t.archived||T&&w&&t.id!==w||(t.tracks||[]).forEach(n=>{e.push({project:t,track:n})})}),e}function ft(e,t){let n={},r=e.map(e=>G(e));return r.forEach(e=>{n[e]=0}),t.forEach(({track:e})=>{let t=U.schedule[e.id]||{};r.forEach(e=>{let r=t[e];r&&r!==`none`&&(n[e]+=1)})}),n}function Z(){let e=document.getElementById(`gridWrapper`),t=lt(),n=dt();if(P=n,F=t,I={},Se={},n.forEach((e,t)=>{I[e.track.id]=t}),t.forEach((e,t)=>{Se[G(e)]=t}),!n.length){e.innerHTML=`
          <div class="empty-message">
            <strong>è¡¨ç¤ºã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>
            å·¦ã®ã€Œæ¡ˆä»¶ã‚’è¿½åŠ ã€â†’ã€Œæ›²ã‚’è¿½åŠ ã€ã§æ›²ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€
            ã“ã“ã« <strong>æ¡ˆä»¶ Ã— æ›² Ã— æ—¥ä»˜</strong> ã®ã‚°ãƒªãƒƒãƒ‰ãŒå‡ºã¦ãã¾ã™ã€‚
          </div>
        `;return}let r=G(W(new Date)),i=Qe(),a={};U.projects.forEach(e=>{e.deadline&&(a[e.id]=e.deadline)});let o=U.settings&&U.settings.heatmapEnabled,s=o?ft(t,n):{},c=0;o&&(Object.values(s).forEach(e=>{e>c&&(c=e)}),c<1&&(c=1));let l=``,u=``,d=`<table class="schedule-grid"><thead><tr>`;t.forEach(e=>{let t=G(e),n=t===r,i=Object.values(a).includes(t),c=0;if(o){let e=s[t]||0;c=Math.max(0,Math.min(1,e/5))}let l=[`date-header`,`date-header-heat`,n?`today`:``,i?`deadline`:``].filter(Boolean).join(` `);d+=`
          <th class="${l}"
              data-date="${t}"
              style="--heat-intensity:${c};">
            <span class="date-header-main">${De(e)}</span>
            <span class="date-header-sub">${t}</span>
          </th>
        `}),d+=`</tr></thead><tbody>`;let f=[];U.projects.forEach(e=>{if(e.archived||T&&w&&e.id!==w)return;let t=(e.tracks||[]).filter(e=>I[e.id]!=null);t.length&&f.push({project:e,tracks:t})}),f.forEach(e=>{let n=e.project,o=a[n.id]||null,s=n.deadline?`ç· åˆ‡: ${n.deadline}`:`ç· åˆ‡: æœªè¨­å®š`,c=!!n.collapsed;l+=`
          <tr class="project-group-row" data-project-id="${n.id}">
            <td class="project-group-cell">
              <div class="project-group-inner">
                <span class="project-group-dot" style="background:${n.color||`#62c3ff`}"></span>
                <span class="project-group-name">${$(n.name)}</span>
                <span class="project-group-deadline">${s}</span>
                <button type="button"
                        class="btn btn-ghost btn-sm project-deadline-btn"
                        data-project-id="${n.id}"
                        title="ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’è¨­å®š">
                  â±
                </button>
                <span class="project-group-toggle">
                  ${c?`â–¶`:`â–¼`}
                </span>
              </div>
            </td>
          </tr>
        `,u+=`
          <tr class="project-group-spacer" data-project-id="${n.id}">
            <td colspan="${t.length}"></td>
          </tr>
        `,!c&&e.tracks.forEach(e=>{let a=I[e.id],s=U.schedule[e.id]||{},c=Ge(e,n.id);l+=`
            <tr>
              <td class="row-header-cell" data-track-id="${e.id}">
                <div class="row-header-inner">
                  <div class="row-header-main">
                    <div class="row-header-top">
                      <div class="row-header-title"
                           data-project-id="${n.id}"
                           data-track-id="${e.id}"
                           data-track-name="${$(e.name)}"
                           data-project-name="${$(n.name)}">${$(e.name)}</div>
                      <div class="row-header-actions">
                        <button type="button"
                                class="btn btn-ghost btn-sm btn-icon-only row-header-memo-btn"
                                data-project-id="${n.id}"
                                data-track-id="${e.id}"
                                title="${$(e.memo||`ãƒ¡ãƒ¢æœªè¨­å®š`)}">
                          ğŸ“
                        </button>
                      </div>
                    </div>
                    <div class="row-header-tag">${$(n.name)}</div>
                  </div>
                  ${c}
                </div>
              </td>
            </tr>
          `;let d=`<tr>`;t.forEach((t,c)=>{let l=G(t),u=l===r,f=o&&o===l,p=s[l]||``,m=X(e.id,l),h=D.has(m),g=X(e.id,l),_=U.cellNotes[g],ee=[`cell`,u?`today`:``,h?`selected`:``,f?`deadline-col`:``,_?`has-note`:``].filter(Boolean).join(` `);d+=`
              <td class="${ee}"
                  data-project-id="${n.id}"
                  data-track-id="${e.id}"
                  data-date="${l}"
                  data-row-index="${a}"
                  data-col-index="${c}"
                  data-status="${$(p)}"
                  title="${$(_||``)}">
                <div class="cell-inner">
                  <span class="cell-label">${p?$(p):``}</span>
                  <button type="button"
                          class="cell-dropdown-btn"
                          data-project-id="${n.id}"
                          data-track-id="${e.id}"
                          data-date="${l}"
                          data-row-index="${a}"
                          data-col-index="${c}">â–¼</button>
                  <select
                    class="cell-select"
                    data-project-id="${n.id}"
                    data-track-id="${e.id}"
                    data-date="${l}"
                    data-row-index="${a}"
                    data-col-index="${c}"
                    onchange="handleCellChange(this)"
                  >
                    ${i.map(e=>`<option value="${e}" ${e===p?`selected`:``}>${e||`---`}</option>`).join(``)}
                  </select>
                </div>
              </td>
            `}),d+=`</tr>`,u+=d})}),e.innerHTML=`
        <div class="grid-split">
          <div class="grid-left" id="gridLeftPane">${`
        <table class="schedule-grid row-header-table">
          <thead>
            <tr>
              <th class="row-header"></th>
            </tr>
          </thead>
          <tbody>
      `+l+`</tbody></table>`}</div>
          <div class="grid-right" id="gridRightPane">${d+u+`</tbody></table>`}</div>
        </div>
      `;let p=document.getElementById(`gridLeftPane`),m=document.getElementById(`gridRightPane`);p&&m&&(m.addEventListener(`scroll`,()=>{p.scrollTop!==m.scrollTop&&(p.scrollTop=m.scrollTop)}),p.addEventListener(`scroll`,()=>{m.scrollTop!==p.scrollTop&&(m.scrollTop=p.scrollTop)})),pt(),mt(),nt(),xt(),St(),Ct(),rt(),wt(),Yt()}function pt(){let e=document.getElementById(`gridRightPane`);if(!e)return;let t=e.querySelector(`table.schedule-grid thead`);if(!t)return;let n=t.getBoundingClientRect(),r=Math.ceil(n.height);document.documentElement.style.setProperty(`--project-group-offset`,`${r}px`),document.documentElement.style.setProperty(`--grid-header-height`,`${r}px`)}function mt(){let e=document.querySelectorAll(`#gridLeftPane tbody tr`),t=document.querySelectorAll(`#gridRightPane tbody tr`),n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e[r].getBoundingClientRect().height,i=t[r].getBoundingClientRect().height,a=Math.max(n,i);e[r].style.height=`${a}px`,t[r].style.height=`${a}px`}}function ht(){U.settings||={cellWidth:70,cellHeight:28};let{cellWidth:e,cellHeight:t}=U.settings,n=document.documentElement;n.style.setProperty(`--cell-width`,(e||70)+`px`),n.style.setProperty(`--cell-height`,(t||28)+`px`),n.style.setProperty(`--cell-font-size`,`0.68rem`);let r=document.getElementById(`colWidthInput`),i=document.getElementById(`rowHeightInput`);r&&(r.value=e||70),i&&(i.value=t||28)}function gt(){let e=document.getElementById(`backupStatus`),t=document.getElementById(`backupStatusText`);if(!U.lastBackupAt){t.textContent=`ã¾ã ã‚ã‚Šã¾ã›ã‚“`,e.classList.remove(`overdue`);return}let n=new Date(U.lastBackupAt);if(isNaN(n.getTime())){t.textContent=`ä¸æ˜ï¼ˆå†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ï¼‰`,e.classList.add(`overdue`);return}t.textContent=Oe(n),new Date().getTime()-n.getTime()>2880*60*1e3?e.classList.add(`overdue`):e.classList.remove(`overdue`)}function _t(){let e=document.getElementById(`statusFilterSelect`);if(!e)return;let t=U.statuses||[],n=`<option value="ALL">ã™ã¹ã¦</option>`;if(t.forEach(e=>{let t=$(e.name);n+=`<option value="${t}">${t}</option>`}),e.innerHTML=n,B!==`ALL`){let n=t.some(e=>e.name===B);e.value=n?B:`ALL`,n||(B=`ALL`)}else e.value=`ALL`}function Q(){!w&&U.projects.length&&(w=U.projects[0].id),ht(),st(),ut(),Z(),gt(),_t(),Ot(),Jt(),Zt()}function vt(e,t,n){if(bt(),!e)return;let r=document.createElement(`div`);r.className=`alt-ghost`,r.textContent=e,r.style.left=t+`px`,r.style.top=n+`px`,document.body.appendChild(r),j=r}function yt(e,t){j&&(j.style.left=e+`px`,j.style.top=t+`px`)}function bt(){j&&=(j.remove(),null)}function xt(){document.querySelectorAll(`.cell`).forEach(e=>{e.addEventListener(`mousedown`,Tt),e.addEventListener(`mouseenter`,Et),e.addEventListener(`mouseup`,Dt),e.addEventListener(`dblclick`,t=>{t.stopPropagation();let n=e.dataset.trackId,r=e.dataset.date;cn(n,r)})}),document.querySelectorAll(`.cell-select`).forEach(e=>{e.addEventListener(`focus`,()=>{M={rowIndex:parseInt(e.dataset.rowIndex,10),colIndex:parseInt(e.dataset.colIndex,10),trackId:e.dataset.trackId,date:e.dataset.date}})})}function St(){document.querySelectorAll(`.row-header-memo-btn`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId,r=e.dataset.trackId;an(n,r)})}),document.querySelectorAll(`.row-header-title`).forEach(e=>{e.addEventListener(`click`,t=>{t.stopPropagation();let n=e.dataset.projectId||``,r=e.dataset.trackId||``;E=r,wt();let i=r;n&&i.startsWith(`${n}__`)&&(i=i.slice(n.length+2));let a={type:`SCHEDULE_TRACK_SELECT`,projectId:n,trackId:r,cueId:i,trackName:e.dataset.trackName||e.textContent||``,projectName:e.dataset.projectName||``};window.parent&&window.parent!==window&&window.parent.postMessage(a,`*`)})}),document.querySelectorAll(`.project-deadline-btn`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.projectId,n=U.projects.find(e=>e.id===t);if(!n)return;let r=n.deadline||``,i=window.prompt(`ã“ã®æ¡ˆä»¶ã®ç· åˆ‡æ—¥ã‚’ YYYY-MM-DD å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºã§è§£é™¤ï¼‰`,r);if(i===null)return;let a=i.trim();if(Y(),!a)delete n.deadline;else{if(!a.match(/^(\d{4})-(\d{2})-(\d{2})$/)){window.alert(`æ—¥ä»˜ã¯ YYYY-MM-DD ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹: 2025-12-31`);return}n.deadline=a}J(),Q()})})}function Ct(){document.querySelectorAll(`.project-group-row`).forEach(e=>{let t=e.dataset.projectId,n=t?U.projects.find(e=>e.id===t):null,r=e.querySelector(`.project-group-toggle`);r&&r.addEventListener(`click`,e=>{e.stopPropagation(),n&&(Y(),n.collapsed=!n.collapsed,J(),Z())});let i=e.querySelector(`.project-group-name`);i&&i.addEventListener(`click`,e=>{if(e.stopPropagation(),!window.parent||window.parent===window||!t)return;let r={type:`SCHEDULE_PROJECT_SELECT`,projectId:t,projectName:n?.name||i.textContent||``};window.parent.postMessage(r,`*`)})})}function wt(){document.querySelectorAll(`.row-header-cell`).forEach(e=>{let t=E&&e.dataset.trackId===E;e.classList.toggle(`track-selected`,t)}),document.querySelectorAll(`.cell`).forEach(e=>{let t=E&&e.dataset.trackId===E;e.classList.toggle(`track-selected`,t)})}function Tt(e){if(e.button!==0||e.target.closest(`.cell-dropdown-btn`))return;let t=e.currentTarget,n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10),o=X(n,r);if(Pt(),n&&E!==n&&(E=n,wt()),e.altKey){let t=(U.schedule[n]||{})[r]||``;A={trackId:n,date:r,value:t},k=!0,t&&vt(t,e.clientX,e.clientY);return}O=!0,it={rowIndex:i,colIndex:a},e.ctrlKey||e.metaKey?D.has(o)?D.delete(o):D.add(o):e.shiftKey&&M?at({rowIndex:M.rowIndex,colIndex:M.colIndex},{rowIndex:i,colIndex:a}):(D.clear(),D.add(o)),M={rowIndex:i,colIndex:a,trackId:n,date:r},rt()}function Et(e){if(!O||!it)return;let t=e.currentTarget,n={rowIndex:parseInt(t.dataset.rowIndex,10),colIndex:parseInt(t.dataset.colIndex,10)};at(it,n)}function Dt(e){let t=e.currentTarget;t.dataset.projectId;let n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10);if(k&&A){Y();let e=A;U.schedule[n]||(U.schedule[n]={}),e.value?U.schedule[n][r]=e.value:delete U.schedule[n][r],J();let i=t.querySelector(`.cell-select`);i&&(i.value=e.value||``,tt(i)),Z()}O=!1,k=!1,A=null,bt(),M={rowIndex:i,colIndex:a,trackId:n,date:r}}window.addEventListener(`mouseup`,()=>{O=!1,k=!1,A=null,bt()}),window.addEventListener(`mousemove`,e=>{k&&yt(e.clientX,e.clientY)}),window.handleCellChange=function(e){e.dataset.projectId;let t=e.dataset.trackId,n=e.dataset.date,r=e.value,i=X(t,n);function a(e,t,n){U.schedule[e]||(U.schedule[e]={}),n?U.schedule[e][t]=n:delete U.schedule[e][t]}if(Y(),D.size>1&&D.has(i)){let e=new Set;D.forEach(t=>{let[n,i]=t.split(`|`);a(n,i,r),e.add(n)}),e.forEach(e=>void 0)}else a(t,n,r);J(),Z()};function Ot(){let e=document.getElementById(`showAllBtn`),t=document.getElementById(`showSelectedBtn`);T?(t.classList.add(`active`),e.classList.remove(`active`)):(e.classList.add(`active`),t.classList.remove(`active`))}function kt(){document.getElementById(`statusEditorOverlay`).classList.remove(`hidden`),jt()}function At(){document.getElementById(`statusEditorOverlay`).classList.add(`hidden`)}function jt(){let e=document.getElementById(`statusListContainer`);e.innerHTML=``,(!U.statuses||!Array.isArray(U.statuses)||U.statuses.length===0)&&(U.statuses=x),U.statuses.forEach(t=>{let n=document.createElement(`div`);n.className=`status-row`,n.innerHTML=`
          <input type="text" class="status-name-input" value="${$(t.name)}" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šä½œæ›²ï¼‰">
          <input type="color" class="status-color-input" value="${t.color||`#f5576c`}">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,n.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{n.remove()}),e.appendChild(n)})}function Mt(){let e=document.getElementById(`statusListContainer`),t=Array.from(e.querySelectorAll(`.status-row`)),n=[];return t.forEach(e=>{let t=e.querySelector(`.status-name-input`),r=e.querySelector(`.status-color-input`),i=t.value.trim(),a=r.value||`#f5576c`;i&&n.push({name:i,color:a})}),n.length===0?x:n}function Nt(e,t){let n=document.getElementById(`contextMenu`);n.classList.remove(`hidden`);let r=n.getBoundingClientRect(),i=e,a=t;i+r.width>window.innerWidth&&(i=window.innerWidth-r.width-4),a+r.height>window.innerHeight&&(a=window.innerHeight-r.height-4),n.style.left=i+`px`,n.style.top=a+`px`}function Pt(){document.getElementById(`contextMenu`).classList.add(`hidden`),Ce=null}function Ft(e){if(h)return;let t=e.target.closest(`.cell`);if(!t){Pt();return}e.preventDefault();let n=t.dataset.trackId,r=t.dataset.date,i=parseInt(t.dataset.rowIndex,10),a=parseInt(t.dataset.colIndex,10);M={rowIndex:i,colIndex:a,trackId:n,date:r},Ce={rowIndex:i,colIndex:a,trackId:n,date:r},rt(),Nt(e.clientX,e.clientY)}function It(){if(h)return;let e=ot();if(!e.length&&M&&P.length&&F.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=M;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}if(!e.length)return;let t=e.map(e=>e.rowIndex),n=e.map(e=>e.colIndex),r=Math.min(...t),i=Math.max(...t),a=Math.min(...n),o=Math.max(...n),s=i-r+1,c=o-a+1,l=Array.from({length:s},()=>Array.from({length:c},()=>``));e.forEach(e=>{let t=e.rowIndex-r,n=e.colIndex-a,i=e.trackId,o=e.date,s=(U.schedule[i]||{})[o]||``;l[t][n]=s}),N={data:l,width:c,height:s}}function Lt(e){if(h||!N)return;let t=e||M;if(!t){let e=ot();if(!e.length)return;let n=e.map(e=>e.rowIndex),r=e.map(e=>e.colIndex);t={rowIndex:Math.min(...n),colIndex:Math.min(...r)}}let{data:n,width:r,height:i}=N;Y();for(let e=0;e<i;e++){let i=t.rowIndex+e;if(!P[i])continue;let a=P[i].track.id;for(let i=0;i<r;i++){let r=t.colIndex+i;if(!F[r])continue;let o=G(F[r]),s=n[e][i];U.schedule[a]||(U.schedule[a]={}),s?U.schedule[a][o]=s:delete U.schedule[a][o]}}J(),Z()}function Rt(){if(h)return;let e=ot();if(!e.length&&M&&P.length&&F.length){let{rowIndex:t,colIndex:n,trackId:r,date:i}=M;e=[{rowIndex:t,colIndex:n,trackId:r,date:i}]}e.length&&(Y(),e.forEach(e=>{U.schedule[e.trackId]&&delete U.schedule[e.trackId][e.date]}),J(),Z())}function zt(){let e=new Date;U.lastBackupAt=e.toISOString(),J(),gt();let t=JSON.stringify(U,null,2),n=new Blob([t],{type:`application/json`}),r=`schedule_backup_${e.getFullYear()}${String(e.getMonth()+1).padStart(2,`0`)}${String(e.getDate()).padStart(2,`0`)}_${String(e.getHours()).padStart(2,`0`)}${String(e.getMinutes()).padStart(2,`0`)}.json`,i=URL.createObjectURL(n),a=document.createElement(`a`);a.href=i,a.download=r,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(i)}function $(e){return e==null?``:String(e).replace(/&/g,`&amp;`).replace(/</g,`&lt;`).replace(/>/g,`&gt;`).replace(/"/g,`&quot;`).replace(/'/g,`&#039;`)}function Bt(e,t){let n=document.getElementById(`inputPopover`),r=document.getElementById(`inputPopoverTitle`),i=document.getElementById(`inputPopoverField`),a=document.getElementById(`inputPopoverOkBtn`);z.type=e,z.anchorBtn=t,e===`project`?(r.textContent=`æ–°ã—ã„æ¡ˆä»¶å`,a.textContent=`è¿½åŠ `):e===`track`&&(r.textContent=`æ–°ã—ã„æ›²å`,a.textContent=`è¿½åŠ `),i.value=``,n.classList.remove(`hidden`);let o=t.getBoundingClientRect();n.style.left=o.left+`px`,n.style.top=o.bottom+6+`px`;let s=n.getBoundingClientRect(),c=o.left,l=o.bottom+6;c+s.width>window.innerWidth-8&&(c=window.innerWidth-s.width-8),l+s.height>window.innerHeight-8&&(l=o.top-s.height-6),n.style.left=c+`px`,n.style.top=l+`px`,i.focus(),i.select()}function Vt(){document.getElementById(`inputPopover`).classList.add(`hidden`),z.type=null,z.anchorBtn=null}function Ht(){let e=document.getElementById(`inputPopoverField`).value.trim();if(!e){Vt();return}z.type===`project`?Ut(e):z.type===`track`&&Wt(e),Vt()}function Ut(e){Y();let t={id:q(),name:e.trim(),color:`#62c3ff`,tracks:[]};U.projects.push(t),w=t.id,J(),Q()}function Wt(e){if(!w){window.alert(`ã¾ãšå·¦ã®æ¡ˆä»¶ãƒªã‚¹ãƒˆã‹ã‚‰ã€æ›²ã‚’è¿½åŠ ã—ãŸã„æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);return}let t=U.projects.find(e=>e.id===w);if(!t){window.alert(`é¸æŠä¸­ã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);return}Y();let n={id:q(),name:e.trim()};t.tracks.push(n),J(),Q()}function Gt(e){let t=U.schedule[e];if(!t)return null;let n=null;return Object.keys(t).forEach(e=>{let t=Ee(e);isNaN(t.getTime())||(!n||t<n)&&(n=t)}),n}function Kt(){Y(),U.projects.forEach(e=>{!e.tracks||e.tracks.length<=1||e.tracks.sort((e,t)=>{let n=Gt(e.id),r=Gt(t.id);if(n&&r){let i=n-r;return i===0?e.name.localeCompare(t.name,`ja`):i}else if(n&&!r)return-1;else if(!n&&r)return 1;else return e.name.localeCompare(t.name,`ja`)})}),J(),Q()}function qt(e){V=m?!0:e,document.body.classList.toggle(`client-view-mode`,V),Jt()}function Jt(){let e=document.getElementById(`clientViewToggleBtn`);e&&(m?e.style.display=`none`:(e.style.display=``,V?(e.classList.add(`active`),e.textContent=`ğŸ‘ é€šå¸¸ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹`):(e.classList.remove(`active`),e.textContent=`ğŸ‘ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼`)));let t=document.getElementById(`clientViewBanner`);t&&t.classList.toggle(`hidden`,!V);let n=document.getElementById(`clientViewBackBtn`);n&&(n.style.display=m?`none`:``)}function Yt(){document.querySelectorAll(`.cell`).forEach(e=>{if(e.classList.remove(`dim`),B&&B!==`ALL`){let t=e.dataset.status||``;(!t||t!==B)&&e.classList.add(`dim`)}})}function Xt(){document.querySelectorAll(`[data-nav-href]`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.getAttribute(`data-nav-href`);t&&(location.href=t)})});let e=document.getElementById(`addTrackBtn`);e.addEventListener(`click`,()=>{Bt(`track`,e)});let t=document.getElementById(`settingsMenuBtn`),n=document.getElementById(`settingsPopover`);t&&n&&(t.addEventListener(`click`,e=>{e.stopPropagation(),n.classList.toggle(`settings-closed`)}),document.addEventListener(`click`,e=>{n.classList.contains(`settings-closed`)||!e.target.closest(`#settingsPopover`)&&!e.target.closest(`#settingsMenuBtn`)&&n.classList.add(`settings-closed`)})),document.getElementById(`autoStairSortBtn`).addEventListener(`click`,()=>{Kt()}),document.getElementById(`showAllBtn`).addEventListener(`click`,()=>{T=!1,Ot(),Q()}),document.getElementById(`showSelectedBtn`).addEventListener(`click`,()=>{T=!0,Ot(),Q()}),document.getElementById(`prevRangeBtn`).addEventListener(`click`,()=>{let e=U.daysToShow||S,t=K(Ee(U.startDate),-e);Y(),U.startDate=G(t),J(),Q()}),document.getElementById(`nextRangeBtn`).addEventListener(`click`,()=>{let e=U.daysToShow||S,t=K(Ee(U.startDate),e);Y(),U.startDate=G(t),J(),Q()});let r=document.getElementById(`themeToggleBtn`);r&&r.addEventListener(`click`,()=>{en(U.settings&&U.settings.theme===`light`?`dark`:`light`)});let i=document.getElementById(`tagToggleBtn`);i&&i.addEventListener(`click`,()=>{nn(!!(U.settings&&U.settings.showProjectTags===!1))}),document.getElementById(`exportBtn`).addEventListener(`click`,()=>{zt()}),document.getElementById(`importInput`).addEventListener(`change`,e=>{let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=t=>{try{let e=t.target.result;U=Ae(JSON.parse(e)),H=[],D.clear(),M=null,N=null,J(),$t(U.settings.theme),tn(U.settings.showProjectTags),Q(),window.alert(`JSONã‹ã‚‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`)}catch(e){console.error(e),window.alert(`JSONã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚`)}finally{e.target.value=``}},n.readAsText(t,`utf-8`)}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.cell-dropdown-btn`);if(!t)return;let n=t.closest(`.cell`);if(!n)return;let r=n.querySelector(`.cell-select`);if(r)if(typeof r.showPicker==`function`)r.showPicker();else{r.focus();let e=new MouseEvent(`mousedown`,{bubbles:!0,cancelable:!0,view:window});r.dispatchEvent(e),r.click()}}),document.addEventListener(`contextmenu`,Ft),document.addEventListener(`mousedown`,e=>{document.getElementById(`contextMenu`).classList.contains(`hidden`)||e.target.closest(`#contextMenu`)||Pt(),document.getElementById(`inputPopover`).classList.contains(`hidden`)||!e.target.closest(`#inputPopover`)&&!e.target.closest(`#addProjectBtn`)&&!e.target.closest(`#addTrackBtn`)&&Vt()}),window.addEventListener(`scroll`,()=>{Pt()},!0),document.querySelectorAll(`#contextMenu .context-menu-item`).forEach(e=>{e.addEventListener(`click`,()=>{let t=e.dataset.action;t===`copy`?It():t===`paste`?Lt(Ce||M||null):t===`clear`&&Rt(),Pt()})});let a=document.getElementById(`statusFilterSelect`);a.addEventListener(`change`,()=>{B=a.value,Yt()}),document.getElementById(`undoBtn`).addEventListener(`click`,()=>{Ze()});let o=document.getElementById(`clientViewToggleBtn`);o&&!m&&o.addEventListener(`click`,()=>{qt(!V)});let s=document.getElementById(`clientViewBackBtn`);s&&!m&&s.addEventListener(`click`,()=>{qt(!1)}),document.addEventListener(`keydown`,e=>{let t=e.ctrlKey||e.metaKey,n=e.target,r=n.tagName,i=r===`SELECT`&&n.classList.contains(`cell-select`),a=(r===`INPUT`||r===`TEXTAREA`||n.isContentEditable)&&!i;if(!document.getElementById(`inputPopover`).classList.contains(`hidden`)){if(e.key===`Enter`){e.preventDefault(),Ht();return}if(e.key===`Escape`){e.preventDefault(),Vt();return}}if(t&&(e.key===`s`||e.key===`S`)){e.preventDefault(),zt();return}if(h&&t&&(e.key===`c`||e.key===`C`)){e.preventDefault();return}if(t&&(e.key===`c`||e.key===`C`)){e.preventDefault(),It();return}if(h&&t&&(e.key===`v`||e.key===`V`)){e.preventDefault();return}if(t&&(e.key===`v`||e.key===`V`)){e.preventDefault(),Lt();return}if(t&&(e.key===`z`||e.key===`Z`)){if(a)return;e.preventDefault(),Ze();return}if(h&&(e.key===`Delete`||e.key===`Backspace`)){e.preventDefault();return}if(e.key===`Delete`||e.key===`Backspace`){if(a)return;e.preventDefault(),Rt();return}});let c=document.getElementById(`colWidthInput`),l=document.getElementById(`rowHeightInput`);c&&c.addEventListener(`change`,()=>{let e=parseInt(c.value,10);isNaN(e)&&(e=70),e=Math.max(20,Math.min(200,e)),Y(),U.settings.cellWidth=e,J(),ht(),Z()}),l&&l.addEventListener(`change`,()=>{let e=parseInt(l.value,10);isNaN(e)&&(e=28),e=Math.max(14,Math.min(80,e)),Y(),U.settings.cellHeight=e,J(),ht(),Z()});let u=document.getElementById(`daysToShowInput`);u&&u.addEventListener(`change`,()=>{let e=parseInt(u.value,10);isNaN(e)&&(e=S),e=Math.max(7,Math.min(90,e)),Y(),U.daysToShow=e,J(),Q()}),document.getElementById(`editStatusesBtn`).addEventListener(`click`,()=>{kt()}),document.getElementById(`closeStatusEditorBtn`).addEventListener(`click`,()=>{At()}),document.getElementById(`addStatusRowBtn`).addEventListener(`click`,()=>{let e=document.getElementById(`statusListContainer`),t=document.createElement(`div`);t.className=`status-row`,t.innerHTML=`
          <input type="text" class="status-name-input" value="" placeholder="å·¥ç¨‹åï¼ˆä¾‹ï¼šãƒªãƒŸãƒƒã‚¯ã‚¹ï¼‰">
          <input type="color" class="status-color-input" value="#f5576c">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">âœ•</button>
        `,t.querySelector(`.status-delete-btn`).addEventListener(`click`,()=>{t.remove()}),e.appendChild(t)}),document.getElementById(`saveStatusesBtn`).addEventListener(`click`,()=>{let e=Mt();Y(),U.statuses=e,J(),At(),Q()}),document.getElementById(`statusEditorOverlay`).addEventListener(`click`,e=>{e.target.id===`statusEditorOverlay`&&At()}),document.getElementById(`inputPopoverCancelBtn`).addEventListener(`click`,()=>{Vt()}),document.getElementById(`inputPopoverOkBtn`).addEventListener(`click`,()=>{Ht()}),document.addEventListener(`click`,e=>{let t=e.target.closest(`.row-header-memo-btn`);if(!t)return;e.stopPropagation();let n=t.dataset.projectId,r=t.dataset.trackId;an(n,r)}),document.addEventListener(`click`,e=>{let t=e.target;if(t.id===`trackMemoSaveBtn`){e.preventDefault(),sn();return}if(t.id===`trackMemoCancelBtn`){e.preventDefault(),on();return}if(t.id===`trackMemoOverlay`){e.preventDefault(),on();return}if(t.id===`cellNoteSaveBtn`){e.preventDefault(),un();return}if(t.id===`cellNoteCloseBtn`){e.preventDefault(),ln();return}if(t.id===`cellNoteOverlay`){e.preventDefault(),ln();return}}),document.getElementById(`heatmapToggleBtn`)?.addEventListener(`click`,()=>{U.settings||={},Y(),U.settings.heatmapEnabled=!U.settings.heatmapEnabled,J(),Q()})}function Zt(){let e=document.getElementById(`heatmapToggleBtn`);e&&(U.settings&&U.settings.heatmapEnabled?(e.classList.add(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ON`):(e.classList.remove(`active`),e.textContent=`ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—OFF`))}function Qt(e){let t=document.getElementById(`themeToggleBtn`);if(!t)return;let n=(e||U.settings&&U.settings.theme||`dark`)===`light`;t.textContent=n?`ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰`:`â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰`,t.classList.toggle(`active`,n)}function $t(e){let t=e===`light`?`light`:`dark`;document.body.classList.toggle(`theme-light`,t===`light`),document.body.classList.toggle(`theme-dark`,t===`dark`),document.documentElement.style.colorScheme=t===`light`?`light`:`dark`,Qt(t),typeof styleAllCellSelect==`function`&&styleAllCellSelect()}function en(e){dn();let t=e===`light`?`light`:`dark`;localStorage.setItem(xe,t),U.settings.theme=t,J(),$t(t),Q()}function tn(e){let t=e!==!1;document.body.classList.toggle(`hide-row-tags`,!t),rn(t)}function nn(e){dn(),U.settings.showProjectTags=!!e,J(),tn(e)}function rn(e){let t=document.getElementById(`tagToggleBtn`);if(!t)return;let n=e!==!1;t.textContent=n?`ğŸ· ã‚¿ã‚°éè¡¨ç¤º`:`ğŸ· ã‚¿ã‚°è¡¨ç¤º`,t.classList.toggle(`active`,n)}function an(e,t){L.projectId=e,L.trackId=t;let n=U.projects.find(t=>t.id===e),r=n?.tracks.find(e=>e.id===t);if(!n||!r)return;let i=document.getElementById(`trackMemoOverlay`),a=document.getElementById(`trackMemoTitle`),o=document.getElementById(`trackMemoText`);a.textContent=`${$(n.name)} - ${$(r.name)}`,o.value=r.memo||``,i.classList.remove(`hidden`),o.focus()}function on(){let e=document.getElementById(`trackMemoOverlay`);e&&e.classList.add(`hidden`),L.projectId=null,L.trackId=null}function sn(){if(!L.projectId||!L.trackId)return;let e=U.projects.find(e=>e.id===L.projectId),t=e?.tracks.find(e=>e.id===L.trackId);if(!e||!t){on();return}let n=document.getElementById(`trackMemoText`).value.trim();Y(),t.memo=n,L.projectId,J(),on(),Z()}function cn(e,t){R.trackId=e,R.dateIso=t;let n=document.getElementById(`cellNoteOverlay`),r=document.getElementById(`cellNoteTitle`),i=document.getElementById(`cellNoteTextarea`),a=X(e,t),o=U.cellNotes[a]||``;r.textContent=`${t} ã®ãƒ¡ãƒ¢`,i.value=o,n.classList.remove(`hidden`),i.focus()}function ln(){let e=document.getElementById(`cellNoteOverlay`);e&&e.classList.add(`hidden`),R.trackId=null,R.dateIso=null}function un(){if(!R.trackId||!R.dateIso)return;let e=document.getElementById(`cellNoteTextarea`).value.trim(),t=X(R.trackId,R.dateIso);Y(),e?U.cellNotes[t]=e:delete U.cellNotes[t],R.trackId,J(),ln(),Z()}function dn(){U.settings||={}}function fn(){dn();let e=new Date,t=G(W(e)),n=U.settings.lastRollDate||null;(e.getHours()>4||e.getHours()===4&&e.getMinutes()>=0)&&n!==t&&(Y(),U.startDate=t,U.settings.lastRollDate=t,J())}function pn(){fn(),setInterval(fn,60*1e3)}function mn(){ht()}Xt(),mn(),window.addEventListener(`resize`,pt),window.addEventListener(`resize`,mt),(function(){document.body.classList.add(`embedded`),g?qt(!0):(qt(!1),console.warn(`[schedule] embed=1 ãªã®ã« project ãŒã‚ã‚Šã¾ã›ã‚“ã€‚portalã‹ã‚‰ ?project=... ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚`)),(p===`light`||p===`dark`)&&en(p),window.addEventListener(`message`,e=>{let t=e.data;!t||typeof t!=`object`||t.type===`SET_THEME`&&(t.theme===`light`||t.theme===`dark`)&&en(t.theme)})})(),pn(),Q();