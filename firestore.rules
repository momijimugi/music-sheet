rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========
    // Basics
    // ==========
    function signedIn() {
      return request.auth != null;
    }

    function tokenEmailLower() {
      return (signedIn() && request.auth.token.email is string)
        ? request.auth.token.email.lower()
        : "";
    }

    // 旧ルール互換（Googleログインで email が token に無いケース対策）
    function identityEmailLower() {
      return (signedIn()
        && request.auth.token.firebase is map
        && request.auth.token.firebase.identities is map
        && request.auth.token.firebase.identities.email is list
        && request.auth.token.firebase.identities.email.size() > 0)
        ? request.auth.token.firebase.identities.email[0].lower()
        : "";
    }

    function emailLower() {
      return tokenEmailLower().size() > 0
        ? tokenEmailLower()
        : identityEmailLower();
    }

    // ==========
    // Admin (あなたの旧ルールを引き継ぎ)
    // ==========
    function isAdmin() {
      return signedIn() && (
        request.auth.uid in [
          "zXEgjnr3eEMXmhj1TssQDmCfblg1"
        ]
        || (emailLower().size() > 0 && emailLower() in ["dmikorogi@gmail.com"])
      );
    }

    // ==========
    // Project role helpers
    // ==========
    function projectDoc(pid) {
      return get(/databases/$(database)/documents/projects/$(pid)).data;
    }

    // 新方式: ownerUid
    // 旧方式: ownerEmail
    function isOwner(pid) {
      return isAdmin()
        || (
          signedIn()
          && (
            (projectDoc(pid).ownerUid is string && projectDoc(pid).ownerUid == request.auth.uid)
            || (emailLower().size() > 0 && projectDoc(pid).ownerEmail is string && projectDoc(pid).ownerEmail.lower() == emailLower())
          )
        );
    }

    // 新方式: /projects/{pid}/members/{uid} doc exists
    function hasMemberDoc(pid) {
      return signedIn()
        && exists(/databases/$(database)/documents/projects/$(pid)/members/$(request.auth.uid));
    }

    // 旧方式互換: projects.members(list) or projects.roleByUid(map)
    function hasLegacyMember(pid) {
      return signedIn()
        && (
          (projectDoc(pid).members is list && request.auth.uid in projectDoc(pid).members)
          || (projectDoc(pid).roleByUid is map && request.auth.uid in projectDoc(pid).roleByUid)
        );
    }

    function isMember(pid) {
      return isOwner(pid) || hasMemberDoc(pid) || hasLegacyMember(pid);
    }

    // ==========
    // users collection
    // - 自分のプロフィールは自分で読み書き
    // - 管理用途で admin は全ユーザー read 可（必要な時だけ読む想定）
    // ==========
    match /users/{uid} {
      allow create: if signedIn() && request.auth.uid == uid;
      allow read: if (signedIn() && request.auth.uid == uid) || isAdmin();
      allow update: if (signedIn() && request.auth.uid == uid) || isAdmin();
    }

    // ==========
    // projects
    // ==========
    match /projects/{pid} {

      // project doc
      allow read: if isMember(pid);

      // create: ownerUid方式（あなたの firebase.js に合わせる）
      allow create: if signedIn()
        && request.resource.data.ownerUid == request.auth.uid;

      // update/delete: owner or admin
      allow update, delete: if isOwner(pid);

      // ---- members subcollection ----
      match /members/{uid} {
        // メンバーは名簿を読める（要らなければ isOwner(pid) に変更してOK）
        allow read: if isMember(pid);

        // owner/admin は自由に追加削除
        allow update, delete: if isOwner(pid);

        // 招待を受けた本人が「自分自身の members/{uid}」を作成する（Join）
        allow create: if (
          isOwner(pid)
          ||
          (
            signedIn()
            && request.auth.uid == uid
            && request.resource.data.uid == request.auth.uid
            // 招待ID必須
            && request.resource.data.inviteId is string
            // 招待が存在
            && exists(/databases/$(database)/documents/projects/$(pid)/invites/$(request.resource.data.inviteId))
            // 招待先メールが一致
            && get(/databases/$(database)/documents/projects/$(pid)/invites/$(request.resource.data.inviteId)).data.emailLower == emailLower()
            // 未使用
            && get(/databases/$(database)/documents/projects/$(pid)/invites/$(request.resource.data.inviteId)).data.usedBy == null
          )
        );
      }

      // ---- invites subcollection ----
      match /invites/{inviteId} {
        // owner/admin は閲覧可
        // 招待された本人は自分宛てだけ閲覧可
        allow read: if isOwner(pid)
          || (signedIn() && emailLower().size() > 0 && resource.data.emailLower == emailLower());

        // owner/admin が発行
        allow create, delete: if isOwner(pid);

        // 招待された本人が usedBy/usedAt を埋めて受諾（Join の batch.update）
        allow update: if isOwner(pid)
          || (
            signedIn()
            && emailLower().size() > 0
            && resource.data.emailLower == emailLower()
            && resource.data.usedBy == null
            && request.resource.data.usedBy == request.auth.uid
            && request.resource.data.usedAt is timestamp
            // 変更は usedBy / usedAt のみ
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedBy','usedAt'])
          );
      }

      // ---- cues ----
      match /cues/{cueId} {
        allow read, write: if isMember(pid);
      }

      // ---- settings ----
      match /settings/{docId} {
        allow read, write: if isMember(pid);
      }

      // ---- portal ----
      match /portal/{docId} {
        allow read, write: if isMember(pid);
      }

      // ---- portalLogs ----
      match /portalLogs/{logId} {
        allow read: if isMember(pid);

        // createdBy は「uid」運用が理想だけど、旧データ互換で email も許容
        allow create: if isMember(pid)
          && (
            request.resource.data.createdBy == request.auth.uid
            || request.resource.data.createdBy == emailLower()
          );

        allow update, delete: if isOwner(pid)
          || (
            isMember(pid)
            && (
              resource.data.createdBy == request.auth.uid
              || resource.data.createdBy == emailLower()
            )
          );
      }

      // ---- scheduleBoard ----
      match /scheduleBoard/{docId} {
        allow read, write: if isMember(pid);
      }

      // その他のサブコレクションをまとめてメンバー制限
      match /{document=**} {
        allow read, write: if isMember(pid);
      }
    }

    // ==========
    // Collection group query support
    // ==========
    // index.js の fetchMemberProjectIds が collectionGroup("members") を読むため
    match /{path=**}/members/{uid} {
      allow read: if signedIn()
        && (
          uid == request.auth.uid
          || (resource.data.uid is string && resource.data.uid == request.auth.uid)
        );
    }

    // index.js の fetchPendingInvites が collectionGroup("invites") を読むため
    match /{path=**}/invites/{inviteId} {
      allow read: if signedIn()
        && emailLower().size() > 0
        && (resource.data.emailLower is string && resource.data.emailLower == emailLower());
    }
  }
}
